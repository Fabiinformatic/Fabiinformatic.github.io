<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Crear tu cuenta — LIXBY</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ajustes pequeños específicos de esta página */
    main.wrap { max-width:860px; margin:48px auto; padding:18px; }
    .errorsmall { color:#ff5c5c; margin-top:6px; }
  </style>
</head>
<body>
  <main class="wrap" role="main" aria-labelledby="hMain">
    <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px">
      <a class="brand" href="index.html" aria-label="Ir al inicio"><img src="https://i.imgur.com/dOCYmkx.jpeg" alt="LIXBY logo" width="44" height="44"><strong>LIXBY</strong></a>
      <div>
        <a href="login.html" class="btn ghost">Iniciar sesión</a>
      </div>
    </header>

    <h1 id="hMain">Crear tu cuenta de Lixby</h1>
    <p class="small">Solo necesitas una cuenta de Lixby para acceder a todos los servicios.</p>

    <section class="panel" aria-labelledby="formTitle" style="margin-top:12px">
      <form id="registerForm" novalidate>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="flex:1;min-width:160px" class="field">
            <label for="firstName">Nombre</label>
            <input id="firstName" autocomplete="given-name" />
            <div id="err-firstName" class="errorsmall" aria-live="polite"></div>
          </div>
          <div style="flex:1;min-width:160px" class="field">
            <label for="lastName">Apellidos</label>
            <input id="lastName" autocomplete="family-name" />
            <div id="err-lastName" class="errorsmall" aria-live="polite"></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <div style="flex:0 0 160px" class="field">
            <label for="country">País</label>
            <select id="country">
              <option value="ES" selected>España</option>
              <option value="PT">Portugal</option>
              <option value="FR">Francia</option>
              <option value="US">Estados Unidos</option>
            </select>
          </div>
          <div style="flex:1" class="field">
            <label>Fecha de nacimiento</label>
            <div style="display:flex;gap:8px">
              <input id="dobDay" placeholder="Día" inputmode="numeric" style="max-width:88px" />
              <input id="dobMonth" placeholder="Mes" inputmode="numeric" style="max-width:88px" />
              <input id="dobYear" placeholder="Año" inputmode="numeric" style="max-width:120px" />
            </div>
            <div id="err-dob" class="errorsmall" aria-live="polite"></div>
          </div>
        </div>

        <div class="field" style="margin-top:12px">
          <label for="email">Correo electrónico</label>
          <input id="email" type="email" autocomplete="email" placeholder="nombre@example.com" />
          <div id="err-email" class="errorsmall" aria-live="polite"></div>
          <div class="small muted">Esta será tu cuenta de Lixby.</div>
        </div>

        <div style="display:flex;gap:8px">
          <div style="flex:1" class="field">
            <label for="password">Contraseña</label>
            <input id="password" type="password" autocomplete="new-password" />
            <div id="err-password" class="errorsmall" aria-live="polite"></div>
          </div>
          <div style="flex:1" class="field">
            <label for="passwordConfirm">Confirmar contraseña</label>
            <input id="passwordConfirm" type="password" autocomplete="new-password" />
            <div id="err-passwordConfirm" class="errorsmall" aria-live="polite"></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:flex-end;margin-top:12px">
          <div style="flex:0 0 160px">
            <label for="phonePrefix">Prefijo</label>
            <select id="phonePrefix"><option value="+34" selected>+34 (ES)</option><option value="+1">+1 (US)</option></select>
          </div>
          <div style="flex:1" class="field">
            <label for="phone">Número de teléfono</label>
            <input id="phone" inputmode="tel" placeholder="612345678" />
            <div id="err-phone" class="errorsmall" aria-live="polite"></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
          <div>
            <button type="button" id="btnGoogle" class="btn ghost">Google</button>
            <button type="button" id="btnGithub" class="btn ghost">GitHub</button>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
          <a href="login.html" class="btn ghost">Iniciar sesión</a>
          <button type="submit" id="btnContinue" class="btn primary">Continuar</button>
        </div>

        <div id="formStatus" role="status" aria-live="polite" style="margin-top:10px;color:var(--muted)"></div>
      </form>
    </section>
  </main>

  <script type="module" src="auth-firebase-minimal.js"></script>
  <script>
    (function(){
      const form = document.getElementById('registerForm');
      const err = (id,msg) => { const el = document.getElementById('err-'+id); if(el) el.textContent = msg || ''; const f = document.getElementById(id); if(f) f.classList.toggle('input-error', !!msg); };
      function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
      function isPositiveInteger(v){ return /^\d+$/.test(v); }
      function validateDOB(day,month,year){
        if(!day || !month || !year) return false;
        const d=Number(day), m=Number(month)-1, y=Number(year);
        const date = new Date(y,m,d);
        if (isNaN(date.getTime())) return false;
        if (date.getFullYear() !== y || date.getMonth() !== m || date.getDate() !== d) return false;
        if (date > new Date()) return false;
        const age = new Date().getFullYear() - y - ((new Date().getMonth() < m || (new Date().getMonth()===m && new Date().getDate() < d)) ? 1 : 0);
        return age >= 13;
      }
      document.getElementById('btnGoogle').addEventListener('click', ()=> { if (window.appAuth) window.appAuth.signInWithGoogle(); else alert('No disponible.'); });
      document.getElementById('btnGithub').addEventListener('click', ()=> { if (window.appAuth) window.appAuth.signInWithGitHub(); else alert('No disponible.'); });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        ['firstName','lastName','dob','email','password','passwordConfirm','phone'].forEach(id => err(id,''));
        let firstInvalid = null;
        const firstName = (document.getElementById('firstName').value||'').trim();
        const lastName = (document.getElementById('lastName').value||'').trim();
        const dDay = (document.getElementById('dobDay').value||'').trim();
        const dMonth = (document.getElementById('dobMonth').value||'').trim();
        const dYear = (document.getElementById('dobYear').value||'').trim();
        const email = (document.getElementById('email').value||'').trim();
        const password = document.getElementById('password').value || '';
        const passwordConfirm = document.getElementById('passwordConfirm').value || '';
        const phone = (document.getElementById('phone').value||'').trim();

        if (!firstName) { err('firstName','Introduce tu nombre.'); firstInvalid = firstInvalid || document.getElementById('firstName'); }
        if (!lastName) { err('lastName','Introduce tus apellidos.'); firstInvalid = firstInvalid || document.getElementById('lastName'); }
        if (!validateDOB(dDay,dMonth,dYear)) { err('dob','Introduce una fecha de nacimiento válida.'); firstInvalid = firstInvalid || document.getElementById('dobDay'); }
        if (!isValidEmail(email)) { err('email','Introduce una dirección de correo válida.'); firstInvalid = firstInvalid || document.getElementById('email'); }
        if (password.length < 8) { err('password','8 o más caracteres'); firstInvalid = firstInvalid || document.getElementById('password'); }
        if (passwordConfirm !== password) { err('passwordConfirm','La confirmación no coincide'); firstInvalid = firstInvalid || document.getElementById('passwordConfirm'); }
        if (phone.replace(/\D/g,'').length < 6) { err('phone','Introduce un número de teléfono válido.'); firstInvalid = firstInvalid || document.getElementById('phone'); }

        if (firstInvalid) { firstInvalid.focus(); document.getElementById('formStatus').textContent = 'Hay errores en el formulario.'; return; }

        document.getElementById('formStatus').textContent = 'Creando cuenta…';
        try {
          if (!window.appAuth || typeof window.appAuth.createUserWithEmail !== 'function') throw new Error('Autenticación no disponible');
          const extra = { firstName, lastName, dob: `${dYear}-${String(dMonth).padStart(2,'0')}-${String(dDay).padStart(2,'0')}`, country: document.getElementById('country').value, phone: document.getElementById('phonePrefix').value + ' ' + phone };
          await window.appAuth.createUserWithEmail(email, password, extra);
          // store some snapshot locally
          const snapshot = { uid: (window?.appAuth?._rawAuth?.currentUser?.uid || null), email, firstName, lastName };
          try { localStorage.setItem('lixby_user', JSON.stringify(snapshot)); } catch(e){}
          document.getElementById('formStatus').textContent = 'Cuenta creada correctamente. Redirigiendo…';
          setTimeout(()=> location.href = 'cuenta.html', 800);
        } catch (err) {
          console.error(err);
          const msg = err && err.message ? err.message : String(err);
          document.getElementById('formStatus').textContent = 'Error: ' + msg;
        }
      });
    })();
  </script>
</body>
</html>
