<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pagar — LIXBY</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,Arial;background:#0b0c10;color:#e9eef2;margin:0;padding:22px}
    .wrap{max-width:760px;margin:24px auto}
    .card{background:#0f1316;padding:18px;border-radius:12px}
    .row{display:flex;gap:12px;align-items:center}
    label{display:block;margin-top:10px;font-size:0.95rem}
    input, select { width:100%; padding:8px; margin-top:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; }
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn-primary{background:#0a84ff;color:#00121a;margin-top:12px}
    .muted{color:#aab3ba}
    .summary-row{display:flex;justify-content:space-between;padding:6px 0}
    #card-element{padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .spinner{display:inline-block;width:18px;height:18px;border:2px solid rgba(255,255,255,0.08);border-top-color:#0a84ff;border-radius:50%;animation:spin .9s linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="font-weight:700;cursor:pointer" onclick="location.href='index.html'">LIXBY</div>
      <div class="muted">Pagar</div>
    </header>

    <div class="card">
      <h2>Pago con tarjeta</h2>
      <div id="orderSummary" style="margin-bottom:12px"></div>

      <form id="paymentForm">
        <div>
          <strong>Tarjeta de crédito</strong>
          <div id="card-element"></div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:14px 0">

        <div>
          <strong>Datos de facturación</strong>
          <label>Nombre completo <input id="b_name" type="text" required></label>
          <label>Correo electrónico <input id="b_email" type="email" required></label>
          <label>Dirección <input id="b_addr" type="text" required></label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="b_city" type="text" placeholder="Ciudad" style="flex:1">
            <input id="b_zip" type="text" placeholder="CP" style="width:120px">
          </div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <button id="confirmPayBtn" class="btn btn-primary" type="button">Pagar ahora</button>
          <div id="payStatus" class="muted"></div>
        </div>
      </form>
    </div>
  </div>

<script>
(async function(){
  // Obtener pedido guardado del paso confirmar-pedido
  const order = JSON.parse(localStorage.getItem('lixby_order') || 'null');
  if (!order || !order.items || order.items.length === 0) {
    alert('No hay pedido activo. Vuelve al carrito.');
    location.href = 'carrito.html';
    return;
  }

  // muestra resumen simple
  const nf = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'});
  const summaryEl = document.getElementById('orderSummary');
  let subtotal = 0;
  order.items.forEach(it => {
    const price = (it.priceNum !== undefined && it.priceNum !== null) ? Number(it.priceNum) : parseFloat(String(it.price||0).replace(/[^\d.-]/g,'')) || 0;
    const qty = Number(it.qty || 1);
    const addon = it.appleCare ? 169.00 : 0;
    subtotal += (price + addon) * qty;
  });
  summaryEl.innerHTML = `<div class="summary-row"><div>Subtotal</div><div>${nf.format(subtotal)}</div></div>`;

  // rellenar los campos de facturación con los datos de envío si están
  document.getElementById('b_name').value = order.shipping?.fullname || '';
  document.getElementById('b_email').value = order.shipping?.email || '';
  document.getElementById('b_addr').value = order.shipping?.addr || '';
  document.getElementById('b_city').value = order.shipping?.city || '';
  document.getElementById('b_zip').value = order.shipping?.zip || '';

  // 1) Obtener la publishable key desde el servidor
  let publishableKey = null;
  try {
    const cfg = await fetch('/config');
    const js = await cfg.json();
    publishableKey = js.publishableKey;
  } catch (err) {
    console.error('No se pudo obtener la publishableKey', err);
  }
  if (!publishableKey) {
    document.getElementById('payStatus').textContent = 'Error de configuración del pago.';
    return;
  }

  // Inicializar Stripe
  const stripe = Stripe(publishableKey);
  const elements = stripe.elements();
  const card = elements.create('card', {hidePostalCode: true});
  card.mount('#card-element');

  card.on('change', (ev) => {
    const s = document.getElementById('payStatus');
    s.textContent = ev.error ? ev.error.message : '';
  });

  const btn = document.getElementById('confirmPayBtn');
  btn.addEventListener('click', async () => {
    btn.disabled = true;
    document.getElementById('payStatus').textContent = 'Creando pago...';

    // recopilar datos de facturación (puedes validarlos más)
    const billing = {
      name: document.getElementById('b_name').value || '',
      email: document.getElementById('b_email').value || '',
      address: {
        line1: document.getElementById('b_addr').value || '',
        city: document.getElementById('b_city').value || '',
        postal_code: document.getElementById('b_zip').value || ''
      }
    };

    if (!billing.name || !billing.email || !billing.address.line1) {
      document.getElementById('payStatus').textContent = 'Rellena los datos de facturación.';
      btn.disabled = false;
      return;
    }

    try {
      // Llamamos a nuestro servidor para crear PaymentIntent
      const res = await fetch('/create-payment-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: order.items, shipping: order.shipping, isGift: order.isGift, giftMessage: order.giftMessage })
      });
      const data = await res.json();
      if (!data || !data.clientSecret) throw new Error(data?.error || 'No se obtuvo clientSecret');

      // Confirmar pago con Stripe Elements
      const result = await stripe.confirmCardPayment(data.clientSecret, {
        payment_method: {
          card: card,
          billing_details: {
            name: billing.name,
            email: billing.email,
            address: billing.address
          }
        },
        receipt_email: billing.email
      });

      if (result.error) {
        console.error(result.error);
        document.getElementById('payStatus').textContent = result.error.message || 'Error procesando el pago';
        btn.disabled = false;
      } else if (result.paymentIntent && result.paymentIntent.status === 'succeeded') {
        // pago correcto
        // opcional: limpiar carrito
        try { localStorage.removeItem('lixby_cart_v1'); } catch(e){}
        // redirige a success (puedes pasar id si quieres)
        window.location.href = 'success.html';
      } else {
        document.getElementById('payStatus').textContent = 'Pago finalizado con estado: ' + (result.paymentIntent ? result.paymentIntent.status : 'desconocido');
        btn.disabled = false;
      }
    } catch (err) {
      console.error(err);
      document.getElementById('payStatus').textContent = 'Error creando el pago: ' + (err.message || err);
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
