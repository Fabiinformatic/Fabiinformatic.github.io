<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Carrito — LIXBY</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#0f1316;
      --muted:#aab3ba;
      --text:#e9eef2;
      --accent:#0a84ff;
      --radius:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:28px auto;padding:24px;}
    h1{margin:14px 0 18px;font-size:2rem}
    .btn{padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:#00121a}
    .btn-secondary{background:transparent;border:1px solid var(--accent);color:var(--accent)}
    .bag-list{margin-top:20px}
    .item{display:flex;gap:16px;padding:18px;border-radius:12px;margin-bottom:14px;background:var(--panel);border:1px solid rgba(255,255,255,0.2);align-items:flex-start}
    .thumb img{width:120px;height:120px;object-fit:cover;border-radius:10px}
    .info{flex:1;min-width:0}
    .title{font-weight:700;margin:0 0 6px}
    .mini{color:var(--muted);margin-bottom:8px}
    .meta{display:flex;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap}
    .qty{display:inline-flex;align-items:center;border:1px solid rgba(255,255,255,0.2);border-radius:8px;overflow:hidden}
    .qty button{background:transparent;border:0;padding:6px 10px;cursor:pointer;color:var(--text)}
    .qty span{padding:6px 10px;min-width:36px;text-align:center}
    .remove{background:transparent;border:0;color:#ff6b6b;cursor:pointer}
    .price{flex:0 0 160px;text-align:right;font-weight:700}
    .summary{width:360px;flex:0 0 360px;margin-left:20px;background:var(--panel);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.2)}
    .summary-row{display:flex;justify-content:space-between;padding:8px 0;color:var(--muted)}
    .summary-row.total{font-weight:700;color:var(--text);font-size:1.05rem}
    .layout{display:flex;gap:20px;align-items:flex-start}
    .empty{padding:40px;text-align:center;color:var(--muted);background:var(--panel);border-radius:12px;border:1px solid rgba(255,255,255,0.2)}
    .checkout-options{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .checkout-options .btn{flex:1;min-width:140px}
    .warning{background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);border-radius:8px;padding:12px;margin:12px 0;color:#ffc107;font-size:0.9rem}
    .warning strong{display:block;margin-bottom:4px}
    @media (max-width:960px){ .layout{flex-direction:column} .summary{width:100%;margin-left:0} .thumb img{width:100%;height:auto} .checkout-options{flex-direction:column} }
  </style>
</head>
<body>
  <div class="wrap">
    <header style="display:flex;align-items:center;justify-content:space-between;padding:16px 0;margin-bottom:18px">
      <div style="font-weight:700;cursor:pointer" onclick="location.href='index.html'">LIXBY</div>
      <div style="color:var(--muted)">Tu carrito</div>
    </header>

    <h1>Tu carrito</h1>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div id="topText" style="color:var(--muted)">Aquí tienes lo que hay en tu bolsa.</div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="clearCart">Vaciar carrito</button>
      </div>
    </div>

    <div class="layout" style="margin-top:18px">
      <div style="flex:1">
        <div id="bag" class="bag-list" role="list" aria-label="Elementos de la bolsa"></div>
        <div id="emptyMsg" class="empty" style="display:none;margin-top:12px" aria-hidden="true">
          <strong>Tu bolsa está vacía</strong>
          <p style="color:var(--muted)">Añade productos desde la tienda.</p>
          <p><a href="index.html" class="btn btn-primary">Volver a la tienda</a></p>
        </div>
      </div>

      <aside class="summary" id="summaryAside" style="display:none" aria-live="polite">
        <div style="font-weight:700;margin-bottom:6px">Resumen</div>
        <div class="summary-row"><div>Subtotal</div><div id="sub">0,00 €</div></div>
        <div class="summary-row"><div>Envío</div><div id="ship">GRATIS</div></div>
        <div class="summary-row total"><div>Tu total:</div><div id="tot">0,00 € (Depende del país)</div></div>
        <div style="font-size:0.94rem;color:var(--muted);margin-top:8px">Incluye IVA si aplica</div>
        
        <!-- Opciones de checkout mejoradas -->
        <div class="checkout-options" id="checkoutOptions" style="display:none">
          <button class="btn btn-primary" id="checkoutStripe">Pagar con Stripe</button>
          <button class="btn btn-secondary" id="checkoutDirect">Pago directo</button>
        </div>
        
        <!-- Aviso para múltiples productos -->
        <div id="multiProductWarning" class="warning" style="display:none">
          <strong>⚠️ Múltiples productos</strong>
          <div>Para pagar varios productos diferentes, usa "Pagar con Stripe". El pago directo solo funciona con un producto a la vez.</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- inline payment map + helpers (mejorado) -->
  <script>
    (function(global){
      const PAYMENT_MAP = [
        { product: 'one air', color: 'black', storage: '128', url: 'https://buy.stripe.com/fZu3cufIXcsZ069c0Uffy00' },
        { product: 'one air', color: 'black', storage: '256', url: 'https://buy.stripe.com/00w4gy0O364BdWZ4ysffy01' },
        { product: 'one air', color: 'black', storage: '512', url: 'https://buy.stripe.com/4gM3cu7cr0Kh5qt9SMffy02' },

        { product: 'one air', color: 'white', storage: '128', url: 'https://buy.stripe.com/8x2cN454jakRf130icffy03' },
        { product: 'one air', color: 'white', storage: '256', url: 'https://buy.stripe.com/8x25kC54jdx3dWZaWQffy04' },
        { product: 'one air', color: 'white', storage: '512', url: 'https://buy.stripe.com/6oU14m68n50xdWZghaffy05' },

        { product: 'one', color: 'blue', storage: '128', url: 'https://buy.stripe.com/dRmeVc8gvcsZ9GJ8OIffy06' },
        { product: 'one', color: 'blue', storage: '256', url: 'https://buy.stripe.com/14A6oG54jdx3g57fd6ffy07' },
        { product: 'one', color: 'blue', storage: '512', url: 'https://buy.stripe.com/4gM8wOgN1eB7bOR7KEffy08' },
        { product: 'one', color: 'blue', storage: '1024', url: 'https://buy.stripe.com/8x27sK54j1Ol6uxfd6ffy09' }
      ];

      function norm(s){
        if (!s) return '';
        return String(s).toLowerCase()
          .replace(/\u00f1/g,'n')
          .replace(/[áàäâ]/g,'a').replace(/[éèëê]/g,'e').replace(/[íìïî]/g,'i').replace(/[óòöô]/g,'o').replace(/[úùüû]/g,'u')
          .replace(/[^a-z0-9 ]/g,' ')
          .replace(/\s+/g,' ')
          .trim();
      }

      function normalizeStorage(s){
        if (!s) return '';
        s = String(s).toLowerCase().replace(/\s+/g,'');
        if (s.match(/1tb|1024/)) return '1024';
        const m = s.match(/(\d{2,4})/);
        return m ? m[1] : s.replace(/[^0-9]/g,'');
      }

      function buildCandidate(item){
        const parts = [];
        if (item.sku) parts.push(item.sku);
        if (item.name) parts.push(item.name);
        if (item.color) parts.push(item.color);
        if (item.storage) parts.push(String(item.storage));
        if (item.description) parts.push(item.description);
        return norm(parts.join(' '));
      }

      function matchItem(item){
        const c = buildCandidate(item);
        if (!c) return null;
        for (const r of PAYMENT_MAP){
          const p = norm(r.product);
          const col = norm(r.color);
          const st = normalizeStorage(r.storage);
          const pm = c.indexOf(p) !== -1;
          const cm = col ? (c.indexOf(col) !== -1) : true;
          const sm = st ? (c.indexOf(st) !== -1 || c.indexOf(st + 'gb') !== -1) : true;
          if (pm && cm && sm) return r.url;
        }
        return null;
      }

      // Función mejorada para detectar si todos los productos tienen el mismo payment link
      function getPaymentLinkForCart(cart){
        if (!Array.isArray(cart) || cart.length === 0) return null;
        
        // Si solo hay un producto, devolver su link
        if (cart.length === 1) return matchItem(cart[0]);
        
        // Para múltiples productos, verificar si todos tienen el mismo link
        const urls = cart.map(item => matchItem(item)).filter(Boolean);
        
        // Si no todos los productos tienen un link válido, retornar null
        if (urls.length !== cart.length) return null;
        
        // Si todos tienen el mismo link, devolverlo
        const uniqueUrls = Array.from(new Set(urls));
        if (uniqueUrls.length === 1) return uniqueUrls[0];
        
        // Si tienen links diferentes, retornar null (requiere checkout múltiple)
        return null;
      }

      // Función para detectar si el carrito puede usar pago directo
      function canUseDirectPayment(cart){
        if (!Array.isArray(cart) || cart.length === 0) return false;
        
        // Un solo producto siempre puede usar pago directo si tiene link
        if (cart.length === 1) return matchItem(cart[0]) !== null;
        
        // Múltiples productos solo si todos tienen el mismo link
        return getPaymentLinkForCart(cart) !== null;
      }

      global.getPaymentLinkForItem = matchItem;
      global.getPaymentLinkForCart = getPaymentLinkForCart;
      global.canUseDirectPayment = canUseDirectPayment;
      global._LIXBY_PAYMENT_MAP = PAYMENT_MAP;
    })(window);
  </script>

  <script>
    (function(){
      'use strict';
      const KEY = 'lixby_cart_v1';
      const bag = document.getElementById('bag');
      const subEl = document.getElementById('sub');
      const totEl = document.getElementById('tot');
      const summaryAside = document.getElementById('summaryAside');
      const emptyMsg = document.getElementById('emptyMsg');
      const topText = document.getElementById('topText');
      const checkoutStripe = document.getElementById('checkoutStripe');
      const checkoutDirect = document.getElementById('checkoutDirect');
      const clearCartBtn = document.getElementById('clearCart');
      const checkoutOptions = document.getElementById('checkoutOptions');
      const multiProductWarning = document.getElementById('multiProductWarning');

      const nf = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });

      function parseValue(v){
        if (typeof v === 'number') return v;
        if (!v) return 0;
        try {
          if (typeof v === 'string' && v.includes(',')) {
            const cleaned = v.replace(/\s/g,'').replace('€','').replace(/\./g,'').replace(',', '.').trim();
            return parseFloat(cleaned) || 0;
          }
          return parseFloat(String(v).replace(/[^\d.-]/g,'')) || 0;
        } catch(e) { return 0; }
      }

      function fmt(n){ return nf.format(n); }

      let cart = [];
      try { cart = JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ cart = []; }

      function persist(){ try { localStorage.setItem(KEY, JSON.stringify(cart)); } catch(e){} }

      function updateCheckoutOptions(){
        if (!cart || cart.length === 0) {
          checkoutOptions.style.display = 'none';
          multiProductWarning.style.display = 'none';
          return;
        }

        checkoutOptions.style.display = 'flex';
        
        const canDirect = window.canUseDirectPayment(cart);
        const hasMultipleProducts = cart.length > 1;
        
        // Mostrar/ocultar botón de pago directo
        if (canDirect) {
          checkoutDirect.style.display = 'inline-flex';
          checkoutDirect.disabled = false;
        } else {
          checkoutDirect.style.display = 'none';
        }
        
        // Mostrar advertencia para múltiples productos
        if (hasMultipleProducts && !canDirect) {
          multiProductWarning.style.display = 'block';
        } else {
          multiProductWarning.style.display = 'none';
        }
        
        // Stripe siempre disponible
        checkoutStripe.disabled = false;
      }

      function render(){
        bag.innerHTML = '';
        if (!cart || cart.length === 0) {
          summaryAside.style.display = 'none';
          emptyMsg.style.display = 'block';
          topText.textContent = 'Tu bolsa está vacía.';
          updateCheckoutOptions();
          return;
        }
        emptyMsg.style.display = 'none';
        summaryAside.style.display = 'block';
        let subtotal = 0;
        cart.forEach((it, idx) => {
          const price = (it.priceNum !== undefined && it.priceNum !== null) ? Number(it.priceNum) : parseValue(it.price);
          const qty = Number(it.qty || 1);
          const line = price * qty;
          subtotal += line;

          const item = document.createElement('div');
          item.className = 'item';
          const img = encodeURI(it.image || 'https://via.placeholder.com/400');
          const title = (it.name || 'Producto');
          const desc = (it.description || '');
          item.innerHTML = `
            <div class="thumb"><img src="${img}" alt="${title}"></div>
            <div class="info">
              <div class="title">${title}</div>
              <div class="mini">${desc}</div>

              <div class="meta">
                <div class="qty" data-idx="${idx}" role="group" aria-label="Control de cantidad">
                  <button data-action="dec" aria-label="Disminuir">−</button>
                  <span class="qval" tabindex="0">${qty}</span>
                  <button data-action="inc" aria-label="Aumentar">+</button>
                </div>
                <button class="remove" data-idx="${idx}" style="margin-left:8px">Eliminar</button>
              </div>
            </div>
            <div class="price">${fmt(line)}</div>
          `;
          bag.appendChild(item);
        });

        const total = subtotal;
        subEl.textContent = fmt(subtotal);
        totEl.textContent = fmt(total) + ' (Depende del país)';
        topText.textContent = 'El total de tu bolsa es de ' + fmt(total) + '.';

        // attach events
        bag.querySelectorAll('.qty').forEach(q => {
          const idx = Number(q.getAttribute('data-idx'));
          const inc = q.querySelector('[data-action="inc"]');
          const dec = q.querySelector('[data-action="dec"]');
          inc && inc.addEventListener('click', ()=> { cart[idx].qty = (Number(cart[idx].qty || 1) + 1); persist(); render(); });
          dec && dec.addEventListener('click', ()=> { cart[idx].qty = Math.max(1, Number(cart[idx].qty || 1) - 1); persist(); render(); });
        });

        bag.querySelectorAll('.remove').forEach(b => {
          b.addEventListener('click', ()=> {
            const idx = Number(b.getAttribute('data-idx'));
            if (!confirm('Eliminar este artículo?')) return;
            cart.splice(idx,1);
            persist();
            render();
          });
        });

        updateCheckoutOptions();
      }

      // Checkout con Stripe (múltiples productos)
      checkoutStripe.addEventListener('click', () => {
        if (!cart || cart.length === 0) { 
          alert('Tu carrito está vacío'); 
          return; 
        }

        // Guardar orden para el checkout
        try { 
          localStorage.setItem('lixby_order', JSON.stringify({ 
            items: cart, 
            shipping: JSON.parse(localStorage.getItem('lixby_order') || '{}').shipping || {} 
          })); 
        } catch(e){}

        // Redirigir a página de checkout con Stripe
        window.location.href = 'checkout.html';
      });

      // Checkout directo (un solo producto o múltiples del mismo tipo)
      checkoutDirect.addEventListener('click', () => {
        if (!cart || cart.length === 0) { 
          alert('Tu carrito está vacío'); 
          return; 
        }

        const canDirect = window.canUseDirectPayment(cart);
        if (!canDirect) {
          alert('El pago directo no está disponible para esta combinación de productos. Usa "Pagar con Stripe" para múltiples productos diferentes.');
          return;
        }

        let savedOrder = null;
        try { savedOrder = JSON.parse(localStorage.getItem('lixby_order') || 'null'); } catch(e){ savedOrder = null; }

        // Para un solo producto, usar su link directo
        if (cart.length === 1) {
          const url = window.getPaymentLinkForItem(cart[0]);
          if (url) {
            const email = savedOrder?.shipping?.email || '';
            const final = url + (email ? `?prefilled_email=${encodeURIComponent(email)}` : '');
            try { localStorage.setItem('lixby_order', JSON.stringify({ items: cart, shipping: savedOrder?.shipping || {} })); } catch(e){}
            window.location.href = final;
          } else {
            alert('No existe un enlace automático para este producto. Contacta con soporte.');
          }
        } else {
          // Para múltiples productos del mismo tipo, usar el link común
          const url = window.getPaymentLinkForCart(cart);
          if (url) {
            const email = savedOrder?.shipping?.email || '';
            const final = url + (email ? `?prefilled_email=${encodeURIComponent(email)}` : '');
            try { localStorage.setItem('lixby_order', JSON.stringify({ items: cart, shipping: savedOrder?.shipping || {} })); } catch(e){}
            window.location.href = final;
          } else {
            alert('No se puede procesar esta combinación de productos. Usa "Pagar con Stripe".');
          }
        }
      });

      clearCartBtn.addEventListener('click', ()=> {
        if (!cart || cart.length === 0) return;
        if (!confirm('Vaciar el carrito?')) return;
        cart = [];
        persist();
        render();
      });

      // init
      render();

    })();
  </script>
</body>
</html>
