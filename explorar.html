<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explorar — LIXBY</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#0f1316; --muted:#aab3ba; --text:#e9eef2; --accent:#0a84ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .explore-wrap { max-width:1000px; margin:28px auto; padding:20px; }
    .explore-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; flex-wrap:wrap; }
    .search { display:flex; gap:8px; align-items:center; position:relative; }
    .search input { padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.01); color:var(--text); min-width:240px; }
    .select { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.03); color:var(--text); appearance:none; -webkit-appearance:none; -moz-appearance:none; }
    /* mejora visual del select (añade caret) */
    .select-wrapper { position:relative; display:inline-block; }
    .select-wrapper::after { content: "▾"; position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none; color:var(--muted); font-size:12px; }

    .filters-bar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
    .facets { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .chip {
      position:relative;
      padding:8px 12px;
      border-radius:999px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
      cursor:pointer;
      font-size:0.95rem;
      transition: all .16s ease;
      margin-left:8px;
    }
    .chip:first-child { margin-left:0; }
    .chip:hover { transform:translateY(-3px); }
    /* estado activo: fondo azul claro y aro/mini-círculo */
    .chip.active {
      background: linear-gradient(180deg, rgba(10,132,255,0.12), rgba(10,132,255,0.06));
      color: #00121a;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(10,132,255,0.08);
    }
    /* aro azul exterior pequeño que rodea el chip cuando activo */
    .chip.active::after {
      content: "";
      position: absolute;
      left: -6px;
      top: -6px;
      right: -6px;
      bottom: -6px;
      border-radius: 999px;
      border: 2px solid var(--accent);
      pointer-events: none;
      box-shadow: 0 0 0 6px rgba(10,132,255,0.06);
    }

    .grid-explore { display:grid; gap:18px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-top:8px; }
    .card-square { border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px; align-items:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); cursor:pointer; transition:transform .14s; }
    .card-square:hover { transform: translateY(-6px); box-shadow: 0 14px 34px rgba(0,0,0,0.6); }
    .thumb { width:100%; aspect-ratio:1/1; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#0f1113; }
    .thumb img { width:100%; height:100%; object-fit:contain; display:block; }
    .card-meta { width:100%; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .price { font-weight:800; color:var(--accent); }
    .tag { font-size:0.85rem; color:var(--muted); }

    .summary-line{ margin-bottom:12px; color:var(--muted); font-size:0.95rem; display:flex; justify-content:space-between; align-items:center; gap:12px; }

    /* suggestions */
    .suggest-list { position:absolute; top:110%; left:0; right:0; background:var(--panel); border:1px solid rgba(255,255,255,0.04); border-radius:8px; z-index:60; max-height:200px; overflow:auto; box-shadow:0 12px 30px rgba(0,0,0,0.6); display:none; }
    .suggest-list button { display:block; width:100%; padding:8px 10px; background:transparent; border:0; text-align:left; color:var(--text); cursor:pointer; }
    .highlight { background:rgba(10,132,255,0.12); color:var(--accent); padding:2px 4px; border-radius:4px; }

    /* responsive */
    @media (max-width:720px){
      .explore-head { flex-direction:column; align-items:flex-start; }
      .filters-bar { width:100%; }
    }
  </style>
</head>
<body>
  <main class="explore-wrap">
    <div class="explore-head">
      <h1>Explorar productos</h1>

      <div style="display:flex; gap:12px; align-items:center;">
        <div class="search" role="search" aria-label="Buscar productos">
          <input id="searchInput" placeholder="Buscar producto..." aria-label="Buscar productos" autocomplete="off">
          <div id="suggestList" class="suggest-list" role="listbox" aria-label="Sugerencias"></div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <div class="select-wrapper">
            <select id="sortSelect" class="select" aria-label="Ordenar">
              <option value="relevance">Relevancia</option>
              <option value="az">A → Z</option>
              <option value="za">Z → A</option>
              <option value="price-asc">Precio: bajo → alto</option>
              <option value="price-desc">Precio: alto → bajo</option>
              <option value="pop-desc">Más populares</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="filters-bar">
      <div class="facets" id="tagFacets" aria-label="Filtrar por etiqueta">
        <!-- chips renderizados por JS: Todos · Económico · Ligero · Potente · Pro -->
      </div>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <label style="color:var(--muted); font-size:0.95rem; margin-right:6px;">Sólo oferta</label>
        <input id="saleOnly" type="checkbox" aria-label="Filtrar solo productos en oferta">
      </div>
    </div>

    <div class="summary-line">
      <div id="resultCount">-- resultados</div>
      <div id="activeFilters" aria-live="polite"></div>
    </div>

    <div id="results" class="grid-explore" role="list" aria-live="polite"></div>

    <div style="margin-top:18px;text-align:center;color:var(--muted)"><small>© <span id="year"></span> LIXBY</small></div>
  </main>

  <script>
  // Solo 3 productos (tal y como pediste)
  const PRODUCTS = [
    { id: 'lixby-one-air', name: 'Lixby One Air', priceNum: 249, price: '249€', image: 'https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg', tag: 'Ligero', popularity: 82, sale: false },
    { id: 'lixby-one',     name: 'Lixby One',     priceNum: 349, price: '349€', image: 'https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg', tag: 'Potente', popularity: 95, sale: true },
    { id: 'lixby-one-pro', name: 'Lixby One Pro', priceNum: 899, price: '899€', image: 'https://m.media-amazon.com/images/I/61rriyfRKwL.jpg', tag: 'Pro', popularity: 76, sale: false }
  ];

  // Facetas fijas en el orden pedido
  const FACET_ORDER = ['Todos','Económico','Ligero','Potente','Pro'];

  // estado
  let state = { q:'', selectedFacet: 'Todos', saleOnly:false, sort:'relevance' };

  // elementos
  const el = {
    searchInput: document.getElementById('searchInput'),
    suggestList: document.getElementById('suggestList'),
    sortSelect: document.getElementById('sortSelect'),
    tagFacets: document.getElementById('tagFacets'),
    saleOnly: document.getElementById('saleOnly'),
    results: document.getElementById('results'),
    resultCount: document.getElementById('resultCount'),
    activeFilters: document.getElementById('activeFilters'),
    year: document.getElementById('year')
  };

  const nf = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
  function fmt(n){ return nf.format(Number(n)||0); }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
  function highlight(text, q){
    if(!q) return escapeHtml(text);
    const re = new RegExp('(' + q.trim().split(/\s+/).map(s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|') + ')', 'ig');
    return escapeHtml(text).replace(re, '<span class="highlight">$1</span>');
  }

  // Render chips (facetas) con el aro azul cuando están activas
  function renderFacets(){
    el.tagFacets.innerHTML = '';
    FACET_ORDER.forEach(f => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'chip' + (state.selectedFacet === f ? ' active' : '');
      btn.textContent = f;
      btn.onclick = () => {
        state.selectedFacet = (state.selectedFacet === f ? 'Todos' : f);
        applyAndRender();
        renderFacets(); // re-render para actualizar apariencia
      };
      el.tagFacets.appendChild(btn);
    });
  }

  function filterItems(){
    let res = PRODUCTS.slice();

    // facet filter
    if (state.selectedFacet && state.selectedFacet !== 'Todos') {
      if (state.selectedFacet === 'Económico') {
        // si alguien selecciona Económico, filtramos por precio bajo (ej. < 300)
        res = res.filter(p => p.priceNum <= 300);
      } else {
        res = res.filter(p => p.tag === state.selectedFacet);
      }
    }

    // sale only
    if (state.saleOnly) res = res.filter(p => p.sale);

    // search query
    const q = (state.q || '').trim().toLowerCase();
    if (q) {
      res = res.filter(p => {
        const hay = (p.name + ' ' + (p.tag||'') + ' ' + (p.id||'')).toLowerCase();
        return q.split(/\s+/).every(t => hay.includes(t));
      });
    }

    // sort
    switch(state.sort){
      case 'az': res.sort((a,b)=> a.name.localeCompare(b.name)); break;
      case 'za': res.sort((a,b)=> b.name.localeCompare(a.name)); break;
      case 'price-asc': res.sort((a,b)=> a.priceNum - b.priceNum); break;
      case 'price-desc': res.sort((a,b)=> b.priceNum - a.priceNum); break;
      case 'pop-desc': res.sort((a,b)=> b.popularity - a.popularity); break;
      case 'relevance':
      default:
        if (q) res.sort((a,b)=> {
          const an=a.name.toLowerCase(), bn=b.name.toLowerCase();
          const score = s => (s.startsWith(q)?100: s.includes(q)?10:0) + (s.length>0?0:0);
          return (score(bn)+b.popularity/100) - (score(an)+a.popularity/100);
        });
        else res.sort((a,b)=> b.popularity - a.popularity);
    }

    return res;
  }

  function renderResults(){
    const list = filterItems();
    el.results.innerHTML = '';
    if (!list.length) {
      el.results.innerHTML = '<div style="color:var(--muted)">No se encontraron productos.</div>';
      el.resultCount.textContent = '0 resultados';
      el.activeFilters.textContent = '';
      return;
    }

    const frag = document.createDocumentFragment();
    list.forEach(p => {
      const card = document.createElement('article');
      card.className = 'card-square glass';
      card.setAttribute('role','listitem');
      card.innerHTML = `
        <div class="thumb"><img src="${escapeHtml(p.image)}" alt="${escapeHtml(p.name)}"></div>
        <div style="width:100%"><div style="font-weight:700">${highlight(p.name, state.q)}</div><div class="tag">${escapeHtml(p.tag)}</div></div>
        <div class="card-meta"><div class="price">${fmt(p.priceNum)}</div><div style="display:flex;gap:8px"><button class="btn-view btn" data-id="${p.id}">Ver</button><button class="btn primary btn-add" data-id="${p.id}">Añadir</button></div></div>
      `;
      card.querySelector('.btn-view').addEventListener('click', ev => { ev.stopPropagation(); location.href = 'producto.html?id=' + encodeURIComponent(p.id); });
      card.querySelector('.btn-add').addEventListener('click', ev => { ev.stopPropagation(); addToCartDemo(p); });
      card.addEventListener('click', ()=> location.href = 'producto.html?id=' + encodeURIComponent(p.id));
      frag.appendChild(card);
    });
    el.results.appendChild(frag);

    el.resultCount.textContent = `${list.length} resultado${list.length===1?'':'s'}`;
    const active = [];
    if (state.q) active.push(`"${state.q}"`);
    if (state.selectedFacet && state.selectedFacet !== 'Todos') active.push(state.selectedFacet);
    if (state.saleOnly) active.push('Oferta');
    el.activeFilters.textContent = active.length ? `Filtros: ${active.join(' · ')}` : '';
  }

  // small cart demo
  function addToCartDemo(product){
    try {
      const KEY='lixby_cart_v1';
      let cart = JSON.parse(localStorage.getItem(KEY) || '[]');
      const found = cart.find(i=>i.id===product.id);
      if (found) found.qty = (found.qty||1) + 1; else cart.push({ id: product.id, name: product.name, priceNum: product.priceNum, qty: 1, image: product.image });
      localStorage.setItem(KEY, JSON.stringify(cart));
      const count = cart.reduce((s,i)=> s + (i.qty||0), 0);
      // actualizar contador si existe
      const headerCount = document.getElementById('cartCount');
      if (headerCount) headerCount.textContent = count;
      // feedback visual temporal
      const toast = document.createElement('div');
      toast.textContent = `${product.name} añadido`;
      Object.assign(toast.style, {position:'fixed',right:'18px',bottom:'18px',background:'rgba(0,0,0,0.72)',color:'#fff',padding:'10px 12px',borderRadius:'8px',zIndex:9999});
      document.body.appendChild(toast);
      setTimeout(()=> toast.remove(), 1500);
    } catch(e){ console.warn(e); }
  }

  // Suggestions (typeahead simple)
  const suggestBox = el.suggestList;
  function showSuggestions(q){
    const s = (q||'').trim().toLowerCase();
    if (!s) { suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
    const matches = PRODUCTS.filter(p => p.name.toLowerCase().includes(s) || (p.tag||'').toLowerCase().includes(s)).slice(0,6);
    if (!matches.length) { suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
    suggestBox.innerHTML = '';
    matches.forEach(m=>{
      const btn = document.createElement('button');
      btn.type='button';
      btn.innerHTML = `${highlight(m.name, s)} <span style="float:right;color:var(--muted)">${fmt(m.priceNum)}</span>`;
      btn.onclick = ()=> { state.q = m.name; el.searchInput.value = m.name; suggestBox.style.display='none'; renderResults(); };
      suggestBox.appendChild(btn);
    });
    suggestBox.style.display='block';
  }

  function debounce(fn, wait=250){ let t; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

  // wiring
  el.searchInput.addEventListener('input', debounce(e=>{
    state.q = e.target.value;
    showSuggestions(state.q);
    renderResults();
  }, 180));
  document.addEventListener('click', (ev)=> {
    if (!document.querySelector('.search').contains(ev.target)) suggestBox.style.display='none';
  });
  el.sortSelect.addEventListener('change', e=> { state.sort = e.target.value; renderResults(); });
  el.saleOnly.addEventListener('change', e=> { state.saleOnly = e.target.checked; renderResults(); });

  // init
  function init(){
    el.year.textContent = new Date().getFullYear();
    renderFacets();
    renderResults();
    // keyboard: Esc hides suggestions
    document.addEventListener('keydown', e => { if (e.key === 'Escape') suggestBox.style.display='none'; });
  }
  init();

  // expose for debug
  window.__LIXBY_EXPLORE = { state, PRODUCTS };
  </script>
</body>
</html>
