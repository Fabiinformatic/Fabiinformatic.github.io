<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Iniciar sesión — LIXBY</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Minimal + accesible */
    :root { --accent:#2f6bff; --bg:#fff; --text:#07101a; --muted:#6b7a86; --stroke:rgba(2,6,12,0.06); }
    body { color:var(--text); background:var(--bg); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:24px; }
    .form-card { max-width:520px; margin:72px auto; text-align:left; border-radius:12px; padding:20px; box-shadow:0 10px 30px rgba(2,6,12,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); }
    h1 { margin:0 0 6px; font-size:1.25rem; }
    .small { color:var(--muted); font-size:0.95rem; }
    .auth-row { display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .auth-btn { display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:transparent; cursor:pointer; font-weight:700; color:var(--text); }
    .auth-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
    .auth-btn img.icon { width:18px;height:18px; display:block; }
    .sep { display:flex; align-items:center; gap:12px; margin:16px 0; color:var(--muted); }
    .sep hr { flex:1; height:1px; border:0; background:var(--stroke); }
    label { display:block; margin-top:8px; font-weight:700; }
    input[type="text"], input[type="password"] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--stroke); box-sizing:border-box; font-size:1rem; margin-top:6px; }
    .error { color:#dc2626; font-size:0.95rem; margin-top:6px; min-height:1.1em; }
    .row-right { display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:12px; }
    .btn { padding:9px 12px; border-radius:8px; border:1px solid var(--stroke); background:transparent; cursor:pointer; font-weight:700; }
    .btn.primary { background:linear-gradient(180deg,var(--accent), color-mix(in oklab, var(--accent) 60%, #fff 40%)); color:#00121a; border:none; }
    .btn.ghost { background:transparent; }
    .muted-link { color:var(--muted); text-decoration:underline; text-underline-offset:3px; }
    .center { text-align:center; }
    .visually-hidden { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; white-space:nowrap; }
    @media (max-width:560px){ .form-card { margin:36px 12px; padding:16px; } }
  </style>
</head>
<body>
  <header class="nav" aria-label="Cabecera">
    <div class="nav-inner" style="max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;">
      <div class="brand" id="brand" role="link" tabindex="0" aria-label="Ir al inicio">LIXBY</div>
      <div class="nav-right">
        <button id="openAuthBtn" class="btn ghost" aria-haspopup="dialog">Cuenta</button>
      </div>
    </div>
  </header>

  <main>
    <div class="form-card" role="main" aria-labelledby="loginTitle">
      <h1 id="loginTitle" class="center">Inicia sesión en LIXBY</h1>
      <p class="small center">Accede a tu cuenta para ver pedidos, favoritos y configuración.</p>

      <div class="auth-row" role="region" aria-label="Iniciar con proveedores">
        <button id="googleBtn" class="auth-btn" type="button" aria-label="Iniciar con Google">
          <img class="icon" src="https://www.svgrepo.com/show/355037/google.svg" alt="">
          <span>Iniciar con Google</span>
        </button>
        <button id="githubBtn" class="auth-btn" type="button" aria-label="Iniciar con GitHub">
          <img class="icon" src="https://www.svgrepo.com/show/341847/github.svg" alt="">
          <span>Iniciar con GitHub</span>
        </button>
      </div>

      <div class="sep" aria-hidden="true"><hr/><div>o</div><hr/></div>

      <form id="loginForm" novalidate>
        <label for="loginId">Correo electrónico</label>
        <input id="loginId" name="loginId" type="text" inputmode="email" autocomplete="username email" aria-describedby="hint-loginId" placeholder="nombre@ejemplo.com">
        <div id="err-loginId" class="error" aria-live="polite"></div>

        <label for="loginPass">Contraseña</label>
        <input id="loginPass" name="loginPass" type="password" autocomplete="current-password">
        <div id="err-loginPass" class="error" aria-live="polite"></div>

        <div class="row-right">
          <a href="forgot-password.html" class="small muted-link">¿Has olvidado la contraseña?</a>
          <div style="display:flex;gap:8px;align-items:center">
            <a href="register.html" class="btn ghost" aria-label="Registrarse">Registrarse</a>
            <button id="btnLogin" class="btn primary" type="submit" aria-live="polite">Iniciar sesión</button>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="btnGuest" type="button" class="btn ghost" aria-label="Entrar como invitado">Entrar como invitado</button>
        </div>

        <div id="loginMsg" class="small" style="margin-top:12px" role="status" aria-live="polite"></div>
      </form>
    </div>
  </main>

  <script type="module" src="auth-firebase-minimal.js"></script>
  <script>
    // --- Helpers ---
    const $ = id => document.getElementById(id);
    function setStatus(msg, isError = false) {
      const el = $('loginMsg');
      el.textContent = msg || '';
      el.style.color = isError ? '#b91c1c' : 'var(--muted)';
    }
    function disableBtns(state){
      ['googleBtn','githubBtn','btnLogin','btnGuest','openAuthBtn'].forEach(id=>{
        const b = $(id); if (!b) return; b.disabled = !!state;
      });
    }

    // --- Navigation / UI wiring ---
    $('brand').addEventListener('click', ()=> location.href='index.html');
    $('brand').addEventListener('keypress', e=> { if (e.key==='Enter') location.href='index.html'; });

    // open auth overlay if available
    $('openAuthBtn').addEventListener('click', ()=> {
      if (window.lixbyAuth && typeof window.lixbyAuth.show === 'function') return window.lixbyAuth.show();
      // fallback: open modal created by auth module
      const ov = document.getElementById('lixbyAuthOverlay');
      if (ov) { ov.style.display='flex'; ov.setAttribute('aria-hidden','false'); }
    });

    // social buttons: try appAuth first, fallback to window.lixbyAuth
    $('googleBtn').addEventListener('click', async ()=> {
      try {
        disableBtns(true); setStatus('Abriendo Google…');
        if (window.appAuth && typeof window.appAuth.signInWithGoogle === 'function') await window.appAuth.signInWithGoogle();
        else if (window.lixbyAuth && typeof window.lixbyAuth.signInWithGoogle === 'function') await window.lixbyAuth.signInWithGoogle();
        setStatus('Acceso mediante Google completado.'); setTimeout(()=> location.href='cuenta.html', 700);
      } catch(e) {
        console.error(e); setStatus((e && e.message) || 'Error con Google', true);
      } finally { disableBtns(false); }
    });

    $('githubBtn').addEventListener('click', async ()=> {
      try {
        disableBtns(true); setStatus('Abriendo GitHub…');
        if (window.appAuth && typeof window.appAuth.signInWithGitHub === 'function') await window.appAuth.signInWithGitHub();
        else if (window.lixbyAuth && typeof window.lixbyAuth.signInWithGitHub === 'function') await window.lixbyAuth.signInWithGitHub();
        setStatus('Acceso mediante GitHub completado.'); setTimeout(()=> location.href='cuenta.html', 700);
      } catch(e) {
        console.error(e); setStatus((e && e.message) || 'Error con GitHub', true);
      } finally { disableBtns(false); }
    });

    // Guest
    $('btnGuest').addEventListener('click', async ()=> {
      try {
        disableBtns(true); setStatus('Entrando como invitado…');
        if (window.appAuth && typeof window.appAuth.signInAnonymously === 'function') {
          await window.appAuth.signInAnonymously();
          setStatus('Entrando como invitado…');
          setTimeout(()=> location.href='cuenta.html', 600);
        } else if (window.lixbyAuth && typeof window.lixbyAuth.signInAnonymously === 'function') {
          await window.lixbyAuth.signInAnonymously();
          setTimeout(()=> location.href='cuenta.html', 600);
        } else {
          throw new Error('Función de invitado no disponible');
        }
      } catch(e) {
        console.error(e); setStatus((e && e.message) || 'No se pudo entrar como invitado', true);
      } finally { disableBtns(false); }
    });

    // --- Login form ---
    const form = $('loginForm');
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      $('err-loginId').textContent = ''; $('err-loginPass').textContent = ''; setStatus('');
      const id = ($('loginId')||{}).value.trim();
      const pass = ($('loginPass')||{}).value;
      if (!id) { $('err-loginId').textContent = 'Introduce tu correo.'; $('loginId').focus(); return; }
      if (!pass) { $('err-loginPass').textContent = 'Introduce la contraseña.'; $('loginPass').focus(); return; }

      try {
        disableBtns(true); setStatus('Iniciando sesión…');
        // prefer email sign-in; the auth module exposes signInWithEmail
        if (!window.appAuth || typeof window.appAuth.signInWithEmail !== 'function') throw new Error('Módulo de autenticación no cargado');
        // If user typed a phone number by mistake, we could detect it here (simple)
        const looksLikeEmail = id.includes('@');
        if (!looksLikeEmail) {
          // still attempt with provided id — most flows expect email
          // but warn user if it's clearly a phone (digits + optional +)
          const digitsOnly = id.replace(/\s+/g,'').replace(/^\+/, '');
          if (/^\d{6,}$/.test(digitsOnly)) {
            // show friendly hint but still attempt
            setStatus('Parece un teléfono — probando con correo…');
          }
        }
        await window.appAuth.signInWithEmail(id, pass);
        setStatus('Sesión iniciada. Redirigiendo…');
        setTimeout(()=> location.href = 'cuenta.html', 600);
      } catch (err) {
        console.error(err);
        // Prefer human-friendly message if provided
        const msg = (err && err.message) ? err.message : 'Error iniciando sesión.';
        setStatus(msg, true);
      } finally {
        disableBtns(false);
      }
    });

    // small UX: press Enter on inputs submits
    ['loginId','loginPass'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('keydown', (e)=> { if (e.key==='Enter') form.dispatchEvent(new Event('submit',{cancelable:true})); });
    });

    // If auth module later populates header, it will override; keep graceful if not present
    window.addEventListener('load', ()=> {
      // keep small timeout to allow auth module to hydrate header
      setTimeout(()=> {
        // nothing else needed here; just ensure UI responsive
      }, 300);
    });
  </script>
</body>
</html>
