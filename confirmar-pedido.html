<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Confirmar pedido — LIXBY</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,system-ui,Arial;background:#0b0c10;color:#e9eef2;margin:0;padding:20px}
    .wrap{max-width:920px;margin:0 auto}
    h1{font-size:1.6rem}
    .grid{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
    .left{flex:1;background:#0f1316;padding:18px;border-radius:12px}
    .right{width:360px;background:#0f1316;padding:18px;border-radius:12px}
    .product-row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .thumb img{width:96px;height:96px;object-fit:cover;border-radius:8px}
    label{display:block;margin-top:10px}
    input[type="text"], input[type="email"], textarea, select {
      width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;
    }
    .btn{display:inline-block;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    .btn-primary{background:#0a84ff;color:#00121a;margin-top:12px}
    .row-between{display:flex;justify-content:space-between;align-items:center}
    .muted{color:#aab3ba;font-size:0.95rem}
    a { color: inherit; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div style="font-weight:700;cursor:pointer" onclick="location.href='index.html'">LIXBY</div>
      <div class="muted">Confirmar pedido</div>
    </header>

    <h1>Confirmar pedido</h1>

    <form id="orderForm" class="grid" novalidate>
      <div class="left" aria-labelledby="leftTitle">
        <div id="giftRow">
          <label><input type="checkbox" id="isGift"> ¿Este pedido es un regalo? Incluir mensaje de regalo</label>
          <div id="giftMessageWrap" style="display:none">
            <label for="giftMessage">Mensaje del regalo (opcional)</label>
            <textarea id="giftMessage" rows="3" placeholder="Escribe tu mensaje..."></textarea>
          </div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:14px 0">

        <div id="productList" aria-live="polite"></div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:14px 0">

        <div>
          <strong>Dirección de envío</strong>
          <label for="fullname">Nombre completo</label>
          <input id="fullname" required type="text" placeholder="Tu nombre">
          <label for="email">Correo electrónico</label>
          <input id="email" required type="email" placeholder="tu@correo.com">
          <label for="addr">Dirección</label>
          <input id="addr" required type="text" placeholder="Calle, número, piso...">
          <label for="city">Ciudad</label>
          <input id="city" required type="text" placeholder="Ciudad">
          <label for="zip">Código postal</label>
          <input id="zip" required type="text" placeholder="28001">
          <label for="country">País</label>
          <select id="country" required>
            <option value="ES">España</option>
            <option value="PT">Portugal</option>
            <option value="FR">Francia</option>
          </select>
        </div>
      </div>

      <aside class="right" aria-labelledby="resumenTitle">
        <div style="font-weight:700;margin-bottom:8px">Resumen</div>
        <div id="summaryItems" style="margin-bottom:12px"></div>
        <div class="row-between"><div class="muted">Subtotal</div><div id="subTotal">0,00 €</div></div>
        <div class="row-between"><div class="muted">Envío</div><div id="shippingCost">GRATIS</div></div>
        <div style="height:12px"></div>
        <div class="row-between" style="font-weight:700;font-size:1.05rem"><div>Total</div><div id="grandTotal">0,00 €</div></div>

        <div style="margin-top:12px">
          <button id="payBtn" type="button" class="btn btn-primary" aria-live="polite">Realizar pago</button>
        </div>

        <div id="status" class="muted" style="margin-top:10px"></div>
      </aside>
    </form>
  </div>

  <!-- Inline payment map + matching helpers -->
  <script>
    (function(global){
      // MAP from user's input
      const PAYMENT_MAP = [
        { product: 'one air', color: 'black', storage: '128', url: 'https://buy.stripe.com/fZu3cufIXcsZ069c0Uffy00' },
        { product: 'one air', color: 'black', storage: '256', url: 'https://buy.stripe.com/00w4gy0O364BdWZ4ysffy01' },
        { product: 'one air', color: 'black', storage: '512', url: 'https://buy.stripe.com/4gM3cu7cr0Kh5qt9SMffy02' },

        { product: 'one air', color: 'white', storage: '128', url: 'https://buy.stripe.com/8x2cN454jakRf130icffy03' },
        { product: 'one air', color: 'white', storage: '256', url: 'https://buy.stripe.com/8x25kC54jdx3dWZaWQffy04' },
        { product: 'one air', color: 'white', storage: '512', url: 'https://buy.stripe.com/6oU14m68n50xdWZghaffy05' },

        { product: 'one', color: 'blue', storage: '128', url: 'https://buy.stripe.com/dRmeVc8gvcsZ9GJ8OIffy06' },
        { product: 'one', color: 'blue', storage: '256', url: 'https://buy.stripe.com/14A6oG54jdx3g57fd6ffy07' },
        { product: 'one', color: 'blue', storage: '512', url: 'https://buy.stripe.com/4gM8wOgN1eB7bOR7KEffy08' },
        { product: 'one', color: 'blue', storage: '1024', url: 'https://buy.stripe.com/8x27sK54j1Ol6uxfd6ffy09' }
      ];

      function norm(s){
        if (!s) return '';
        return String(s).toLowerCase()
          .replace(/\u00f1/g,'n')
          .replace(/[áàäâ]/g,'a').replace(/[éèëê]/g,'e').replace(/[íìïî]/g,'i').replace(/[óòöô]/g,'o').replace(/[úùüû]/g,'u')
          .replace(/[^a-z0-9 ]/g,' ')
          .replace(/\s+/g,' ')
          .trim();
      }

      function normalizeStorage(s){
        if (!s) return '';
        s = String(s).toLowerCase().replace(/\s+/g,'');
        if (s.match(/1tb|1024/)) return '1024';
        const m = s.match(/(\d{2,4})/);
        return m ? m[1] : s.replace(/[^0-9]/g,'');
      }

      function buildCandidate(item){
        const parts = [];
        if (item.sku) parts.push(item.sku);
        if (item.name) parts.push(item.name);
        if (item.color) parts.push(item.color);
        if (item.storage) parts.push(String(item.storage));
        if (item.description) parts.push(item.description);
        return norm(parts.join(' '));
      }

      function matchItem(item){
        const c = buildCandidate(item);
        if (!c) return null;
        // exact product+color+storage
        for (const r of PAYMENT_MAP){
          const p = norm(r.product);
          const col = norm(r.color);
          const st = normalizeStorage(r.storage);
          const pm = c.indexOf(p) !== -1;
          const cm = col ? (c.indexOf(col) !== -1) : true;
          const sm = st ? (c.indexOf(st) !== -1 || c.indexOf(st + 'gb') !== -1) : true;
          if (pm && cm && sm) return r.url;
        }
        // looser matches (product+storage or product+color)
        for (const r of PAYMENT_MAP){
          const p = norm(r.product);
          const col = norm(r.color);
          const st = normalizeStorage(r.storage);
          const pm = c.indexOf(p) !== -1;
          const cm = col ? (c.indexOf(col) !== -1) : false;
          const sm = st ? (c.indexOf(st) !== -1) : false;
          if (pm && (cm || sm)) return r.url;
        }
        return null;
      }

      global._LIXBY_PAYMENT_MAP = PAYMENT_MAP;
      global.getPaymentLinkForItem = matchItem;
      global.getPaymentLinkForCart = function(cart){
        if (!Array.isArray(cart) || cart.length === 0) return null;
        if (cart.length === 1) return matchItem(cart[0]);
        // if every item maps and all to same URL -> return it
        const urls = cart.map(i => matchItem(i)).filter(Boolean);
        if (urls.length === cart.length){
          const uniq = Array.from(new Set(urls));
          if (uniq.length === 1) return uniq[0];
        }
        return null;
      };

    })(window);
  </script>

  <script>
    (function(){
      const KEY = 'lixby_cart_v1';
      const nf = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'});
      function parseValue(v){
        if (typeof v === 'number') return v;
        if (!v) return 0;
        try {
          if (typeof v === 'string' && v.includes(',')) {
            const cleaned = v.replace(/\s/g,'').replace('€','').replace(/\./g,'').replace(',', '.').trim();
            return parseFloat(cleaned) || 0;
          }
          return parseFloat(String(v).replace(/[^\d.-]/g,'')) || 0;
        } catch(e){ return 0; }
      }

      const cart = (()=>{ try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch(e){ return []; } })();
      const productList = document.getElementById('productList');
      const summaryItems = document.getElementById('summaryItems');
      const subTotalEl = document.getElementById('subTotal');
      const grandTotalEl = document.getElementById('grandTotal');

      function fmt(n){ return nf.format(n); }

      // render cart
      if (!cart || cart.length === 0) {
        productList.innerHTML = '<div class="muted">Tu bolsa está vacía. <a href="index.html">Volver a la tienda</a></div>';
        document.getElementById('payBtn').disabled = true;
      } else {
        let subtotal = 0;
        cart.forEach(it => {
          const price = (it.priceNum !== undefined && it.priceNum !== null) ? Number(it.priceNum) : parseValue(it.price);
          const qty = Number(it.qty || 1);
          const addon = it.appleCare ? 169.00 : 0;
          const line = (price + addon) * qty;
          subtotal += line;
          const img = it.image ? it.image : 'https://via.placeholder.com/400';
          const el = document.createElement('div');
          el.className = 'product-row';
          el.innerHTML = `
            <div style="display:flex;gap:12px;align-items:center">
              <div class="thumb"><img src="${img}" alt="${(it.name||'Producto')}" width="96" height="96"></div>
              <div>
                <div style="font-weight:700">${(it.name||'Producto')}</div>
                <div class="muted" style="margin-top:4px">${(it.description||'')}</div>
                <div class="muted" style="margin-top:6px">Cantidad: ${qty}${it.appleCare ? ' · AppleCare añadido' : ''}</div>
              </div>
            </div>
            <div style="margin-left:auto;font-weight:700">${fmt(line)}</div>
          `;
          productList.appendChild(el);

          const srow = document.createElement('div');
          srow.style.display = 'flex';
          srow.style.justifyContent = 'space-between';
          srow.style.marginBottom = '8px';
          srow.innerHTML = `<div>${(it.name||'Producto')} x${qty}</div><div>${fmt(line)}</div>`;
          summaryItems.appendChild(srow);
        });

        subTotalEl.textContent = fmt(subtotal);
        grandTotalEl.textContent = fmt(subtotal);
      }

      // gift toggle
      document.getElementById('isGift').addEventListener('change', (e)=>{
        document.getElementById('giftMessageWrap').style.display = e.target.checked ? 'block' : 'none';
      });

      // Handler del botón Realizar pago
      document.getElementById('payBtn').addEventListener('click', async () => {
        const payBtn = document.getElementById('payBtn');
        payBtn.disabled = true;
        document.getElementById('status').textContent = 'Preparando pedido...';

        // recolecta datos
        const payloadOrder = {
          items: cart,
          isGift: !!document.getElementById('isGift').checked,
          giftMessage: document.getElementById('giftMessage').value || '',
          shipping: {
            fullname: document.getElementById('fullname').value,
            email: document.getElementById('email').value,
            addr: document.getElementById('addr').value,
            city: document.getElementById('city').value,
            zip: document.getElementById('zip').value,
            country: document.getElementById('country').value
          }
        };

        // validaciones básicas
        if (!payloadOrder.shipping.fullname || !payloadOrder.shipping.email || !payloadOrder.shipping.addr) {
          document.getElementById('status').textContent = 'Rellena nombre, email y dirección antes de pagar.';
          payBtn.disabled = false;
          return;
        }

        try {
          // guardamos pedido temporalmente en localStorage por si lo necesitas en success/backoffice
          localStorage.setItem('lixby_order', JSON.stringify(payloadOrder));
        } catch(e){ console.warn('No se pudo guardar pedido en localStorage', e); }

        // intentamos mapear carrito a Payment Link
        let url = null;
        try { url = window.getPaymentLinkForCart ? window.getPaymentLinkForCart(cart) : null; } catch(e){ url = null; }

        // si no hay url para todo el carrito, intentar el primero
        if (!url) {
          url = (window.getPaymentLinkForItem && cart[0] ? window.getPaymentLinkForItem(cart[0]) : null);
        }

        if (url) {
          const email = payloadOrder.shipping.email ? `?prefilled_email=${encodeURIComponent(payloadOrder.shipping.email)}` : '';
          window.location.href = url + email;
          return;
        }

        // si llegamos aquí, no hay link
        document.getElementById('status').textContent = 'No se encontró un enlace automático para este pedido. Contacta con soporte.';
        payBtn.disabled = false;
      });

    })();
  </script>
</body>
</html>
