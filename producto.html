<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIXBY ‚Äî Detalle de producto</title>

  <!-- Evitar FOUC: aplicar tema antes de que cargue CSS -->
  <script>
    (function () {
      try {
        const THEME_KEY = 'lixby_theme';
        const saved = localStorage.getItem(THEME_KEY); // 'light' | 'dark' | null
        const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        // if user saved a preference, respect it
        if (saved === 'light') {
          document.documentElement.classList.add('light');
          document.documentElement.dataset.themeManual = 'true';
        } else if (saved === 'dark') {
          document.documentElement.classList.remove('light');
          document.documentElement.dataset.themeManual = 'true';
        } else {
          // no saved pref -> follow system
          if (mq && mq.matches === false) {
            document.documentElement.classList.add('light');
          } else {
            document.documentElement.classList.remove('light');
          }
        }
      } catch (e) {
        // silent
      }
    })();
  </script>

  <!-- PERF -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin>

  <meta name="description" content="Ficha del producto Lixby ‚Äî detalles, precio y especificaciones. A√±ade al carrito y guarda en favoritos." />
  <meta name="theme-color" content="#07101a" />

  <link rel="stylesheet" href="style.css" />
  <style>
    /* Additions for product options UI */
    .options { display:flex; flex-direction:column; gap:18px; margin-top:18px; }
    .option-title { font-weight:700; margin-bottom:8px; }
    .colors { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .color-dot {
      width:34px; height:34px; border-radius:50%; border:2px solid transparent;
      display:inline-block; cursor:pointer; box-sizing:border-box; position:relative;
      outline:none; transition: transform .12s ease, box-shadow .12s ease;
    }
    .color-dot:focus { box-shadow: 0 0 0 4px rgba(0,0,0,0.06) inset; }
    .color-dot.active { box-shadow: 0 0 0 4px rgba(0,0,0,0.06) inset; border-color: var(--accent); transform: scale(1.04); }
    .color-dot[data-color="blue"] { background:#2f6bff; }
    .color-dot[data-color="green"] { background:#9fe0d4; }
    .color-dot[data-color="pink"] { background:#f1b6d9; }
    .color-dot[data-color="white"] { background:#f7f7f7; border:1px solid rgba(0,0,0,0.08); }
    .color-dot[data-color="black"] { background:#3d3f42; }

    .capacities { display:flex; gap:12px; flex-wrap:wrap; }
    .cap-card {
      border:1px solid rgba(255,255,255,0.06); background:transparent; min-width:160px; padding:14px; border-radius:10px;
      cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:12px; transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
    }
    .cap-card.active { border-color: var(--accent); box-shadow: 0 8px 22px rgba(2,6,12,0.08); transform: translateY(-4px); }
    .cap-left { font-weight:700; }
    .cap-right { text-align:right; color:var(--muted); font-size:0.95rem; }

    .payments, .care { display:flex; gap:12px; flex-wrap:wrap; }
    .pay-card, .care-card { border:1px solid rgba(255,255,255,0.06); padding:12px; border-radius:10px; min-width:200px; cursor:pointer; background:transparent; transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
    .pay-card.active, .care-card.active { border-color:var(--accent); box-shadow:0 8px 20px rgba(2,6,12,0.06); transform: translateY(-4px); }

    .summary { margin-top:18px; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); display:flex; justify-content:space-between; align-items:center; gap:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); }
    .summary .big { font-weight:800; font-size:1.2rem; }
    .muted { color:var(--muted); font-size:0.95rem; }

    /* small helpers */
    .visually-hidden { position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* modal styles for payment months chooser */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal-backdrop.open { display:flex; }
    .modal { background:var(--surface, #0b1220); border-radius:12px; padding:18px; width:320px; max-width:92%; box-shadow:0 20px 50px rgba(2,6,12,0.6); color:var(--text); }
    .modal h3 { margin:0 0 12px 0; font-size:1.05rem; }
    .months { display:flex; gap:8px; flex-wrap:wrap; }
    .month-btn { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); cursor:pointer; min-width:70px; text-align:center; }
    .month-btn.active { border-color:var(--accent); box-shadow:0 8px 22px rgba(2,6,12,0.08); transform:translateY(-3px); }

    @media (max-width:700px) {
      .cap-card { min-width:140px; }
      .pay-card, .care-card { min-width: 48%; }
    }

    /* product image wrapper */
    .image-wrap { width:420px; max-width:48%; display:block; border-radius:12px; overflow:hidden; background:linear-gradient(180deg,#111,#0b0b0b); display:flex; align-items:center; justify-content:center; }
    .product-image { width:100%; height:auto; display:block; object-fit:cover; }

    /* small adjustments to keep layout stable if image taller */
    @media (max-width:900px) {
      .image-wrap { max-width:100%; width:100%; margin-bottom:14px; }
      .product-detail { flex-direction:column; padding:16px; }
    }

    /* Minimal glass utility included (keeps the apple-like liquid glass look even if style.css missing) */
    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      backdrop-filter: blur(10px) saturate(120%);
      box-shadow: 0 6px 26px rgba(2,6,12,0.48);
      color: inherit;
    }

    /* small responsive container */
    main { padding: 20px; }
  </style>
</head>
<body>
  <header class="nav glass" role="banner">
    <div class="nav-inner">
      <div class="nav-left">
        <div class="brand" role="button" onclick="window.location.href='index.html'">LIXBY</div>
      </div>

      <nav id="navLinks" role="navigation" aria-label="Principal">
        <a href="index.html#inicio" data-i18n="nav.inicio">Inicio</a>
        <a href="index.html#productos" data-i18n="nav.productos">Productos</a>
        <a href="index.html#contacto" data-i18n="nav.contacto">Cont√°ctanos</a>
        <a href="index.html#conocenos" data-i18n="nav.conocenos">Con√≥cenos</a>
      </nav>

      <div class="nav-right">
        <div class="cart-wrapper" style="position:relative;">
          <button id="cartBtn" class="icon-btn" aria-label="Ver carrito" aria-controls="miniCart" aria-expanded="false">üõí <span id="cartCount" class="badge">0</span></button>
          <div id="miniCart" class="mini-cart glass" aria-hidden="true" role="region" aria-label="Mini carrito" style="flex-direction:column;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <strong data-i18n="cart.title">Carrito</strong>
              <button id="clearCart" class="text-btn" data-i18n="cart.clear">Vaciar</button>
            </div>
            <div id="miniCartItems" style="max-height:200px;overflow:auto;"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
              <div><strong data-i18n="cart.total">Total:</strong> <span id="miniCartTotal">0‚Ç¨</span></div>
              <div><button id="checkoutBtn" class="btn primary" data-i18n="cart.checkout">Pagar</button></div>
            </div>
          </div>
        </div>

        <div class="lang-wrapper" style="position:relative;">
          <button id="langBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false">üá™üá∏ <span id="langLabel">Espa√±ol</span> ‚ñæ</button>
          <div id="langMenu" class="lang-menu glass" aria-hidden="true" style="flex-direction:column;gap:6px;padding:8px;width:160px;">
            <button class="lang-item" data-lang="es">üá™üá∏ Espa√±ol</button>
            <button class="lang-item" data-lang="en">üá¨üáß English</button>
            <button class="lang-item" data-lang="fr">üá´üá∑ Fran√ßais</button>
          </div>
        </div>

        <!-- Theme toggle: muestra icono y texto seg√∫n tema -->
        <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema" aria-pressed="false">‚óê</button>
      </div>
    </div>
  </header>

  <main>
    <!-- aria-live para notificar cambios importantes (ej. "A√±adido al carrito") -->
    <div id="productDetail" class="product-detail glass" aria-live="polite" style="display:flex;gap:24px;max-width:1100px;margin:24px auto;padding:24px;">
      <div style="flex:1;padding:24px;">Cargando producto‚Ä¶</div>
    </div>

    <div class="product-list" id="quickLinks" style="display:none;margin-top:22px;">
      <!-- quickLinks tienen tabindex para accesibilidad teclado -->
      <a tabindex="0" href="producto.html?id=lixby-one">Ver Lixby One</a>
      <a tabindex="0" href="producto.html?id=lixby-one-plus">Ver Lixby One Plus</a>
      <a tabindex="0" href="producto.html?id=lixby-one-pro">Ver Lixby One Pro</a>
    </div>
  </main>

  <div id="debug" class="debug" role="status" aria-live="polite" style="white-space:pre-wrap;display:none;padding:8px;margin:8px;max-width:1100px;color:var(--muted);"></div>

  <footer class="footer glass" style="text-align:center;padding:24px;margin-top:40px;">
    <p>¬© <span id="year"></span> LIXBY ‚Äî Todos los derechos reservados</p>
  </footer>

  <noscript>
    <div style="max-width:1100px;margin:16px auto;padding:12px;background:#2a2a2a;color:#fff;border-radius:8px;">
      Esta p√°gina requiere JavaScript para mostrar la ficha completa del producto. Por favor habilita JavaScript en tu navegador.
    </div>
  </noscript>

  <script>
  (function(){
    // -------------------------
    // Helpers y estado (mejorados)
    // -------------------------
    const THEME_KEY = 'lixby_theme'; // 'light'|'dark' or null
    function showDebug(msg){ const el = document.getElementById('debug'); if (!el) return; el.style.display = 'block'; el.textContent += msg + "\n"; console.log("DEBUG:", msg); }
    function loadCart(){ try { return JSON.parse(localStorage.getItem('lixby_cart_v1'))||[]; } catch(e){ return []; } }
    function saveCart(c){ try { localStorage.setItem('lixby_cart_v1', JSON.stringify(c)); } catch(e){} }
    function formatPrice(n){
      const v = Math.round((Number(n)||0)*100)/100;
      // use comma for decimal to match es-ES visual style
      return v.toFixed(2).replace('.',',') + '‚Ç¨';
    }
    function formatDecimal(n){
      const v = Math.round((Number(n)||0)*100)/100;
      return v.toFixed(2);
    }
    function parsePriceToNumber(raw){
      // Accepts numbers, "249‚Ç¨", "1.234,56 ‚Ç¨", "1234.56"
      if (typeof raw === 'number') return raw;
      if (!raw) return 0;
      try {
        const s = String(raw).trim();
        // remove currency symbol and spaces
        let cleaned = s.replace(/\s/g,'').replace('‚Ç¨','').replace('EUR','');
        // If contains comma as decimal separator and dots as thousand separators -> convert
        if (cleaned.indexOf(',') !== -1 && cleaned.indexOf('.') !== -1) {
          cleaned = cleaned.replace(/\./g,'').replace(',', '.');
        } else {
          // remove any non-digit except dot or minus
          cleaned = cleaned.replace(/[^0-9\.\-]/g,'');
        }
        const v = parseFloat(cleaned);
        return Number.isFinite(v) ? v : 0;
      } catch(e){ return 0; }
    }

    // small theme helpers (toggle + persist + UI)
    function applyThemeClass(theme) {
      if (theme === 'light') document.documentElement.classList.add('light');
      else document.documentElement.classList.remove('light');
    }
    function updateThemeToggleUI(theme) {
      const btn = document.getElementById('themeToggle');
      if (!btn) return;
      if (theme === 'light') {
        btn.innerHTML = 'üåû Claro';
        btn.setAttribute('aria-pressed', 'true');
        btn.title = 'Cambiar a modo oscuro';
      } else {
        btn.innerHTML = 'üåô Oscuro';
        btn.setAttribute('aria-pressed', 'false');
        btn.title = 'Cambiar a modo claro';
      }
    }
    function setTheme(theme, save=true) {
      applyThemeClass(theme);
      updateThemeToggleUI(theme);
      if (save) {
        try { localStorage.setItem(THEME_KEY, theme); document.documentElement.dataset.themeManual = 'true'; } catch(e){}
      } else {
        try { if (!localStorage.getItem(THEME_KEY)) delete document.documentElement.dataset.themeManual; } catch(e){}
      }
    }

    // initialize theme state (after initial head script)
    try {
      const saved = localStorage.getItem(THEME_KEY);
      const mq = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
      if (saved === 'light' || saved === 'dark') {
        setTheme(saved, true);
      } else {
        const sys = (mq && mq.matches) ? 'dark' : 'light';
        setTheme(sys, false);
      }
      if (mq && mq.addEventListener) {
        mq.addEventListener('change', (e) => {
          try {
            const manual = document.documentElement.dataset.themeManual === 'true';
            if (manual) return; // respect manual choice
            const newTheme = e.matches ? 'dark' : 'light';
            setTheme(newTheme, false);
          } catch(e){}
        });
      }
      const toggleBtn = document.getElementById('themeToggle');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          const isLight = document.documentElement.classList.contains('light');
          const newTheme = isLight ? 'dark' : 'light';
          setTheme(newTheme, true);
        });
      }
    } catch(e){ console.warn('theme init err', e); }

    // set year
    try { const yearEl = document.getElementById('year'); if (yearEl) yearEl.textContent = new Date().getFullYear(); } catch(e){}

    // Productos con colores y capacidades (precios como n√∫mero)
    const products = {
      "lixby-one-air": {
        id: 'lixby-one-air', name: "Lixby One Air",
        mini: "Ligero y asequible",
        image: "https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg",
        colors: ['blue','green','pink','white','black'],
        storage: { '128':249, '256':299, '512':379 } // no 1TB
      },
      "lixby-one": {
        id: 'lixby-one', name: "Lixby One",
        mini: "Ultraligero, potente",
        image: "https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg",
        colors: ['blue','green','pink','white','black'],
        storage: { '128':349, '256':429, '512':549, '1024':699 }
      },
      "lixby-one-plus": {
        id: 'lixby-one-plus', name: "Lixby One Plus",
        mini: "C√°mara profesional",
        image: "https://media.ldlc.com/r1600/ld/products/00/06/16/66/LD0006166643_0006166668_0006166693.jpg",
        colors: ['blue','green','pink','white','black'],
        storage: { '128':659, '256':749, '512':899, '1024':1099 }
      },
      "lixby-one-pro": {
        id: 'lixby-one-pro', name: "Lixby One Pro",
        mini: "Audio & rendimiento",
        image: "https://m.media-amazon.com/images/I/61rriyfRKwL.jpg",
        colors: ['blue','white','black'], // pro only white/black/blue
        storage: { '256':899, '512':1099, '1024':1299 } // no 128
      }
    };

    // payment terms allowed (we'll offer months in modal)
    const TERMS = [6, 12, 18, 24];

    // care monthly base rates
    const CARE_BASE = {
      none: 0,
      standard: 2.99,
      theft: 4.99
    };

    // proxiedUrl helper
    function proxiedUrl(originalUrl){ try { const stripped = originalUrl.replace(/^https?:\/\//,''); return `https://images.weserv.nl/?url=${encodeURIComponent(stripped)}&w=900&q=80`; } catch(e){ return originalUrl; } }

    // -------------------------
    // Mini-cart UI (igual)
    // -------------------------
    let cart = loadCart();
    const cartBtn = document.getElementById('cartBtn');
    const miniCart = document.getElementById('miniCart');
    const miniCartItems = document.getElementById('miniCartItems');
    const miniCartTotal = document.getElementById('miniCartTotal');
    const cartCount = document.getElementById('cartCount');
    const clearCartBtn = document.getElementById('clearCart');
    const checkoutBtn = document.getElementById('checkoutBtn');

    function updateMiniCartUI(){
      const totalQty = cart.reduce((s,i)=>s+(i.qty||0),0);
      if (cartCount) cartCount.textContent = totalQty;
      if (!miniCartItems) return;
      miniCartItems.innerHTML = '';
      if (cart.length === 0) {
        miniCartItems.innerHTML = '<div style="padding:8px;color:var(--muted)">Tu carrito est√° vac√≠o.</div>';
        if (miniCartTotal) miniCartTotal.textContent = '0‚Ç¨';
        return;
      }
      let total = 0;
      const frag = document.createDocumentFragment();
      cart.forEach((it, idx) => {
        const item = document.createElement('div');
        item.className = 'mini-cart-item';
        item.style.display = 'flex'; item.style.gap='10px'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderRadius='8px';
        const img = document.createElement('img'); img.src = it.image || 'https://via.placeholder.com/80x80?text=Img'; img.alt = it.name; img.style.width='44px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
        img.loading='lazy'; img.decoding='async';
        const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<div style="font-weight:700">${it.name}</div><div style="color:var(--muted)">${it.price} x${it.qty||1}</div>`;
        const remove = document.createElement('button'); remove.className='remove'; remove.textContent='‚úï'; remove.style.background='transparent'; remove.style.border='none'; remove.style.cursor='pointer';
        remove.addEventListener('click', (ev) => { ev.stopPropagation(); cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); });
        item.appendChild(img); item.appendChild(meta); item.appendChild(remove);
        frag.appendChild(item);
        total += (it.priceNum || parsePriceToNumber(it.price)) * (it.qty||1);
      });
      miniCartItems.appendChild(frag);
      if (miniCartTotal) miniCartTotal.textContent = formatPrice(total);
    }

    if (cartBtn && miniCart) {
      cartBtn.addEventListener('click', (e) => {
        const shown = miniCart.getAttribute('aria-hidden') === 'false';
        miniCart.setAttribute('aria-hidden', String(!shown));
        try { cartBtn.setAttribute('aria-expanded', String(!shown)); } catch(e){}
      });
      document.addEventListener('click', (e) => {
        try {
          if (!cartBtn.contains(e.target) && !miniCart.contains(e.target)) {
            miniCart.setAttribute('aria-hidden','true');
            cartBtn.setAttribute('aria-expanded','false');
          }
        } catch(e){}
      });
    }
    if (clearCartBtn) clearCartBtn.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); });
    if (checkoutBtn) checkoutBtn.addEventListener('click', () => { if (cart.length===0) return alert('El carrito est√° vac√≠o'); alert('Simulaci√≥n de checkout: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });

    window.addToCart = function(product){
      const existing = cart.find(p => p.id === product.id && p.color === product.color && p.storage === product.storage && p.term === product.term && p.care === product.care);
      if (existing) existing.qty = (existing.qty||1) + 1;
      else cart.push({
        id: product.id,
        name: product.name,
        price: product.price,
        priceNum: product.priceNum || parsePriceToNumber(product.price) || 0,
        qty:1,
        image: product.image,
        color: product.color,
        storage: product.storage,
        term: product.term,
        care: product.care
      });
      saveCart(cart);
      updateMiniCartUI();
      if (miniCart) { miniCart.setAttribute('aria-hidden','false'); setTimeout(()=>miniCart.setAttribute('aria-hidden','true'), 2200); }
      const pd = document.getElementById('productDetail');
      try { if (pd) pd.setAttribute('aria-live','polite'); } catch(e){}
    };

    updateMiniCartUI();

    // I18N (igual)
    const langBtn = document.getElementById('langBtn'), langMenu = document.getElementById('langMenu'), langLabel = document.getElementById('langLabel');
    const translations = {
      es: { "nav.inicio":"Inicio","nav.productos":"Productos","nav.contacto":"Cont√°ctanos","nav.conocenos":"Con√≥cenos","cart.title":"Carrito","cart.clear":"Vaciar","cart.total":"Total:","cart.checkout":"Pagar","btn.add":"A√±adir al carrito","btn.added":"A√±adido" },
      en: { "nav.inicio":"Home","nav.productos":"Products","nav.contacto":"Contact","nav.conocenos":"About","cart.title":"Cart","cart.clear":"Clear","cart.total":"Total:","cart.checkout":"Checkout","btn.add":"Add to cart","btn.added":"Added" },
      fr: { "nav.inicio":"Accueil","nav.productos":"Produits","nav.contacto":"Contact","nav.conocenos":"√Ä propos","cart.title":"Panier","cart.clear":"Vider","cart.total":"Total:","cart.checkout":"Payer","btn.add":"Ajouter au panier","btn.added":"Ajout√©" }
    };
    let currentLang = localStorage.getItem('lixby_lang') || 'es';
    function applyTranslations(lang){
      const map = translations[lang] || translations['es'];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (key && map[key]) el.textContent = map[key];
      });
      document.querySelectorAll('.btn-add').forEach(btn => btn.textContent = map['btn.add'] || btn.textContent);
      const names = { es:'Espa√±ol', en:'English', fr:'Fran√ßais' };
      if (langLabel) langLabel.textContent = names[lang] || names['es'];
    }
    function setLang(l){ if (!translations[l]) l='es'; currentLang=l; try{ localStorage.setItem('lixby_lang', l); }catch(e){} applyTranslations(l); }
    setLang(localStorage.getItem('lixby_lang') || currentLang);
    if (langBtn && langMenu){
      langBtn.addEventListener('click', ()=> { const isOpen = langMenu.getAttribute('aria-hidden') === 'false'; langMenu.setAttribute('aria-hidden', String(!isOpen)); langBtn.setAttribute('aria-expanded', String(!isOpen)); });
      langMenu.querySelectorAll('.lang-item').forEach(btn => btn.addEventListener('click', ()=>{ const lang = btn.getAttribute('data-lang'); setLang(lang); langMenu.setAttribute('aria-hidden','true'); langBtn.setAttribute('aria-expanded','false'); }));
      document.addEventListener('click', (e)=> { try { if (!langBtn.contains(e.target) && !langMenu.contains(e.target)) { langMenu.setAttribute('aria-hidden','true'); langBtn.setAttribute('aria-expanded','false'); }} catch(e){}});
    }

    // -------------------------
    // Render product on this page (logic) with options UI
    // -------------------------
    try {
      function getProductIdFromUrl() {
        try {
          const params = new URLSearchParams(window.location.search);
          const qid = params.get('id');
          if (qid) return decodeURIComponent(qid);
        } catch(e){}
        try {
          const h = window.location.hash || '';
          if (h) {
            if (h.indexOf('id=') !== -1) {
              const m = h.match(/id=([^&]+)/);
              if (m && m[1]) return decodeURIComponent(m[1]);
            }
            const clean = h.replace(/^#\/?/, '');
            const parts = clean.split('/');
            if (parts.length) {
              const last = parts[parts.length-1];
              if (last) return decodeURIComponent(last);
            }
          }
        } catch(e){}
        try {
          const path = window.location.pathname || '';
          const segs = path.split('/').filter(Boolean);
          if (segs.length) {
            const last = segs[segs.length-1];
            if (last && !last.match(/\.html$/i) && last !== 'producto' && last !== 'producto.html') {
              return decodeURIComponent(last);
            }
            if (segs.length >= 2) {
              const maybe = segs[segs.length-1];
              if (maybe && !maybe.match(/\.html$/i)) return decodeURIComponent(maybe);
            }
          }
        } catch(e){}
        try {
          const ref = document.referrer || '';
          if (ref) {
            const uq = ref.split('?')[1];
            if (uq) {
              const sp = new URLSearchParams(uq);
              const rid = sp.get('id');
              if (rid) return decodeURIComponent(rid);
            }
          }
        } catch(e){}
        return null;
      }

      function findProductByIdFlexible(k) {
        if (!k) return null;
        if (products[k]) return k;
        const key = String(k).toLowerCase().replace(/\s+/g,'-').replace(/_/g,'-');
        for (const pk in products) if (pk.toLowerCase() === key) return pk;
        for (const pk in products) if (pk.toLowerCase().indexOf(key) !== -1 || key.indexOf(pk.toLowerCase()) !== -1) return pk;
        return null;
      }

      const idRaw = getProductIdFromUrl();
      const container = document.getElementById('productDetail');
      const quickLinks = document.getElementById('quickLinks');

      if (!idRaw) {
        if (container) container.innerHTML = '<div style="padding:20px;"><h2>Producto no especificado</h2><p>Parece que no se recibi√≥ un identificador de producto. Usa uno de estos enlaces o vuelve a la tienda.</p></div>';
        if (quickLinks) quickLinks.style.display = 'flex';
        showDebug('No se detect√≥ id en la URL (ni query, ni hash, ni path).');
        return;
      }

      const id = String(idRaw).trim();
      const matchedId = findProductByIdFlexible(id);
      if (!matchedId) {
        container.innerHTML = '<div style="padding:20px;"><h2>Producto no encontrado</h2><p>El identificador recibido fue: <code>' + id + '</code>. Vuelve a la <a href="index.html">tienda</a>.</p></div>';
        showDebug('ID no coincide con productos: ' + id);
        return;
      }

      const p = products[matchedId];
      try { window.currentProductId = matchedId; } catch(e){}

      // build layout
      const wrap = document.createElement('div'); wrap.className = 'image-wrap';
      const placeholder = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="900" height="900"><rect width="100%" height="100%" fill="#111"/><text x="50%" y="50%" font-size="18" fill="#999" text-anchor="middle" dominant-baseline="middle">Imagen</text></svg>`);
      const img = document.createElement('img'); img.className = 'product-image'; img.alt = p.name; img.src = placeholder; img.loading='lazy'; img.decoding='async';
      try {
        const orig = p.image;
        try {
          // use proxied URL but keep original as fallback
          img.dataset.src = proxiedUrl(orig);
          // On product detail we want the main image to attempt loading immediately
          img.loading = 'eager';
          img.decoding = 'async';

          if ('IntersectionObserver' in window) {
            const io = new IntersectionObserver((entries, obs) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  const el = entry.target;
                  if (el.dataset && el.dataset.src) el.src = el.dataset.src;
                  try { obs.unobserve(el); } catch(e){}
                }
              });
            }, { rootMargin: '200px 0px' });
            io.observe(img);

            // Safety: if IO doesn't fire for some reason, force a load shortly after
            setTimeout(() => {
              try {
                if (img && (img.src === placeholder || !img.src) && img.dataset && img.dataset.src) {
                  img.src = img.dataset.src;
                }
              } catch(e){}
            }, 300);
          } else {
            // no IO -> load immediately
            img.src = img.dataset.src || orig;
          }
        } catch(e){
          try { img.src = orig || placeholder; } catch(e2){ img.src = placeholder; }
        }
      } catch(e){}
      // Improved error handler: if proxy fails, try original image once; otherwise keep placeholder
      img.addEventListener('error', function () {
        try {
          const current = this.src || '';
          if (current.indexOf('images.weserv.nl') !== -1 && orig && current !== orig) {
            // proxy failed ‚Äî try original image directly
            this.src = orig;
            return;
          }
        } catch(e){}
        // last resort
        try { this.src = placeholder; } catch(e){}
      });

      wrap.appendChild(img);

      const info = document.createElement('div'); info.className = 'product-info';
      const title = document.createElement('h1'); title.textContent = p.name;
      const desc = document.createElement('p'); desc.textContent = p.mini || '';
      const priceEl = document.createElement('div'); priceEl.className = 'price'; priceEl.textContent = ''; // will show selected storage price

      // favorite and add buttons
      const favBtn = document.createElement('button'); favBtn.id='favBtn'; favBtn.className='btn-fav'; favBtn.innerHTML='‚ô° Favorito'; favBtn.title='Guardar en favoritos'; favBtn.setAttribute('aria-pressed','false');
      favBtn.addEventListener('click', ()=> window.dispatchEvent(new CustomEvent('toggleFavorite', { detail: { id: p.id||matchedId, name: p.name, price: '', image: p.image } })));

      const addBtn = document.createElement('button'); addBtn.className='btn-add'; addBtn.textContent = (translations[currentLang] && translations[currentLang]['btn.add']) || 'A√±adir al carrito';

      // options UI container
      const options = document.createElement('div'); options.className = 'options';

      // ------ COLORS ------
      const colorWrap = document.createElement('div');
      const colTitle = document.createElement('div'); colTitle.className = 'option-title'; colTitle.textContent = 'Color. Elige tu favorito.';
      colorWrap.appendChild(colTitle);
      const colorsRow = document.createElement('div'); colorsRow.className = 'colors';
      const colorHidden = document.createElement('input'); colorHidden.type='hidden'; colorHidden.id='selColor';
      // load persisted selection per product if any
      const savedColorKey = 'lixby_sel_color_' + matchedId;
      const savedColor = localStorage.getItem(savedColorKey);
      p.colors.forEach((c, idx) => {
        const dot = document.createElement('button');
        dot.type='button';
        dot.className='color-dot';
        dot.setAttribute('data-color', c);
        dot.setAttribute('aria-label', c);
        dot.tabIndex = 0;
        // default: saved or first
        if (savedColor ? (savedColor === c) : (idx === 0)) dot.classList.add('active');
        dot.addEventListener('click', function () {
          colorsRow.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active'));
          this.classList.add('active');
          colorHidden.value = this.dataset.color;
          try { localStorage.setItem(savedColorKey, this.dataset.color); } catch(e){}
          updateSummary();
        });
        colorsRow.appendChild(dot);
      });
      colorWrap.appendChild(colorsRow);
      colorWrap.appendChild(colorHidden);
      options.appendChild(colorWrap);

      // ------ CAPACIDADES ------
      const capWrap = document.createElement('div');
      const capTitle = document.createElement('div'); capTitle.className='option-title'; capTitle.textContent = 'Capacidad. ¬øCu√°nto espacio necesitas?';
      capWrap.appendChild(capTitle);
      const capRow = document.createElement('div'); capRow.className = 'capacities';
      const capHidden = document.createElement('input'); capHidden.type='hidden'; capHidden.id='selCap';
      // build capacities from p.storage keys sorted ascending numeric
      const keys = Object.keys(p.storage).map(k=>String(k)).sort((a,b)=> Number(a)-Number(b));
      // try to load saved
      const savedCapKey = 'lixby_sel_cap_' + matchedId;
      const savedCap = localStorage.getItem(savedCapKey);
      keys.forEach((sz, idx) => {
        const price = p.storage[sz];
        const card = document.createElement('div'); card.className = 'cap-card';
        card.setAttribute('data-cap', sz);
        if ( (savedCap && savedCap === sz) || (!savedCap && idx===0) ) card.classList.add('active');
        const left = document.createElement('div'); left.className='cap-left'; left.textContent = (sz==='1024' ? '1 TB' : sz + ' GB');
        const right = document.createElement('div'); right.className='cap-right'; right.innerHTML = `${formatPrice(price)}<div class="muted"></div>`;
        card.appendChild(left); card.appendChild(right);
        card.addEventListener('click', function(){
          capRow.querySelectorAll('.cap-card').forEach(c=>c.classList.remove('active'));
          this.classList.add('active');
          capHidden.value = this.dataset.cap;
          try { localStorage.setItem(savedCapKey, this.dataset.cap); } catch(e){}
          updateSummary();
        });
        capRow.appendChild(card);
      });
      capWrap.appendChild(capRow);
      capWrap.appendChild(capHidden);
      options.appendChild(capWrap);

      // ------ PAGOS: ahora solo "Pago √∫nico" y "A plazo" ------
      const payWrap = document.createElement('div');
      const payTitle = document.createElement('div'); payTitle.className='option-title'; payTitle.textContent = 'Opciones de pago. Elige lo que m√°s te convenga.';
      payWrap.appendChild(payTitle);
      const payRow = document.createElement('div'); payRow.className='payments';
      const payHidden = document.createElement('input'); payHidden.type='hidden'; payHidden.id='selTerm';
      // Payment choices: 'single' or 'plazo'
      const paySingle = document.createElement('div'); paySingle.className='pay-card'; paySingle.setAttribute('data-pay','single'); paySingle.innerHTML = `<div style="font-weight:700">Pago √∫nico</div><div class="muted">Paga todo ahora</div>`;
      const payPlazo = document.createElement('div'); payPlazo.className='pay-card'; payPlazo.setAttribute('data-pay','plazo'); payPlazo.innerHTML = `<div style="font-weight:700">A plazo</div><div class="muted">Elegir meses</div>`;
      // default: Pago √∫nico
      paySingle.classList.add('active');
      payHidden.value = '1'; // term 1 = pago √∫nico
      // function to open modal
      function createMonthsModal(){
        if (document.getElementById('monthsModal')) return;
        const bd = document.createElement('div');
        bd.id = 'monthsModal';
        bd.className = 'modal-backdrop';
        bd.innerHTML = `<div class="modal" role="dialog" aria-modal="true" aria-labelledby="monthsTitle">
            <h3 id="monthsTitle">Elige la duraci√≥n del pago a plazo</h3>
            <div class="months">
              ${TERMS.map(m => `<button type="button" class="month-btn" data-month="${m}">${m} meses</button>`).join('')}
            </div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px;">
              <button id="monthsCancel" class="text-btn">Cancelar</button>
            </div>
          </div>`;
        document.body.appendChild(bd);
        // attach listeners
        bd.addEventListener('click', (ev) => {
          if (ev.target === bd) closeMonthsModal();
        });
        const cancel = bd.querySelector('#monthsCancel');
        if (cancel) cancel.addEventListener('click', closeMonthsModal);
        bd.querySelectorAll('.month-btn').forEach(btn => {
          btn.addEventListener('click', function(){
            const months = Number(this.dataset.month) || TERMS[0];
            // set hidden value and mark payRow UI
            payRow.querySelectorAll('.pay-card').forEach(c=>c.classList.remove('active'));
            payPlazo.classList.add('active');
            payHidden.value = String(months);
            updateSummary();
            closeMonthsModal();
          });
        });
      }
      function openMonthsModal(){
        createMonthsModal();
        const bd = document.getElementById('monthsModal');
        if (bd) bd.classList.add('open');
      }
      function closeMonthsModal(){
        const bd = document.getElementById('monthsModal');
        if (bd) bd.classList.remove('open');
      }

      paySingle.addEventListener('click', function(){
        payRow.querySelectorAll('.pay-card').forEach(c=>c.classList.remove('active'));
        this.classList.add('active');
        payHidden.value = '1';
        updateSummary();
      });
      payPlazo.addEventListener('click', function(){
        // open modal to choose months
        // temporarily mark as active visually
        payRow.querySelectorAll('.pay-card').forEach(c=>c.classList.remove('active'));
        this.classList.add('active');
        // open months chooser
        openMonthsModal();
      });

      payRow.appendChild(paySingle);
      payRow.appendChild(payPlazo);
      payWrap.appendChild(payRow);
      payWrap.appendChild(payHidden);
      options.appendChild(payWrap);

      // ------ LixbyCare ------
      const careWrap = document.createElement('div');
      const careTitle = document.createElement('div'); careTitle.className='option-title'; careTitle.textContent = 'LixbyCare+. Protege tu nuevo dispositivo.';
      careWrap.appendChild(careTitle);
      const careRow = document.createElement('div'); careRow.className='care';
      const careHidden = document.createElement('input'); careHidden.type='hidden'; careHidden.id='selCare';
      const savedCareKey = 'lixby_sel_care_' + matchedId;
      const savedCare = localStorage.getItem(savedCareKey) || 'none';
      const careOptions = [
        { id:'none', title:'Sin LixbyCare+', desc:'Sin protecci√≥n adicional', base: CARE_BASE.none },
        { id:'theft', title:'LixbyCare+ (robo y p√©rdida)', desc:'Cobertura robo y p√©rdida', base: CARE_BASE.theft },
        { id:'standard', title:'LixbyCare+', desc:'Cobertura est√°ndar', base: CARE_BASE.standard }
      ];
      careOptions.forEach((c,i) => {
        const cc = document.createElement('div'); cc.className='care-card'; cc.setAttribute('data-care', c.id);
        if (savedCare === c.id) cc.classList.add('active');
        cc.innerHTML = `<div style="font-weight:700">${c.title}</div><div class="muted">${c.desc}</div>`;
        cc.addEventListener('click', function(){
          careRow.querySelectorAll('.care-card').forEach(x=>x.classList.remove('active'));
          this.classList.add('active');
          careHidden.value = this.dataset.care;
          try { localStorage.setItem(savedCareKey, this.dataset.care); } catch(e){}
          updateSummary();
        });
        careRow.appendChild(cc);
      });
      careWrap.appendChild(careRow);
      careWrap.appendChild(careHidden);
      options.appendChild(careWrap);

      // summary
      const summary = document.createElement('div'); summary.className = 'summary';
      summary.innerHTML = `<div><div class="muted">Total</div><div class="big" id="totalPrice">--</div></div><div style="text-align:right"><div id="perMonth" class="muted">--</div><div id="careInfo" class="muted">--</div></div>`;
      options.appendChild(summary);

      // actions row (add to cart + fav)
      const actionsWrap = document.createElement('div'); actionsWrap.style.display='flex'; actionsWrap.style.gap='10px'; actionsWrap.style.marginTop='12px';
      const addBtnWrap = addBtn;
      addBtnWrap.addEventListener('click', function(){
        // prepare product object with selections
        const selectedColor = document.getElementById('selColor').value || p.colors[0];
        const selectedCap = document.getElementById('selCap').value || Object.keys(p.storage)[0];
        const selPrice = Number(p.storage[selectedCap] || 0);
        const selTerm = Number(document.getElementById('selTerm').value || 1);
        const selCare = document.getElementById('selCare').value || 'none';
        const displayStorage = (selectedCap === '1024' ? '1 TB' : selectedCap + ' GB');
        const productData = {
          id: p.id || matchedId,
          name: p.name + ' ‚Äî ' + displayStorage + ' / ' + selectedColor + (selTerm>1 ? ` (${selTerm} meses)` : ''),
          price: formatPrice(selPrice),
          priceNum: selPrice,
          image: p.image,
          color: selectedColor,
          storage: selectedCap,
          term: selTerm,
          care: selCare
        };
        // add to cart
        window.addToCart(productData);
        addBtnWrap.textContent = (translations[currentLang] && translations[currentLang]['btn.added']) || 'A√±adido';
        setTimeout(()=> addBtnWrap.textContent = (translations[currentLang] && translations[currentLang]['btn.add']) || 'A√±adir al carrito', 1200);
      });
      actionsWrap.appendChild(addBtn);
      actionsWrap.appendChild(favBtn);

      // assemble info column
      info.appendChild(title);
      if (desc && desc.textContent) info.appendChild(desc);
      info.appendChild(priceEl);
      info.appendChild(options);
      info.appendChild(actionsWrap);

      // place into container
      container.innerHTML = '';
      container.appendChild(wrap);
      container.appendChild(info);

      // initialize hidden inputs values from defaults/saved
      // color
      const currentColor = (localStorage.getItem(savedColorKey) || p.colors[0]);
      const colorButtons = container.querySelectorAll('.color-dot');
      colorButtons.forEach(b => {
        if (b.dataset.color === currentColor) {
          b.classList.add('active');
          document.getElementById('selColor').value = currentColor;
        } else b.classList.remove('active');
      });
      // cap
      const defaultCap = (localStorage.getItem(savedCapKey) || keys[0]);
      const capButtons = container.querySelectorAll('.cap-card');
      capButtons.forEach(b => {
        if (b.dataset.cap === defaultCap) { b.classList.add('active'); document.getElementById('selCap').value = b.dataset.cap; }
        else b.classList.remove('active');
      });
      // term: default already set to 1 (Pago √∫nico)
      // care
      const defaultCare = localStorage.getItem(savedCareKey) || 'none';
      const careButtons = container.querySelectorAll('.care-card');
      careButtons.forEach(b => {
        if (b.dataset.care === defaultCare) { b.classList.add('active'); document.getElementById('selCare').value = b.dataset.care; }
        else b.classList.remove('active');
      });

      // updatePrice UI function
      function updateSummary() {
        try {
          const selCap = document.getElementById('selCap').value || keys[0];
          const basePrice = Number(p.storage[selCap] || 0);
          const term = Number(document.getElementById('selTerm').value || 1);
          const careType = (document.getElementById('selCare').value || 'none');

          // update main price shown
          priceEl.textContent = formatPrice(basePrice);
          document.getElementById('totalPrice').textContent = formatPrice(basePrice);

          // monthly text
          if (term <= 1) {
            document.getElementById('perMonth').textContent = 'Pago √∫nico: ' + formatPrice(basePrice);
          } else {
            const monthly = Math.round((basePrice / term) * 100) / 100;
            document.getElementById('perMonth').textContent = formatPrice(monthly) + ' al mes durante ' + term + ' meses al 0% TAE';
          }

          // care text (monthly)
          const careOption = careOptions.find(c => c.id === careType) || careOptions[0];
          if (!careOption || careOption.base === 0) document.getElementById('careInfo').textContent = 'Sin LixbyCare+';
          else {
            const careMonthly = Math.round(careOption.base * 100) / 100;
            if (term <= 1) document.getElementById('careInfo').textContent = formatPrice(careMonthly) + ' / mes (pago √∫nico)';
            else document.getElementById('careInfo').textContent = formatPrice(careMonthly) + ' / mes durante ' + term + ' meses';
          }
        } catch(e){ showDebug('updateSummary err: ' + e.message); }
      }

      // initial update
      updateSummary();

      // notify other modules
      window.dispatchEvent(new CustomEvent('productRendered', { detail: { id: p.id||matchedId } }));
      showDebug('Producto renderizado: ' + matchedId);

      // expose updateSummary so external code (e.g. fav module observer) can call
      window.lixby_updateSummary = updateSummary;

      // add small event listeners for keyboard accessibility (Enter)
      container.querySelectorAll('.color-dot, .cap-card, .pay-card, .care-card').forEach(el=>{
        el.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); el.click(); }
        });
      });

    } catch(err) {
      showDebug('Error en script: ' + (err && err.message ? err.message : String(err)));
      const pd = document.getElementById('productDetail');
      if (pd) pd.innerHTML = '<div style="padding:20px;"><h2>Error cargando la ficha</h2><p>Mira la consola para m√°s detalles.</p></div>';
    }

    // Ajuste padding header (defensivo)
    try {
      const header = document.querySelector('.nav');
      if (header) {
        const updatePad = () => {
          const pad = Math.round(header.getBoundingClientRect().height + 12);
          document.body.style.paddingTop = pad + 'px';
        };
        updatePad();
        let t;
        window.addEventListener('resize', ()=> { clearTimeout(t); t = setTimeout(updatePad, 120); });
      }
    } catch(e){}
  })();
  </script>

  <!-- Firebase module for favorites (defensa: getApps/getApp) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMcDeBKSGqf9ZEexQAIM-9u6GLaQEnLcs",
      authDomain: "lixby-e0344.firebaseapp.com",
      projectId: "lixby-e0344",
      storageBucket: "lixby-e0344.firebasestorage.app",
      messagingSenderId: "671722866179",
      appId: "1:671722866179:web:65868eca5146942b507036",
      measurementId: "G-09SQL30MS8"
    };

    const app = (getApps() && getApps().length) ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentProductId = (window.currentProductId || null);

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      refreshFavButton();
    });

    function favDocRef(uid, pid){ return doc(db, 'users', uid, 'favorites', pid); }

    async function refreshFavButton(){
      const btn = document.getElementById('favBtn');
      if (!btn) return;
      if (!currentProductId && window.currentProductId) currentProductId = window.currentProductId;
      if (!currentProductId) { btn.innerHTML = '‚ô° Favorito'; btn.setAttribute('aria-pressed','false'); return; }
      if (!currentUser) { btn.innerHTML = '‚ô° Favorito'; btn.title='Inicia sesi√≥n para guardar favoritos'; btn.dataset.favorited='false'; btn.setAttribute('aria-pressed','false'); return; }
      try {
        const ref = favDocRef(currentUser.uid, currentProductId);
        const snap = await getDoc(ref);
        if (snap.exists()){ btn.innerHTML = '‚ô• Favorito'; btn.dataset.favorited='true'; btn.title='Eliminar de favoritos'; btn.setAttribute('aria-pressed','true'); }
        else { btn.innerHTML = '‚ô° Favorito'; btn.dataset.favorited='false'; btn.title='Guardar en favoritos'; btn.setAttribute('aria-pressed','false'); }
      } catch(err){ console.warn('refreshFavButton err', err); btn.innerHTML='‚ô° Favorito'; btn.dataset.favorited='false'; btn.setAttribute('aria-pressed','false'); }
    }

    window.addEventListener('productRendered', (ev) => {
      currentProductId = ev.detail && ev.detail.id ? ev.detail.id : null;
      try { window.currentProductId = currentProductId; } catch(e){}
      refreshFavButton();
    });

    window.addEventListener('toggleFavorite', async (ev) => {
      const detail = ev.detail;
      if (!detail || !detail.id) return;
      if (!currentUser){
        const go = confirm('Debes iniciar sesi√≥n para guardar favoritos. ¬øIr a la p√°gina de cuenta para iniciar sesi√≥n?');
        if (go) window.location.href = 'cuenta.html';
        return;
      }
      const pid = detail.id;
      const ref = favDocRef(currentUser.uid, pid);
      const btn = document.getElementById('favBtn');
      try {
        const snap = await getDoc(ref);
        if (snap.exists()){
          await deleteDoc(ref);
          if (btn) { btn.innerHTML = '‚ô° Favorito'; btn.dataset.favorited = 'false'; btn.setAttribute('aria-pressed','false'); }
          alert('Eliminado de favoritos');
        } else {
          await setDoc(ref, { id: detail.id, name: detail.name || '', price: detail.price || '', image: detail.image || '', createdAt: new Date().toISOString() });
          if (btn) { btn.innerHTML = '‚ô• Favorito'; btn.dataset.favorited = 'true'; btn.setAttribute('aria-pressed','true'); }
          alert('A√±adido a favoritos');
        }
      } catch(err){
        console.error('toggleFavorite err', err);
        alert('Error guardando favorito. Revisa la consola.');
      }
    });

    const observer = new MutationObserver(()=> refreshFavButton());
    observer.observe(document.getElementById('productDetail') || document.body, { childList:true, subtree:true });

  </script>

  <!-- tu script principal (defer) -->
  <script src="script.js" defer></script>

  <script>
    try { document.getElementById('year').textContent = new Date().getFullYear(); } catch(e){}
  </script>
</body>
</html>
