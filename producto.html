<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIXBY ‚Äî Detalle de producto</title>
  <meta name="description" content="Ficha del producto Lixby ‚Äî detalles, precio y especificaciones." />
  <link rel="stylesheet" href="style.css">
  <!-- Minimal helper CSS para opciones (redondeado, minimal) -->
  <style>
    /* Minimal product UI overrides (keeps look Apple-like) */
    .options { gap:18px; display:flex; flex-direction:column; }
    .option-title { font-weight:700; font-size:1.02rem; color:color-mix(in oklab, var(--text) 88%, var(--muted) 12%); margin-bottom:8px; }
    .colors { display:flex; gap:12px; align-items:center; }
    .color-dot {
      width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,0.06);
      display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .14s ease,box-shadow .14s ease;
      box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset; outline:none;
    }
    .color-dot::after{ content:""; width:22px;height:22px;border-radius:50%; background:transparent; transition:transform .12s ease; }
    .color-dot[data-color="blue"]{ background:#2f6bff }
    .color-dot[data-color="green"]{ background:#9fe0d4 }
    .color-dot[data-color="pink"]{ background:#f1b6d9 }
    .color-dot[data-color="white"]{ background:#f7f7f7; border:1px solid rgba(0,0,0,0.08) }
    .color-dot[data-color="black"]{ background:#3d3f42 }
    .color-dot.active{ transform:scale(1.03); box-shadow: 0 18px 36px rgba(10,132,255,0.08); border-color:var(--accent); }
    .color-dot:focus{ box-shadow: 0 0 0 6px rgba(10,132,255,0.12); }

    .capacities { display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; }
    .cap-card {
      min-width:150px;padding:14px 16px;border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(255,255,255,0.04); cursor:pointer; display:flex; justify-content:space-between; align-items:center;
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
      box-shadow: 0 6px 18px rgba(2,6,12,0.04);
    }
    .cap-card.active{ border-color:var(--accent); transform:translateY(-6px); box-shadow:0 20px 40px rgba(10,132,255,0.06) }
    .cap-card:focus{ outline:none; box-shadow: 0 0 0 6px rgba(10,132,255,0.08); }

    .summary { margin-top:12px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03); display:flex;justify-content:space-between;align-items:center; }
    .big { font-weight:800; font-size:1.16rem; }
    .muted { color:var(--muted); font-size:0.95rem; }

    /* Responsive minor tweaks */
    @media (max-width:700px) {
      .color-dot { width:34px;height:34px; }
      .cap-card { min-width:48%; padding:12px;border-radius:12px; }
    }

    /* Make mini-cart pointer interactions safe */
    .mini-cart[aria-hidden="true"] { display:none !important; pointer-events:none; }
    .mini-cart[aria-hidden="false"] { display:flex !important; pointer-events:auto; }
  </style>
</head>
<body>
  <header class="nav glass" role="banner">
    <div class="nav-inner">
      <div class="brand" role="button" onclick="location.href='index.html'">LIXBY</div>
      <nav id="navLinks" aria-label="Principal">
        <a href="index.html#inicio">Inicio</a>
        <a href="index.html#productos">Productos</a>
        <a href="index.html#contacto">Cont√°ctanos</a>
      </nav>
      <div class="nav-right">
        <div class="cart-wrapper" style="position:relative">
          <button id="cartBtn" class="icon-btn" aria-label="Ver carrito" aria-controls="miniCart" aria-expanded="false">üõí <span id="cartCount" class="badge">0</span></button>
          <div id="miniCart" class="mini-cart glass" aria-hidden="true" role="region" aria-label="Mini carrito" style="flex-direction:column;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <strong>Carrito</strong>
              <button id="miniClear" class="text-btn">Vaciar</button>
            </div>
            <div id="miniCartItems" style="max-height:220px;overflow:auto;"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
              <div><strong>Total:</strong> <span id="miniCartTotal">0‚Ç¨</span></div>
              <div><button id="checkoutBtn" class="btn primary">Pagar</button></div>
            </div>
          </div>
        </div>
        <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema">‚óê</button>
      </div>
    </div>
  </header>

  <main>
    <div id="productDetail" class="product-detail glass" aria-live="polite" style="display:flex;gap:22px;max-width:1100px;margin:28px auto;padding:20px;">
      <div style="flex:1;padding:18px;">Cargando producto‚Ä¶</div>
    </div>
  </main>

  <footer class="footer glass" style="text-align:center;padding:20px;margin-top:32px;">
    <p>¬© <span id="year"></span> LIXBY ‚Äî Todos los derechos reservados</p>
  </footer>

  <!-- core JS: render product + robust mini-cart + favorites (with defensive handling) -->
  <script>
  (function(){
    'use strict';

    // ---------- Utilities ----------
    const el = sel => document.querySelector(sel);
    const els = sel => Array.from(document.querySelectorAll(sel));
    const nf = v => (Math.round((Number(v)||0)*100)/100).toFixed(2).replace('.',',') + '‚Ç¨';
    const proxied = url => {
      try { return 'https://images.weserv.nl/?url=' + encodeURIComponent(url.replace(/^https?:\/\//,'')) + '&w=900&q=80'; }
      catch(e){ return url; }
    };

    // ---------- Product data (mock) ----------
    const products = {
      "lixby-one": { id:'lixby-one', name:'Lixby One', mini:'Ultraligero, potente', image:'https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg', colors:['blue','green','pink','white','black'], storage:{'128':349,'256':429,'512':549,'1024':699} },
      "lixby-one-pro": { id:'lixby-one-pro', name:'Lixby One Pro', mini:'Audio & rendimiento', image:'https://m.media-amazon.com/images/I/61rriyfRKwL.jpg', colors:['blue','white','black'], storage:{'256':899,'512':1099,'1024':1299} }
    };

    // ---------- CART localStorage keys ----------
    const CART_KEY = 'lixby_cart_v1';
    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch(e){ return []; } }
    function saveCart(c){ try { localStorage.setItem(CART_KEY, JSON.stringify(c)); } catch(e){} }

    // ---------- Mini-cart UI (robusto) ----------
    let cart = loadCart();
    const cartBtn = el('#cartBtn');
    const miniCart = el('#miniCart');
    const miniCartItems = el('#miniCartItems');
    const miniCartTotal = el('#miniCartTotal');
    const cartCount = el('#cartCount');
    const miniClear = el('#miniClear');
    const checkoutBtn = el('#checkoutBtn');

    function updateMiniCartUI(){
      try {
        const totalQty = cart.reduce((s,i)=>s+(i.qty||0),0);
        if (cartCount) cartCount.textContent = totalQty;
        if (!miniCartItems) return;
        miniCartItems.innerHTML = '';
        if (cart.length === 0) {
          miniCartItems.innerHTML = '<div style="padding:8px;color:var(--muted)">Tu carrito est√° vac√≠o.</div>';
          if (miniCartTotal) miniCartTotal.textContent = '0‚Ç¨';
          return;
        }
        let total = 0;
        const frag = document.createDocumentFragment();
        cart.forEach((it, idx) => {
          const item = document.createElement('div');
          item.className = 'mini-cart-item';
          item.style.display='flex'; item.style.gap='10px'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderRadius='8px';
          const img = document.createElement('img'); img.src = it.image || 'https://via.placeholder.com/80'; img.alt = it.name || ''; img.style.width='44px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px'; img.loading='lazy';
          const meta = document.createElement('div'); meta.className='meta'; meta.style.flex='1'; meta.innerHTML = `<div style="font-weight:700">${it.name}</div><div style="color:var(--muted)">${it.price} x${it.qty||1}</div>`;
          const remove = document.createElement('button'); remove.className='remove'; remove.textContent='‚úï'; remove.style.background='transparent'; remove.style.border='none'; remove.style.cursor='pointer';
          remove.addEventListener('click', (ev) => { ev.stopPropagation(); cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); });
          item.appendChild(img); item.appendChild(meta); item.appendChild(remove);
          frag.appendChild(item);
          total += (it.priceNum || Number((it.price||'0').replace(/[^\d.,-]/g,'')) ) * (it.qty||1);
        });
        miniCartItems.appendChild(frag);
        if (miniCartTotal) miniCartTotal.textContent = nf(total);
      } catch(e){ console.warn('updateMiniCartUI err', e); }
    }

    function openMiniCartTemporarily(){
      try {
        if (!miniCart || !cartBtn) return;
        miniCart.setAttribute('aria-hidden','false');
        cartBtn.setAttribute('aria-expanded','true');
        // auto close after 2.2s
        setTimeout(()=> {
          try { miniCart.setAttribute('aria-hidden','true'); cartBtn.setAttribute('aria-expanded','false'); } catch(e){}
        }, 2200);
      } catch(e){}
    }

    if (cartBtn && miniCart) {
      cartBtn.addEventListener('click', (ev) => {
        try {
          const shown = miniCart.getAttribute('aria-hidden') === 'false';
          miniCart.setAttribute('aria-hidden', String(shown));
          const expanded = shown ? 'false' : 'true';
          cartBtn.setAttribute('aria-expanded', expanded);
          // NOTE: toggle show/hide handled by aria-hidden attribute and CSS
        } catch(e){ console.warn('cartBtn click err', e); }
      });
      // close when clicking outside - safer using closest
      document.addEventListener('click', (e) => {
        try {
          const tg = e.target;
          if (!tg) return;
          if (!tg.closest) return;
          if (!cartBtn.contains(tg) && !miniCart.contains(tg)) {
            miniCart.setAttribute('aria-hidden','true');
            cartBtn.setAttribute('aria-expanded','false');
          }
        } catch(e){}
      });
    }

    if (miniClear) miniClear.addEventListener('click', ()=> { cart = []; saveCart(cart); updateMiniCartUI(); });
    if (checkoutBtn) checkoutBtn.addEventListener('click', ()=> { if (!cart.length) return alert('El carrito est√° vac√≠o'); alert('Simulaci√≥n de pago ‚Äî ' + cart.reduce((s,i)=> s+(i.qty||0),0) + ' items'); });

    // Expose addToCart global (defensivo)
    window.addToCart = function(product){
      try {
        if (!product) return;
        // normalize priceNum
        if (!product.priceNum) {
          const p = String(product.price||'0').replace(/[^\d\.,-]/g,'').replace(',', '.');
          product.priceNum = parseFloat(p) || 0;
        }
        product.qty = Number(product.qty || 1);
        const existing = cart.find(p => p.id === product.id && p.color === product.color && p.storage === product.storage && p.term === product.term && p.care === product.care);
        if (existing) existing.qty = (existing.qty||1) + 1;
        else cart.push(Object.assign({}, product));
        saveCart(cart);
        updateMiniCartUI();
        openMiniCartTemporarily();
        // aria-live notification
        try { const pd = document.getElementById('productDetail'); if (pd) pd.setAttribute('aria-live','polite'); } catch(e){}
      } catch(e){ console.error('addToCart err', e); }
    };

    updateMiniCartUI();

    // ---------- product renderer (robusto y accesible) ----------
    function getProductIdFromUrl(){
      try {
        const params = new URLSearchParams(window.location.search);
        const q = params.get('id'); if (q) return q;
        const path = location.pathname.split('/').filter(Boolean).pop();
        if (path && !path.endsWith('.html')) return path;
      } catch(e){}
      return 'lixby-one';
    }

    function renderProduct(){
      try {
        const id = getProductIdFromUrl();
        const p = products[id] || products['lixby-one'];
        const container = el('#productDetail');
        if (!container) return;
        container.innerHTML = ''; // clear

        // image
        const wrap = document.createElement('div'); wrap.className = 'image-wrap';
        const img = document.createElement('img'); img.className = 'product-image'; img.alt = p.name; img.src = proxied(p.image);
        img.loading='eager'; img.decoding='async';
        img.addEventListener('error', function(){ try { this.src = p.image; } catch(e){} });
        wrap.appendChild(img);

        // info
        const info = document.createElement('div'); info.className = 'product-info';
        const title = document.createElement('h1'); title.textContent = p.name;
        const mini = document.createElement('p'); mini.textContent = p.mini || '';
        const priceEl = document.createElement('div'); priceEl.className = 'price'; priceEl.textContent = nf(Object.values(p.storage)[0]);

        // fav + add
        const favBtn = document.createElement('button'); favBtn.id='favBtn'; favBtn.className='btn'; favBtn.innerHTML='‚ô° Favorito'; favBtn.title='Guardar favorito';
        favBtn.addEventListener('click', () => {
          // if not logged, redirect to cuenta.html (no popup here)
          try {
            // simple approach: go to cuenta
            if (!confirm('Para guardar favoritos debes iniciar sesi√≥n. ¬øIr a la p√°gina de cuenta?')) return;
            window.location.href = 'cuenta.html';
          } catch(e){ console.warn(e); }
        });

        const addBtn = document.createElement('button'); addBtn.className='btn btn-buy'; addBtn.textContent = 'A√±adir al carrito';

        // options container
        const options = document.createElement('div'); options.className = 'options';

        // COLORS
        const colWrap = document.createElement('div');
        const colTitle = document.createElement('div'); colTitle.className='option-title'; colTitle.textContent = 'Color';
        colWrap.appendChild(colTitle);
        const colorsRow = document.createElement('div'); colorsRow.className = 'colors';
        const hiddenColor = document.createElement('input'); hiddenColor.type='hidden'; hiddenColor.id='selColor';
        const savedColorKey = 'lixby_sel_color_' + p.id;
        const savedColor = localStorage.getItem(savedColorKey);
        (p.colors||[]).forEach((c, idx) => {
          const dot = document.createElement('button');
          dot.className='color-dot';
          dot.setAttribute('data-color', c);
          dot.setAttribute('aria-label', c);
          dot.tabIndex = 0;
          if (savedColor ? savedColor === c : idx===0) dot.classList.add('active');
          dot.addEventListener('click', function(){
            colorsRow.querySelectorAll('.color-dot').forEach(d=>{ d.classList.remove('active'); d.setAttribute('aria-checked','false'); });
            this.classList.add('active'); this.setAttribute('aria-checked','true');
            hiddenColor.value = this.dataset.color || '';
            try { localStorage.setItem(savedColorKey, this.dataset.color); } catch(e){}
            updateSummary();
          });
          dot.addEventListener('keydown', (ev) => { if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); dot.click(); }});
          colorsRow.appendChild(dot);
        });
        colWrap.appendChild(colorsRow);
        colWrap.appendChild(hiddenColor);
        options.appendChild(colWrap);

        // CAPACITIES
        const capWrap = document.createElement('div');
        const capTitle = document.createElement('div'); capTitle.className='option-title'; capTitle.textContent = 'Capacidad';
        capWrap.appendChild(capTitle);
        const capRow = document.createElement('div'); capRow.className='capacities';
        const hiddenCap = document.createElement('input'); hiddenCap.type='hidden'; hiddenCap.id='selCap';
        const savedCapKey = 'lixby_sel_cap_' + p.id;
        const savedCap = localStorage.getItem(savedCapKey);
        const keys = Object.keys(p.storage).sort((a,b)=>Number(a)-Number(b));
        keys.forEach((sz, i) => {
          const price = p.storage[sz];
          const card = document.createElement('div'); card.className='cap-card'; card.setAttribute('data-cap', sz); card.tabIndex=0;
          if (savedCap ? savedCap === sz : i===0) card.classList.add('active');
          const left = document.createElement('div'); left.className='cap-left'; left.textContent = (sz==='1024' ? '1 TB' : sz + ' GB');
          const right = document.createElement('div'); right.className='cap-right'; right.innerHTML = `${nf(price)}<div class="muted">&nbsp;</div>`;
          card.appendChild(left); card.appendChild(right);
          card.addEventListener('click', function(){
            capRow.querySelectorAll('.cap-card').forEach(c=>c.classList.remove('active'));
            this.classList.add('active');
            hiddenCap.value = this.dataset.cap || '';
            try { localStorage.setItem(savedCapKey, this.dataset.cap); } catch(e){}
            updateSummary();
          });
          card.addEventListener('keydown', (ev) => { if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); card.click(); } });
          capRow.appendChild(card);
        });
        capWrap.appendChild(capRow);
        capWrap.appendChild(hiddenCap);
        options.appendChild(capWrap);

        // CARE (simple)
        const careWrap = document.createElement('div');
        const careTitle = document.createElement('div'); careTitle.className='option-title'; careTitle.textContent = 'LixbyCare+ (opcional)';
        careWrap.appendChild(careTitle);
        const careRow = document.createElement('div'); careRow.className='care'; careRow.style.display='flex'; careRow.style.gap='10px';
        const careHidden = document.createElement('input'); careHidden.type='hidden'; careHidden.id='selCare';
        ['none','standard','theft'].forEach((c, i) => {
          const cc = document.createElement('div'); cc.className='care-card'; cc.tabIndex=0; cc.style.minWidth='150px';
          cc.setAttribute('data-care', c); cc.innerHTML = `<div style="font-weight:700">${c==='none' ? 'Sin' : (c==='standard' ? 'LixbyCare+' : 'LixbyCare+ (robo)')}</div><div class="muted">${c==='none' ? 'Sin protecci√≥n' : 'Protecci√≥n extra'}</div>`;
          if (i===0) cc.classList.add('active');
          cc.addEventListener('click', ()=> { careRow.querySelectorAll('.care-card').forEach(x=>x.classList.remove('active')); cc.classList.add('active'); careHidden.value = c; updateSummary(); });
          cc.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); cc.click(); }});
          careRow.appendChild(cc);
        });
        careWrap.appendChild(careRow); careWrap.appendChild(careHidden);
        options.appendChild(careWrap);

        // summary + actions
        const summary = document.createElement('div'); summary.className='summary';
        summary.innerHTML = `<div><div class="muted">Total</div><div class="big" id="totalPrice">--</div></div><div style="text-align:right"><div id="perMonth" class="muted">--</div><div id="careInfo" class="muted">--</div></div>`;
        options.appendChild(summary);

        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='10px'; actions.style.marginTop='12px';
        addBtn.addEventListener('click', () => {
          const selectedColor = hiddenColor.value || (p.colors[0]||'blue');
          const selectedCap = hiddenCap.value || keys[0];
          const priceNum = Number(p.storage[selectedCap] || 0);
          const selCare = careHidden.value || 'none';
          const displayStorage = selectedCap === '1024' ? '1 TB' : selectedCap + ' GB';
          const productData = {
            id: p.id,
            name: `${p.name} ‚Äî ${displayStorage} / ${selectedColor}`,
            price: nf(priceNum),
            priceNum: priceNum,
            qty: 1,
            image: p.image,
            color: selectedColor,
            storage: selectedCap,
            care: selCare
          };
          window.addToCart(productData);
          addBtn.textContent = 'A√±adido';
          setTimeout(()=> addBtn.textContent = 'A√±adir al carrito', 900);
        });

        actions.appendChild(addBtn); actions.appendChild(favBtn);

        // assemble
        info.appendChild(title); info.appendChild(mini); info.appendChild(priceEl); info.appendChild(options); info.appendChild(actions);
        container.appendChild(wrap); container.appendChild(info);

        // initial hidden values
        const persistedColor = localStorage.getItem(savedColorKey);
        if (persistedColor) hiddenColor.value = persistedColor;
        const persistedCap = localStorage.getItem(savedCapKey);
        if (persistedCap) hiddenCap.value = persistedCap;

        // update summary function
        function updateSummary(){
          try {
            const selCap = hiddenCap.value || keys[0];
            const base = Number(p.storage[selCap] || 0);
            document.getElementById('totalPrice').textContent = nf(base);
            document.getElementById('perMonth').textContent = 'Pago √∫nico: ' + nf(base);
            const care = careHidden.value || 'none';
            if (care === 'none') document.getElementById('careInfo').textContent = 'Sin LixbyCare+';
            else if (care === 'standard') document.getElementById('careInfo').textContent = '3,00‚Ç¨ / mes (estim.)';
            else document.getElementById('careInfo').textContent = '5,00‚Ç¨ / mes (estim.)';
          } catch(e){ console.warn('updateSummary err', e); }
        }
        updateSummary();

      } catch(e){ console.error('renderProduct err', e); }
    }

    // init
    renderProduct();
    document.getElementById('year').textContent = new Date().getFullYear();

    // Theme toggle (simple)
    try {
      const tbtn = document.getElementById('themeToggle');
      tbtn && tbtn.addEventListener('click', ()=> {
        document.documentElement.classList.toggle('light');
        const isLight = document.documentElement.classList.contains('light');
        try { localStorage.setItem('lixby_theme', isLight ? 'light' : 'dark'); } catch(e){}
      });
    } catch(e){}

  })();
  </script>

  <!-- Firebase favorites snippet (defensivo) -->
  <script type="module">
    // Si usas favoritos v√≠a Firebase, hazlo en un m√≥dulo separado. Aqu√≠ solo dejamos la plantilla.
    // Nota: Para minimizar popups problem√°ticos, REDIRIGE a /cuenta.html para login.
    import { getApps, initializeApp, getApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMcDeBKSGqf9ZEexQAIM-9u6GLaQEnLcs",
      authDomain: "lixby-e0344.firebaseapp.com",
      projectId: "lixby-e0344"
    };
    const app = (getApps().length ? getApp() : initializeApp(firebaseConfig));
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    onAuthStateChanged(auth, user => { currentUser = user; });

    // toggleFavorite: intenta guardar, pero si no hay user -> redirige a cuenta.html
    window.addEventListener('toggleFavorite', async (ev) => {
      const detail = ev.detail;
      if (!detail || !detail.id) return;
      if (!currentUser) {
        if (confirm('Debes iniciar sesi√≥n para guardar favoritos. ¬øIr a la p√°gina de cuenta?')) location.href='cuenta.html';
        return;
      }
      const ref = doc(db, 'users', currentUser.uid, 'favorites', detail.id);
      try {
        const snap = await getDoc(ref);
        if (snap.exists()) {
          await deleteDoc(ref);
          alert('Eliminado de favoritos');
        } else {
          await setDoc(ref, { id: detail.id, name: detail.name, image: detail.image || '', price: detail.price || '', createdAt: new Date().toISOString() });
          alert('A√±adido a favoritos');
        }
      } catch(err){ console.error('fav err', err); alert('Error guardando favorito. Revisa consola.'); }
    });
  </script>

</body>
</html>
