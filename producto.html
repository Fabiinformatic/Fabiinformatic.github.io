<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIXBY ‚Äî Detalle de producto</title>

  <!-- Aplicar tema temprano para evitar FOUC (si el usuario guard√≥ preferencia) -->
  <script>
    (function(){
      try {
        const saved = localStorage.getItem('lixby_theme'); // 'light'|'dark'
        if (saved === 'light') document.documentElement.classList.add('light');
        else if (saved === 'dark') document.documentElement.classList.remove('light');
        // si no hay preferencia, no tocar (estilos por defecto)
      } catch(e){}
    })();
  </script>

  <link rel="stylesheet" href="style.css">
  <meta name="description" content="Ficha del producto Lixby ‚Äî detalles, precio y especificaciones." />
  <style>
    /* Overrides / UI local para product page (compacto, minimal) */
    .options { gap:18px; display:flex; flex-direction:column; }
    .option-title { font-weight:700; font-size:1.02rem; color:color-mix(in oklab, var(--text) 88%, var(--muted) 12%); margin-bottom:8px; }
    .colors { display:flex; gap:12px; align-items:center; }
    .color-dot { width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,0.06); display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .14s ease,box-shadow .14s ease; outline:none; }
    .color-dot[data-color="blue"]{ background:#2f6bff }
    .color-dot[data-color="green"]{ background:#9fe0d4 }
    .color-dot[data-color="pink"]{ background:#f1b6d9 }
    .color-dot[data-color="white"]{ background:#f7f7f7; border:1px solid rgba(0,0,0,0.08) }
    .color-dot[data-color="black"]{ background:#3d3f42 }
    .color-dot.active{ transform:scale(1.03); box-shadow: 0 18px 36px rgba(10,132,255,0.08); border-color:var(--accent); }
    .color-dot:focus{ box-shadow: 0 0 0 6px rgba(10,132,255,0.12); }

    .capacities { display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; }
    .cap-card { min-width:150px;padding:14px 16px;border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.04); cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease; box-shadow: 0 6px 18px rgba(2,6,12,0.04); }
    .cap-card.active{ border-color:var(--accent); transform:translateY(-6px); box-shadow:0 20px 40px rgba(10,132,255,0.06) }
    .cap-card:focus{ outline:none; box-shadow: 0 0 0 6px rgba(10,132,255,0.08); }

    .summary { margin-top:12px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03); display:flex;justify-content:space-between;align-items:center; }
    .big { font-weight:800; font-size:1.28rem; color:var(--accent); }
    .muted { color:var(--muted); font-size:0.95rem; }

    .pay-options { display:flex; gap:10px; align-items:center; }
    .pay-card { padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); cursor:pointer; min-width:140px; text-align:center; }
    .pay-card.active { border-color:var(--accent); box-shadow:0 12px 30px rgba(10,132,255,0.06); transform:translateY(-4px); }

    .term-select-wrap { display:flex; gap:8px; align-items:center; margin-left:8px; }
    .term-select { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; }

    .care-grid { display:flex; gap:12px; flex-wrap:wrap; align-items:stretch; }
    .care-card { min-width:160px;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); cursor:pointer; display:flex; flex-direction:column; gap:8px; transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
    .care-card.active { border-color:var(--accent); transform:translateY(-6px); box-shadow:0 18px 36px rgba(10,132,255,0.06); }
    .care-card small { color:var(--muted); font-size:0.92rem; }

    /* panel de pago del seguro */
    .care-pay-panel { margin-top:12px; padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); display:flex; gap:12px; align-items:flex-start; }
    .care-pay-option { flex:1; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); cursor:pointer; background:transparent; }
    .care-pay-option.active { border-color:var(--accent); box-shadow:0 12px 30px rgba(10,132,255,0.06); transform:translateY(-4px); }

    /* responsive */
    @media (max-width:700px) {
      .color-dot { width:34px;height:34px; }
      .cap-card { min-width:48%; padding:12px;border-radius:12px; }
      .big { font-size:1.08rem; }
      .term-select-wrap { margin-left:0; margin-top:8px; flex-direction:column; align-items:flex-start; }
      .care-pay-panel { flex-direction:column; }
    }
  </style>
</head>
<body>
  <header class="nav glass" role="banner">
    <div class="nav-inner">
      <div class="brand" role="button" onclick="location.href='index.html'">LIXBY</div>
      <nav id="navLinks" aria-label="Principal">
        <a href="index.html#inicio">Inicio</a>
        <a href="index.html#productos">Productos</a>
        <a href="index.html#contacto">Cont√°ctanos</a>
      </nav>
      <div class="nav-right">
        <div class="cart-wrapper" style="position:relative">
          <button id="cartBtn" class="icon-btn" aria-label="Ver carrito" aria-controls="miniCart" aria-expanded="false">üõí <span id="cartCount" class="badge">0</span></button>
          <div id="miniCart" class="mini-cart glass" aria-hidden="true" role="region" aria-label="Mini carrito" style="flex-direction:column;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <strong>Carrito</strong>
              <button id="miniClear" class="text-btn">Vaciar</button>
            </div>
            <div id="miniCartItems" style="max-height:220px;overflow:auto;"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
              <div><strong>Total:</strong> <span id="miniCartTotal">0‚Ç¨</span></div>
              <div><button id="checkoutBtn" class="btn primary">Pagar</button></div>
            </div>
          </div>
        </div>
        <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema">‚óê</button>
      </div>
    </div>
  </header>

  <main>
    <div id="productDetail" class="product-detail glass" aria-live="polite" style="display:flex;gap:22px;max-width:1100px;margin:28px auto;padding:20px;">
      <div style="flex:1;padding:18px;">Cargando producto‚Ä¶</div>
    </div>
  </main>

  <footer class="footer glass" style="text-align:center;padding:20px;margin-top:32px;">
    <p>¬© <span id="year"></span> LIXBY ‚Äî Todos los derechos reservados</p>
  </footer>

  <script>
  (function(){
    'use strict';
    // formateo sencillo
    function nfEuro(v){ return (Math.round((Number(v)||0)*100)/100).toFixed(2).replace('.',',') + ' ‚Ç¨'; }
    function proxied(url){ try { return 'https://images.weserv.nl/?url=' + encodeURIComponent(url.replace(/^https?:\/\//,'')) + '&w=900&q=80'; } catch(e){ return url; } }

    // Productos: ahora incluyen air y pro con diferencias
    const products = {
      "lixby-one": {
        id:'lixby-one', name:'Lixby One',
        mini:'Ultraligero, potente',
        image:'https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg',
        colors:['blue','green','pink','white','black'],
        storage:{ '128':349, '256':429, '512':549, '1024':699 }
      },
      "lixby-one-air": {
        id:'lixby-one-air', name:'Lixby One Air',
        mini:'Ligero y asequible',
        image:'https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg',
        colors:['blue','green','pink','white','black'],
        // Air no tiene 1TB
        storage:{ '128':249, '256':299, '512':379 }
      },
      "lixby-one-pro": {
        id:'lixby-one-pro', name:'Lixby One Pro',
        mini:'Audio & rendimiento',
        image:'https://m.media-amazon.com/images/I/61rriyfRKwL.jpg',
        // Pro no tiene 128 GB y colores limitados
        colors:['blue','white','black'],
        storage:{ '256':899, '512':1099, '1024':1299 }
      }
    };

    // Opciones de LixbyCare (ejemplo) -> monthly = tarifa mensual estimada
    const CARE = {
      none:    { id:'none', label:'Sin LixbyCare+', monthly:0 },
      monthly: { id:'monthly', label:'P√≥liza anual con pago mensual', monthly:8.99 }, // se mostrar√° 8.99‚Ç¨/mes
      upfront: { id:'upfront', label:'Dos a√±os de cobertura (pago √∫nico)', monthly: 169 } // aqu√≠ monthly actuar√≠a como precio √∫nico
    };

    const TERMS = [6,12,18,24,30,36];

    // Cart helpers (igual)
    const CART_KEY = 'lixby_cart_v1';
    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY))||[]; } catch(e){ return []; } }
    function saveCart(c){ try { localStorage.setItem(CART_KEY, JSON.stringify(c)); } catch(e){} }
    let cart = loadCart();

    // Mini-cart UI
    const cartBtn = document.getElementById('cartBtn');
    const miniCart = document.getElementById('miniCart');
    const miniCartItems = document.getElementById('miniCartItems');
    const miniCartTotal = document.getElementById('miniCartTotal');
    const cartCount = document.getElementById('cartCount');
    const miniClear = document.getElementById('miniClear');
    const checkoutBtn = document.getElementById('checkoutBtn');

    function updateMiniCartUI(){
      try {
        if (!miniCartItems) return;
        miniCartItems.innerHTML = '';
        if (!cart || cart.length === 0) {
          miniCartItems.innerHTML = '<div style="padding:8px;color:var(--muted)">Tu carrito est√° vac√≠o.</div>';
          miniCartTotal.textContent = '0 ‚Ç¨';
          if (cartCount) cartCount.textContent = '0';
          return;
        }
        let total=0, qty=0;
        cart.forEach((it, idx) => {
          const row = document.createElement('div'); row.style.display='flex'; row.style.gap='10px'; row.style.padding='8px'; row.style.alignItems='center';
          const img = document.createElement('img'); img.src = it.image || 'https://via.placeholder.com/80'; img.alt = it.name || ''; img.style.width='44px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
          const meta = document.createElement('div'); meta.style.flex='1'; meta.innerHTML = `<div style="font-weight:700">${it.name}</div><div style="color:var(--muted)">${it.price} √ó ${it.qty||1}</div>`;
          const remove = document.createElement('button'); remove.textContent='‚úï'; remove.style.background='transparent'; remove.style.border='none'; remove.style.cursor='pointer';
          remove.addEventListener('click', ()=>{ cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); });
          row.appendChild(img); row.appendChild(meta); row.appendChild(remove);
          miniCartItems.appendChild(row);
          total += (it.priceNum || 0) * (it.qty||1);
          qty += (it.qty||1);
        });
        miniCartTotal.textContent = nfEuro(total);
        if (cartCount) cartCount.textContent = qty;
      } catch(e){ console.warn(e); }
    }
    updateMiniCartUI();

    if (cartBtn && miniCart) {
      cartBtn.addEventListener('click', () => {
        const shown = miniCart.getAttribute('aria-hidden') === 'false';
        miniCart.setAttribute('aria-hidden', String(!shown));
        cartBtn.setAttribute('aria-expanded', String(!shown));
      });
      document.addEventListener('click', (ev) => {
        const tg = ev.target;
        if (!tg || !tg.closest) return;
        if (!cartBtn.contains(tg) && !miniCart.contains(tg)) {
          miniCart.setAttribute('aria-hidden','true');
          cartBtn.setAttribute('aria-expanded','false');
        }
      });
    }
    if (miniClear) miniClear.addEventListener('click', ()=> { cart=[]; saveCart(cart); updateMiniCartUI(); });
    if (checkoutBtn) checkoutBtn.addEventListener('click', ()=> { if (!cart.length) return alert('El carrito est√° vac√≠o'); alert('Simulaci√≥n checkout ‚Äî ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });

    window.addToCart = function(product){
      try {
        if (!product) return;
        product.priceNum = product.priceNum || Number(String(product.price||'0').replace(/[^\d.-]/g,'').replace(',', '.')) || 0;
        product.qty = Number(product.qty || 1);
        const existing = cart.find(p => p.id === product.id && p.storage === product.storage && p.color === product.color && p.care === product.care && p.term === product.term);
        if (existing) existing.qty = (existing.qty||1) + product.qty;
        else cart.push(Object.assign({}, product));
        saveCart(cart);
        updateMiniCartUI();
        try { miniCart.setAttribute('aria-hidden','false'); cartBtn.setAttribute('aria-expanded','true'); setTimeout(()=>{ miniCart.setAttribute('aria-hidden','true'); cartBtn.setAttribute('aria-expanded','false'); }, 2000); } catch(e){}
      } catch(e){ console.error(e); }
    };

    // Detecci√≥n flexible de ID en URL (query, hash, path)
    function getProductIdFromUrl(){
      try {
        const qs = new URLSearchParams(location.search).get('id'); if (qs) return decodeURIComponent(qs);
      } catch(e){}
      try {
        const h = (location.hash || '').replace(/^#\/?/, '');
        if (h) {
          // formatos: #id=lixby-one-air  o #/producto/lixby-one-air
          const m = h.match(/id=([^&]+)/);
          if (m && m[1]) return decodeURIComponent(m[1]);
          const parts = h.split('/').filter(Boolean);
          if (parts.length) return decodeURIComponent(parts[parts.length-1]);
        }
      } catch(e){}
      try {
        const segs = location.pathname.split('/').filter(Boolean);
        if (segs.length) {
          const last = segs[segs.length-1];
          if (last && !last.match(/\.html$/i)) return decodeURIComponent(last);
        }
      } catch(e){}
      return null;
    }

    function findProductKeyFlexible(raw){
      if (!raw) return null;
      raw = String(raw).trim().toLowerCase();
      // exact match
      if (products[raw]) return raw;
      // normalize common variants: spaces, underscores -> hyphens
      const normalized = raw.replace(/\s+/g,'-').replace(/_/g,'-');
      for (const k in products) {
        if (k.toLowerCase() === normalized) return k;
      }
      // partial match: contains or contained
      for (const k in products) {
        if (k.toLowerCase().indexOf(normalized) !== -1 || normalized.indexOf(k.toLowerCase()) !== -1) return k;
      }
      return null;
    }

    // Render product
    function renderProduct(){
      const raw = getProductIdFromUrl();
      const key = findProductKeyFlexible(raw) || 'lixby-one';
      const p = products[key];
      const container = document.getElementById('productDetail');
      if (!container) return;
      container.innerHTML = '';

      // left: image
      const wrap = document.createElement('div'); wrap.className = 'image-wrap';
      const img = document.createElement('img'); img.className='product-image'; img.alt = p.name; img.src = proxied(p.image); img.loading='eager';
      img.addEventListener('error', ()=>{ img.src = p.image; });
      wrap.appendChild(img);

      // right: info
      const info = document.createElement('div'); info.className='product-info';
      const title = document.createElement('h1'); title.textContent = p.name;
      const mini = document.createElement('p'); mini.textContent = p.mini || '';
      const priceEl = document.createElement('div'); priceEl.className='price'; priceEl.textContent = nfEuro(Object.values(p.storage)[0]);

      const options = document.createElement('div'); options.className='options';

      // Colors
      const colWrap = document.createElement('div');
      const colTitle = document.createElement('div'); colTitle.className='option-title'; colTitle.textContent='Acabado. Elige tu favorito.';
      colWrap.appendChild(colTitle);
      const colorsRow = document.createElement('div'); colorsRow.className='colors';
      const selColor = document.createElement('input'); selColor.type='hidden'; selColor.id='selColor';
      const savedColorKey = 'lixby_sel_color_' + p.id;
      const savedColor = localStorage.getItem(savedColorKey);
      (p.colors||[]).forEach((c, i) => {
        const b = document.createElement('button'); b.className='color-dot'; b.setAttribute('data-color', c); b.setAttribute('aria-label', c); b.tabIndex=0;
        if (savedColor ? savedColor===c : i===0) b.classList.add('active');
        b.addEventListener('click', function(){
          colorsRow.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active'));
          this.classList.add('active'); selColor.value = this.dataset.color; localStorage.setItem(savedColorKey, this.dataset.color); updateSummary();
        });
        b.addEventListener('keydown', ev => { if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); b.click(); }});
        colorsRow.appendChild(b);
      });
      colWrap.appendChild(colorsRow); colWrap.appendChild(selColor);
      options.appendChild(colWrap);

      // Capacidades
      const capWrap = document.createElement('div');
      const capTitle = document.createElement('div'); capTitle.className='option-title'; capTitle.textContent='Capacidad. ¬øCu√°nto espacio necesitas?';
      capWrap.appendChild(capTitle);
      const capRow = document.createElement('div'); capRow.className='capacities';
      const selCap = document.createElement('input'); selCap.type='hidden'; selCap.id='selCap';
      const keys = Object.keys(p.storage).sort((a,b)=>Number(a)-Number(b));
      const savedCapKey = 'lixby_sel_cap_' + p.id;
      const savedCap = localStorage.getItem(savedCapKey);
      keys.forEach((sz, idx) => {
        const card = document.createElement('div'); card.className='cap-card'; card.setAttribute('data-cap', sz); card.tabIndex=0;
        if (savedCap ? savedCap===sz : idx===0) card.classList.add('active');
        const left = document.createElement('div'); left.style.fontWeight='700'; left.textContent = (sz==='1024' ? '1 TB' : sz + ' GB');
        const right = document.createElement('div'); right.innerHTML = `${nfEuro(p.storage[sz])}<div class="muted" style="margin-top:6px">o ${nfEuro(Math.round((p.storage[sz]/24)*100)/100)} /mes (24 meses)</div>`;
        card.appendChild(left); card.appendChild(right);
        card.addEventListener('click', ()=>{ capRow.querySelectorAll('.cap-card').forEach(c=>c.classList.remove('active')); card.classList.add('active'); selCap.value = sz; localStorage.setItem(savedCapKey, sz); updateSummary(); });
        card.addEventListener('keydown', ev => { if (ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); card.click(); }});
        capRow.appendChild(card);
      });
      capWrap.appendChild(capRow); capWrap.appendChild(selCap);
      options.appendChild(capWrap);

      // Opciones de pago
      const payWrap = document.createElement('div');
      const payTitle = document.createElement('div'); payTitle.className='option-title'; payTitle.textContent='Opciones de pago. Elige lo que m√°s te convenga.';
      payWrap.appendChild(payTitle);
      const payRow = document.createElement('div'); payRow.className='pay-options';
      const paySingle = document.createElement('div'); paySingle.className='pay-card active'; paySingle.setAttribute('data-pay','single'); paySingle.textContent='Pago √∫nico';
      const payPlazo  = document.createElement('div'); payPlazo.className='pay-card'; payPlazo.setAttribute('data-pay','plazo'); payPlazo.textContent='Pagos mensuales';
      payRow.appendChild(paySingle); payRow.appendChild(payPlazo);

      // selector terms
      const termWrap = document.createElement('div'); termWrap.className='term-select-wrap';
      const termSelect = document.createElement('select'); termSelect.className='term-select'; termSelect.id='selTerm';
      TERMS.forEach(m => { const o = document.createElement('option'); o.value = String(m); o.textContent = `${m} meses`; termSelect.appendChild(o); });
      const termBadge = document.createElement('div'); termBadge.id='termBadge'; termBadge.className='muted';
      termWrap.appendChild(termSelect); termWrap.appendChild(termBadge);
      termWrap.style.display = 'none';
      payWrap.appendChild(payRow); payWrap.appendChild(termWrap);
      options.appendChild(payWrap);

      // LixbyCare (titulo cambiado)
      const careWrap = document.createElement('div');
      const careTitle = document.createElement('div'); careTitle.className='option-title'; careTitle.textContent='LixbyCare+. Protege tu nuevo Lixby.';
      careWrap.appendChild(careTitle);
      const careGrid = document.createElement('div'); careGrid.className='care-grid';
      const careSavedKey = 'lixby_sel_care_' + p.id;
      const savedCare = localStorage.getItem(careSavedKey) || 'none';
      Object.values(CARE).forEach(c => {
        const card = document.createElement('button'); card.type='button'; card.className='care-card'; card.setAttribute('data-care', c.id);
        if (savedCare === c.id) card.classList.add('active');
        // show monthly or upfront price
        let priceLine = '';
        if (c.id === 'monthly') priceLine = nfEuro(c.monthly) + ' /mes';
        else if (c.id === 'upfront') priceLine = nfEuro(c.monthly) + ' (pago √∫nico)';
        else priceLine = 'Sin coste';
        card.innerHTML = `<div style="font-weight:700">${c.id==='none' ? 'Sin LixbyCare+' : c.label}</div><small>${priceLine}</small>`;
        card.addEventListener('click', ()=> {
          careGrid.querySelectorAll('.care-card').forEach(x=>x.classList.remove('active'));
          card.classList.add('active');
          localStorage.setItem(careSavedKey, c.id);
          // mostrar panel de m√©todo de pago del seguro (solo si no none)
          toggleCarePaymentPanel(c.id);
          updateSummary();
        });
        careGrid.appendChild(card);
      });
      careWrap.appendChild(careGrid);

      // Panel de pago del seguro (oculto por defecto)
      const carePayPanel = document.createElement('div'); carePayPanel.className='care-pay-panel'; carePayPanel.style.display='none';
      carePayPanel.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700;margin-bottom:8px">¬øQu√© p√≥liza de seguro LixbyCare+ quieres?</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="care-pay-option" data-payopt="monthly">
              <div style="font-weight:700">P√≥liza anual con pago mensual hasta su cancelaci√≥n</div>
              <div class="muted" style="margin-top:6px" id="payMonthlyPrice"></div>
            </div>
            <div class="care-pay-option" data-payopt="upfront">
              <div style="font-weight:700">Dos a√±os de cobertura con pago al contado</div>
              <div class="muted" style="margin-top:6px" id="payUpfrontPrice"></div>
            </div>
          </div>
        </div>
        <div style="flex:0 0 320px;color:var(--muted);font-size:0.95rem">
          <div style="font-weight:700;margin-bottom:8px">Informaci√≥n</div>
          <div>La p√≥liza anual con pago mensual se renueva autom√°ticamente salvo cancelaci√≥n. El pago al contado es un precio por la cobertura completa (2 a√±os).</div>
        </div>
      `;
      careWrap.appendChild(carePayPanel);
      options.appendChild(careWrap);

      // summary
      const summary = document.createElement('div'); summary.className='summary';
      summary.innerHTML = `<div><div class="muted">Precio</div><div class="big" id="totalPrice">--</div></div><div style="text-align:right"><div id="perMonth" class="muted">--</div><div id="careInfo" class="muted">--</div></div>`;
      options.appendChild(summary);

      // acciones
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='10px'; actions.style.marginTop='12px';
      const addBtn = document.createElement('button'); addBtn.className='btn btn-buy'; addBtn.textContent='A√±adir al carrito';
      const favBtn = document.createElement('button'); favBtn.className='btn'; favBtn.textContent='‚ô° Favorito';
      actions.appendChild(addBtn); actions.appendChild(favBtn);

      // ensamblar
      info.appendChild(title); info.appendChild(mini); info.appendChild(priceEl); info.appendChild(options); info.appendChild(actions);
      container.appendChild(wrap); container.appendChild(info);

      // inicializar valores escondidos
      const defaultColor = savedColor || (p.colors[0]||'');
      selColor.value = defaultColor;
      const defaultCap = savedCap || keys[0];
      selCap.value = defaultCap;
      termSelect.value = '12';
      // mostrar u ocultar panel cuidado segun seleccionado guardado
      toggleCarePaymentPanel(localStorage.getItem(careSavedKey) || 'none');

      // Interacciones: pago
      paySingle.addEventListener('click', ()=> { payRow.querySelectorAll('.pay-card').forEach(c=>c.classList.remove('active')); paySingle.classList.add('active'); termWrap.style.display='none'; updateSummary(); });
      payPlazo.addEventListener('click', ()=> { payRow.querySelectorAll('.pay-card').forEach(c=>c.classList.remove('active')); payPlazo.classList.add('active'); termWrap.style.display='flex'; updateSummary(); });
      termSelect.addEventListener('change', updateSummary);

      // togglear panel de pago del seguro
      function toggleCarePaymentPanel(careId){
        if (!carePayPanel) return;
        if (!careId || careId === 'none') { carePayPanel.style.display = 'none'; return; }
        carePayPanel.style.display = 'flex';
        // rellenar precios
        const monthlyEl = carePayPanel.querySelector('#payMonthlyPrice');
        const upfrontEl  = carePayPanel.querySelector('#payUpfrontPrice');
        const c = CARE[careId];
        if (!c) { monthlyEl.textContent = ''; upfrontEl.textContent = ''; return; }
        if (careId === 'monthly') {
          monthlyEl.textContent = nfEuro(c.monthly) + ' /mes';
          // compute upfront approx (12 meses)
          upfrontEl.textContent = nfEuro(Math.round(c.monthly*12*100)/100) + ' (estim.)';
        } else if (careId === 'upfront') {
          // here c.monthly holds upfront price in our data
          monthlyEl.textContent = nfEuro(Math.round((c.monthly/12)*100)/100) + ' /mes (estim.)';
          upfrontEl.textContent = nfEuro(c.monthly) + ' (precio √∫nico)';
        } else {
          monthlyEl.textContent = '‚Äî'; upfrontEl.textContent = '‚Äî';
        }

        // hacer opciones seleccionables
        carePayPanel.querySelectorAll('.care-pay-option').forEach(opt => {
          opt.classList.remove('active');
          opt.addEventListener('click', ()=> {
            carePayPanel.querySelectorAll('.care-pay-option').forEach(o=>o.classList.remove('active'));
            opt.classList.add('active');
            // guardar elecci√≥n para usar en updateSummary (opcional si quieres persistir)
            localStorage.setItem(careSavedKey + '_payopt', opt.dataset.payopt);
            updateSummary();
          });
        });

        // marcar por defecto la opci√≥n 'monthly' si existe
        const savedOpt = localStorage.getItem(careSavedKey + '_payopt') || (careId === 'monthly' ? 'monthly' : 'upfront');
        const def = carePayPanel.querySelector(`.care-pay-option[data-payopt="${savedOpt}"]`);
        if (def) def.classList.add('active');
      }

      // actualizar resumen
      function updateSummary(){
        try {
          const cap = selCap.value || keys[0];
          const base = Number(p.storage[cap] || 0);
          const isPlazo = payPlazo.classList.contains('active');
          const term = isPlazo ? Number(termSelect.value || 12) : 1;
          const careSel = (careGrid.querySelector('.care-card.active') || {}).dataset?.care || 'none';
          const careObj = CARE[careSel] || CARE.none;

          // seleccionar metodo de pago del seguro (si panel visible)
          const payOpt = (document.querySelector('.care-pay-option.active') || {}).dataset?.payopt || (careSel==='upfront' ? 'upfront' : 'monthly');

          // c√°lculos:
          // device monthly
          const deviceMonthly = Math.round((base / Math.max(term,1)) * 100) / 100;
          // care monthly / upfront
          let careMonthly = 0, careUpfront = 0;
          if (careSel === 'monthly') {
            careMonthly = careObj.monthly;
            careUpfront = Math.round(careMonthly * 12 * 100) / 100;
          } else if (careSel === 'upfront') {
            careUpfront = careObj.monthly; // in our structure monthly field stores upfront price
            careMonthly = Math.round((careUpfront / 24) * 100) / 100; // approx
          } else {
            careMonthly = 0; careUpfront = 0;
          }

          const perMonthTotal = Math.round((deviceMonthly + (careSel==='none' ? 0 : (payOpt==='monthly' ? careMonthly : Math.round((careUpfront/term)*100)/100))) * 100) / 100;

          const totalEl = document.getElementById('totalPrice');
          const perMonthEl = document.getElementById('perMonth');
          const careInfoEl = document.getElementById('careInfo');
          const termBadgeEl = document.getElementById('termBadge');

          if (!isPlazo) {
            // pago √∫nico: mostrar device + posible care upfront si pago upfront o monthly (we assume show base + upfront)
            const totalSingle = Math.round((base + (payOpt==='upfront' ? careUpfront : careUpfront)) * 100) / 100;
            totalEl.textContent = nfEuro(totalSingle);
            perMonthEl.textContent = `Pago √∫nico. (Ej.: ${nfEuro(Math.round((base/24)*100)/100)} /mes si financias a 24 meses)`;
            termBadgeEl && (termBadgeEl.textContent = '');
          } else {
            totalEl.textContent = 'Desde ' + nfEuro(base);
            perMonthEl.textContent = `${nfEuro(perMonthTotal)} /mes durante ${term} meses (estim.)`;
            termBadgeEl && (termBadgeEl.textContent = `Dispositivo: ${nfEuro(deviceMonthly)} /mes`);
          }

          if (careSel === 'none') {
            careInfoEl.textContent = 'Sin LixbyCare+';
          } else {
            if (payOpt === 'monthly') {
              careInfoEl.textContent = `${CARE[careSel].label} ‚Äî ${nfEuro(careMonthly)} /mes (estim.)`;
            } else {
              careInfoEl.textContent = `${CARE[careSel].label} ‚Äî ${nfEuro(careUpfront)} pago √∫nico`;
            }
          }

          // actualizar badge precio por mes del dispositivo al cambiar term
          const badge = document.getElementById('termBadge');
          if (badge) {
            if (isPlazo) {
              badge.textContent = `Dispositivo: ${nfEuro(deviceMonthly)} /mes`;
            } else badge.textContent = '';
          }
        } catch(e){ console.warn('updateSummary err', e); }
      }

      // enlazar click add to cart
      addBtn.addEventListener('click', ()=> {
        const cap = selCap.value || keys[0];
        const base = Number(p.storage[cap] || 0);
        const careSel = (careGrid.querySelector('.care-card.active') || {}).dataset?.care || 'none';
        const term = payPlazo.classList.contains('active') ? Number(termSelect.value || 12) : 1;
        const priceLabel = nfEuro(base);
        const prod = {
          id: p.id,
          name: `${p.name} ‚Äî ${cap} GB ‚Äî ${selColor.value || 'color'}`,
          price: priceLabel,
          priceNum: base,
          qty: 1,
          image: p.image,
          color: selColor.value || '',
          storage: cap,
          care: careSel,
          term: term
        };
        window.addToCart(prod);
        addBtn.textContent = 'A√±adido';
        setTimeout(()=> addBtn.textContent = 'A√±adir al carrito', 900);
      });

      favBtn.addEventListener('click', ()=> {
        if (confirm('Debes iniciar sesi√≥n para guardar favoritos. ¬øIr a la p√°gina de cuenta?')) location.href='cuenta.html';
      });

      // llamadas iniciales
      updateSummary();
    } // renderProduct end

    renderProduct();

    // year
    try { document.getElementById('year').textContent = new Date().getFullYear(); } catch(e){}

    // theme toggle (guarda preferencia)
    try {
      const tbtn = document.getElementById('themeToggle');
      tbtn && tbtn.addEventListener('click', ()=> {
        const isLight = document.documentElement.classList.contains('light');
        if (isLight) {
          document.documentElement.classList.remove('light');
          localStorage.setItem('lixby_theme','dark');
        } else {
          document.documentElement.classList.add('light');
          localStorage.setItem('lixby_theme','light');
        }
      });
    } catch(e){}
  })();
  </script>
</body>
</html>
