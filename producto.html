<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIXBY ‚Äî Detalle de producto</title>

  <!-- PERF -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin>

  <meta name="description" content="Ficha del producto Lixby ‚Äî detalles, precio y especificaciones. A√±ade al carrito y guarda en favoritos." />
  <meta name="theme-color" content="#07101a" />

  <link rel="stylesheet" href="style.css" />
  <style>
    /* (estilos tal cual llevabas) */
    .nav { top: 0; left: 0; right: 0; position: fixed; padding: 10px 18px; z-index: 120; background: transparent; }
    .nav-inner { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 12px; }
    .nav-left { justify-self: start; display:flex; align-items:center; gap:8px; }
    #navLinks { justify-self:center; display:flex; gap:18px; align-items:center; }
    .nav-right { justify-self:end; display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
    @media (max-width:900px) { #navLinks { gap:10px; font-size:0.95rem; } .nav-right { flex-direction:row; align-items:center; } }
    .product-detail { display:flex; gap:36px; align-items:flex-start; max-width:1100px; margin:120px auto 80px; padding:28px; border-radius:14px; box-sizing:border-box; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.03); }
    .image-wrap { width:420px; height:420px; border-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.04); flex:0 0 420px; box-sizing:border-box; }
    .product-image { max-width:100%; max-height:100%; object-fit:contain; display:block; }
    .thumbs { display:flex; gap:8px; margin-top:12px; }
    .thumbs img { width:64px; height:64px; object-fit:cover; border-radius:8px; cursor:pointer; border:1px solid rgba(255,255,255,0.04); }
    .thumbs img[aria-current="true"]{ outline:2px solid var(--accent); }
    .product-info { flex:1; display:flex; flex-direction:column; gap:14px; }
    .product-info h1 { font-size:1.6rem; margin:0; }
    .product-info p { color:var(--muted); margin:0; }
    .mini-note { color:var(--muted); font-size:0.95rem; margin-top:6px; }
    .product-info .price { font-size:1.4rem; color:var(--accent); font-weight:700; margin-top:8px; }

    .btn-add { margin-top:12px; padding:12px 18px; border-radius:10px; background: linear-gradient(180deg,var(--accent), color-mix(in oklab, var(--accent) 60%, #fff 40%)); border:none; color:#00121a; font-weight:700; cursor:pointer; max-width:320px; text-align:center; }
    .btn-fav { margin-top:12px; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--text); cursor:pointer; font-weight:700; display:inline-flex; gap:8px; align-items:center; }
    .detail-block { margin-top:18px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.03); }
    .bom { margin-top:18px; border-collapse:collapse; width:100%; max-width:760px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,0.05); }
    .bom thead { background: rgba(255,255,255,0.02); }
    .bom th, .bom td { padding:12px 14px; text-align:left; font-size:0.95rem; border-bottom: 1px solid rgba(255,255,255,0.03); color: var(--text); }
    .bom th { font-weight:700; color:var(--muted); }
    main { padding-top: 84px; }
    @media(max-width:900px){ .product-detail{ flex-direction:column; margin:90px 16px; } .image-wrap{ width:100%; height:auto; aspect-ratio:1/1; padding:18px; } .product-image{ max-width:80%; max-height:80%; } .mini-cart, .lang-menu { right:8px; top:48px; } }
    .btn-add, .btn-fav, .icon-btn, .btn { transition: transform .16s cubic-bezier(.2,.9,.3,1), box-shadow .16s ease; }
    .btn-add:hover, .btn-fav:hover, .icon-btn:hover, .btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 22px rgba(2,6,12,0.12); }

    /* lightbox */
    .lightbox { position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;background:rgba(0,0,0,0.85); }
    .lightbox.open{ display:flex; }
    .lightbox img{ max-width:92%; max-height:92%; object-fit:contain; border-radius:10px; }
  </style>
</head>
<body>
  <header class="nav glass" role="banner">
    <div class="nav-inner">
      <div class="nav-left">
        <div class="brand" role="button" onclick="window.location.href='index.html'">LIXBY</div>
      </div>

      <nav id="navLinks" role="navigation" aria-label="Principal">
        <a href="index.html#inicio" data-i18n="nav.inicio">Inicio</a>
        <a href="index.html#productos" data-i18n="nav.productos">Productos</a>
        <a href="index.html#contacto" data-i18n="nav.contacto">Cont√°ctanos</a>
        <a href="index.html#conocenos" data-i18n="nav.conocenos">Con√≥cenos</a>
      </nav>

      <div class="nav-right">
        <div class="cart-wrapper" style="position:relative;">
          <!-- Accessible cart button: aria-controls -> id of the miniCart -->
          <button id="cartBtn" class="icon-btn" aria-label="Ver carrito" aria-controls="miniCart" aria-expanded="false">üõí <span id="cartCount" class="badge">0</span></button>

          <!-- miniCart: aria-hidden toggled in JS, role region -->
          <div id="miniCart" class="mini-cart glass" aria-hidden="true" role="region" aria-label="Mini carrito" style="flex-direction:column;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
              <strong data-i18n="cart.title">Carrito</strong>
              <button id="clearCart" class="text-btn" data-i18n="cart.clear">Vaciar</button>
            </div>
            <div id="miniCartItems" style="max-height:200px;overflow:auto;"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
              <div><strong data-i18n="cart.total">Total:</strong> <span id="miniCartTotal">0‚Ç¨</span></div>
              <div><button id="checkoutBtn" class="btn primary" data-i18n="cart.checkout">Pagar</button></div>
            </div>
          </div>
        </div>

        <div class="lang-wrapper" style="position:relative;">
          <button id="langBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false">üá™üá∏ <span id="langLabel">Espa√±ol</span> ‚ñæ</button>
          <div id="langMenu" class="lang-menu glass" aria-hidden="true" style="flex-direction:column;gap:6px;padding:8px;width:160px;">
            <button class="lang-item" data-lang="es">üá™üá∏ Espa√±ol</button>
            <button class="lang-item" data-lang="en">üá¨üáß English</button>
            <button class="lang-item" data-lang="fr">üá´üá∑ Fran√ßais</button>
          </div>
        </div>

        <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema">‚óê</button>
      </div>
    </div>
  </header>

  <main>
    <!-- aria-live para notificar cambios importantes (ej. "A√±adido al carrito") -->
    <div id="productDetail" class="product-detail glass" aria-live="polite">
      <div style="flex:1;padding:24px;">Cargando producto‚Ä¶</div>
    </div>

    <div class="product-list" id="quickLinks" style="display:none;margin-top:22px;">
      <!-- quickLinks tienen tabindex para accesibilidad teclado -->
      <a tabindex="0" href="producto.html?id=lixby-one">Ver Lixby One</a>
      <a tabindex="0" href="producto.html?id=lixby-one-plus">Ver Lixby One Plus</a>
      <a tabindex="0" href="producto.html?id=lixby-one-pro">Ver Lixby One Pro</a>
    </div>
  </main>

  <div id="debug" class="debug" role="status" aria-live="polite" style="white-space:pre-wrap;display:none;padding:8px;margin:8px;max-width:1100px;color:var(--muted);"></div>

  <footer class="footer glass" style="text-align:center;padding:24px;margin-top:40px;">
    <p>¬© <span id="year"></span> LIXBY ‚Äî Todos los derechos reservados</p>
  </footer>

  <!-- lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-hidden="true">
    <img id="lightboxImg" alt="" />
  </div>

  <!-- Mensaje para usuarios sin JS -->
  <noscript>
    <div style="max-width:1100px;margin:16px auto;padding:12px;background:#2a2a2a;color:#fff;border-radius:8px;">
      Esta p√°gina requiere JavaScript para mostrar la ficha completa del producto. Por favor habilita JavaScript en tu navegador.
    </div>
  </noscript>

  <script>
  (function(){
    'use strict';
    // -------------------------
    // Helpers y estado (mejorados)
    // -------------------------
    const CART_KEY = 'lixby_cart_v1';
    function showDebug(msg){ const el = document.getElementById('debug'); if (!el) return; el.style.display = 'block'; el.textContent += msg + "\n"; console.log("DEBUG:", msg); }
    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY))||[]; } catch(e){ return []; } }
    function saveCart(c){ try { localStorage.setItem(CART_KEY, JSON.stringify(c)); } catch(e){} }
    function parsePriceToNumber(priceStr){ if(!priceStr) return 0; const num=String(priceStr).replace(/[^\d.,]/g,'').replace(',','.'); return parseFloat(num)||0; }
    function formatPriceNum(num){ return (Math.round(num*100)/100) + '‚Ç¨'; }

    // set year
    const yearEl = document.getElementById('year'); if (yearEl) yearEl.textContent = new Date().getFullYear();

    // Productos (a√±ad√≠ "images" array para poder tener galer√≠a sin petar)
    const products = {
      "lixby-one-air": { id: 'lixby-one-air', name: "Lixby One Air", description: "Versi√≥n ligera y asequible, ideal para un uso diario eficiente.", mini: "Pantalla OLED 6.1\" ‚Ä¢ Rendimiento equilibrado ‚Ä¢ Compacto y ligero", price: "249‚Ç¨", image: "https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg", images: ["https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg"] },
      "lixby-one": { id: 'lixby-one', name: "Lixby One", description: "Ultraligero, potente y dise√±ado para la vida moderna.", mini: "Pantalla OLED 6.7\", 120 Hz ‚Ä¢ SoC 5G ‚Ä¢ C√°mara dual 50 MP + 8 MP ‚Ä¢ Bater√≠a 5.000 mAh", price: "349‚Ç¨", image: "https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg", images: ["https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg","https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg"], bom: [ ["SoC 5G (Snapdragon 7s Gen 2 / Dimensity 8300) + PMIC", ""], ["RAM 8 GB LPDDR5X", ""], ["Almacenamiento UFS 3.1 256 GB", ""] ] },
      "lixby-one-plus": { id: 'lixby-one-plus', name: "Lixby One Plus", description: "Tel√©fono de √∫ltima generaci√≥n con c√°mara de alta resoluci√≥n.", mini: "C√°mara profesional ‚Ä¢ Rendimiento equilibrado ‚Ä¢ Bater√≠a duradera", price: "659‚Ç¨", image: "https://media.ldlc.com/r1600/ld/products/00/06/16/66/LD0006166643_0006166668_0006166693.jpg", images: ["https://media.ldlc.com/r1600/ld/products/00/06/16/66/LD0006166643_0006166668_0006166693.jpg"] },
      "lixby-one-pro": { id: 'lixby-one-pro', name: "Lixby One Pro", description: "Rendimiento y audio de alta fidelidad para creadores y audi√≥filos.", mini: "Audio premium ‚Ä¢ CPU/GPU potentes ‚Ä¢ Dise√±o robusto", price: "899‚Ç¨", image: "https://m.media-amazon.com/images/I/61rriyfRKwL.jpg", images: ["https://m.media-amazon.com/images/I/61rriyfRKwL.jpg"] }
    };

    // proxiedUrl optimizada (ancho reducido y compresi√≥n)
    function proxiedUrl(originalUrl, width = 900){ if (!originalUrl) return originalUrl || ''; const stripped = String(originalUrl).replace(/^https?:\/\//,''); return `https://images.weserv.nl/?url=${encodeURIComponent(stripped)}&w=${width}&q=80`; }

    // -------------------------
    // Mini-cart UI (sin cambios importantes)
    // -------------------------
    let cart = loadCart();
    const cartBtn = document.getElementById('cartBtn');
    const miniCart = document.getElementById('miniCart');
    const miniCartItems = document.getElementById('miniCartItems');
    const miniCartTotal = document.getElementById('miniCartTotal');
    const cartCount = document.getElementById('cartCount');
    const clearCartBtn = document.getElementById('clearCart');
    const checkoutBtn = document.getElementById('checkoutBtn');

    function updateMiniCartUI(){
      const totalQty = cart.reduce((s,i)=>s+(i.qty||0),0);
      if (cartCount) cartCount.textContent = totalQty;
      if (!miniCartItems) return;
      miniCartItems.innerHTML = '';
      if (cart.length === 0) {
        miniCartItems.innerHTML = '<div style="padding:8px;color:var(--muted)">Tu carrito est√° vac√≠o.</div>';
        if (miniCartTotal) miniCartTotal.textContent = '0‚Ç¨';
        return;
      }
      let total = 0;
      const frag = document.createDocumentFragment();
      cart.forEach((it, idx) => {
        const item = document.createElement('div');
        item.className = 'mini-cart-item';
        item.style.display = 'flex'; item.style.gap='10px'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderRadius='8px';
        const img = document.createElement('img'); img.src = it.image || 'https://via.placeholder.com/80x80?text=Img'; img.alt = it.name; img.style.width='44px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
        img.loading='lazy'; img.decoding='async';
        const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<div style="font-weight:700">${it.name}</div><div style="color:var(--muted)">${it.price} x${it.qty||1}</div>`;
        const remove = document.createElement('button'); remove.className='remove'; remove.textContent='‚úï'; remove.style.background='transparent'; remove.style.border='none'; remove.style.cursor='pointer';
        remove.addEventListener('click', (ev) => { ev.stopPropagation(); cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); });
        item.appendChild(img); item.appendChild(meta); item.appendChild(remove);
        frag.appendChild(item);
        total += (it.priceNum || parsePriceToNumber(it.price)) * (it.qty||1);
      });
      miniCartItems.appendChild(frag);
      if (miniCartTotal) miniCartTotal.textContent = formatPriceNum(total);
    }

    if (cartBtn && miniCart) {
      cartBtn.addEventListener('click', (e) => {
        const shown = miniCart.getAttribute('aria-hidden') === 'false';
        miniCart.setAttribute('aria-hidden', String(!shown));
        try { cartBtn.setAttribute('aria-expanded', String(!shown)); } catch(e){}
      });
      document.addEventListener('click', (e) => {
        try {
          if (!cartBtn.contains(e.target) && !miniCart.contains(e.target)) {
            miniCart.setAttribute('aria-hidden','true');
            cartBtn.setAttribute('aria-expanded','false');
          }
        } catch(e){}
      });
    }
    if (clearCartBtn) clearCartBtn.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); });
    if (checkoutBtn) checkoutBtn.addEventListener('click', () => { if (cart.length===0) return alert('El carrito est√° vac√≠o'); alert('Simulaci√≥n de checkout: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });

    window.addToCart = function(product){
      const existing = cart.find(p => p.id === product.id);
      if (existing) existing.qty = (existing.qty||1) + 1;
      else cart.push({ id: product.id, name: product.name, price: product.price, priceNum: parsePriceToNumber(product.price) || product.priceNum || 0, qty:1, image: product.image });
      saveCart(cart);
      updateMiniCartUI();
      if (miniCart) { miniCart.setAttribute('aria-hidden','false'); setTimeout(()=>miniCart.setAttribute('aria-hidden','true'), 2200); }
      const pd = document.getElementById('productDetail');
      try { if (pd) pd.setAttribute('aria-live','polite'); } catch(e){}
    };

    updateMiniCartUI();

    // I18N (sin cambios)
    const langBtn = document.getElementById('langBtn'), langMenu = document.getElementById('langMenu'), langLabel = document.getElementById('langLabel');
    const translations = {
      es: { "nav.inicio":"Inicio","nav.productos":"Productos","nav.contacto":"Cont√°ctanos","nav.conocenos":"Con√≥cenos","cart.title":"Carrito","cart.clear":"Vaciar","cart.total":"Total:","cart.checkout":"Pagar","btn.add":"A√±adir al carrito","btn.added":"A√±adido" },
      en: { "nav.inicio":"Home","nav.productos":"Products","nav.contacto":"Contact","nav.conocenos":"About","cart.title":"Cart","cart.clear":"Clear","cart.total":"Total:","cart.checkout":"Checkout","btn.add":"Add to cart","btn.added":"Added" },
      fr: { "nav.inicio":"Accueil","nav.productos":"Produits","nav.contacto":"Contact","nav.conocenos":"√Ä propos","cart.title":"Panier","cart.clear":"Vider","cart.total":"Total:","cart.checkout":"Payer","btn.add":"Ajouter au panier","btn.added":"Ajout√©" }
    };
    let currentLang = localStorage.getItem('lixby_lang') || 'es';
    function applyTranslations(lang){
      const map = translations[lang] || translations['es'];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (key && map[key]) el.textContent = map[key];
      });
      document.querySelectorAll('.btn-add').forEach(btn => btn.textContent = map['btn.add'] || btn.textContent);
      const names = { es:'Espa√±ol', en:'English', fr:'Fran√ßais' };
      if (langLabel) langLabel.textContent = names[lang] || names['es'];
    }
    function setLang(l){ if (!translations[l]) l='es'; currentLang=l; try{ localStorage.setItem('lixby_lang', l); }catch(e){} applyTranslations(l); }
    setLang(localStorage.getItem('lixby_lang') || currentLang);
    if (langBtn && langMenu){
      langBtn.addEventListener('click', ()=> { const isOpen = langMenu.getAttribute('aria-hidden') === 'false'; langMenu.setAttribute('aria-hidden', String(!isOpen)); langBtn.setAttribute('aria-expanded', String(!isOpen)); });
      langMenu.querySelectorAll('.lang-item').forEach(btn => btn.addEventListener('click', ()=>{ const lang = btn.getAttribute('data-lang'); setLang(lang); langMenu.setAttribute('aria-hidden','true'); langBtn.setAttribute('aria-expanded','false'); }));
      document.addEventListener('click', (e)=> { if (!langBtn.contains(e.target) && !langMenu.contains(e.target)) { langMenu.setAttribute('aria-hidden','true'); langBtn.setAttribute('aria-expanded','false'); }});
    }

    // -------------------------
    // Render product on this page (logic) - optimized
    // -------------------------
    try {
      function getProductIdFromUrl() {
        try {
          const params = new URLSearchParams(window.location.search);
          const qid = params.get('id');
          if (qid) return decodeURIComponent(qid);
        } catch(e){}
        try {
          const h = window.location.hash || '';
          if (h) {
            if (h.indexOf('id=') !== -1) {
              const m = h.match(/id=([^&]+)/);
              if (m && m[1]) return decodeURIComponent(m[1]);
            }
            const clean = h.replace(/^#\/?/, '');
            const parts = clean.split('/');
            if (parts.length) {
              const last = parts[parts.length-1];
              if (last) return decodeURIComponent(last);
            }
          }
        } catch(e){}
        try {
          const path = window.location.pathname || '';
          const segs = path.split('/').filter(Boolean);
          if (segs.length) {
            const last = segs[segs.length-1];
            if (last && !last.match(/\.html$/i) && last !== 'producto' && last !== 'producto.html') {
              return decodeURIComponent(last);
            }
            if (segs.length >= 2) {
              const maybe = segs[segs.length-1];
              if (maybe && !maybe.match(/\.html$/i)) return decodeURIComponent(maybe);
            }
          }
        } catch(e){}
        try {
          const ref = document.referrer || '';
          if (ref) {
            const uq = ref.split('?')[1];
            if (uq) {
              const sp = new URLSearchParams(uq);
              const rid = sp.get('id');
              if (rid) return decodeURIComponent(rid);
            }
          }
        } catch(e){}
        return null;
      }

      const idRaw = getProductIdFromUrl();
      const container = document.getElementById('productDetail');
      const quickLinks = document.getElementById('quickLinks');

      if (!idRaw) {
        if (container) container.innerHTML = '<div style="padding:20px;"><h2>Producto no especificado</h2><p>Parece que no se recibi√≥ un identificador de producto. Usa uno de estos enlaces o vuelve a la tienda.</p></div>';
        if (quickLinks) quickLinks.style.display = 'flex';
        showDebug('No se detect√≥ id en la URL (ni query, ni hash, ni path).');
        return;
      }

      const id = String(idRaw).trim();

      function findProductByIdFlexible(k) {
        if (products[k]) return k;
        const key = k.toLowerCase();
        for (const pk in products) if (pk.toLowerCase() === key) return pk;
        const alt = key.replace(/\s+/g,'-').replace(/_/g,'-');
        for (const pk in products) if (pk.toLowerCase() === alt) return pk;
        for (const pk in products) if (pk.toLowerCase().indexOf(key) !== -1 || key.indexOf(pk.toLowerCase()) !== -1) return pk;
        return null;
      }

      const matchedId = findProductByIdFlexible(id);
      if (!matchedId) {
        container.innerHTML = '<div style="padding:20px;"><h2>Producto no encontrado</h2><p>El identificador recibido fue: <code>' + id + '</code>. Vuelve a la <a href="index.html">tienda</a>.</p></div>';
        showDebug('ID no coincide con productos: ' + id);
        return;
      }

      const p = products[matchedId];
      try { window.currentProductId = matchedId; } catch(e){}

      // wrapper
      const wrap = document.createElement('div'); wrap.className = 'image-wrap';

      // lightweight SVG placeholder (fast)
      const placeholder = 'data:image/svg+xml;utf8,' + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="600" height="600"><rect width="100%" height="100%" fill="#111"/><text x="50%" y="50%" font-size="20" fill="#888" text-anchor="middle" dominant-baseline="middle">Cargando imagen‚Ä¶</text></svg>`
      );

      // main image element (lazy, low-res first)
      const img = document.createElement('img');
      img.className = 'product-image';
      img.alt = p.name;
      img.src = placeholder; // placeholder
      img.dataset.src = proxiedUrl(p.images && p.images[0] ? p.images[0] : p.image, 1200); // load larger when visible
      img.loading = 'lazy'; img.decoding = 'async';
      img.width = 900; img.height = 900;

      // error fallback
      let triedOriginal = false, triedPlaceholder = false;
      img.addEventListener('error', function onErr(){
        if (!triedOriginal) { triedOriginal = true; showDebug('proxied failed, trying original for ' + matchedId); img.src = p.images && p.images[0] ? p.images[0] : p.image; }
        else if (!triedPlaceholder) { triedPlaceholder = true; img.removeEventListener('error', onErr); showDebug('original failed, using placeholder for ' + matchedId); img.src = 'https://via.placeholder.com/600x600?text=Sin+imagen'; }
      });

      wrap.appendChild(img);

      // thumbnails (if multiple images)
      const thumbsWrap = document.createElement('div'); thumbsWrap.className = 'thumbs';
      const gallery = Array.isArray(p.images) && p.images.length ? p.images : [p.image];

      // create shared IntersectionObserver for thumbs + main to lazy-load small ones
      const thumbObserver = ('IntersectionObserver' in window) ? new IntersectionObserver((entries, obs) => {
        entries.forEach(en => {
          if (en.isIntersecting) {
            const el = en.target;
            if (el.dataset && el.dataset.src) { el.src = el.dataset.src; delete el.dataset.src; }
            obs.unobserve(el);
          }
        });
      }, { rootMargin: '200px 0px' }) : null;

      gallery.forEach((url, i) => {
        const t = document.createElement('img');
        t.alt = p.name + ' ' + (i+1);
        t.dataset.src = proxiedUrl(url, 300);
        t.loading = 'lazy'; t.decoding = 'async';
        t.setAttribute('role','button');
        t.tabIndex = 0;
        if (i === 0) t.setAttribute('aria-current','true');
        // click: swap main image but DO NOT reload until user requests (lightbox)
        t.addEventListener('click', (e) => {
          // mark selected
          thumbsWrap.querySelectorAll('img').forEach(x => x.removeAttribute('aria-current'));
          t.setAttribute('aria-current','true');
          // set low-latency proxied medium-res on main
          img.src = proxiedUrl(url, 900);
        });
        t.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); t.click(); } });
        thumbsWrap.appendChild(t);
        if (thumbObserver) thumbObserver.observe(t); else { t.src = t.dataset.src; delete t.dataset.src; }
      });

      // lightbox open on main image click - loads original high-res lazily
      const lightbox = document.getElementById('lightbox');
      const lightboxImg = document.getElementById('lightboxImg');
      function openLightbox(src){
        try {
          lightboxImg.alt = p.name;
          // load original (not proxied) when available: try original first
          lightboxImg.src = p.images && p.images[0] ? p.images[0] : p.image;
          lightbox.setAttribute('aria-hidden','false'); lightbox.classList.add('open');
          document.documentElement.style.overflow = 'hidden';
        } catch(e){ showDebug('lightbox open err ' + e); }
      }
      function closeLightbox(){ lightbox.setAttribute('aria-hidden','true'); lightbox.classList.remove('open'); lightboxImg.src = ''; document.documentElement.style.overflow = ''; }
      img.style.cursor = 'zoom-in';
      img.addEventListener('click', ()=> openLightbox());
      lightbox.addEventListener('click', (ev)=> { if (ev.target === lightbox || ev.target === lightboxImg) closeLightbox(); });
      document.addEventListener('keydown', (ev)=> { if (ev.key === 'Escape') closeLightbox(); });

      // IntersectionObserver to swap data-src -> src when visible for main image
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries, obs) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const el = entry.target;
              if (el.dataset && el.dataset.src) {
                el.src = el.dataset.src;
                delete el.dataset.src;
              }
              obs.unobserve(el);
            }
          });
        }, { rootMargin: '300px 0px' });
        io.observe(img);
      } else {
        img.src = img.dataset.src; delete img.dataset.src;
      }

      // info
      const info = document.createElement('div'); info.className = 'product-info';
      const title = document.createElement('h1'); title.textContent = p.name;
      const desc = document.createElement('p'); desc.textContent = p.description || '';
      const mini = document.createElement('div'); mini.className = 'mini-note'; mini.textContent = p.mini || '';
      const price = document.createElement('div'); price.className = 'price'; price.textContent = p.price;

      // favorito (mejor aria y estado)
      const favBtn = document.createElement('button'); favBtn.id='favBtn'; favBtn.className='btn-fav'; favBtn.innerHTML='‚ô° Favorito'; favBtn.title='Guardar en favoritos';
      favBtn.setAttribute('aria-pressed','false');
      favBtn.addEventListener('click', (ev) => {
        // lazy-load firebase module when user interacts with favoritos
        window.dispatchEvent(new CustomEvent('toggleFavorite', { detail: { id: p.id||matchedId, name: p.name, price: p.price, image: p.image } }));
      });

      // a√±adir
      const addBtn = document.createElement('button'); addBtn.className='btn-add';
      addBtn.textContent = (translations[currentLang] && translations[currentLang]['btn.add']) || 'A√±adir al carrito';
      addBtn.addEventListener('click', () => {
        const productData = { id: p.id||matchedId, name: p.name, price: p.price, image: p.image, priceNum: parsePriceToNumber(p.price) };
        if (typeof window.addToCart === 'function') { window.addToCart(productData); }
        else { const existing = cart.find(x => x.id === productData.id); if (existing) existing.qty = (existing.qty||1)+1; else cart.push({ id: productData.id, name: productData.name, price: productData.price, priceNum: parsePriceToNumber(productData.price), qty:1, image: productData.image }); saveCart(cart); updateMiniCartUI(); }
        addBtn.textContent = (translations[currentLang] && translations[currentLang]['btn.added']) || 'A√±adido';
        try { const pd = document.getElementById('productDetail'); if (pd) pd.setAttribute('aria-live','polite'); } catch(e){}
        setTimeout(()=> addBtn.textContent = (translations[currentLang] && translations[currentLang]['btn.add']) || 'A√±adir al carrito', 1000);
      });

      const actionsWrap = document.createElement('div');
      actionsWrap.style.display = 'flex'; actionsWrap.style.gap='10px';
      actionsWrap.appendChild(addBtn); actionsWrap.appendChild(favBtn);

      info.appendChild(title); if (desc.textContent) info.appendChild(desc); if (mini.textContent) info.appendChild(mini);
      info.appendChild(price); info.appendChild(actionsWrap);

      // attach thumbs AFTER main to keep layout stable
      if (gallery.length > 1) {
        const thumbsContainer = document.createElement('div'); thumbsContainer.style.marginTop = '12px';
        thumbsContainer.appendChild(thumbsWrap);
        wrap.appendChild(thumbsContainer);
      }

      container.innerHTML = ''; container.appendChild(wrap); container.appendChild(info);
      // add thumbs into DOM (after wrap is in DOM to reduce reflow)
      if (gallery.length > 1) wrap.appendChild(thumbsWrap);

      // BOM if any
      if (matchedId === 'lixby-one' && Array.isArray(p.bom)) {
        const tableWrap = document.createElement('div'); tableWrap.style.marginTop='18px';
        const note = document.createElement('div'); note.textContent = 'Lista de componentes (BOM)'; note.style.fontWeight='700'; note.style.marginBottom='8px'; note.style.color='var(--muted)';
        tableWrap.appendChild(note);
        const table = document.createElement('table'); table.className='bom';
        const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Componente / Parte</th></tr>'; table.appendChild(thead);
        const tbody = document.createElement('tbody');
        p.bom.forEach(row => { const tr = document.createElement('tr'); const td1 = document.createElement('td'); td1.textContent = row[0]; tr.appendChild(td1); tbody.appendChild(tr); });
        table.appendChild(tbody); tableWrap.appendChild(table); info.appendChild(tableWrap);
      }

      if (matchedId === 'lixby-one') {
        const detail = document.createElement('div'); detail.className = 'detail-block';
        detail.innerHTML = `<h3>M√°s sobre ${p.name}</h3><p>Detalles t√©cnicos y caracter√≠sticas clave para usuarios avanzados.</p>`;
        info.appendChild(detail);
      }

      // Notify firebase module & others
      window.dispatchEvent(new CustomEvent('productRendered', { detail: { id: p.id||matchedId } }));
      showDebug('Producto renderizado: ' + matchedId);

      // Insert structured data JSON-LD (SEO, no pide recursos)
      try {
        const ld = {
          "@context": "https://schema.org/",
          "@type": "Product",
          "name": p.name,
          "image": [ p.image ],
          "description": p.description || '',
          "sku": p.id,
          "offers": {
            "@type": "Offer",
            "priceCurrency": "EUR",
            "price": parsePriceToNumber(p.price).toFixed(2),
            "availability": "https://schema.org/InStock"
          }
        };
        const s = document.createElement('script'); s.type = 'application/ld+json'; s.textContent = JSON.stringify(ld);
        document.head.appendChild(s);
      } catch(e){}
    } catch(err) {
      showDebug('Error en script: ' + (err && err.message ? err.message : String(err)));
      const pd = document.getElementById('productDetail');
      if (pd) pd.innerHTML = '<div style="padding:20px;"><h2>Error cargando la ficha</h2><p>Mira la consola para m√°s detalles.</p></div>';
    }

    // Ajuste padding header (defensivo)
    try {
      const header = document.querySelector('.nav');
      if (header) {
        const updatePad = () => {
          const pad = Math.round(header.getBoundingClientRect().height + 12);
          document.body.style.paddingTop = pad + 'px';
        };
        updatePad();
        let t;
        window.addEventListener('resize', ()=> { clearTimeout(t); t = setTimeout(updatePad, 120); });
      }
    } catch(e){}

    // -------------------------
    // Lazy-load Firebase only when needed (fav) ‚Äî evita bloquear carga
    // -------------------------
    (function(){
      let firebaseLoaded = false;
      let firebaseInitializing = false;
      let fb = { app: null, auth: null, db: null, currentUser: null };

      async function loadFirebase(){
        if (firebaseLoaded) return fb;
        if (firebaseInitializing) {
          // wait until loaded
          return new Promise((res) => {
            const i = setInterval(() => { if (firebaseLoaded) { clearInterval(i); res(fb); } }, 80);
          });
        }
        firebaseInitializing = true;
        try {
          // dynamic import of modules (only when user interacts)
          const [appMod, authMod, dbMod] = await Promise.all([
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js'),
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js'),
            import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js')
          ]);
          const { initializeApp, getApps, getApp } = appMod;
          const { getAuth, onAuthStateChanged } = authMod;
          const { getFirestore, doc, getDoc, setDoc, deleteDoc } = dbMod;

          const firebaseConfig = {
            apiKey: "AIzaSyDMcDeBKSGqf9ZEexQAIM-9u6GLaQEnLcs",
            authDomain: "lixby-e0344.firebaseapp.com",
            projectId: "lixby-e0344",
            storageBucket: "lixby-e0344.firebasestorage.app",
            messagingSenderId: "671722866179",
            appId: "1:671722866179:web:65868eca5146942b507036",
            measurementId: "G-09SQL30MS8"
          };

          const app = (getApps() && getApps().length) ? getApp() : initializeApp(firebaseConfig);
          const auth = getAuth(app);
          const db = getFirestore(app);

          fb.app = app; fb.auth = auth; fb.db = db; fb.doc = doc; fb.getDoc = getDoc; fb.setDoc = setDoc; fb.deleteDoc = deleteDoc;

          // subscribe to auth state
          onAuthStateChanged(auth, (user) => { fb.currentUser = user; });

          firebaseLoaded = true; firebaseInitializing = false;
          return fb;
        } catch(err){
          firebaseInitializing = false;
          console.error('Firebase load failed', err);
          throw err;
        }
      }

      // graceful handler for toggleFavorite events
      window.addEventListener('toggleFavorite', async (ev) => {
        const detail = ev.detail || {};
        if (!detail || !detail.id) return;
        try {
          await loadFirebase();
        } catch(e){ alert('No se pudo inicializar el servicio de favoritos. Revisa la consola.'); return; }

        // now we have fb with methods
        const uid = fb.currentUser && fb.currentUser.uid;
        if (!uid){
          const go = confirm('Debes iniciar sesi√≥n para guardar favoritos. ¬øIr a la p√°gina de cuenta para iniciar sesi√≥n?');
          if (go) window.location.href = 'cuenta.html';
          return;
        }

        const favDocRef = (u, pid) => fb.doc(fb.db, 'users', u, 'favorites', pid);
        const pid = detail.id;
        const btn = document.getElementById('favBtn');
        try {
          const ref = favDocRef(uid, pid);
          const snap = await fb.getDoc(ref);
          if (snap.exists()){
            await fb.deleteDoc(ref);
            if (btn) { btn.innerHTML = '‚ô° Favorito'; btn.dataset.favorited = 'false'; btn.setAttribute('aria-pressed','false'); }
            alert('Eliminado de favoritos');
          } else {
            await fb.setDoc(ref, { id: detail.id, name: detail.name || '', price: detail.price || '', image: detail.image || '', createdAt: new Date().toISOString() });
            if (btn) { btn.innerHTML = '‚ô• Favorito'; btn.dataset.favorited = 'true'; btn.setAttribute('aria-pressed','true'); }
            alert('A√±adido a favoritos');
          }
        } catch(err){ console.error('toggleFavorite err', err); alert('Error guardando favorito. Revisa la consola.'); }
      });

      // Also refresh the fav button state when productRendered fires (lazy-load only if needed)
      window.addEventListener('productRendered', async (ev) => {
        try {
          // only load firebase if user has logged in (fast check via cookie/local) - we avoid forcing load
          // We'll try to load firebase only if user interacts or if you explicitly call refreshFavButton
        } catch(e){}
      });

      // small API if you want to explicitly refresh favorites
      window.__LIXBY_FIREBASE = { load: loadFirebase };
    })();

  })();
  </script>

  <!-- tu script principal (defer) -->
  <script src="script.js" defer></script>

  <script>
    try { document.getElementById('year').textContent = new Date().getFullYear(); } catch(e){}
  </script>
</body>
</html>
