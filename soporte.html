<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIXBY ‚Äî Soporte t√©cnico</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ... (tu CSS tal cual lo ten√≠as) ... */
    /* Ajustes de p√°gina (mantener estilo minimalista) */
    main { padding-top: calc(var(--header-height,72px) + 18px); max-width:1100px; margin:0 auto; }
    .support-hero { padding:28px; border-radius:12px; display:flex; gap:20px; align-items:center; justify-content:space-between; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .support-hero h1 { margin:0; font-size:1.4rem; }
    .support-columns { display:grid; grid-template-columns: 1fr 380px; gap:22px; margin-top:28px; }
    @media(max-width:900px){ .support-columns { grid-template-columns: 1fr; } }

    /* KB */
    .kb { display:flex; flex-direction:column; gap:12px; }
    .kb-item { border-radius:10px; padding:12px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.03); }
    .kb-item summary { cursor:pointer; font-weight:700; list-style:none; }
    .kb-item summary::after { content:" ‚ñæ"; font-weight:400; color:var(--muted); margin-left:6px; }
    .kb-item[open] summary::after { content:" ‚ñ¥"; }

    /* ticket form */
    .ticket-form { display:flex; flex-direction:column; gap:10px; padding:14px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.03); }
    .ticket-form input, .ticket-form textarea, .ticket-form select { padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); }
    .ticket-meta { font-size:0.9rem; color:var(--muted); margin-top:6px; }

    /* file dropzone */
    .dropzone { border: 2px dashed rgba(255,255,255,0.04); padding:12px; border-radius:10px; display:flex; align-items:center; gap:12px; justify-content:space-between; cursor:pointer; background: rgba(255,255,255,0.005); }
    .dz-info { color:var(--muted); font-size:0.95rem; }
    .attachments { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .attach-item { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.03); }
    .attach-meta { display:flex; gap:8px; align-items:center; }
    .attach-thumb { width:44px; height:44px; border-radius:6px; object-fit:cover; background:rgba(255,255,255,0.02); display:inline-block; }

    /* progress */
    .progress-wrap { width:100%; background: rgba(255,255,255,0.02); border-radius:8px; overflow:hidden; height:10px; margin-top:6px; }
    .progress-bar { height:100%; width:0%; background:linear-gradient(90deg,var(--accent), color-mix(in oklab, var(--accent) 60%, #fff 40%)); transition: width .18s ease; }

    .ticket-success { display:none; padding:10px; border-radius:8px; background: rgba(10,132,255,0.08); color:var(--accent); font-weight:700; }

    .tickets-list { margin-top:18px; display:flex; flex-direction:column; gap:10px; }
    .ticket-card { padding:12px; border-radius:10px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.03); display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .ticket-meta-compact { color:var(--muted); font-size:0.92rem; }

    .btn-outline { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer; }
    .muted { color:var(--muted); font-size:0.95rem; }
  </style>
</head>
<body>
  <!-- header minimal (compatible con index) -->
  <header class="nav glass" role="banner">
    <div class="nav-inner">
      <div class="nav-left"><div class="brand" role="button" onclick="location.href='index.html'">LIXBY</div></div>
      <nav id="navLinks" role="navigation" aria-label="Principal">
        <a href="index.html#inicio">Inicio</a>
        <a href="index.html#productos">Productos</a>
        <a href="faq.html">FAQ</a>
      </nav>
      <div class="nav-right">
        <button class="btn ghost" onclick="location.href='cuenta.html'">Cuenta</button>
        <button class="btn ghost" id="themeToggleSmall">‚óê</button>
      </div>
    </div>
  </header>

  <main id="maincontent" class="reveal">
    <div class="support-hero glass">
      <div>
        <h1>Soporte t√©cnico</h1>
        <p style="margin:6px 0 0;color:var(--muted)">Abrir un ticket con logs y archivos adjuntos ayuda a diagnosticar m√°s r√°pido. Adjunta capturas, registros (.txt, .log) o un ZIP.</p>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700;color:var(--accent)">Horario de soporte</div>
        <div class="ticket-meta">Lun ‚Äì Vie ‚Ä¢ 09:00 ‚Äì 18:00 (CEST)</div>
      </div>
    </div>

    <div class="support-columns" role="region" aria-label="Secci√≥n de soporte">
      <!-- Left: Knowledge base -->
      <section aria-labelledby="kb-title">
        <h2 id="kb-title">Resoluci√≥n r√°pida & base de conocimientos</h2>
        <div class="kb" role="list">
          <details class="kb-item" role="listitem" open>
            <summary>Mi dispositivo no enciende</summary>
            <div>
              <ol style="margin:8px 0 0 18px;color:var(--muted)">
                <li>Comprueba el cargador y el conector.</li>
                <li>Mant√©n pulsado el bot√≥n de encendido 12s.</li>
                <li>Prueba reinicio por hardware (consulta manual).</li>
              </ol>
              <p style="margin-top:8px;color:var(--muted)">Si no funciona, abre un ticket y adjunta fotos del puerto y el LED.</p>
            </div>
          </details>

          <details class="kb-item" role="listitem">
            <summary>Problemas de red</summary>
            <div>
              <ul style="margin:8px 0 0 18px;color:var(--muted)">
                <li>Reinicia router + dispositivo.</li>
                <li>Comprueba otras redes / hotspots.</li>
                <li>Incluye logs de red si abres un ticket.</li>
              </ul>
            </div>
          </details>

          <details class="kb-item" role="listitem">
            <summary>Audio o micr√≥fono con ruido</summary>
            <div>
              <p style="color:var(--muted)">Deshabilita Bluetooth de otros dispositivos y prueba con accesorio cableado. Adjunta grabaci√≥n de prueba si es posible.</p>
            </div>
          </details>
        </div>

        <hr style="margin:18px 0;border:none;height:1px;background:rgba(255,255,255,0.03)" />

        <div class="muted">Enlaces r√°pidos</div>
        <div style="display:flex;gap:12px;margin-top:8px;">
          <a class="btn-outline" href="faq.html">FAQ</a>
          <a class="btn-outline" href="envios.html">Env√≠os</a>
          <a class="btn-outline" href="contacto.html">Contacto</a>
        </div>

        <!-- Listado local de tickets (persistente) -->
        <div style="margin-top:18px">
          <h3>Tus tickets recientes</h3>
          <div id="ticketsList" class="tickets-list" aria-live="polite"></div>
        </div>
      </section>

      <!-- Right: Ticket form -->
      <aside aria-labelledby="ticket-title">
        <h2 id="ticket-title">Abrir un ticket</h2>

        <form id="ticketForm" class="ticket-form" aria-label="Formulario para abrir ticket" enctype="multipart/form-data" onsubmit="return false;">
          <!-- Hidden fields required by template -->
          <!-- Cambia soporte@lixby.com por el correo real de soporte si lo deseas -->
          <input type="hidden" name="to_email" value="soporte@lixby.com" />
          <input type="hidden" name="to" value="soporte@lixby.com" />
          <input type="hidden" name="reply_to" id="replyToHidden" value="" />
          <input type="hidden" name="from_name" id="fromNameHidden" value="" />
          <input type="hidden" name="ticket_id" id="ticketIdHidden" value="" />

          <input id="t-name" name="from_name_visible" type="text" placeholder="Tu nombre" required autocomplete="name" />
          <input id="t-email" name="from_email" type="email" placeholder="tu@correo.com" required autocomplete="email" />
          <select id="t-product" name="product" aria-label="Selecciona producto">
            <option value="">Producto (opcional)</option>
            <option value="lixby-one-air">Lixby One Air</option>
            <option value="lixby-one">Lixby One</option>
            <option value="lixby-one-pro">Lixby One Pro</option>
          </select>
          <textarea id="t-desc" name="description" rows="6" placeholder="Describe el problema con la mayor brevedad posible" required></textarea>

          <!-- Attachments: drag & drop + file input -->
          <label for="fileInput" class="dropzone" id="dropzone" tabindex="0" role="button" aria-label="Area para adjuntar archivos">
            <div class="dz-info">Arrastra archivos aqu√≠ o haz clic para a√±adir (m√°x 5 archivos, 10MB total)</div>
            <div class="muted">Adjuntos</div>
            <input id="fileInput" name="attachments" type="file" accept=".png,.jpg,.jpeg,.webp,.txt,.log,.zip,.pdf" multiple style="display:none" />
          </label>

          <div id="attachments" class="attachments" aria-live="polite"></div>

          <div class="progress-wrap" style="display:none" id="uploadProgressWrap" aria-hidden="true">
            <div class="progress-bar" id="uploadProgressBar"></div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <button id="submitTicket" class="btn primary" type="button">Enviar ticket</button>
            <div style="display:flex;gap:8px">
              <button id="attachLog" class="btn ghost" type="button" title="Adjuntar registro (demo)">Adjuntar registro</button>
              <button id="clearForm" class="btn ghost" type="button">Limpiar</button>
            </div>
          </div>

          <div id="ticketInfo" class="ticket-meta" aria-live="polite"></div>
          <div id="ticketSuccess" class="ticket-success" role="status" aria-live="polite">Ticket creado ‚Äî ID: <span id="ticketId"></span></div>
        </form>
      </aside>
    </div>
  </main>

  <footer class="footer glass" role="contentinfo" style="text-align:center;padding:20px;margin-top:36px;">
    <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div><strong class="footer-brand">LIXBY</strong> <div class="muted">Soporte t√©cnico ‚Äî ¬© <span id="yearSupport"></span></div></div>
      <div style="display:flex;gap:12px;align-items:center"><a href="faq.html">FAQ</a><a href="contacto.html">Contacto</a></div>
    </div>
  </footer>

  <!-- EmailJS SDK (lazy load inside script) -->
  <script>
  (function(){
    // ---------- CONFIG: pon aqu√≠ tus credenciales EmailJS ----------
    const EMAILJS_USER_ID = 'xsKpaFjbRsS95AK3i';        // tu USER ID
    const EMAILJS_SERVICE_ID = 'service_tagcpgm';       // tu SERVICE ID
    const EMAILJS_TEMPLATE_ID_SUPPORT = 'template_oxwjyfc'; // template usado para enviar a soporte (con adjuntos)
    const EMAILJS_TEMPLATE_ID_CONFIRM = 'template_oxwjyfc'; // template para confirmaci√≥n al cliente (puede ser el mismo o otro)
    const SUPPORT_EMAIL = 'soporte@lixby.com';          // correo destino que recibir√° los tickets (puedes cambiar)
    // ----------------------------------------------------------------

    const MAX_FILES = 5;
    const MAX_TOTAL_BYTES = 10 * 1024 * 1024; // 10 MB
    const ALLOWED_EXT = ['png','jpg','jpeg','webp','txt','log','zip','pdf'];

    // Elementos DOM
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const attachmentsEl = document.getElementById('attachments');
    const submitBtn = document.getElementById('submitTicket');
    const attachLogBtn = document.getElementById('attachLog');
    const clearBtn = document.getElementById('clearForm');
    const infoEl = document.getElementById('ticketInfo');
    const successEl = document.getElementById('ticketSuccess');
    const ticketIdSpan = document.getElementById('ticketId');
    const progressWrap = document.getElementById('uploadProgressWrap');
    const progressBar = document.getElementById('uploadProgressBar');
    const ticketsList = document.getElementById('ticketsList');
    const ticketForm = document.getElementById('ticketForm');

    const replyToHidden = document.getElementById('replyToHidden');
    const fromNameHidden = document.getElementById('fromNameHidden');
    const ticketIdHidden = document.getElementById('ticketIdHidden');

    // State
    let attachedFiles = [];

    // Utilities
    function fmtBytes(n){ if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(2)+' MB'; }
    // Mejor ID: LIXBY-YYYYMMDD-XXXXXX
    function genTicketId(){
      const d = new Date();
      const Y = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const rnd = Array.from(crypto.getRandomValues(new Uint8Array(4))).map(b => (b % 36).toString(36)).join('').toUpperCase().slice(0,6);
      return `LIXBY-${Y}${mm}${dd}-${rnd}`;
    }
    function sanitizeFilename(name){ return name.replace(/[^a-zA-Z0-9._-]/g,'_').slice(0,120); }

    // Render attachments
    function renderAttachments(){
      attachmentsEl.innerHTML = '';
      if (attachedFiles.length === 0) return;
      attachedFiles.forEach((f, idx) => {
        const item = document.createElement('div');
        item.className = 'attach-item';
        const meta = document.createElement('div');
        meta.className = 'attach-meta';
        if (f.type && f.type.startsWith('image/')) {
          const img = document.createElement('img'); img.className = 'attach-thumb'; img.alt = f.name;
          img.src = f.objectURL || URL.createObjectURL(f);
          meta.appendChild(img);
        } else {
          const placeholder = document.createElement('div'); placeholder.className = 'attach-thumb'; placeholder.style.display='flex'; placeholder.style.alignItems='center'; placeholder.style.justifyContent='center'; placeholder.textContent = 'üìÑ';
          meta.appendChild(placeholder);
        }
        const txt = document.createElement('div');
        txt.innerHTML = `<div style="font-weight:700">${sanitizeFilename(f.name)}</div><div class="muted">${fmtBytes(f.size)} ‚Ä¢ ${f.type||'‚Äî'}</div>`;
        meta.appendChild(txt);

        const right = document.createElement('div');
        const remove = document.createElement('button'); remove.className='btn-outline'; remove.type='button'; remove.textContent='Eliminar';
        remove.addEventListener('click', ()=>{ 
          if (f.objectURL) try { URL.revokeObjectURL(f.objectURL); } catch(e){}
          attachedFiles.splice(idx,1); renderAttachments(); 
        });
        right.appendChild(remove);

        item.appendChild(meta);
        item.appendChild(right);
        attachmentsEl.appendChild(item);
      });

      const totalBytes = attachedFiles.reduce((s,f)=> s + (f.size || 0), 0);
      const totalNote = document.createElement('div');
      totalNote.className = 'muted';
      totalNote.textContent = `Archivos: ${attachedFiles.length} ‚Äî Total: ${fmtBytes(totalBytes)}`;
      attachmentsEl.appendChild(totalNote);
    }

    // Add files (validate)
    function addFiles(files){
      let arr = Array.from(files || []);
      const totalNow = attachedFiles.reduce((s,f)=> s + (f.size||0), 0);
      const totalIncoming = arr.reduce((s,f)=> s + (f.size||0), 0);
      if (attachedFiles.length + arr.length > MAX_FILES) {
        alert(`M√°ximo ${MAX_FILES} archivos.`);
        return;
      }
      if (totalNow + totalIncoming > MAX_TOTAL_BYTES) {
        alert(`Tama√±o total excede ${fmtBytes(MAX_TOTAL_BYTES)}.`);
        return;
      }
      arr = arr.filter(f => {
        const ext = (f.name.split('.').pop() || '').toLowerCase();
        if (ALLOWED_EXT.includes(ext)) return true;
        if (f.type && (f.type.startsWith('image/') || f.type === 'text/plain' || f.type === 'application/pdf' || f.type === 'application/zip')) return true;
        return false;
      });
      arr.forEach(f => {
        f.objectURL = URL.createObjectURL(f);
        attachedFiles.push(f);
      });
      renderAttachments();
    }

    // Dropzone
    dropzone.addEventListener('click', ()=> fileInput.click());
    dropzone.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); } });
    dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.style.borderColor = 'var(--accent)'; });
    dropzone.addEventListener('dragleave', (e)=>{ dropzone.style.borderColor = ''; });
    dropzone.addEventListener('drop', (e)=>{ e.preventDefault(); dropzone.style.borderColor = ''; addFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', (e)=> addFiles(e.target.files));

    // Attach demo log
    attachLogBtn.addEventListener('click', () => {
      const now = new Date().toISOString();
      const content = `Log demo LIXBY\nFecha: ${now}\nNivel: INFO\nMensaje: Ejemplo de registro para diagn√≥stico.\n`;
      const blob = new Blob([content], { type:'text/plain' });
      const f = new File([blob], `lixby-log-${Date.now()}.txt`, { type:'text/plain' });
      f.objectURL = URL.createObjectURL(f);
      attachedFiles.push(f);
      renderAttachments();
      infoEl.textContent = 'Registro de diagn√≥stico adjuntado (demo).';
    });

    clearBtn.addEventListener('click', () => {
      attachedFiles.forEach(f => f.objectURL && URL.revokeObjectURL(f));
      attachedFiles = [];
      document.getElementById('t-desc').value = '';
      document.getElementById('t-product').value = '';
      document.getElementById('t-name').value = '';
      document.getElementById('t-email').value = '';
      renderAttachments();
      infoEl.textContent = '';
    });

    // Local storage for tickets (fallback)
    const STORAGE_KEY = 'lixby_support_tickets_v2';
    function loadTickets(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch(e){ return []; } }
    function saveTickets(arr){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); } catch(e){} }
    function renderTickets(){
      ticketsList.innerHTML = '';
      const arr = loadTickets().slice(0,10);
      if (!arr.length) { ticketsList.innerHTML = '<div class="muted">No hay tickets recientes.</div>'; return; }
      arr.forEach(t => {
        const card = document.createElement('div'); card.className = 'ticket-card';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:700">${t.title || sanitizeFilename((t.description||'').slice(0,40) || t.product || 'Ticket')}</div>
                          <div class="ticket-meta-compact">ID: ${t.id} ‚Ä¢ ${t.status} ‚Ä¢ ${new Date(t.createdAt).toLocaleString()}</div>`;
        const right = document.createElement('div');
        const view = document.createElement('button'); view.className='btn-outline'; view.textContent='Ver';
        view.addEventListener('click', ()=> showTicketDetail(t.id));
        right.appendChild(view);
        card.appendChild(left); card.appendChild(right);
        ticketsList.appendChild(card);
      });
    }

    function showTicketDetail(id){
      const arr = loadTickets();
      const t = arr.find(x=>x.id===id);
      if (!t) return alert('Ticket no encontrado (demo).');
      const detail = `
ID: ${t.id}
Nombre: ${t.name || '‚Äî'}
Email: ${t.email || '‚Äî'}
Producto: ${t.product || '‚Äî'}
Estado: ${t.status}
Creado: ${new Date(t.createdAt).toLocaleString()}

Descripci√≥n:
${t.description}

Adjuntos: ${t.attachments ? t.attachments.length : 0} (si guardado localmente)
`;
      alert(detail);
    }

    // ---------- EmailJS ----------
    let emailJsLoaded = false;
    async function ensureEmailJs(){
      if (emailJsLoaded && window.emailjs && typeof window.emailjs.sendForm === 'function') return;
      await new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js';
        s.crossOrigin = 'anonymous';
        s.onload = res;
        s.onerror = () => rej(new Error('EmailJS load failed'));
        document.head.appendChild(s);
      });
      try {
        if (window.emailjs && typeof emailjs.init === 'function') {
          emailjs.init(EMAILJS_USER_ID);
          emailJsLoaded = true;
        }
      } catch(e){
        console.warn('EmailJS init failed', e);
      }
    }

    // send with form (attachments)
    async function sendSupportEmail(formEl){
      await ensureEmailJs();
      if (!window.emailjs || typeof emailjs.sendForm !== 'function') throw new Error('EmailJS SDK no disponible (sendForm)');
      return emailjs.sendForm(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_SUPPORT, formEl);
    }
    // send confirmation to user (no attachments, faster)
    async function sendConfirmationToCustomer(params){
      await ensureEmailJs();
      if (!window.emailjs || typeof emailjs.send !== 'function') throw new Error('EmailJS SDK no disponible (send)');
      return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_CONFIRM, params);
    }

    // Submit handler
    submitBtn.addEventListener('click', async () => {
      infoEl.textContent = '';
      successEl.style.display = 'none';
      const name = document.getElementById('t-name').value.trim();
      const email = document.getElementById('t-email').value.trim();
      const product = document.getElementById('t-product').value;
      const description = document.getElementById('t-desc').value.trim();

      if (!name || !email || !description) {
        infoEl.style.color = '#ffb4b4';
        infoEl.textContent = 'Completa nombre, correo y descripci√≥n.';
        return;
      }

      const totalBytes = attachedFiles.reduce((s,f)=> s + (f.size||0), 0);
      if (totalBytes > MAX_TOTAL_BYTES) {
        infoEl.style.color = '#ffb4b4';
        infoEl.textContent = `Tama√±o total de adjuntos excede ${fmtBytes(MAX_TOTAL_BYTES)}.`;
        return;
      }

      // Prepare IDs and hidden fields
      const ticketId = genTicketId();
      if (replyToHidden) replyToHidden.value = email;
      if (fromNameHidden) fromNameHidden.value = name;
      if (ticketIdHidden) ticketIdHidden.value = ticketId;
      if (ticketIdSpan) ticketIdSpan.textContent = ticketId;

      // Try to sync fileInput.files with attachedFiles via DataTransfer (best-effort)
      try {
        if (attachedFiles.length > 0) {
          const dt = new DataTransfer();
          attachedFiles.forEach(f => dt.items.add(new File([f], f.name, { type: f.type })));
          fileInput.files = dt.files;
        }
      } catch (e) {
        console.warn('No se pudo sincronizar fileInput con attachedFiles', e);
      }

      // Disable UI
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';
      progressWrap.style.display = 'block';
      progressWrap.setAttribute('aria-hidden','false');
      progressBar.style.width = '4%';

      // Local ticket fallback
      const localTicket = {
        id: ticketId,
        name, email, product, description,
        attachments: attachedFiles.map(f => ({ name: sanitizeFilename(f.name), size: f.size, type: f.type })),
        createdAt: new Date().toISOString(),
        status: 'pendiente-offline'
      };

      // 1) Enviar a soporte (con adjuntos) mediante sendForm
      let supportSendOk = false;
      try {
        // ensure support target filled
        ticketForm.querySelector('input[name="to_email"]').value = SUPPORT_EMAIL;
        ticketForm.querySelector('input[name="to"]').value = SUPPORT_EMAIL;

        progressBar.style.width = '12%';
        const resp = await sendSupportEmail(ticketForm);
        supportSendOk = true;
        progressBar.style.width = '70%';
        console.log('Support send response:', resp);
        // persist with server-like id if available
        const serverId = (resp && resp.text) ? resp.text : ticketId;
        const ticketSaved = {...localTicket, id: serverId, status: 'enviado-soporte', serverResponse: resp};
        const arr = loadTickets(); arr.unshift(ticketSaved); saveTickets(arr); renderTickets();
      } catch (err) {
        console.error('EmailJS sendForm (soporte) fallo:', err);
        // save local fallback (still will try confirmation)
        const arr = loadTickets(); arr.unshift(localTicket); saveTickets(arr); renderTickets();
      }

      // 2) Enviar confirmaci√≥n al cliente (sin adjuntos) via emailjs.send
      try {
        progressBar.style.width = supportSendOk ? '85%' : '40%';
        const params = {
          from_name: name,
          from_email: email,
          description: description,
          ticket_id: ticketId,
          product: product || 'No indicado',
          to_email: email,     // si tu plantilla usa to_email variable
          reply_to: SUPPORT_EMAIL
        };
        const resp2 = await sendConfirmationToCustomer(params);
        console.log('Confirm send response:', resp2);
        // show success
        ticketIdSpan.textContent = ticketId;
        successEl.style.display = 'block';
        infoEl.style.color = 'var(--muted)';
        infoEl.textContent = 'Ticket enviado correctamente. Has recibido un correo de confirmaci√≥n.';
      } catch (err) {
        console.error('EmailJS confirm failed:', err);
        // still show fallback message
        ticketIdSpan.textContent = ticketId;
        successEl.style.display = 'block';
        infoEl.style.color = '#ffb4b4';
        infoEl.textContent = 'No se pudo enviar por email (EmailJS). Ticket guardado localmente.';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar ticket';
        progressWrap.style.display = 'none';
        progressBar.style.width = '0%';
        attachedFiles.forEach(f => f.objectURL && URL.revokeObjectURL(f));
        attachedFiles = [];
        renderAttachments();
        document.getElementById('t-desc').value = '';
        setTimeout(()=> { successEl.style.display = 'none'; ticketIdSpan.textContent = ''; }, 7000);
      }
    });

    // Initialize
    document.getElementById('yearSupport').textContent = new Date().getFullYear();
    renderTickets();

    // Reintento pendiente cuando online (env√≠o sin adjuntos para los pendientes)
    window.addEventListener('online', async () => {
      const arr = loadTickets();
      const pending = arr.filter(t => t.status && t.status.startsWith('pendiente'));
      if (!pending.length) return;
      infoEl.style.color = 'var(--muted)';
      infoEl.textContent = `Hay ${pending.length} ticket(s) pendientes. Reintentando env√≠o...`;
      for (const t of pending) {
        try {
          await ensureEmailJs();
          if (!window.emailjs || typeof emailjs.send !== 'function') continue;
          const params = {
            from_name: t.name || '',
            from_email: t.email || '',
            description: t.description || '',
            ticket_id: t.id || genTicketId(),
            product: t.product || '',
            to_email: SUPPORT_EMAIL,
            reply_to: t.email || ''
          };
          const resp = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID_SUPPORT, params);
          t.status = 'recibido';
          t.serverResponse = resp;
        } catch(e){
          console.warn('Retry ticket failed', e);
        }
      }
      saveTickets(arr);
      renderTickets();
      infoEl.textContent = 'Reintento completado (demo).';
    });

    // theme toggle
    document.getElementById('themeToggleSmall')?.addEventListener('click', () => {
      const isLight = document.documentElement.classList.toggle('light');
      try { localStorage.setItem('lixby_theme', isLight ? 'light' : 'dark'); }catch(e){}
    });

  })();
  </script>
</body>
</html>
