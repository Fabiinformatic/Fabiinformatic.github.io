<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIXBY ‚Äî Soporte t√©cnico</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* Ajustes de p√°gina (mantener estilo minimalista) */
    main { padding-top: calc(var(--header-height,72px) + 18px); max-width:1100px; margin:0 auto; }
    .support-hero { padding:28px; border-radius:12px; display:flex; gap:20px; align-items:center; justify-content:space-between; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .support-hero h1 { margin:0; font-size:1.4rem; }
    .support-columns { display:grid; grid-template-columns: 1fr 380px; gap:22px; margin-top:28px; }
    @media(max-width:900px){ .support-columns { grid-template-columns: 1fr; } }

    /* KB */
    .kb { display:flex; flex-direction:column; gap:12px; }
    .kb-item { border-radius:10px; padding:12px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.03); }
    .kb-item summary { cursor:pointer; font-weight:700; list-style:none; }
    .kb-item summary::after { content:" ‚ñæ"; font-weight:400; color:var(--muted); margin-left:6px; }
    .kb-item[open] summary::after { content:" ‚ñ¥"; }

    /* ticket form */
    .ticket-form { display:flex; flex-direction:column; gap:10px; padding:14px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.03); }
    .ticket-form input, .ticket-form textarea, .ticket-form select { padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); }
    .ticket-meta { font-size:0.9rem; color:var(--muted); margin-top:6px; }

    /* file dropzone */
    .dropzone { border: 2px dashed rgba(255,255,255,0.04); padding:12px; border-radius:10px; display:flex; align-items:center; gap:12px; justify-content:space-between; cursor:pointer; background: rgba(255,255,255,0.005); }
    .dz-info { color:var(--muted); font-size:0.95rem; }
    .attachments { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .attach-item { display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.03); }
    .attach-meta { display:flex; gap:8px; align-items:center; }
    .attach-thumb { width:44px; height:44px; border-radius:6px; object-fit:cover; background:rgba(255,255,255,0.02); display:inline-block; }

    /* progress */
    .progress-wrap { width:100%; background: rgba(255,255,255,0.02); border-radius:8px; overflow:hidden; height:10px; margin-top:6px; }
    .progress-bar { height:100%; width:0%; background:linear-gradient(90deg,var(--accent), color-mix(in oklab, var(--accent) 60%, #fff 40%)); transition: width .18s ease; }

    .ticket-success { display:none; padding:10px; border-radius:8px; background: rgba(10,132,255,0.08); color:var(--accent); font-weight:700; }

    .tickets-list { margin-top:18px; display:flex; flex-direction:column; gap:10px; }
    .ticket-card { padding:12px; border-radius:10px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.03); display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .ticket-meta-compact { color:var(--muted); font-size:0.92rem; }

    .btn-outline { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer; }
    .muted { color:var(--muted); font-size:0.95rem; }
  </style>
</head>
<body>
  <!-- header minimal (compatible con index) -->
  <header class="nav glass" role="banner">
    <div class="nav-inner">
      <div class="nav-left"><div class="brand" role="button" onclick="location.href='index.html'">LIXBY</div></div>
      <nav id="navLinks" role="navigation" aria-label="Principal">
        <a href="index.html#inicio">Inicio</a>
        <a href="index.html#productos">Productos</a>
        <a href="faq.html">FAQ</a>
      </nav>
      <div class="nav-right">
        <button class="btn ghost" onclick="location.href='cuenta.html'">Cuenta</button>
        <button class="btn ghost" id="themeToggleSmall">‚óê</button>
      </div>
    </div>
  </header>

  <main id="maincontent" class="reveal">
    <div class="support-hero glass">
      <div>
        <h1>Soporte t√©cnico</h1>
        <p style="margin:6px 0 0;color:var(--muted)">Abrir un ticket con logs y archivos adjuntos ayuda a diagnosticar m√°s r√°pido. Adjunta capturas, registros (.txt, .log) o un ZIP.</p>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700;color:var(--accent)">Horario de soporte</div>
        <div class="ticket-meta">Lun ‚Äì Vie ‚Ä¢ 09:00 ‚Äì 18:00 (CEST)</div>
      </div>
    </div>

    <div class="support-columns" role="region" aria-label="Secci√≥n de soporte">
      <!-- Left: Knowledge base -->
      <section aria-labelledby="kb-title">
        <h2 id="kb-title">Resoluci√≥n r√°pida & base de conocimientos</h2>
        <div class="kb" role="list">
          <details class="kb-item" role="listitem" open>
            <summary>Mi dispositivo no enciende</summary>
            <div>
              <ol style="margin:8px 0 0 18px;color:var(--muted)">
                <li>Comprueba el cargador y el conector.</li>
                <li>Mant√©n pulsado el bot√≥n de encendido 12s.</li>
                <li>Prueba reinicio por hardware (consulta manual).</li>
              </ol>
              <p style="margin-top:8px;color:var(--muted)">Si no funciona, abre un ticket y adjunta fotos del puerto y el LED.</p>
            </div>
          </details>

          <details class="kb-item" role="listitem">
            <summary>Problemas de red</summary>
            <div>
              <ul style="margin:8px 0 0 18px;color:var(--muted)">
                <li>Reinicia router + dispositivo.</li>
                <li>Comprueba otras redes / hotspots.</li>
                <li>Incluye logs de red si abres un ticket.</li>
              </ul>
            </div>
          </details>

          <details class="kb-item" role="listitem">
            <summary>Audio o micr√≥fono con ruido</summary>
            <div>
              <p style="color:var(--muted)">Deshabilita Bluetooth de otros dispositivos y prueba con accesorio cableado. Adjunta grabaci√≥n de prueba si es posible.</p>
            </div>
          </details>
        </div>

        <hr style="margin:18px 0;border:none;height:1px;background:rgba(255,255,255,0.03)" />

        <div class="muted">Enlaces r√°pidos</div>
        <div style="display:flex;gap:12px;margin-top:8px;">
          <a class="btn-outline" href="faq.html">FAQ</a>
          <a class="btn-outline" href="envios.html">Env√≠os</a>
          <a class="btn-outline" href="contacto.html">Contacto</a>
        </div>

        <!-- Listado local de tickets (persistente) -->
        <div style="margin-top:18px">
          <h3>Tus tickets recientes</h3>
          <div id="ticketsList" class="tickets-list" aria-live="polite"></div>
        </div>
      </section>

      <!-- Right: Ticket form -->
      <aside aria-labelledby="ticket-title">
        <h2 id="ticket-title">Abrir un ticket</h2>

        <!-- Nota: name="attachments" en el input para que EmailJS lo recoja -->
        <form id="ticketForm" class="ticket-form" aria-label="Formulario para abrir ticket" enctype="multipart/form-data" onsubmit="return false;">
          <input id="t-name" name="from_name" type="text" placeholder="Tu nombre" required autocomplete="name" />
          <input id="t-email" name="from_email" type="email" placeholder="tu@correo.com" required autocomplete="email" />
          <select id="t-product" name="product" aria-label="Selecciona producto">
            <option value="">Producto (opcional)</option>
            <option value="lixby-one-air">Lixby One Air</option>
            <option value="lixby-one">Lixby One</option>
            <option value="lixby-one-pro">Lixby One Pro</option>
          </select>
          <textarea id="t-desc" name="description" rows="6" placeholder="Describe el problema con la mayor brevedad posible" required></textarea>

          <!-- hidden ticket id (se asigna antes de enviar) -->
          <input type="hidden" id="t-id" name="ticket_id" value="">

          <!-- Attachments: drag & drop + file input -->
          <label for="fileInput" class="dropzone" id="dropzone" tabindex="0" role="button" aria-label="Area para adjuntar archivos">
            <div class="dz-info">Arrastra archivos aqu√≠ o haz clic para a√±adir (m√°x 5 archivos, 10MB total)</div>
            <div class="muted">Adjuntos</div>
            <input id="fileInput" name="attachments" type="file" accept=".png,.jpg,.jpeg,.webp,.txt,.log,.zip,.pdf" multiple style="display:none" />
          </label>

          <div id="attachments" class="attachments" aria-live="polite"></div>

          <div class="progress-wrap" style="display:none" id="uploadProgressWrap" aria-hidden="true">
            <div class="progress-bar" id="uploadProgressBar"></div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <button id="submitTicket" class="btn primary" type="button">Enviar ticket</button>
            <div style="display:flex;gap:8px">
              <button id="attachLog" class="btn ghost" type="button" title="Adjuntar registro (demo)">Adjuntar registro</button>
              <button id="clearForm" class="btn ghost" type="button">Limpiar</button>
            </div>
          </div>

          <div id="ticketInfo" class="ticket-meta" aria-live="polite"></div>
          <div id="ticketSuccess" class="ticket-success" role="status" aria-live="polite">Ticket creado ‚Äî ID: <span id="ticketId"></span></div>
        </form>
      </aside>
    </div>
  </main>

  <footer class="footer glass" role="contentinfo" style="text-align:center;padding:20px;margin-top:36px;">
    <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div><strong class="footer-brand">LIXBY</strong> <div class="muted">Soporte t√©cnico ‚Äî ¬© <span id="yearSupport"></span></div></div>
      <div style="display:flex;gap:12px;align-items:center"><a href="faq.html">FAQ</a><a href="contacto.html">Contacto</a></div>
    </div>
  </footer>

  <script>
  (function(){
    // ---------- CONFIG emailjs ----------
    const EMAILJS_USER_ID = 'xsKpaFjbRsS95AK3i';          // TU USER ID (me lo diste)
    const EMAILJS_SERVICE_ID = 'service_tagcpgm';         // TU SERVICE ID (me lo diste)
    const EMAILJS_TEMPLATE_ID = 'template_oxwjyfc';       // TU TEMPLATE SELECCIONADO (me lo diste)
    // Si quieres enviar adem√°s un auto-reply, coloca el template ID aqu√≠ (opcional).
    const EMAILJS_AUTO_REPLY_TEMPLATE = 'template_l1e0go2'; // opcional, cambia o pon '' para desactivar

    // L√çMITES y TIPOS
    const MAX_FILES = 5;
    const MAX_TOTAL_BYTES = 10 * 1024 * 1024; // 10 MB
    const ALLOWED_EXT = ['png','jpg','jpeg','webp','txt','log','zip','pdf'];

    // Elementos
    const form = document.getElementById('ticketForm');
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const attachmentsEl = document.getElementById('attachments');
    const submitBtn = document.getElementById('submitTicket');
    const attachLogBtn = document.getElementById('attachLog');
    const clearBtn = document.getElementById('clearForm');
    const infoEl = document.getElementById('ticketInfo');
    const successEl = document.getElementById('ticketSuccess');
    const ticketIdSpan = document.getElementById('ticketId');
    const progressWrap = document.getElementById('uploadProgressWrap');
    const progressBar = document.getElementById('uploadProgressBar');
    const ticketsList = document.getElementById('ticketsList');
    const hidTicketId = document.getElementById('t-id');

    // Estado
    let attachedFiles = [];

    // Helpers
    function fmtBytes(n){ if(n<1024) return n+' B'; if(n<1024*1024) return (n/1024).toFixed(1)+' KB'; return (n/1024/1024).toFixed(2)+' MB'; }
    function genTicketId(){ const d = new Date(); const y = String(d.getFullYear()).slice(2); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); const rnd = Math.random().toString(36).slice(2,6).toUpperCase(); return `LXB-${y}${mm}${dd}-${rnd}`; }
    function sanitizeFilename(name){ return name.replace(/[^a-zA-Z0-9._-]/g,'_').slice(0,120); }

    // Render attachments
    function renderAttachments(){
      attachmentsEl.innerHTML = '';
      if (attachedFiles.length === 0) return;
      attachedFiles.forEach((f, idx) => {
        const item = document.createElement('div');
        item.className = 'attach-item';
        const meta = document.createElement('div');
        meta.className = 'attach-meta';
        if (f.type && f.type.startsWith('image/')) {
          const img = document.createElement('img'); img.className = 'attach-thumb'; img.alt = f.name;
          img.src = f.objectURL || URL.createObjectURL(f);
          meta.appendChild(img);
        } else {
          const placeholder = document.createElement('div'); placeholder.className = 'attach-thumb'; placeholder.style.display='flex'; placeholder.style.alignItems='center'; placeholder.style.justifyContent='center'; placeholder.textContent = 'üìÑ';
          meta.appendChild(placeholder);
        }
        const txt = document.createElement('div');
        txt.innerHTML = `<div style="font-weight:700">${sanitizeFilename(f.name)}</div><div class="muted">${fmtBytes(f.size)} ‚Ä¢ ${f.type||'‚Äî'}</div>`;
        meta.appendChild(txt);

        const right = document.createElement('div');
        const remove = document.createElement('button'); remove.className='btn-outline'; remove.type='button'; remove.textContent='Eliminar';
        remove.addEventListener('click', ()=>{ if (f.objectURL) URL.revokeObjectURL(f.objectURL); attachedFiles.splice(idx,1); renderAttachments(); });
        right.appendChild(remove);

        item.appendChild(meta);
        item.appendChild(right);
        attachmentsEl.appendChild(item);
      });

      const totalBytes = attachedFiles.reduce((s,f)=> s + (f.size || 0), 0);
      const totalNote = document.createElement('div');
      totalNote.className = 'muted';
      totalNote.textContent = `Archivos: ${attachedFiles.length} ‚Äî Total: ${fmtBytes(totalBytes)}`;
      attachmentsEl.appendChild(totalNote);
    }

    // Agregar ficheros (validaci√≥n)
    function addFiles(files){
      let arr = Array.from(files);
      // enforce limits
      if (attachedFiles.length + arr.length > MAX_FILES) {
        alert(`M√°ximo ${MAX_FILES} archivos.`);
        return;
      }
      const totalNow = attachedFiles.reduce((s,f)=> s + (f.size||0), 0);
      const totalIncoming = arr.reduce((s,f)=> s + (f.size||0), 0);
      if (totalNow + totalIncoming > MAX_TOTAL_BYTES) {
        alert(`Tama√±o total excede ${fmtBytes(MAX_TOTAL_BYTES)}.`); return;
      }
      // filter by extension
      arr = arr.filter(f => {
        const ext = (f.name.split('.').pop() || '').toLowerCase();
        return ALLOWED_EXT.includes(ext);
      });
      arr.forEach(f => {
        f.objectURL = URL.createObjectURL(f);
        attachedFiles.push(f);
      });
      renderAttachments();
    }

    // Dropzone wiring
    dropzone.addEventListener('click', ()=> fileInput.click());
    dropzone.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); } });
    dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.style.borderColor = 'var(--accent)'; });
    dropzone.addEventListener('dragleave', (e)=>{ dropzone.style.borderColor = ''; });
    dropzone.addEventListener('drop', (e)=>{ e.preventDefault(); dropzone.style.borderColor = ''; addFiles(e.dataTransfer.files); });

    fileInput.addEventListener('change', (e)=> addFiles(e.target.files));

    // attach demo log
    attachLogBtn.addEventListener('click', () => {
      const now = new Date().toISOString();
      const content = `Log demo LIXBY\nFecha: ${now}\nNivel: INFO\nMensaje: Ejemplo de registro para diagn√≥stico.\n`;
      const blob = new Blob([content], { type:'text/plain' });
      const f = new File([blob], `lixby-log-${Date.now()}.txt`, { type:'text/plain' });
      f.objectURL = URL.createObjectURL(f);
      attachedFiles.push(f);
      renderAttachments();
      infoEl.textContent = 'Registro de diagn√≥stico adjuntado (demo).';
    });

    // clear form
    clearBtn.addEventListener('click', () => {
      attachedFiles.forEach(f => f.objectURL && URL.revokeObjectURL(f));
      attachedFiles = [];
      document.getElementById('t-desc').value = '';
      document.getElementById('t-product').value = '';
      document.getElementById('t-name').value = '';
      document.getElementById('t-email').value = '';
      renderAttachments();
      infoEl.textContent = '';
    });

    // Local persistence for tickets (backup)
    const STORAGE_KEY = 'lixby_support_tickets_v2';
    function loadTickets(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); } catch(e){ return []; } }
    function saveTickets(arr){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); } catch(e){} }
    function renderTickets(){
      ticketsList.innerHTML = '';
      const arr = loadTickets().slice(0,10);
      if (!arr.length) { ticketsList.innerHTML = '<div class="muted">No hay tickets recientes.</div>'; return; }
      arr.forEach(t => {
        const card = document.createElement('div'); card.className = 'ticket-card';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:700">${t.title || sanitizeFilename((t.description||'').slice(0,40) || t.product || 'Ticket')}</div>
                          <div class="ticket-meta-compact">ID: ${t.id} ‚Ä¢ ${t.status} ‚Ä¢ ${new Date(t.createdAt).toLocaleString()}</div>`;
        const right = document.createElement('div');
        const view = document.createElement('button'); view.className='btn-outline'; view.textContent='Ver';
        view.addEventListener('click', ()=> showTicketDetail(t.id));
        right.appendChild(view);
        card.appendChild(left); card.appendChild(right);
        ticketsList.appendChild(card);
      });
    }
    function showTicketDetail(id){
      const arr = loadTickets();
      const t = arr.find(x=>x.id===id);
      if (!t) return alert('Ticket no encontrado (demo).');
      const detail = `
ID: ${t.id}
Nombre: ${t.name || '‚Äî'}
Email: ${t.email || '‚Äî'}
Producto: ${t.product || '‚Äî'}
Estado: ${t.status}
Creado: ${new Date(t.createdAt).toLocaleString()}

Descripci√≥n:
${t.description}

Adjuntos: ${t.attachments ? t.attachments.length : 0}
`;
      alert(detail);
    }

    // ---------- EMAILJS send ----------
    // Cargar SDK din√°micamente (si no est√° ya)
    async function ensureEmailJs(){
      if (window.emailjs && typeof window.emailjs.sendForm === 'function') return;
      await new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js';
        s.crossOrigin = 'anonymous';
        s.onload = res;
        s.onerror = () => rej(new Error('EmailJS load failed'));
        document.head.appendChild(s);
      });
      try { if (window.emailjs && typeof emailjs.init === 'function') emailjs.init(EMAILJS_USER_ID); } catch(e){ console.warn('EmailJS init failed', e); }
    }

    // Enviar usando emailjs.sendForm (incluye file inputs con name="attachments")
    async function sendViaEmailJS(formEl, ticketObj){
      await ensureEmailJs();

      // set hidden ticket id in form
      hidTicketId.value = ticketObj.id;

      // set attachments_count input (EmailJS template puede leerla)
      // We'll create a temporary hidden input for attachments_count
      let ac = formEl.querySelector('input[name="attachments_count"]');
      if (!ac) { ac = document.createElement('input'); ac.type='hidden'; ac.name='attachments_count'; formEl.appendChild(ac); }
      ac.value = String(ticketObj.attachments.length || 0);

      // Note: EmailJS sendForm will include file inputs present in the form
      return emailjs.sendForm(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, formEl);
    }

    // Also optionally send auto-reply to the user (template must exist)
    async function sendAutoReply(formEl){
      if (!EMAILJS_AUTO_REPLY_TEMPLATE) return null;
      // Ensure the auto-reply template expects from_name, from_email, ticket_id, description, product etc.
      return emailjs.sendForm(EMAILJS_SERVICE_ID, EMAILJS_AUTO_REPLY_TEMPLATE, formEl);
    }

    // Submit click handler
    submitBtn.addEventListener('click', async () => {
      infoEl.textContent = '';
      successEl.style.display = 'none';

      const name = (document.getElementById('t-name')||{}).value.trim();
      const email = (document.getElementById('t-email')||{}).value.trim();
      const product = (document.getElementById('t-product')||{}).value;
      const description = (document.getElementById('t-desc')||{}).value.trim();

      if (!name || !email || !description) {
        infoEl.style.color = '#ffb4b4';
        infoEl.textContent = 'Completa nombre, correo y descripci√≥n.';
        return;
      }

      // Limit attachments total already enforced at addFiles
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';
      progressWrap.style.display = 'block'; progressBar.style.width = '6%';

      // prepare localTicket for storage (backup)
      const localTicket = {
        id: genTicketId(),
        name, email, product, description,
        attachments: attachedFiles.map(f => ({ name: sanitizeFilename(f.name), size: f.size, type: f.type })),
        createdAt: new Date().toISOString(),
        status: 'pendiente-offline'
      };
      // set hidden ticket id for form
      hidTicketId.value = localTicket.id;

      // IMPORTANT: Put files into a temporary file input inside form so emailjs.sendForm picks them up.
      // Our fileInput is already in the form with name="attachments" and contains the chosen files.
      // But we've been manipulating attachedFiles separately, so sync fileInput.files if needed:
      try {
        // If attachedFiles were built programmatically (e.g. via attachLog), we need to populate a DataTransfer and assign to fileInput.files
        if (attachedFiles.length > 0 && (!fileInput.files || fileInput.files.length !== attachedFiles.length)) {
          const dt = new DataTransfer();
          attachedFiles.forEach(f => dt.items.add(f));
          fileInput.files = dt.files;
        }
      } catch(e){
        // can't set files on some browsers ‚Äî continue, emailjs may still pick the original file inputs
      }

      try {
        // Send to support (primary template)
        await sendViaEmailJS(form, localTicket);
        // Optional: send auto-reply to user (if configured)
        try { if (EMAILJS_AUTO_REPLY_TEMPLATE) await sendAutoReply(form); } catch(e){ console.warn('Auto-reply failed', e); }

        // Persist as recibido
        const ticketSaved = { ...localTicket, status: 'recibido', serverResponse: { provider: 'emailjs' } };
        const arr = loadTickets();
        arr.unshift(ticketSaved); saveTickets(arr); renderTickets();

        ticketIdSpan.textContent = ticketSaved.id;
        successEl.style.display = 'block';
        infoEl.style.color = 'var(--muted)';
        infoEl.textContent = 'Ticket enviado correctamente. Revisa tu correo para confirmaci√≥n (si se configur√≥ auto-reply).';
      } catch (err) {
        // Fallback: save locally and notify user
        const arr = loadTickets();
        arr.unshift(localTicket); saveTickets(arr); renderTickets();
        ticketIdSpan.textContent = localTicket.id;
        successEl.style.display = 'block';
        infoEl.style.color = '#ffb4b4';
        infoEl.textContent = 'No se pudo enviar por email (EmailJS). Ticket guardado localmente.';
        console.error('EmailJS send failed', err);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar ticket';
        progressBar.style.width = '100%';
        setTimeout(()=> { progressWrap.style.display = 'none'; progressBar.style.width = '0%'; }, 600);
        // revoke object URLs and clear attachments
        attachedFiles.forEach(f => f.objectURL && URL.revokeObjectURL(f.objectURL));
        attachedFiles = [];
        renderAttachments();
        document.getElementById('t-desc').value = '';
        // hide success after a while
        setTimeout(()=> { successEl.style.display = 'none'; ticketIdSpan.textContent = ''; }, 8000);
      }
    });

    // Inicializaci√≥n UI
    document.getElementById('yearSupport').textContent = new Date().getFullYear();
    renderTickets();

    // theme toggle
    document.getElementById('themeToggleSmall')?.addEventListener('click', () => {
      const isLight = document.documentElement.classList.toggle('light');
      try { localStorage.setItem('lixby_theme', isLight ? 'light' : 'dark'); }catch(e){}
    });

  })();
  </script>
</body>
</html>
