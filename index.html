<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="meta.title">LIXBY ‚Äî Tecnolog√≠a minimalista</title>

  <!-- PERF: preconnect para reducir latencia en recursos externos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <link rel="stylesheet" href="style.css" />
  <!-- Peque√±os overrides y utilidades inline (NO BORRAR: conservadas y combinadas) -->
  <style>
    /* adjustments: make header/controls a bit more rounded & minimal */
    :root { --radius-md: 12px; --radius-lg: 16px; }
    .nav-inner { min-height: 64px; gap:12px; }
    .btn { border-radius: var(--radius-md); }
    .brand img { border-radius: 10px; }

    /* PRO button style (kept here so HTML is copy/paste-ready) */
    .btn-pro {
      padding:8px 14px;
      font-weight:800;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(90deg, rgba(10,132,255,0.14), rgba(10,132,255,0.28));
      color: #fff;
      box-shadow: 0 6px 18px rgba(10,132,255,0.06);
      position:relative;
      overflow:hidden;
    }
    .btn-pro:before {
      content: "";
      position: absolute;
      inset: -120% -40% -120% -40%;
      background: linear-gradient(90deg, rgba(255,255,255,0.16), rgba(10,132,255,0.28), rgba(255,255,255,0.16));
      transform: rotate(20deg);
      opacity: .6;
      transition: transform .9s ease;
      filter: blur(8px);
    }
    .btn-pro:hover:before { transform: translateX(18%) rotate(20deg); opacity: .95; }
    .btn-pro:focus { box-shadow: 0 8px 28px rgba(10,132,255,0.18); outline: none; }

    /* make mini language & cart menus more rounded */
    .mini-cart, .lang-menu { border-radius: 14px; }

    /* small responsive tweak so PRO button doesn't crowd */
    @media (max-width:720px) { .btn-pro { display:none; } }

    /* --- ADICIONES: Bot√≥n PRO y Discover (no borra nada) --- */
    .btn-pro {
      margin-left:8px;
      padding:8px 12px;
      border-radius:12px;
      font-weight:800;
      letter-spacing:0.02em;
      background: linear-gradient(90deg, rgba(10,132,255,0.14) 0%, rgba(10,84,255,0.95) 50%, rgba(10,132,255,0.14) 100%);
      color: white;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 6px 20px rgba(10,132,255,0.08);
      transition: transform .22s ease, box-shadow .22s ease, background .6s ease;
    }
    .btn-pro:hover { transform: translateY(-3px); box-shadow: 0 14px 36px rgba(10,132,255,0.12); }

    /* animated subtle gradient shift */
    @keyframes proShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .btn-pro { background-size: 200% 200%; animation: proShift 6s ease infinite; }

    /* discover button (single CTA on product cards) */
    .btn-discover {
      width:100%;
      display:inline-flex;
      justify-content:center;
      padding:10px 12px;
      border-radius:10px;
      border: none;
      font-weight:700;
      cursor:pointer;
      background: linear-gradient(180deg,var(--accent), color-mix(in oklab, var(--accent) 60%, #fff 40%));
      color:#00121a;
      box-shadow: 0 8px 18px rgba(10,132,255,0.06);
    }
    @media (max-width:900px) {
      .btn-discover { padding:10px; font-size:0.95rem; }
    }

    /* download button style */
    .btn-download {
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background:transparent;
      cursor:pointer;
      font-weight:700;
    }

    /* ======================
       ADICIONES: HERO VIDEO (estilo tipo Apple)
       ======================
    */
    .hero {
      position: relative; /* para el video absoluto */
      overflow: hidden;
      min-height: 72vh; /* ocupa buena parte de la pantalla */
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 48px 24px;
    }
    .hero video.hero-bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover; /* recorta sin deformar */
      z-index: -2; /* detr√°s del contenido */
      pointer-events: none; /* no interfiere con clicks */
      filter: brightness(0.6) saturate(0.98);
      will-change: transform;
    }
    /* overlay sutil para texto legible */
    .hero::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.18) 0%, rgba(0,0,0,0.35) 100%);
      z-index: -1;
      pointer-events: none;
    }
    .hero-content { position: relative; z-index: 1; text-align:center; max-width:1100px; }

    /* ======================
       MEJORAS: FOOTER ‚Äî distribuci√≥n y responsividad
       (NO BORRAR NADA: solo ajusta layout/estilos)
       ======================
    */
    .footer { padding-top: 28px; }
    .footer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 28px;
      align-items: start;
      padding: 32px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .footer-col { min-width: 0; }
    .footer-brand { font-weight: 800; font-size: 1.15rem; letter-spacing: .04em; margin-bottom: 8px; }
    .social-links { display:flex; gap:10px; margin-top:12px; }
    .social-links a { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; background:rgba(255,255,255,0.03); text-decoration:none; }

    .newsletter-form { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .newsletter-form input[type="email"] { flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); }
    .newsletter-form button { padding:10px 12px; border-radius:10px; }

    .footer-bottom { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:14px 40px; border-top: 1px solid rgba(255,255,255,0.03); max-width:1200px; margin:0 auto; flex-wrap:wrap; }
    .legal-left { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .legal-links a { margin-left:8px; }

    @media (max-width:720px){
      .hero { min-height:56vh; padding:28px 18px; }
      .footer-grid { padding:20px 18px; gap:18px; }
      .footer-bottom { padding:12px 18px; }
      .newsletter-form { flex-direction:column; align-items:stretch; }
      .newsletter-form input, .newsletter-form button { width:100%; }
    }

  </style>
</head>
<body>
  <!-- skip link para accesibilidad -->
  <a class="skip-link" href="#maincontent">Saltar al contenido</a>

<!-- NAV -->
<header class="nav glass" role="banner">
  <div class="nav-inner">
    <!-- LEFT: logo -->
    <div class="nav-left">
      <div class="brand"
           role="link"
           tabindex="0"
           aria-label="Ir al inicio"
           onclick="location.href='index.html'"
           onkeydown="if(event.key==='Enter' || event.key===' ') { event.preventDefault(); location.href='index.html'; }">
        <img src="https://i.imgur.com/dOCYmkx.jpeg" alt="LIXBY logo" width="44" height="44">
        <div class="title">LIXBY</div>
      </div>
    </div>

    <!-- CENTER: nav links -->
    <nav id="navLinks" role="navigation" aria-label="Principal">
      <a href="#inicio" data-i18n="nav.inicio">Inicio</a>
      <a href="#productos" data-i18n="nav.productos">Productos</a>
      <a href="#contacto" data-i18n="nav.contacto">Cont√°ctanos</a>
      <a href="#conocenos" data-i18n="nav.conocenos">Con√≥cenos</a>
    </nav>

    <!-- RIGHT: controles en fila -->
    <div class="nav-right" aria-hidden="false">
      <div class="cart-wrapper" style="position:relative;">
        <button id="cartBtn" class="icon-btn" aria-label="Ver carrito" aria-controls="miniCart" aria-expanded="false" type="button">üõí <span id="cartCount" class="badge">0</span></button>

        <div id="miniCart" class="mini-cart glass" aria-hidden="true" role="region" aria-label="Mini carrito">
          <div class="mini-cart-header" style="display:flex;justify-content:space-between;align-items:center;">
            <strong data-i18n="cart.title">Carrito</strong>
            <button id="clearCart" class="text-btn" data-i18n="cart.clear" type="button">Vaciar</button>
          </div>
          <div id="miniCartItems" class="mini-cart-items" tabindex="0" aria-live="polite" style="max-height:220px;overflow:auto;">
            <!-- items din√°micos -->
          </div>
          <div class="mini-cart-footer" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong data-i18n="cart.total">Total:</strong> <span id="miniCartTotal">0‚Ç¨</span></div>
              <div><button id="checkoutBtn" class="btn primary" data-i18n="cart.checkout" type="button">Pagar</button></div>
            </div>
            <div style="display:flex;gap:8px;">
              <button id="viewCartBtn" class="btn ghost" type="button" data-i18n="cart.view">Ver carrito</button>
            </div>
          </div>
        </div>
      </div>

      <div class="lang-wrapper">
        <button id="langBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false" type="button"> <span id="langFlag">üá™üá∏</span> <span id="langLabel">Espa√±ol</span> ‚ñæ </button>
        <div id="langMenu" class="lang-menu glass" aria-hidden="true" style="display:none;flex-direction:column;gap:6px;padding:8px;width:220px;">
          <button class="lang-item" data-lang="es" type="button">üá™üá∏ Espa√±ol</button>
          <button class="lang-item" data-lang="en" type="button">üá¨üáß English</button>
          <button class="lang-item" data-lang="fr" type="button">üá´üá∑ Fran√ßais</button>
          <button class="lang-item" data-lang="de" type="button">üá©üá™ Deutsch</button>
          <button class="lang-item" data-lang="it" type="button">üáÆüáπ Italiano</button>
          <!-- a√±adidos: m√°s idiomas -->
          <button class="lang-item" data-lang="pt" type="button">üáµüáπ Portugu√™s</button>
          <button class="lang-item" data-lang="nl" type="button">üá≥üá± Nederlands</button>
          <button class="lang-item" data-lang="zh" type="button">üá®üá≥ ‰∏≠Êñá</button>
          <button class="lang-item" data-lang="ja" type="button">üáØüáµ Êó•Êú¨Ë™û</button>
        </div>
      </div>

      <div id="accountContainer" style="display:flex;align-items:center;gap:8px;">
        <button id="accountBtn" class="btn ghost" aria-label="Mi cuenta" type="button">Cuenta</button>

        <!-- NUEVO: bot√≥n PASATE AL PRO (al lado de la cuenta) -->
        <button id="proBtn" class="btn btn-pro" type="button" aria-label="P√°sate al Pro" data-i18n="pro.cta">P√ÅSATE AL PRO</button>
      </div>

      <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema" type="button">‚óê</button>
    </div>
  </div>
</header>

<main id="maincontent">
  <!-- HERO -->
  <section id="inicio" class="hero reveal" aria-labelledby="hero-title">

    <!-- VIDEO DE FONDO (decorativo) -->
    <video class="hero-bg" autoplay muted loop playsinline preload="auto" aria-hidden="true">
      <source src="Bienvenido.mp4" type="video/mp4">
      <!-- fallback: still se mantiene el poster si el navegador no soporta video -->
    </video>

    <div class="hero-content">
      <h1 id="hero-title" data-i18n="hero.title">La tecnolog√≠a que te entiende</h1>
      <p id="hero-subtitle" data-i18n="hero.subtitle">Innovaci√≥n minimalista para tu d√≠a a d√≠a</p>
      <a href="explorar.html" class="btn primary" data-i18n="btn.explorar">Explorar</a>
    </div>
  </section>

  <!-- PRODUCTOS -->
  <section id="productos" class="section reveal" aria-labelledby="prod-title">
    <h2 id="prod-title" data-i18n="section.products">Productos</h2>
    <div class="grid">
      <!-- Lixby One Air -->
      <article class="card glass" data-product="lixby-one-air" role="button" tabindex="0" aria-label="Lixby One Air">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg" alt="Lixby One Air" loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3 class="prod-title" data-i18n="product.lixby-one-air.title">Lixby One Air</h3>
        <p class="prod-desc" data-i18n="product.lixby-one-air.desc">Ultraligero y econ√≥mico.</p>
        <span class="price" data-i18n="product.lixby-one-air.price">249‚Ç¨</span>
        <div class="actions">
          <!-- botones originales preservados pero a√±adiremos el CTA 'Explorar' din√°micamente -->
        </div>
      </article>

      <!-- Lixby One -->
      <article class="card glass" data-product="lixby-one" role="button" tabindex="0" aria-label="Lixby One">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg" alt="Lixby One" loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3 class="prod-title" data-i18n="product.lixby-one.title">Lixby One</h3>
        <p class="prod-desc" data-i18n="product.lixby-one.desc">Ultraligero y potente.</p>
        <span class="price" data-i18n="product.lixby-one.price">349‚Ç¨</span>
        <div class="actions"></div>
      </article>

      <!-- Lixby One Pro -->
      <article class="card glass" data-product="lixby-one-pro" role="button" tabindex="0" aria-label="Lixby One Pro">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/61rriyfRKwL.jpg" alt="Lixby One Pro" loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3 class="prod-title" data-i18n="product.lixby-one-pro.title">Lixby One Pro</h3>
        <p class="prod-desc" data-i18n="product.lixby-one-pro.desc">Audio de alta fidelidad.</p>
        <span class="price" data-i18n="product.lixby-one-pro.price">899‚Ç¨</span>
        <div class="actions"></div>
      </article>
    </div>
  </section>

  <!-- CONTACTO -->
  <section id="contacto" class="section contact-min glass reveal" aria-labelledby="contact-title">
    <div class="left">
      <h2 id="contact-title" data-i18n="contact.title">Cont√°ctanos</h2>
      <p class="lead" data-i18n="contact.lead">D√©janos una duda o sugerencias y te responderemos lo antes posible.</p>
    </div>

    <form id="contactForm" class="form" aria-label="Formulario de contacto" onsubmit="return false;">
      <input id="contactName" name="from_name" type="text" placeholder="Nombre" data-i18n-placeholder="contact.placeholder.name" required autocomplete="name">
      <input id="contactEmail" name="from_email" type="email" placeholder="Correo" data-i18n-placeholder="contact.placeholder.email" required autocomplete="email">
      <textarea id="contactMessage" name="message" placeholder="Tu mensaje" data-i18n-placeholder="contact.placeholder.message" required></textarea>

      <input id="ticketId" type="hidden" name="ticket_id" value="">

      <div class="actions">
        <button type="button" class="btn ghost" onclick="document.getElementById('contactForm').reset();" data-i18n="btn.clear">Borrar</button>
        <button type="submit" id="contactSend" class="btn primary" data-i18n="btn.enviar">Enviar</button>
      </div>
      <div id="contactSuccess" class="contact-success" role="status" aria-live="polite" data-i18n="contact.success">Mensaje enviado. ¬°Gracias! Te contestaremos pronto.</div>
    </form>
  </section>

  <!-- CON√ìCENOS -->
  <section id="conocenos" class="section reveal" aria-labelledby="about-title">
    <h2 id="about-title" data-i18n="about.title">Con√≥cenos</h2>
    <p data-i18n="about.text">En LIXBY creemos en el equilibrio perfecto entre dise√±o y funcionalidad. Creamos productos que no solo funcionan, sino que tambi√©n inspiran.</p>
  </section>
</main>

<!-- debug -->
<div id="debug" style="display:none;max-width:1100px;margin:12px auto;color:var(--muted);white-space:pre-wrap;"></div>

<!-- Footer (con traducciones aplicables) -->
<footer class="footer glass" role="contentinfo" aria-labelledby="footer-heading">
  <div class="footer-grid" id="footerGrid">
    <div class="footer-col">
      <div class="footer-brand">LIXBY</div>
      <p data-i18n="footer.description">Dise√±o minimalista, tecnolog√≠a que acompa√±a tu d√≠a a d√≠a. S√≠guenos para novedades y lanzamientos.</p>
      <div class="social-links" aria-label="Redes sociales">
        <!-- icons... preserved -->
        <a href="#" title="Twitter" aria-label="Twitter" rel="noopener">...</a>
        <a href="#" title="Instagram" aria-label="Instagram" rel="noopener">...</a>
        <a href="#" title="YouTube" aria-label="YouTube" rel="noopener">...</a>
      </div>
    </div>

    <div class="footer-col">
      <h4 data-i18n="footer.links">Enlaces</h4>
      <div class="footer-links" role="navigation" aria-label="Enlaces r√°pidos">
        <a href="explorar.html" data-i18n="footer.explore">Explorar</a>
        <a href="productos.html" data-i18n="footer.catalog">Cat√°logo</a>
        <a href="carrito.html" data-i18n="footer.cart">Carrito</a>
        <a href="cuenta.html" data-i18n="footer.account">Mi cuenta</a>
      </div>
    </div>

    <div class="footer-col">
      <h4 data-i18n="footer.help">Ayuda</h4>
      <div class="footer-links">
        <a href="contacto.html" data-i18n="footer.contact">Contacto</a>
        <a href="faq.html" id="footerFaqLink">Preguntas frecuentes</a>
        <a href="envios.html" data-i18n="footer.shipping">Env√≠os y devoluciones</a>
        <a href="soporte.html" data-i18n="footer.support">Soporte t√©cnico</a>
      </div>
    </div>

    <div class="footer-col" aria-label="Newsletter">
      <h4 data-i18n="footer.subscribe">Suscr√≠bete</h4>
      <p data-i18n="footer.subscribe_text">Recibe novedades, ofertas exclusivas y lanzamientos.</p>
      <form id="newsletterForm" class="newsletter-form" onsubmit="return false;" aria-label="Formulario newsletter">
        <input id="newsletterEmail" type="email" placeholder="tu@correo.com" data-i18n-placeholder="newsletter.placeholder" aria-label="Correo electr√≥nico para newsletter" required>
        <button id="newsletterBtn" type="submit" aria-label="Suscribirse" data-i18n="btn.subscribe">Suscribir</button>
      </form>
      <div style="margin-top:8px;">
        <!-- DOWNLOAD BUTTON ADDED: se traducir√° y actualizar√° la ruta con el idioma -->
        <a id="downloadBtn" class="btn-download" href="download/guide-es.pdf" download data-i18n="btn.download">Descargar</a>
      </div>
      <div id="newsletterMsg" role="status" aria-live="polite" style="margin-top:8px;color:var(--muted);font-size:0.95rem"></div>
    </div>
  </div>

  <div class="footer-bottom">
    <div class="legal-left">
      <small>¬© <span id="year"></span> LIXBY ‚Äî Todos los derechos reservados</small>
      <div class="legal-links" style="margin-left:12px;">
        <a href="privacidad.html" data-i18n="footer.privacy">Pol√≠tica de privacidad</a>
        <a href="terminos.html" data-i18n="footer.terms">T√©rminos y condiciones</a>
        <a id="accessibilityLink" href="accessibility.html" aria-label="Ir a la p√°gina de accesibilidad" data-i18n="footer.accessibility">Accesibilidad</a>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <button id="backToTop" class="back-to-top" aria-label="Volver arriba" title="Volver arriba">‚Üë Volver arriba</button>
      <small style="color:var(--muted)">Versi√≥n demo</small>
    </div>
  </div>
</footer>

<!-- Cart panel (est√°tico) + backdrop (se mantiene funcional) -->
<div id="cartBackdrop" class="cart-backdrop" aria-hidden="true"></div>
<aside id="cartPanel" class="cart-panel" aria-hidden="true">
  <div class="cart-panel-inner glass" role="dialog" aria-label="Carrito">
    <div class="cart-header" style="display:flex;justify-content:space-between;align-items:center;">
      <strong data-i18n="cart.title">Carrito</strong>
      <button id="cartPanelClose" class="text-btn" aria-label="Cerrar" type="button">‚úï</button>
    </div>
    <div id="cartPanelItems" class="cart-list" style="max-height:60vh;overflow:auto;padding:12px"></div>
    <div class="cart-footer" style="padding:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Total</strong>
        <span id="cartPanelTotal">0‚Ç¨</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="cartPanelCheckout" class="btn primary" data-i18n="cart.checkout" type="button">Pagar</button>
        <button id="cartPanelClear" class="btn ghost" data-i18n="cart.clear" type="button">Vaciar</button>
      </div>
    </div>
  </div>
</aside>

<!-- Live region for screen-reader announcements -->
<div id="announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<noscript style="display:block;background:#fffb; padding:10px; text-align:center;">
  JavaScript est√° desactivado o ha ocurrido un error. Si la p√°gina no carga correctamente, abre la consola (F12 ‚Üí Console).
</noscript>

<!-- ===========================
     SCRIPTS (inline para copiar directo)
     =========================== -->
<script>
(function(){
  // -------------------------
  // Helpers y estado
  // -------------------------
  const KEY = 'lixby_cart_v1';
  const CURRENCY = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
  function parsePrice(s){ if (s === undefined || s === null) return 0; return Number(String(s).replace(/[^\d.,-]/g,'').replace(',', '.')) || 0; }
  function saveCart(c){ try { localStorage.setItem(KEY, JSON.stringify(c)); } catch(e){} }
  function loadCart(){ try { return JSON.parse(localStorage.getItem(KEY))||[]; } catch(e){ return []; } }
  function formatPriceNum(num){ return CURRENCY.format(Number(num) || 0); }
  function showDebug(msg){ const el=document.getElementById('debug'); if(!el) return; el.style.display='block'; el.textContent += msg + "\n"; console.log('DEBUG',msg); }

  try { document.getElementById('year').textContent = new Date().getFullYear(); } catch(e){}

  // Productos (preservado)
  const PRODUCTS_BRIEF = {
    'lixby-one-air': { id:'lixby-one-air', name: 'Lixby One Air', price: '249‚Ç¨', priceNum: 249, image: 'https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg' },
    'lixby-one': { id:'lixby-one', name: 'Lixby One', price: '349‚Ç¨', priceNum: 349, image: 'https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg' },
    'lixby-one-pro': { id:'lixby-one-pro', name: 'Lixby One Pro', price: '899‚Ç¨', priceNum: 899, image: 'https://m.media-amazon.com/images/I/61rriyfRKwL.jpg' }
  };

  // CART state & UI refs
  let cart = loadCart();
  const cartBtn = document.getElementById('cartBtn');
  const miniCart = document.getElementById('miniCart');
  const miniCartItems = document.getElementById('miniCartItems');
  const miniCartTotal = document.getElementById('miniCartTotal');
  const cartCount = document.getElementById('cartCount');
  const clearCartBtn = document.getElementById('clearCart');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const announcements = document.getElementById('announcements');

  const cartPanel = document.getElementById('cartPanel');
  const cartBackdrop = document.getElementById('cartBackdrop');
  const cartPanelClose = document.getElementById('cartPanelClose');
  const cartPanelItems = document.getElementById('cartPanelItems');
  const cartPanelTotal = document.getElementById('cartPanelTotal');
  const cartPanelClear = document.getElementById('cartPanelClear');

  function updateMiniCartUI(){
    if (!cartCount) return;
    const totalQty = cart.reduce((s,i)=>s+(i.qty||0),0);
    cartCount.textContent = totalQty;
    if (!miniCartItems) return;
    miniCartItems.innerHTML = '';
    if (cart.length === 0) {
      miniCartItems.innerHTML = '<div style="padding:8px;color:var(--muted)'> + (getTranslation('cart.empty') || 'Tu carrito est√° vac√≠o.') +'</div>';
      if (miniCartTotal) miniCartTotal.textContent = formatPriceNum(0);
      return;
    }
    let total = 0;
    const frag = document.createDocumentFragment();
    cart.forEach((it, idx) => {
      const item = document.createElement('div');
      item.className = 'mini-cart-item';
      item.style.display = 'flex'; item.style.gap='10px'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderRadius='8px';
      const img = document.createElement('img'); img.src = it.image || 'https://via.placeholder.com/80x80?text=Img'; img.alt = it.name; img.style.width='44px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
      img.loading='lazy'; img.decoding='async';
      const meta = document.createElement('div'); meta.className='meta';
      const title = document.createElement('div'); title.style.fontWeight = '700'; title.textContent = it.name || '';
      const subtitle = document.createElement('div'); subtitle.style.color = 'var(--muted)'; subtitle.textContent = `${formatPriceNum(it.priceNum || parsePrice(it.price))} √ó ${it.qty||1}`;
      meta.appendChild(title); meta.appendChild(subtitle);
      const remove = document.createElement('button'); remove.className='remove'; remove.textContent='‚úï'; remove.style.background='transparent'; remove.style.border='none'; remove.style.cursor='pointer';
      remove.setAttribute('type','button');
      remove.addEventListener('click', (e)=>{ e.stopPropagation(); cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
      item.appendChild(img); item.appendChild(meta); item.appendChild(remove);
      frag.appendChild(item);
      total += (it.priceNum || parsePrice(it.price)) * (it.qty||1);
    });
    miniCartItems.appendChild(frag);
    if (miniCartTotal) miniCartTotal.textContent = formatPriceNum(total);
  }

  function updateCartPanel(){
    if (!cartPanelItems) return;
    cartPanelItems.innerHTML = '';
    if (cart.length === 0) {
      cartPanelItems.innerHTML = '<div style="padding:12px;color:var(--muted)'> + (getTranslation('cart.empty') || 'Tu carrito est√° vac√≠o.') +'</div>';
      if (cartPanelTotal) cartPanelTotal.textContent = formatPriceNum(0);
      return;
    }
    let total = 0;
    const frag = document.createDocumentFragment();
    cart.forEach((it, idx) => {
      const row = document.createElement('div');
      row.style.display='flex'; row.style.gap='12px'; row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      const img = document.createElement('img'); img.src = it.image || ''; img.alt = it.name; img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
      const meta = document.createElement('div'); meta.style.flex='1';
      const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = it.name || '';
      const qty = document.createElement('div'); qty.style.color='var(--muted)'; qty.textContent = `√ó ${it.qty || 1} ‚Äî ${formatPriceNum(it.priceNum || parsePrice(it.price))}`;
      meta.appendChild(title); meta.appendChild(qty);
      const remove = document.createElement('button'); remove.className='text-btn'; remove.textContent='Eliminar'; remove.setAttribute('type','button');
      remove.addEventListener('click', ()=> { cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
      row.appendChild(img); row.appendChild(meta); row.appendChild(remove);
      frag.appendChild(row);
      total += (it.priceNum || parsePrice(it.price)) * (it.qty||1);
    });
    cartPanelItems.appendChild(frag);
    if (cartPanelTotal) cartPanelTotal.textContent = formatPriceNum(total);
  }

  // ensure miniCart style reflects aria-hidden initially
  if (miniCart) {
    if (miniCart.getAttribute('aria-hidden') === 'false') miniCart.style.display = 'flex';
    else miniCart.style.display = '';
  }

  // Hover show mini-cart & click navigates to carrito.html (fixed per request)
  (function wireCartHoverAndClick(){
    const wrapper = document.querySelector('.cart-wrapper');
    let hideTimeout = null;

    function showMini(){
      if (!miniCart) return;
      miniCart.setAttribute('aria-hidden','false');
      miniCart.style.display = 'flex';
      try { cartBtn.setAttribute('aria-expanded','true'); } catch(e){}
    }
    function hideMini(){
      if (!miniCart) return;
      miniCart.setAttribute('aria-hidden','true');
      miniCart.style.display = '';
      try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){}
    }

    if (wrapper) {
      wrapper.addEventListener('mouseenter', (e) => {
        clearTimeout(hideTimeout);
        showMini();
      });
      wrapper.addEventListener('mouseleave', (e) => {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          if (cartPanel && cartPanel.classList.contains('open')) return;
          hideMini();
        }, 220);
      });
    }
    if (miniCart) {
      miniCart.addEventListener('mouseenter', () => { clearTimeout(hideTimeout); showMini(); });
      miniCart.addEventListener('mouseleave', () => {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          if (cartPanel && cartPanel.classList.contains('open')) return;
          hideMini();
        }, 220);
      });
    }

    // CLICK: ahora redirige a carrito.html (seg√∫n tu petici√≥n)
    if (cartBtn) {
      cartBtn.addEventListener('click', (e) => {
        // si quieres mantener comportamiento panel con tecla modificadora, se puede:
        if (e.metaKey || e.ctrlKey) {
          openCartPanel();
          return;
        }
        window.location.href = 'carrito.html';
      });
    }

    // viewCartBtn sigue abriendo el panel (√∫til)
    const viewBtn = document.getElementById('viewCartBtn');
    if (viewBtn) viewBtn.addEventListener('click', (e) => openCartPanel());
  })();

  // Panel functions
  function openCartPanel(){
    if (!cartPanel || !cartBackdrop) return;
    cartPanel.classList.add('open');
    cartBackdrop.classList.add('open');
    cartPanel.setAttribute('aria-hidden','false');
    cartBackdrop.setAttribute('aria-hidden','false');
    if (miniCart) { miniCart.setAttribute('aria-hidden','true'); miniCart.style.display = ''; try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){} }
    updateCartPanel();
  }
  function closeCartPanel(){
    if (!cartPanel || !cartBackdrop) return;
    cartPanel.classList.remove('open');
    cartBackdrop.classList.remove('open');
    cartPanel.setAttribute('aria-hidden','true');
    cartBackdrop.setAttribute('aria-hidden','true');
  }
  if (cartBackdrop) cartBackdrop.addEventListener('click', closeCartPanel);
  if (cartPanelClose) cartPanelClose.addEventListener('click', closeCartPanel);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (cartPanel && cartPanel.classList.contains('open')) closeCartPanel(); } });

  if (clearCartBtn) clearCartBtn.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
  if (cartPanelClear) cartPanelClear.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); updateCartPanel(); });

  if (checkoutBtn) checkoutBtn.addEventListener('click', () => { if (cart.length===0) return alert(getTranslation('cart.empty') || 'El carrito est√° vac√≠o'); alert('Simulaci√≥n de checkout: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });
  if (document.getElementById('cartPanelCheckout')) document.getElementById('cartPanelCheckout').addEventListener('click', () => { if (cart.length===0) return alert(getTranslation('cart.empty') || 'El carrito est√° vac√≠o'); alert('Simulaci√≥n de checkout desde panel: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });

  window.addToCart = function(product){
    const existing = cart.find(p => p.id === product.id);
    if (existing) existing.qty = (existing.qty||1) + 1;
    else cart.push({ id: product.id, name: product.name, price: product.price, priceNum: Number(product.priceNum || parsePrice(product.price) || 0), qty:1, image: product.image });
    saveCart(cart);
    updateMiniCartUI();
    updateCartPanel();
    if (miniCart) { miniCart.setAttribute('aria-hidden','false'); miniCart.style.display = 'flex'; try { cartBtn.setAttribute('aria-expanded','true'); } catch(e){} setTimeout(()=>{ if (miniCart) { miniCart.setAttribute('aria-hidden','true'); miniCart.style.display = ''; try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){} } }, 2200); }
    try { if (announcements) announcements.textContent = `${product.name} a√±adido al carrito.`; } catch(e){}
  };

  updateMiniCartUI();
  updateCartPanel();

  // ---------------------------
  // I18N / translations (mejorado, no petar√°)
  // ---------------------------
  const langBtn = document.getElementById('langBtn'), langMenu = document.getElementById('langMenu'), langLabel = document.getElementById('langLabel'), langFlag = document.getElementById('langFlag');
  const translations = {
    es: {
      "meta.title":"LIXBY ‚Äî Tecnolog√≠a minimalista",
      "nav.inicio":"Inicio","nav.productos":"Productos","nav.contacto":"Cont√°ctanos","nav.conocenos":"Con√≥cenos",
      "hero.title":"La tecnolog√≠a que te entiende","hero.subtitle":"Innovaci√≥n minimalista para tu d√≠a a d√≠a",
      "section.products":"Productos",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultraligero y econ√≥mico.","product.lixby-one-air.price":"249‚Ç¨",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultraligero y potente.","product.lixby-one.price":"349‚Ç¨",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"Audio de alta fidelidad.","product.lixby-one-pro.price":"899‚Ç¨",
      "btn.explorar":"Explorar","btn.view":"Ver","btn.add":"A√±adir al carrito","btn.added":"A√±adido","btn.enviar":"Enviar","btn.clear":"Borrar","btn.subscribe":"Suscribir",
      "btn.descubrir":"Descubrir",
      "btn.download":"Descargar",
      "contact.title":"Cont√°ctanos","contact.lead":"D√©janos una duda o sugerencias y te responderemos lo antes posible.","contact.placeholder.name":"Nombre","contact.placeholder.email":"Correo","contact.placeholder.message":"Tu mensaje","contact.success":"Mensaje enviado. ¬°Gracias! Te contestaremos pronto.",
      "cart.title":"Carrito","cart.clear":"Vaciar","cart.total":"Total:","cart.checkout":"Pagar","cart.empty":"Tu carrito est√° vac√≠o.","cart.view":"Ver carrito",
      "footer.description":"Dise√±o minimalista, tecnolog√≠a que acompa√±a tu d√≠a a d√≠a. S√≠guenos para novedades y lanzamientos.",
      "footer.links":"Enlaces","footer.explore":"Explorar","footer.catalog":"Cat√°logo","footer.cart":"Carrito","footer.account":"Mi cuenta",
      "footer.help":"Ayuda","footer.contact":"Contacto","footer.faq":"Preguntas frecuentes","footer.shipping":"Env√≠os y devoluciones","footer.support":"Soporte t√©cnico",
      "footer.subscribe":"Suscr√≠bete","footer.subscribe_text":"Recibe novedades, ofertas exclusivas y lanzamientos.","newsletter.placeholder":"tu@correo.com",
      "footer.privacy":"Pol√≠tica de privacidad","footer.terms":"T√©rminos y condiciones","footer.accessibility":"Accesibilidad",
      "pro.cta":"P√ÅSATE AL PRO",
      "about.text":"En LIXBY creemos en el equilibrio perfecto entre dise√±o y funcionalidad. Creamos productos que no solo funcionan, sino que tambi√©n inspiran."
    },
    en: {
      "meta.title":"LIXBY ‚Äî Minimal technology",
      "nav.inicio":"Home","nav.productos":"Products","nav.contacto":"Contact","nav.conocenos":"About",
      "hero.title":"Technology that understands you","hero.subtitle":"Minimal innovations for your day-to-day",
      "section.products":"Products",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultralight and affordable.","product.lixby-one-air.price":"249‚Ç¨",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultralight and powerful.","product.lixby-one.price":"349‚Ç¨",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"High-fidelity audio.","product.lixby-one-pro.price":"899‚Ç¨",
      "btn.explorar":"Explore","btn.view":"View","btn.add":"Add to cart","btn.added":"Added","btn.enviar":"Send","btn.clear":"Clear","btn.subscribe":"Subscribe",
      "btn.descubrir":"Discover",
      "btn.download":"Download",
      "contact.title":"Contact","contact.lead":"Leave us a question or suggestion and we'll reply soon.","contact.placeholder.name":"Name","contact.placeholder.email":"Email","contact.placeholder.message":"Your message","contact.success":"Message sent. Thanks!",
      "cart.title":"Cart","cart.clear":"Clear","cart.total":"Total:","cart.checkout":"Checkout","cart.empty":"Your cart is empty.","cart.view":"View cart",
      "footer.description":"Minimal design, technology that accompanies your everyday life. Follow us for updates and launches.",
      "pro.cta":"GO PRO",
      "about.text":"At LIXBY we believe in the perfect balance between design and functionality. We create products that not only work, but inspire."
    },
    fr: {
      "meta.title":"LIXBY ‚Äî Technologie minimaliste",
      "nav.inicio":"Accueil","nav.productos":"Produits","nav.contacto":"Contact","nav.conocenos":"√Ä propos",
      "hero.title":"La technologie qui vous comprend","hero.subtitle":"Innovation minimaliste pour votre quotidien",
      "section.products":"Produits",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultral√©ger et abordable.","product.lixby-one-air.price":"249‚Ç¨",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultral√©ger et puissant.","product.lixby-one.price":"349‚Ç¨",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"Audio haute fid√©lit√©.","product.lixby-one-pro.price":"899‚Ç¨",
      "btn.explorar":"Explorer","btn.view":"Voir","btn.add":"Ajouter au panier","btn.added":"Ajout√©","btn.enviar":"Envoyer","btn.clear":"Vider","btn.subscribe":"S'abonner",
      "btn.descubrir":"D√©couvrir",
      "btn.download":"T√©l√©charger",
      "contact.title":"Contact","contact.lead":"Laissez-nous une question ou suggestion et nous r√©pondrons bient√¥t.","contact.placeholder.name":"Nom","contact.placeholder.email":"Email","contact.placeholder.message":"Votre message","contact.success":"Message envoy√©. Merci!",
      "cart.title":"Panier","cart.clear":"Vider","cart.total":"Total:","cart.checkout":"Payer","cart.empty":"Votre panier est vide.","cart.view":"Voir le panier",
      "pro.cta":"PASSER PRO",
      "about.text":"Chez LIXBY, nous croyons √† l'√©quilibre parfait entre design et fonctionnalit√©. Nous cr√©amos productos que no solo funcionan, sino que tambi√©n inspiran."
    },
    de: {
      "meta.title":"LIXBY ‚Äî Minimal Technologie",
      "nav.inicio":"Start","nav.productos":"Produkte","nav.contacto":"Kontakt","nav.conocenos":"√úber uns",
      "hero.title":"Technologie, die dich versteht","hero.subtitle":"Minimalistische Innovationen f√ºr deinen Alltag",
      "section.products":"Produkte",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultraleicht und preiswert.","product.lixby-one-air.price":"249‚Ç¨",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultraleicht und leistungsstark.","product.lixby-one.price":"349‚Ç¨",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"High-Fidelity Audio.","product.lixby-one-pro.price":"899‚Ç¨",
      "btn.explorar":"Entdecken","btn.view":"Ansehen","btn.add":"In den Warenkorb","btn.added":"Hinzugef√ºgt","btn.enviar":"Senden","btn.clear":"L√∂schen","btn.subscribe":"Abonnieren",
      "btn.descubrir":"Entdecken",
      "btn.download":"Herunterladen",
      "cart.title":"Warenkorb","cart.clear":"Leeren","cart.total":"Gesamt:","cart.checkout":"Zur Kasse","cart.empty":"Dein Warenkorb ist leer.","cart.view":"Warenkorb ansehen",
      "pro.cta":"PRO WERDEN",
      "about.text":"Bei LIXBY glauben wir an la perfecta equilibrio entre dise√±o y funcionalidad."
    },
    it: {
      "meta.title":"LIXBY ‚Äî Tecnologia minimalista",
      "nav.inicio":"Home","nav.productos":"Prodotti","nav.contacto":"Contatti","nav.conocenos":"Chi siamo",
      "hero.title":"La tecnologia che ti capisce","hero.subtitle":"Innovazione minimalista per la tua quotidianit√†",
      "section.products":"Prodotti",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultraleggero ed economico.","product.lixby-one-air.price":"249‚Ç¨",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultraleggero e potente.","product.lixby-one.price":"349‚Ç¨",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"Audio ad alta fedelt√†.","product.lixby-one-pro.price":"899‚Ç¨",
      "btn.explorar":"Esplora","btn.view":"Vedi","btn.add":"Aggiungi al carrello","btn.added":"Aggiunto","btn.enviar":"Invia","btn.clear":"Cancella","btn.subscribe":"Iscriviti",
      "btn.descubrir":"Scopri",
      "btn.download":"Scarica",
      "pro.cta":"PASSA A PRO",
      "about.text":"In LIXBY crediamo nel perfetto equilibrio tra design e funzionalit√†. Creiamo prodotti che no solo funzionano, ma ispirano."
    }
  };

  // Start language
  let currentLang = localStorage.getItem('lixby_lang') || (navigator.language ? navigator.language.slice(0,2) : 'es');
  if (!translations[currentLang]) currentLang = 'es';

  function getTranslation(key, lang){
    try {
      const map = translations[lang || currentLang] || translations['es'];
      return (map && map[key]) ? map[key] : null;
    } catch(e){ return null; }
  }

  // safe text setter: updates only text nodes directly under el (preserves icons/child elements)
  function setElementTextSafe(el, text){
    if (!el) return;
    try {
      // prefer to update first text node child
      const textNodes = Array.from(el.childNodes).filter(n => n.nodeType === 3);
      if (textNodes.length > 0) {
        // set first text node to full text, remove other text nodes
        textNodes[0].nodeValue = text;
        for (let i = 1; i < textNodes.length; i++) textNodes[i].nodeValue = '';
        return;
      }
      // if no text nodes, but there are element children, try to find an element with class 'i18n-text' or data-i18n-text
      const candidate = el.querySelector('.i18n-text, [data-i18n-text]');
      if (candidate) { candidate.textContent = text; return; }
      // fallback: append a text node (safe)
      el.appendChild(document.createTextNode(text));
    } catch(e){ try { el.textContent = text; } catch(err){} }
  }

  // utility: translate plain visible text nodes by matching source (es) strings. This helps "translate the whole page" when elements weren't annotated.
  function translateVisibleTextNodes(lang){
    try {
      // build reverse map from Spanish source -> translation
      const base = translations['es'] || {};
      const target = translations[lang] || base;
      const rev = {};
      Object.keys(base).forEach(k => { const s = base[k]; const t = target[k]; if (s && t) rev[s.trim()] = t; });

      // walker that visits text nodes in body (excluding script/style/textarea/input)
      const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, {
        acceptNode: function(node){
          // ignore empty or whitespace-only
          if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          // skip inside certain elements
          const parent = node.parentElement;
          if (!parent) return NodeFilter.FILTER_REJECT;
          const tag = parent.tagName.toLowerCase();
          if (['script','style','textarea','code','pre'].includes(tag)) return NodeFilter.FILTER_REJECT;
          // only short nodes to avoid long paragraphs (still safe)
          if (node.nodeValue.trim().length > 200) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      }, false);

      const toReplace = [];
      while(walker.nextNode()){
        const txt = walker.currentNode.nodeValue.trim();
        if (rev[txt]) toReplace.push({node: walker.currentNode, from: txt, to: rev[txt]});
      }

      toReplace.forEach(item => { item.node.nodeValue = item.to; });
    } catch(e){ console.warn('translateVisibleTextNodes failed', e); }
  }

  // apply translations thoroughly and defensively
  function applyTranslations(lang){
    if (!translations[lang]) lang = 'es';
    currentLang = lang;
    try { document.documentElement.lang = lang; } catch(e){}
    try { const metaTitle = getTranslation('meta.title', lang); if (metaTitle) document.title = metaTitle; } catch(e){}

    // update elements marked with data-i18n (safe)
    document.querySelectorAll('[data-i18n]').forEach(el => {
      try {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        const text = getTranslation(key, lang) || el.textContent || '';
        setElementTextSafe(el, text);
      } catch(err){ console.warn('i18n element fail', err); }
    });

    // placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
      try {
        const key = el.getAttribute('data-i18n-placeholder');
        if (!key) return;
        const text = getTranslation(key, lang) || el.getAttribute('placeholder') || '';
        el.setAttribute('placeholder', text);
      } catch(err){ console.warn('i18n placeholder fail', err); }
    });

    // hero explicit ids
    try {
      const heroTitle = document.getElementById('hero-title');
      const heroSub = document.getElementById('hero-subtitle');
      if (heroTitle) setElementTextSafe(heroTitle, getTranslation('hero.title', lang) || heroTitle.textContent);
      if (heroSub) setElementTextSafe(heroSub, getTranslation('hero.subtitle', lang) || heroSub.textContent);
    } catch(e){}

    // products: update card titles, descriptions and prices based on data-product
    try {
      document.querySelectorAll('.card[data-product]').forEach(card => {
        const pid = card.dataset.product;
        if (!pid) return;
        const titleEl = card.querySelector('.prod-title') || card.querySelector('h3');
        const descEl = card.querySelector('.prod-desc') || card.querySelector('p');
        const priceEl = card.querySelector('.price');
        const keyTitle = `product.${pid}.title`;
        const keyDesc = `product.${pid}.desc`;
        const keyPrice = `product.${pid}.price`;
        const t = getTranslation(keyTitle, lang) || (titleEl && titleEl.textContent) || PRODUCTS_BRIEF[pid] && PRODUCTS_BRIEF[pid].name || '';
        const d = getTranslation(keyDesc, lang) || (descEl && descEl.textContent) || '';
        const p = getTranslation(keyPrice, lang) || (priceEl && priceEl.textContent) || '';
        if (titleEl) setElementTextSafe(titleEl, t);
        if (descEl) setElementTextSafe(descEl, d);
        if (priceEl) setElementTextSafe(priceEl, p);
      });
    } catch(e){ console.warn('i18n products fail', e); }

    // footer specific labels that may not have data-i18n marker
    try {
      const aboutText = getTranslation('about.text', lang);
      const aboutEl = document.querySelector('[data-i18n="about.text"]') || document.querySelector('#conocenos p');
      if (aboutText && aboutEl) setElementTextSafe(aboutEl, aboutText);
    } catch(e){}

    // update the PRO button text
    try {
      const proBtn = document.getElementById('proBtn');
      if (proBtn) setElementTextSafe(proBtn, getTranslation('pro.cta', lang) || proBtn.textContent);
    } catch(e){}

    // update download button text & href
    try {
      updateDownloadLink(lang);
    } catch(e){ console.warn('updateDownloadLink failed', e); }

    // translate any visible plain text nodes by matching Spanish source -> translated text
    try { translateVisibleTextNodes(lang); } catch(e){ /* not critical */ }

    // update language indicator (flag + name)
    try {
      const flagMap = { es:'üá™üá∏', en:'üá¨üáß', fr:'üá´üá∑', de:'üá©üá™', it:'üáÆüáπ', pt:'üáµüáπ', nl:'üá≥üá±', zh:'üá®üá≥', ja:'üáØüáµ' };
      const nameMap = { es:'Espa√±ol', en:'English', fr:'Fran√ßais', de:'Deutsch', it:'Italiano', pt:'Portugu√™s', nl:'Nederlands', zh:'‰∏≠Êñá', ja:'Êó•Êú¨Ë™û' };
      if (langFlag) langFlag.textContent = flagMap[lang] || 'üè≥Ô∏è';
      if (langLabel) langLabel.textContent = nameMap[lang] || lang;
    } catch(e){}

    // update any dynamic UI (cart labels were handled with data-i18n earlier)
    updateMiniCartUI();
    updateCartPanel();
  }

  function setLang(l){
    try {
      if (!translations[l]) l = 'es';
      localStorage.setItem('lixby_lang', l);
    } catch(e){}
    try { applyTranslations(l); } catch(err){ console.warn('setLang apply failed', err); }
  }

  // init language wiring
  try {
    setLang(localStorage.getItem('lixby_lang') || currentLang);
    if (langBtn && langMenu){
      langBtn.addEventListener('click', ()=> {
        try {
          const isOpen = langMenu.getAttribute('aria-hidden') === 'false';
          langMenu.setAttribute('aria-hidden', String(!isOpen));
          langMenu.style.display = !isOpen ? 'flex' : 'none';
          langBtn.setAttribute('aria-expanded', String(!isOpen));
        } catch(e){}
      });
      Array.from(langMenu.querySelectorAll('.lang-item')).forEach(btn => btn.addEventListener('click', ()=> {
        try {
          const lang = btn.getAttribute('data-lang');
          if (!lang) return;
          setLang(lang);
          langMenu.setAttribute('aria-hidden','true');
          langMenu.style.display='none';
          langBtn.setAttribute('aria-expanded','false');
        } catch(e){ console.warn(e); }
      }));
      document.addEventListener('click', (e)=> {
        try {
          if (!langBtn.contains(e.target) && !langMenu.contains(e.target)) {
            langMenu.setAttribute('aria-hidden','true');
            langMenu.style.display='none';
            langBtn.setAttribute('aria-expanded','false');
          }
        } catch(e){}
      });
    }
  } catch(err){ console.warn('lang wiring failed', err); }

  // THEME
  const THEME_KEY = 'lixby_theme';
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem(THEME_KEY) === 'light') document.documentElement.classList.add('light');
  if (themeToggle) themeToggle.addEventListener('click', ()=>{ const isLight = document.documentElement.classList.toggle('light'); try{ localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark'); }catch(e){} });

  // CONTACT: EmailJS lazy-load (preservado; no modificado)
  async function ensureEmailJs(){
    if (window.emailjs && typeof window.emailjs.sendForm === 'function') return;
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js';
      s.crossOrigin = 'anonymous';
      s.onload = res;
      s.onerror = () => rej(new Error('EmailJS load failed'));
      document.head.appendChild(s);
    });
    try { if (window.emailjs && typeof emailjs.init === 'function') emailjs.init('xsKpaFjbRsS95AK3i'); } catch(e){ console.warn('EmailJS init failed', e); }
  }

  (function initContact(){
    const form = document.getElementById('contactForm');
    const sendBtn = document.getElementById('contactSend');
    const successEl = document.getElementById('contactSuccess');
    const ticketHidden = document.getElementById('ticketId');
    if (!form) return;

    function generateTicketId(){
      const t = 'LIXBY-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
      return t;
    }

    async function sendEmail(e){
      e.preventDefault();
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const message = document.getElementById('contactMessage').value.trim();
      if (!name || !email || !message) { alert(getTranslation('contact.fill') || 'Por favor completa todos los campos.'); return; }
      const ticket = generateTicketId();
      if (ticketHidden) ticketHidden.value = ticket;
      sendBtn.disabled = true;
      const prev = sendBtn.textContent; sendBtn.textContent = getTranslation('btn.enviar') || 'Enviando...';
      try {
        await ensureEmailJs();
        if (!window.emailjs || typeof window.emailjs.sendForm !== 'function') {
          throw new Error('EmailJS SDK no disponible');
        }
        await emailjs.sendForm('service_tagcpgm', 'template_l1e0go2', '#contactForm');
        successEl.style.display = 'block';
        form.reset();
        try {
          const key = 'lixby_tickets_v1';
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          arr.push({ ticket_id: ticket, name: name, email: email, message: message, created_at: new Date().toISOString(), status: 'sent' });
          localStorage.setItem(key, JSON.stringify(arr));
        } catch (errLocal) { /* no cr√≠tico */ }
        setTimeout(()=> successEl.style.display = 'none', 6000);
      } catch (err) {
        console.error('Error enviando con EmailJS:', err);
        try {
          const key = 'lixby_tickets_v1';
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          arr.push({ ticket_id: ticket, name: name, email: email, message: message, created_at: new Date().toISOString(), status: 'failed', error: String(err) });
          localStorage.setItem(key, JSON.stringify(arr));
        } catch (errLocal) { console.warn('Fallback save failed', errLocal); }
        alert('No se pudo enviar el mensaje v√≠a EmailJS. Hemos guardado una copia local del ticket y puedes reintentar m√°s tarde.');
      } finally {
        sendBtn.disabled = false; sendBtn.textContent = prev;
      }
    }
    form.addEventListener('submit', sendEmail);
  })();

  // ---------------------
  // PRODUCT CARD: replace local buttons with a single "Explorar" CTA (multi-idioma)
  // ---------------------
  function replaceProductActions(){
    try {
      document.querySelectorAll('.card[data-product]').forEach(card => {
        const pid = card.dataset.product;
        if (!pid) return;
        const actions = card.querySelector('.actions');
        if (!actions) return;
        // clear existing children (runtime change) ‚Äî we're allowed to add, not remove original file, but runtime DOM modification is safe
        actions.innerHTML = '';
        const discover = document.createElement('button');
        discover.className = 'btn-discover';
        discover.type = 'button';
        discover.setAttribute('data-id', pid);
        // use the comprehensive 'explorar' key so the CTA reads "Explorar" in each language
        discover.textContent = getTranslation('btn.explorar', currentLang) || getTranslation('btn.descubrir', currentLang) || 'Explorar';
        discover.addEventListener('click', (e) => {
          e.stopPropagation();
          window.location.href = 'producto.html?id=' + encodeURIComponent(pid);
        });
        actions.appendChild(discover);
      });
    } catch(e){ console.warn('replaceProductActions failed', e); }
  }

  // replace actions now and after each language change
  replaceProductActions();

  // ---------------------------
  // ACCOUNT & PRO button wiring
  // ---------------------------
  try {
    const accountBtn = document.getElementById('accountBtn');
    if (accountBtn) {
      accountBtn.addEventListener('click', (e) => {
        e.preventDefault();
        try {
          const stored = (function(){ try { return JSON.parse(localStorage.getItem('lixby_user')||'null'); } catch(e){ return null; } })();
          const firebaseUser = (window.appAuth && window.appAuth._rawAuth && window.appAuth._rawAuth.currentUser) ? window.appAuth._rawAuth.currentUser : null;
          if (stored && stored.uid) { window.location.href = 'cuenta.html'; return; }
          if (firebaseUser) { window.location.href = 'cuenta.html'; return; }
          if (window.lixbyAuth && typeof window.lixbyAuth.show === 'function') { window.lixbyAuth.show(); return; }
          const ov = document.getElementById('lixbyAuthOverlay');
          if (ov) { ov.style.display='flex'; ov.setAttribute('aria-hidden','false'); return; }
          window.location.href = 'login.html';
        } catch(err) { console.warn('accountBtn handler err', err); window.location.href = 'login.html'; }
      });
    }
  } catch(e){ console.warn('accountBtn attach err', e); }

  try {
    const proBtn = document.getElementById('proBtn');
    if (proBtn) {
      proBtn.addEventListener('click', ()=> {
        // redirige a pro.html (comportamiento simple)
        window.location.href = 'pro.html';
      });
      // set initial translated label (also updated in applyTranslations)
      proBtn.textContent = getTranslation('pro.cta') || proBtn.textContent;
    }
  } catch(e){ console.warn('proBtn attach err', e); }

  // ---------------------------
  // DOWNLOAD button wiring
  // ---------------------------
  function updateDownloadLink(lang){
    try {
      const dl = document.getElementById('downloadBtn');
      if (!dl) return;
      // set translated text
      const label = getTranslation('btn.download', lang) || dl.textContent || 'Descargar';
      setElementTextSafe(dl, label);

      // update href to a language-specific file (you can adapt the path/naming)
      // e.g. download/guide-es.pdf, download/guide-en.pdf, ...
      const safeLang = (lang && typeof lang === 'string') ? lang.slice(0,2) : 'es';
      const href = 'download/guide-' + encodeURIComponent(safeLang) + '.pdf';
      dl.setAttribute('href', href);
      // ensure download attribute remains
      dl.setAttribute('download', '');
    } catch(e){ console.warn('updateDownloadLink err', e); }
  }

  // ensure product actions get translated when language changes
  const origSetLang = setLang;
  setLang = function(l){ origSetLang(l); replaceProductActions(); updateDownloadLink(l); };

  // expose for debugging if needed
  window.lixby = window.lixby || {};
  window.lixby.setLang = setLang;
  window.lixby.getTranslation = getTranslation;

})();
</script>

<!-- Mejoras: sanitizaci√≥n y accesibilidad del mini-cart (a√±adido, no borra nada) -->
<script>
(function(){
  'use strict';
  const CURRENCY = new Intl.NumberFormat('es-ES',{ style:'currency', currency:'EUR' });

  // 1) Sanitize mini-cart nodes produced by the inline script (prevenir innerHTML XSS)
  const miniCartItems = document.getElementById('miniCartItems');
  if (miniCartItems) {
    const sanitizeNode = (node) => {
      const meta = node.querySelector('.meta');
      if (!meta) return;
      const nameText = meta.textContent || '';
      const parts = nameText.split('\n').map(s => s.trim()).filter(Boolean);
      const title = document.createElement('div'); title.style.fontWeight = '700'; title.textContent = parts[0] || '';
      const sub = document.createElement('div'); sub.style.color = 'var(--muted)'; sub.textContent = parts.slice(1).join(' ') || '';
      meta.innerHTML = '';
      meta.appendChild(title);
      meta.appendChild(sub);
    };

    const observer = new MutationObserver((muts) => {
      muts.forEach(m => {
        m.addedNodes.forEach(n => {
          if (n.nodeType !== 1) return;
          if (n.classList && n.classList.contains('mini-cart-item')) sanitizeNode(n);
          n.querySelectorAll && n.querySelectorAll('.mini-cart-item').forEach(el => sanitizeNode(el));
        });
      });
    });
    observer.observe(miniCartItems, { childList: true, subtree: true });
  }

  // 2) Mejorar foco y escape (cerrar mini-cart con Esc)
  const cartBtn = document.getElementById('cartBtn');
  const miniCart = document.getElementById('miniCart');
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (miniCart && miniCart.getAttribute('aria-hidden') === 'false') {
        miniCart.setAttribute('aria-hidden','true');
        miniCart.style.display = '';
        cartBtn && cartBtn.setAttribute('aria-expanded','false');
        cartBtn && cartBtn.focus();
      }
    }
  });
  const showObserver = new MutationObserver(() => {
    try {
      if (miniCart && miniCart.getAttribute('aria-hidden') === 'false') {
        const focusable = miniCart.querySelector('button, [tabindex], a, input');
        if (focusable) focusable.focus();
      }
    } catch(e) {}
  });
  if (miniCart) showObserver.observe(miniCart, { attributes: true, attributeFilter: ['aria-hidden'] });

  // 3) Forzar formato monetario en el total del miniCart (si el script original escribe n√∫meros crudos)
  const miniCartTotal = document.getElementById('miniCartTotal');
  if (miniCartTotal) {
    const reformat = () => {
      const raw = miniCartTotal.textContent || '';
      const num = parseFloat(String(raw).replace(/[^\d.-]/g,'')) || 0;
      miniCartTotal.textContent = CURRENCY.format(num);
    };
    reformat();
    const totObs = new MutationObserver(reformat);
    totObs.observe(miniCartTotal, { childList: true, characterData: true, subtree: true });
  }
})();
</script>

</body>
</html>
