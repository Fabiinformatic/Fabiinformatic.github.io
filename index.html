<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIXBY ‚Äî Tecnolog√≠a minimalista</title>

  <!-- PERF: preconnect para reducir latencia en recursos externos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <link rel="stylesheet" href="style.css" />
  <!-- Overrides locales para header y comportamiento consistente -->
  <style>
    /* (estilos conservados, cortados para brevedad en esta vista ‚Äî en tu archivo real mantenlos completos) */
    /* Header compacto, l√≠nea recta, minimal */
    .nav { position: fixed; top: 0; left: 0; right: 0; z-index: 120; padding: 10px 24px; background: rgba(255,255,255,0.02); backdrop-filter: blur(8px) saturate(120%); -webkit-backdrop-filter: blur(8px) saturate(120%); border-bottom: 1px solid rgba(255,255,255,0.03); border-radius: 0; box-shadow: none; }
    .nav-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 16px; min-height: 64px; padding: 0 6px; }
    .nav-left { display:flex; align-items:center; gap:8px; flex:0 0 auto; }
    #navLinks { display:flex; gap:18px; align-items:center; justify-content:center; flex: 1 1 auto; padding: 8px 12px; white-space: nowrap; }
    .nav-right { display:flex; gap:10px; align-items:center; justify-content:flex-end; flex: 0 0 auto; flex-direction: row !important; }
    .cart-wrapper { position:relative; }
    .mini-cart { right:18px; top:56px; width:320px; box-sizing:border-box; z-index:140; display:none; flex-direction:column; }
    .lang-menu { right:18px; top:56px; box-sizing:border-box; z-index:140; }
    main { padding-top: calc(64px + 12px); }
    .card .actions { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .btn-add { padding:8px 12px; border-radius:8px; border: none; cursor:pointer; background:linear-gradient(180deg,var(--accent), color-mix(in oklab, var(--accent) 60%, #fff 40%)); color:#00121a; font-weight:700; }
    .btn-view { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--text); cursor:pointer; }
    .contact-min { max-width: 1100px; margin: 28px auto; padding: 30px; display:flex; gap:24px; align-items:center; justify-content:space-between; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid rgba(255,255,255,0.03); box-sizing:border-box; }
    .contact-min .form { flex:0 0 360px; display:flex; flex-direction:column; gap:10px }
    .contact-success { display:none; color:var(--accent); font-weight:600; margin-top:8px }
    #authOverlay { display:none; }
    #authOverlay[aria-hidden="false"] { display:block; }
    #authModal .btn { min-width:120px; }

    /* ligero hover animation global */
    .btn-add, .btn-fav, .icon-btn, .btn { transition: transform .16s cubic-bezier(.2,.9,.3,1), box-shadow .16s ease; }
    .btn-add:hover, .btn-fav:hover, .icon-btn:hover, .btn:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 10px 22px rgba(2,6,12,0.12); }

    /* skip link visible cuando tiene foco */
    .skip-link {
      position: absolute;
      left: 12px;
      top: 8px;
      padding: 8px 12px;
      background: #07101a;
      color: #fff;
      border-radius: 6px;
      z-index: 99999;
      transform: translateY(-120%);
      transition: transform .18s ease;
    }
    .skip-link:focus { transform: translateY(0); }

    /* pantalla oculta para lectores */
    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    @media (max-width:900px){
      .contact-min { flex-direction:column; } .contact-min .form{ width:100% }
    }

    /* small header account holder */
    .account-holder-btn {
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 8px;
      border-radius:10px;
      background: transparent;
      border:1px solid rgba(255,255,255,0.03);
      color:var(--text);
      cursor:pointer;
    }
    .account-holder-btn img { width:32px; height:32px; border-radius:8px; object-fit:cover; display:block; }
    .account-holder-btn .name { font-weight:700; font-size:0.95rem; color:var(--muted); }

    /* icon inside auth buttons */
    .auth-icon { width:18px; height:18px; flex:0 0 18px; display:inline-block; vertical-align:middle; }
    .auth-btn { display:inline-flex; align-items:center; gap:10px; justify-content:center; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; cursor:pointer; }

    /* Footer improvements */
    .footer { text-align:left; padding:40px 20px; margin-top:40px; }
    .footer-grid { max-width:1200px; margin:0 auto; display:grid; grid-template-columns: 1.4fr 1fr 1fr 1.2fr; gap:22px; align-items:start; }
    .footer-col h4 { margin:0 0 8px 0; font-size:1rem; color:var(--text); }
    .footer-brand { font-weight:800; letter-spacing:0.08em; font-size:1.05rem; margin-bottom:8px; }
    .footer p { margin:0 0 8px 0; color:var(--muted); }
    .footer-links { display:flex; flex-direction:column; gap:6px; }
    .footer-links a { color:var(--muted); font-size:0.95rem; }
    .social-links { display:flex; gap:8px; margin-top:8px; }
    .social-links a { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; background: rgba(255,255,255,0.02); color:var(--text); text-decoration:none; }
    .newsletter-form { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .newsletter-form input[type="email"]{ padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); min-width:0; flex:1; }
    .newsletter-form button{ padding:10px 12px; border-radius:8px; border:0; background:var(--accent); color:#00121a; font-weight:700; cursor:pointer; }
    .footer-bottom { max-width:1200px; margin:18px auto 0; display:flex; align-items:center; justify-content:space-between; gap:12px; color:var(--muted); font-size:0.92rem; }
    .legal-links { display:flex; gap:12px; align-items:center; }
    .back-to-top { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); cursor:pointer; color:var(--text); }
    @media (max-width:900px){
      .footer-grid { grid-template-columns: 1fr; gap:14px; }
      .footer-bottom { flex-direction:column; align-items:flex-start; gap:8px; }
    }

    /* small additions to style brand with image */
    .brand { display:flex; align-items:center; gap:8px; cursor:pointer; text-decoration:none; color:inherit; }
    .brand img { width:44px; height:44px; border-radius:8px; object-fit:cover; display:block; }
    .brand .title { font-weight:800; letter-spacing:0.08em; }
  </style>

  <!-- A√±adir: glass util (liquid glass styling consistente) -->
  <style id="lixby-glass-style">
    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      backdrop-filter: blur(10px) saturate(120%);
      box-shadow: 0 6px 26px rgba(2,6,12,0.48);
      color: inherit;
    }
    .btn, .icon-btn {
      transition: transform .14s cubic-bezier(.2,.9,.3,1), box-shadow .14s ease;
    }
    .btn:focus, .icon-btn:focus, button:focus { outline: 3px solid rgba(10,132,255,0.14); outline-offset: 3px; }
  </style>
</head>
<body>
  <!-- skip link para accesibilidad -->
  <a class="skip-link" href="#maincontent">Saltar al contenido</a>

<!-- NAV -->
<header class="nav glass" role="banner">
  <div class="nav-inner">
    <!-- LEFT: logo -->
    <div class="nav-left">
      <!-- Usamos DIV con onclick y manejador de teclado (igual que tu ejemplo), y role/tabindex para accesibilidad -->
      <div class="brand"
           role="link"
           tabindex="0"
           aria-label="Ir al inicio"
           onclick="location.href='index.html'"
           onkeydown="if(event.key==='Enter' || event.key===' ') { event.preventDefault(); location.href='index.html'; }">
        <img src="https://i.imgur.com/dOCYmkx.jpeg" alt="LIXBY logo" width="44" height="44">
        <div class="title">LIXBY</div>
      </div>
    </div>
    <!-- CENTER: nav links -->
    <nav id="navLinks" role="navigation" aria-label="Principal">
      <a href="#inicio" data-i18n="nav.inicio">Inicio</a>
      <a href="#productos" data-i18n="nav.productos">Productos</a>
      <a href="#contacto" data-i18n="nav.contacto">Cont√°ctanos</a>
      <a href="#conocenos" data-i18n="nav.conocenos">Con√≥cenos</a>
    </nav>
    <!-- RIGHT: controles en fila -->
    <div class="nav-right" aria-hidden="false">
      <div class="cart-wrapper" style="position:relative;">
        <!-- A√±adido aria-controls y aria-expanded para accesibilidad -->
        <button id="cartBtn" class="icon-btn" aria-label="Ver carrito" aria-controls="miniCart" aria-expanded="false" type="button">üõí <span id="cartCount" class="badge">0</span></button>
        <div id="miniCart" class="mini-cart glass" aria-hidden="true" role="region" aria-label="Mini carrito">
          <div class="mini-cart-header" style="display:flex;justify-content:space-between;align-items:center;">
            <strong data-i18n="cart.title">Carrito</strong>
            <button id="clearCart" class="text-btn" data-i18n="cart.clear" type="button">Vaciar</button>
          </div>
          <div id="miniCartItems" class="mini-cart-items" tabindex="0" aria-live="polite" style="max-height:220px;overflow:auto;">
            <!-- items din√°micos -->
          </div>
          <div class="mini-cart-footer" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong data-i18n="cart.total">Total:</strong> <span id="miniCartTotal">0‚Ç¨</span></div>
              <div><button id="checkoutBtn" class="btn primary" data-i18n="cart.checkout" type="button">Pagar</button></div>
            </div>
            <div style="display:flex;gap:8px;"><button id="viewCartBtn" class="btn ghost" type="button">Ver carrito</button></div>
          </div>
        </div>
      </div>

      <div class="lang-wrapper">
        <button id="langBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false" type="button"> üá™üá∏ <span id="langLabel">Espa√±ol</span> ‚ñæ </button>
        <div id="langMenu" class="lang-menu glass" aria-hidden="true" style="display:none;flex-direction:column;gap:6px;padding:8px;width:160px;">
          <button class="lang-item" data-lang="es" type="button">üá™üá∏ Espa√±ol</button>
          <button class="lang-item" data-lang="en" type="button">üá¨üáß English</button>
          <button class="lang-item" data-lang="fr" type="button">üá´üá∑ Fran√ßais</button>
        </div>
      </div>

      <div id="accountContainer">
        <button id="accountBtn" class="btn ghost" aria-label="Mi cuenta" type="button">Cuenta</button>
      </div>

      <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema" type="button">‚óê</button>
    </div>
  </div>
</header>

<!-- NOTE:
     He REMOVIDO aqu√≠ el antiguo bloque del modal hard-coded.
     El modal ahora lo crea y gestiona `auth-firebase-minimal.js` (se carga como m√≥dulo al final).
-->


<main id="maincontent">
  <!-- HERO -->
  <section id="inicio" class="hero reveal" aria-labelledby="hero-title">
    <div class="hero-content">
      <h1 id="hero-title">La tecnolog√≠a que te entiende</h1>
      <p>Innovaci√≥n minimalista para tu d√≠a a d√≠a</p>
      <!-- changed to explorar.html as requested -->
      <a href="explorar.html" class="btn primary" data-i18n="btn.explorar">Explorar</a>
    </div>
  </section>

  <!-- PRODUCTOS -->
  <section id="productos" class="section reveal" aria-labelledby="prod-title">
    <h2 id="prod-title">Productos</h2>
    <div class="grid">
      <!-- Lixby One Air -->
      <article class="card glass" data-product="lixby-one-air" role="button" tabindex="0" aria-label="Lixby One Air">
        <div class="thumb">
          <!-- mantuvimos loading lazy y dimensiones -->
          <img src="https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg" alt="Lixby One Air"
               loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3>Lixby One Air</h3>
        <p>Ultraligero y econ√≥mico.</p>
        <span class="price">249‚Ç¨</span>
        <div class="actions">
          <button class="btn-view" onclick="location.href='producto.html?id=lixby-one-air'" type="button">Ver</button>
          <button class="btn-add" data-id="lixby-one-air" type="button">A√±adir al carrito</button>
        </div>
      </article>

      <!-- Lixby One -->
      <article class="card glass" data-product="lixby-one" role="button" tabindex="0" aria-label="Lixby One">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg" alt="Lixby One"
               loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3>Lixby One</h3>
        <p>Ultraligero y potente.</p>
        <span class="price">349‚Ç¨</span>
        <div class="actions">
          <button class="btn-view" onclick="location.href='producto.html?id=lixby-one'" type="button">Ver</button>
          <button class="btn-add" data-id="lixby-one" type="button">A√±adir al carrito</button>
        </div>
      </article>

      <!-- Lixby One Pro -->
      <article class="card glass" data-product="lixby-one-pro" role="button" tabindex="0" aria-label="Lixby One Pro">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/61rriyfRKwL.jpg" alt="Lixby One Pro"
               loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3>Lixby One Pro</h3>
        <p>Audio de alta fidelidad.</p>
        <span class="price">899‚Ç¨</span>
        <div class="actions">
          <button class="btn-view" onclick="location.href='producto.html?id=lixby-one-pro'" type="button">Ver</button>
          <button class="btn-add" data-id="lixby-one-pro" type="button">A√±adir al carrito</button>
        </div>
      </article>
    </div>
  </section>

  <!-- CONTACTO -->
  <section id="contacto" class="section contact-min glass reveal" aria-labelledby="contact-title">
    <div class="left">
      <h2 id="contact-title">Cont√°ctanos</h2>
      <p class="lead">D√©janos una duda o sugerencias y te responderemos lo antes posible.</p>
    </div>

    <!-- A√±adido: hidden ticket_id para que EmailJS reciba un identificador √∫nico del ticket -->
    <form id="contactForm" class="form" aria-label="Formulario de contacto" onsubmit="return false;">
      <input id="contactName" name="from_name" type="text" placeholder="Nombre" required autocomplete="name">
      <input id="contactEmail" name="from_email" type="email" placeholder="Correo" required autocomplete="email">
      <textarea id="contactMessage" name="message" placeholder="Tu mensaje" required></textarea>

      <!-- hidden field que enviaremos a EmailJS como {{ticket_id}} -->
      <input id="ticketId" type="hidden" name="ticket_id" value="">

      <div class="actions">
        <button type="button" class="btn ghost" onclick="document.getElementById('contactForm').reset();">Borrar</button>
        <button type="submit" id="contactSend" class="btn primary">Enviar</button>
      </div>
      <div id="contactSuccess" class="contact-success" role="status" aria-live="polite">Mensaje enviado. ¬°Gracias! Te contestaremos pronto.</div>
    </form>
  </section>

  <!-- CON√ìCENOS -->
  <section id="conocenos" class="section reveal" aria-labelledby="about-title">
    <h2 id="about-title">Con√≥cenos</h2>
    <p>En LIXBY creemos en el equilibrio perfecto entre dise√±o y funcionalidad. Creamos productos que no solo funcionan, sino que tambi√©n inspiran.</p>
  </section>
</main>

<!-- debug (oculto a usuarios, √∫til para showDebug) -->
<div id="debug" style="display:none;max-width:1100px;margin:12px auto;color:var(--muted);white-space:pre-wrap;"></div>

<!-- Enhanced footer: preserve original copyright but add columns, newsletter and links -->
<footer class="footer glass" role="contentinfo" aria-labelledby="footer-heading">
  <div class="footer-grid" id="footerGrid">
    <div class="footer-col">
      <div class="footer-brand">LIXBY</div>
      <p>Dise√±o minimalista, tecnolog√≠a que acompa√±a tu d√≠a a d√≠a. S√≠guenos para novedades y lanzamientos.</p>
      <div class="social-links" aria-label="Redes sociales">
        <a href="#" title="Twitter" aria-label="Twitter" rel="noopener">
          <!-- simple svg icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M22 5.92c-.64.29-1.32.49-2.04.58.73-.44 1.28-1.14 1.54-1.97-.68.4-1.43.69-2.23.85C18.94 4.6 18 4.2 17 4.2c-1.83 0-3.32 1.54-3 3.34C9.72 7.3 6.1 5.3 3.73 2.47c-.2.35-.3.76-.3 1.2 0 1.03.52 1.94 1.33 2.48-.6 0-1.15-.18-1.63-.45v.05c0 1.2.9 2.2 2.06 2.43-.45.12-.92.15-1.4.06.4 1.25 1.56 2.16 2.94 2.19C6.1 11.4 4.5 11.9 3 11.9c-.25 0-.5 0-.74-.04C4.36 13.06 6.16 13.8 8.12 13.8c8.35 0 12.92-6.9 12.92-12.88v-.58c.9-.68 1.6-1.54 2.2-2.52-.83.38-1.72.63-2.64.74z"/></svg>
        </a>
        <a href="#" title="Instagram" aria-label="Instagram" rel="noopener">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 6.2a4.8 4.8 0 1 0 0 9.6 4.8 4.8 0 0 0 0-9.6zm6.5-.9a1.1 1.1 0 1 1 0 2.2 1.1 1.1 0 0 1 0-2.2zM12 9.6a2.4 2.4 0 1 1 0 4.8 2.4 2.4 0 0 1 0-4.8z"/></svg>
        </a>
        <a href="#" title="YouTube" aria-label="YouTube" rel="noopener">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M23 7.5s-.2-1.7-.8-2.4c-.8-.9-1.7-.92-2.1-1-2.95-.22-7.35-.22-7.35-.22S6.9 3 3.95 3.22c-.44.07-1.33.1-2.1 1C1.27 4.8 1 6.5 1 6.5S1 8.86 1 11.25v1.5C1 16 1 18.5 1 18.5s.27 1.7.85 2.4c.8.9 1.84.87 2.3.98 1.66.22 7.05.22 7.05.22s4.4 0 7.35-.22c.44-.07 1.33-.1 2.1-1 .62-.66.82-2.4.82-2.4s.1-2.5.1-4.88v-1.5C23 8.86 23 7.5 23 7.5zM9.75 15.5v-7l6 3.5-6 3.5z"/></svg>
        </a>
      </div>
    </div>

    <div class="footer-col">
      <h4>Enlaces</h4>
      <div class="footer-links" role="navigation" aria-label="Enlaces r√°pidos">
        <a href="explorar.html">Explorar</a>
        <a href="productos.html">Cat√°logo</a>
        <a href="carrito.html">Carrito</a>
        <a href="cuenta.html">Mi cuenta</a>
      </div>
    </div>

    <div class="footer-col">
      <h4>Ayuda</h4>
      <div class="footer-links">
        <a href="contacto.html">Contacto</a>
        <a href="faq.html" id="footerFaqLink">Preguntas frecuentes</a>
        <a href="envios.html">Env√≠os y devoluciones</a>
        <a href="soporte.html">Soporte t√©cnico</a>
      </div>
    </div>

    <div class="footer-col" aria-label="Newsletter">
      <h4>Suscr√≠bete</h4>
      <p>Recibe novedades, ofertas exclusivas y lanzamientos.</p>
      <form id="newsletterForm" class="newsletter-form" onsubmit="return false;" aria-label="Formulario newsletter">
        <input id="newsletterEmail" type="email" placeholder="tu@correo.com" aria-label="Correo electr√≥nico para newsletter" required>
        <button id="newsletterBtn" type="submit" aria-label="Suscribirse">Suscribir</button>
      </form>
      <div id="newsletterMsg" role="status" aria-live="polite" style="margin-top:8px;color:var(--muted);font-size:0.95rem"></div>
    </div>
  </div>

  <div class="footer-bottom">
    <div class="legal-left">
      <small>¬© <span id="year"></span> LIXBY ‚Äî Todos los derechos reservados</small>
      <div class="legal-links" style="margin-left:12px;">
        <a href="privacidad.html">Pol√≠tica de privacidad</a>
        <a href="terminos.html">T√©rminos y condiciones</a>
        <!-- MODIFICADO: abre en la misma pesta√±a -->
        <a id="accessibilityLink"
           href="accessibility.html"
           aria-label="Ir a la p√°gina de accesibilidad">
          Accesibilidad
        </a>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <button id="backToTop" class="back-to-top" aria-label="Volver arriba" title="Volver arriba">‚Üë Volver arriba</button>
      <small style="color:var(--muted)">Versi√≥n demo</small>
    </div>
  </div>
</footer>

<!-- Cart panel (est√°tico) + backdrop -->
<div id="cartBackdrop" class="cart-backdrop" aria-hidden="true"></div>
<aside id="cartPanel" class="cart-panel" aria-hidden="true">
  <div class="cart-panel-inner glass" role="dialog" aria-label="Carrito">
    <div class="cart-header" style="display:flex;justify-content:space-between;align-items:center;">
      <strong data-i18n="cart.title">Carrito</strong>
      <button id="cartPanelClose" class="text-btn" aria-label="Cerrar" type="button">‚úï</button>
    </div>
    <div id="cartPanelItems" class="cart-list" style="max-height:60vh;overflow:auto;padding:12px"></div>
    <div class="cart-footer" style="padding:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Total</strong>
        <span id="cartPanelTotal">0‚Ç¨</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="cartPanelCheckout" class="btn primary" data-i18n="cart.checkout" type="button">Pagar</button>
        <button id="cartPanelClear" class="btn ghost" data-i18n="cart.clear" type="button">Vaciar</button>
      </div>
    </div>
  </div>
</aside>

<!-- Live region for screen-reader announcements (used when adding to cart, etc.) -->
<div id="announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<noscript style="display:block;background:#fffb; padding:10px; text-align:center;">
  JavaScript est√° desactivado o ha ocurrido un error. Si la p√°gina no carga correctamente, abre la consola (F12 ‚Üí Console).
</noscript>

<!-- ===========================
     SCRIPTS (todo inline para que copies directo)
     =========================== -->
<script>
(function(){
  // -------------------------
  // Helpers y estado
  // -------------------------
  const KEY = 'lixby_cart_v1';
  // Formateador consistente (es-ES)
  const CURRENCY = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });

  function parsePrice(s){ if (s === undefined || s === null) return 0; return Number(String(s).replace(/[^\d.,-]/g,'').replace(',', '.')) || 0; }
  function saveCart(c){ try { localStorage.setItem(KEY, JSON.stringify(c)); } catch(e){} }
  function loadCart(){ try { return JSON.parse(localStorage.getItem(KEY))||[]; } catch(e){ return []; } }
  function formatPriceNum(num){ return CURRENCY.format(Number(num) || 0); }
  function showDebug(msg){ const el=document.getElementById('debug'); if(!el) return; el.style.display='block'; el.textContent += msg + "\n"; console.log('DEBUG',msg); }

  // set year
  try { document.getElementById('year').textContent = new Date().getFullYear(); } catch(e){}

  // product brief (igual que antes)
  const PRODUCTS_BRIEF = {
    'lixby-one-air': { id:'lixby-one-air', name: 'Lixby One Air', price: '249‚Ç¨', priceNum: 249, image: 'https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg' },
    'lixby-one': { id:'lixby-one', name: 'Lixby One', price: '349‚Ç¨', priceNum: 349, image: 'https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg' },
    'lixby-one-pro': { id:'lixby-one-pro', name: 'Lixby One Pro', price: '899‚Ç¨', priceNum: 899, image: 'https://m.media-amazon.com/images/I/61rriyfRKwL.jpg' }
  };

  // CART
  let cart = loadCart();
  const cartBtn = document.getElementById('cartBtn');
  const miniCart = document.getElementById('miniCart');
  const miniCartItems = document.getElementById('miniCartItems');
  const miniCartTotal = document.getElementById('miniCartTotal');
  const cartCount = document.getElementById('cartCount');
  const clearCartBtn = document.getElementById('clearCart');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const announcements = document.getElementById('announcements');

  // panel elements
  const cartPanel = document.getElementById('cartPanel');
  const cartBackdrop = document.getElementById('cartBackdrop');
  const cartPanelClose = document.getElementById('cartPanelClose');
  const cartPanelItems = document.getElementById('cartPanelItems');
  const cartPanelTotal = document.getElementById('cartPanelTotal');
  const cartPanelClear = document.getElementById('cartPanelClear');

  function updateMiniCartUI(){
    if (!cartCount) return;
    const totalQty = cart.reduce((s,i)=>s+(i.qty||0),0);
    cartCount.textContent = totalQty;
    if (!miniCartItems) return;
    miniCartItems.innerHTML = '';
    if (cart.length === 0) {
      miniCartItems.innerHTML = '<div style="padding:8px;color:var(--muted)">'+ (getTranslation('cart.empty') || 'Tu carrito est√° vac√≠o.') +'</div>';
      if (miniCartTotal) miniCartTotal.textContent = formatPriceNum(0);
      return;
    }
    let total = 0;
    // fragment para menor reflow
    const frag = document.createDocumentFragment();
    cart.forEach((it, idx) => {
      const item = document.createElement('div');
      item.className = 'mini-cart-item';
      item.style.display = 'flex'; item.style.gap='10px'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderRadius='8px';
      const img = document.createElement('img'); img.src = it.image || 'https://via.placeholder.com/80x80?text=Img'; img.alt = it.name; img.style.width='44px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
      img.loading='lazy'; img.decoding='async';
      const meta = document.createElement('div'); meta.className='meta';
      // RENDER SEGURO: no usar innerHTML con contenido din√°mico
      const title = document.createElement('div'); title.style.fontWeight = '700'; title.textContent = it.name || '';
      const subtitle = document.createElement('div'); subtitle.style.color = 'var(--muted)'; subtitle.textContent = `${formatPriceNum(it.priceNum || parsePrice(it.price))} √ó ${it.qty||1}`;
      meta.appendChild(title); meta.appendChild(subtitle);

      const remove = document.createElement('button'); remove.className='remove'; remove.textContent='‚úï'; remove.style.background='transparent'; remove.style.border='none'; remove.style.cursor='pointer';
      remove.setAttribute('type','button');
      remove.addEventListener('click', (e)=>{ e.stopPropagation(); cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
      item.appendChild(img); item.appendChild(meta); item.appendChild(remove);
      frag.appendChild(item);
      total += (it.priceNum || parsePrice(it.price)) * (it.qty||1);
    });
    miniCartItems.appendChild(frag);
    if (miniCartTotal) miniCartTotal.textContent = formatPriceNum(total);
  }

  function updateCartPanel(){
    if (!cartPanelItems) return;
    cartPanelItems.innerHTML = '';
    if (cart.length === 0) {
      cartPanelItems.innerHTML = '<div style="padding:12px;color:var(--muted)">'+ (getTranslation('cart.empty') || 'Tu carrito est√° vac√≠o.') +'</div>';
      if (cartPanelTotal) cartPanelTotal.textContent = formatPriceNum(0);
      return;
    }
    let total = 0;
    const frag = document.createDocumentFragment();
    cart.forEach((it, idx) => {
      const row = document.createElement('div');
      row.style.display='flex'; row.style.gap='12px'; row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      const img = document.createElement('img'); img.src = it.image || ''; img.alt = it.name; img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
      const meta = document.createElement('div'); meta.style.flex='1';
      const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = it.name || '';
      const qty = document.createElement('div'); qty.style.color='var(--muted)'; qty.textContent = `√ó ${it.qty || 1} ‚Äî ${formatPriceNum(it.priceNum || parsePrice(it.price))}`;
      meta.appendChild(title); meta.appendChild(qty);
      const remove = document.createElement('button'); remove.className='text-btn'; remove.textContent='Eliminar'; remove.setAttribute('type','button');
      remove.addEventListener('click', ()=> { cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
      row.appendChild(img); row.appendChild(meta); row.appendChild(remove);
      frag.appendChild(row);
      total += (it.priceNum || parsePrice(it.price)) * (it.qty||1);
    });
    cartPanelItems.appendChild(frag);
    if (cartPanelTotal) cartPanelTotal.textContent = formatPriceNum(total);
  }

  // ensure miniCart style reflects aria-hidden initially
  if (miniCart) {
    if (miniCart.getAttribute('aria-hidden') === 'false') miniCart.style.display = 'flex';
    else miniCart.style.display = '';
  }

  // Hover show mini-cart & click open panel
  (function wireCartHoverAndClick(){
    const wrapper = document.querySelector('.cart-wrapper');
    let hideTimeout = null;

    function showMini(){
      if (!miniCart) return;
      miniCart.setAttribute('aria-hidden','false');
      miniCart.style.display = 'flex';
      try { cartBtn.setAttribute('aria-expanded','true'); } catch(e){}
    }
    function hideMini(){
      if (!miniCart) return;
      miniCart.setAttribute('aria-hidden','true');
      miniCart.style.display = '';
      try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){}
    }

    // show on hover enter; keep visible while hovering miniCart
    if (wrapper) {
      wrapper.addEventListener('mouseenter', (e) => {
        clearTimeout(hideTimeout);
        showMini();
      });
      wrapper.addEventListener('mouseleave', (e) => {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          // do not hide if cart panel is open
          if (cartPanel && cartPanel.classList.contains('open')) return;
          hideMini();
        }, 180);
      });
    }
    if (miniCart) {
      miniCart.addEventListener('mouseenter', () => { clearTimeout(hideTimeout); showMini(); });
      miniCart.addEventListener('mouseleave', () => {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          if (cartPanel && cartPanel.classList.contains('open')) return;
          hideMini();
        }, 180);
      });
    }

    // click opens panel (and hide mini)
    if (cartBtn) {
      cartBtn.addEventListener('click', (e) => {
        openCartPanel();
      });
    }

    // also wire viewCartBtn to open panel
    const viewBtn = document.getElementById('viewCartBtn');
    if (viewBtn) viewBtn.addEventListener('click', (e)=> openCartPanel());
  })();

  // Panel control functions
  function openCartPanel(){
    if (!cartPanel || !cartBackdrop) return;
    cartPanel.classList.add('open');
    cartBackdrop.classList.add('open');
    cartPanel.setAttribute('aria-hidden','false');
    cartBackdrop.setAttribute('aria-hidden','false');
    // ensure mini hidden
    if (miniCart) { miniCart.setAttribute('aria-hidden','true'); miniCart.style.display = ''; try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){} }
    // update content
    updateCartPanel();
  }
  function closeCartPanel(){
    if (!cartPanel || !cartBackdrop) return;
    cartPanel.classList.remove('open');
    cartBackdrop.classList.remove('open');
    cartPanel.setAttribute('aria-hidden','true');
    cartBackdrop.setAttribute('aria-hidden','true');
  }
  if (cartBackdrop) cartBackdrop.addEventListener('click', closeCartPanel);
  if (cartPanelClose) cartPanelClose.addEventListener('click', closeCartPanel);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (cartPanel && cartPanel.classList.contains('open')) closeCartPanel(); } });

  // clear handlers for panel & mini
  if (clearCartBtn) clearCartBtn.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
  if (cartPanelClear) cartPanelClear.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); updateCartPanel(); });

  if (checkoutBtn) checkoutBtn.addEventListener('click', () => { if (cart.length===0) return alert('El carrito est√° vac√≠o'); alert('Simulaci√≥n de checkout: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });
  if (document.getElementById('cartPanelCheckout')) document.getElementById('cartPanelCheckout').addEventListener('click', () => { if (cart.length===0) return alert('El carrito est√° vac√≠o'); alert('Simulaci√≥n de checkout desde panel: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });

  window.addToCart = function(product){
    const existing = cart.find(p => p.id === product.id);
    if (existing) existing.qty = (existing.qty||1) + 1;
    else cart.push({ id: product.id, name: product.name, price: product.price, priceNum: Number(product.priceNum || parsePrice(product.price) || 0), qty:1, image: product.image });
    saveCart(cart);
    updateMiniCartUI();
    updateCartPanel();
    if (miniCart) { miniCart.setAttribute('aria-hidden','false'); miniCart.style.display = 'flex'; try { cartBtn.setAttribute('aria-expanded','true'); } catch(e){} setTimeout(()=>{ if (miniCart) { miniCart.setAttribute('aria-hidden','true'); miniCart.style.display = ''; try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){} } }, 2200); }
    // announce for screen readers
    try { if (announcements) announcements.textContent = `${product.name} a√±adido al carrito.`; } catch(e){}
  };

  updateMiniCartUI();
  updateCartPanel();

  // LANG / I18N (simple)
  const langBtn = document.getElementById('langBtn'), langMenu = document.getElementById('langMenu'), langLabel = document.getElementById('langLabel');
  const translations = {
    es: { "nav.inicio":"Inicio","nav.productos":"Productos","nav.contacto":"Cont√°ctanos","nav.conocenos":"Con√≥cenos","cart.title":"Carrito","cart.clear":"Vaciar","cart.total":"Total:","cart.checkout":"Pagar","btn.add":"A√±adir al carrito","btn.added":"A√±adido","btn.explorar":"Explorar","btn.enviar":"Enviar","theme.toggle":"Cambiar tema","cart.empty":"Tu carrito est√° vac√≠o." },
    en: { "nav.inicio":"Home","nav.productos":"Products","nav.contacto":"Contact","nav.conocenos":"About","cart.title":"Cart","cart.clear":"Clear","cart.total":"Total:","cart.checkout":"Checkout","btn.add":"Add to cart","btn.added":"Added","btn.explorar":"Explore","btn.enviar":"Send","theme.toggle":"Toggle theme","cart.empty":"Your cart is empty." },
    fr: { "nav.inicio":"Accueil","nav.productos":"Produits","nav.contacto":"Contact","nav.conocenos":"√Ä propos","cart.title":"Panier","cart.clear":"Vider","cart.total":"Total:","cart.checkout":"Payer","btn.add":"Ajouter au panier","btn.added":"Ajout√©","btn.explorar":"Explorer","btn.enviar":"Envoyer","theme.toggle":"Changer el th√®me","cart.empty":"Votre panier est vide." }
  };
  // start language from localStorage or default 'es'
  let currentLang = localStorage.getItem('lixby_lang') || 'es';

  function getTranslation(key){
    try {
      const map = translations[currentLang] || translations['es'];
      return (map && map[key]) ? map[key] : null;
    } catch(e){ return null; }
  }

  // safer applyTranslations: do not clobber child images/icons; update only textual part when possible
  function applyTranslations(lang){
    const map = translations[lang] || translations['es'];
    document.querySelectorAll('[data-i18n]').forEach(el => {
      try {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        const text = (map && map[key]) ? map[key] : el.textContent;
        // If element has non-img child nodes (like a span for label), replace that child's text only
        const childElements = Array.from(el.children || []);
        // Prefer updating the first non-img child element's textContent if there is one
        const nonImgChild = childElements.find(c => c.tagName.toLowerCase() !== 'img');
        if (nonImgChild) {
          nonImgChild.textContent = text;
        } else {
          // fallback: replace textContent (safe for plain elements)
          el.textContent = text;
        }
      } catch(err) {
        // guard: don't let one element break the whole translation operation
        console.warn('applyTranslations item failed', err);
      }
    });

    // Buttons with icons: try to update only a text span if present, otherwise update textContent
    document.querySelectorAll('.btn-add').forEach(btn => {
      try {
        const labelSpan = btn.querySelector('span');
        if (labelSpan) labelSpan.textContent = (map && map['btn.add']) || labelSpan.textContent;
        else btn.textContent = (map && map['btn.add']) || btn.textContent;
      } catch(e){}
    });

    // update lang label
    const names = { es:'Espa√±ol', en:'English', fr:'Fran√ßais' };
    if (langLabel) langLabel.textContent = names[lang] || names['es'];

    // refresh cart empty message and totals
    try { updateMiniCartUI(); updateCartPanel(); } catch(e){}
  }

  function setLang(l){
    if (!translations[l]) l = 'es';
    currentLang = l;
    try { localStorage.setItem('lixby_lang', l); } catch(e){}
    try { applyTranslations(l); } catch(e){}
  }

  // init language (guardado y aplicado)
  try { setLang(localStorage.getItem('lixby_lang') || currentLang); } catch(e){ setLang('es'); }

  if (langBtn && langMenu){
    langBtn.addEventListener('click', ()=> {
      try {
        const isOpen = langMenu.getAttribute('aria-hidden') === 'false';
        langMenu.setAttribute('aria-hidden', String(!isOpen));
        langMenu.style.display = !isOpen ? 'flex' : 'none';
        langBtn.setAttribute('aria-expanded', String(!isOpen));
      } catch(e){}
    });

    // click handlers for language items (delegation safe)
    Array.from(langMenu.querySelectorAll('.lang-item')).forEach(btn => btn.addEventListener('click', ()=>{ 
      try {
        const lang = btn.getAttribute('data-lang');
        if (!lang) return;
        setLang(lang);
        langMenu.setAttribute('aria-hidden','true');
        langMenu.style.display='none';
        langBtn.setAttribute('aria-expanded','false');
      } catch(e){ console.warn(e); }
    }));

    // close menu when clicking outside (defensivo)
    document.addEventListener('click', (e)=> { 
      try { 
        if (!langBtn.contains(e.target) && !langMenu.contains(e.target)) { 
          langMenu.setAttribute('aria-hidden','true'); 
          langMenu.style.display='none'; 
          langBtn.setAttribute('aria-expanded','false'); 
        } 
      } catch(e){} 
    });
  }

  // THEME
  const THEME_KEY = 'lixby_theme';
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem(THEME_KEY) === 'light') document.documentElement.classList.add('light');
  if (themeToggle) themeToggle.addEventListener('click', ()=>{ const isLight = document.documentElement.classList.toggle('light'); try{ localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark'); }catch(e){} });

  // ---------- FALLBACK addToCart (si no hay script.js externo) ----------
  document.addEventListener('click', (ev) => {
    const closestFn = ev.target && ev.target.closest ? ev.target.closest.bind(ev.target) : (sel)=> {
      // simple fallback: walk up parents
      let n = ev.target;
      while(n && n.nodeType === 1) {
        if (n.matches && n.matches(sel)) return n;
        n = n.parentElement;
      }
      return null;
    };
    const btn = closestFn('.btn-add');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const product = PRODUCTS_BRIEF[id];
    const payload = product ? product : { id: id, name: id, price: '0‚Ç¨', priceNum: 0, image: '' };
    if (typeof window.addToCart === 'function' && window.addToCart !== undefined) {
      window.addToCart(payload);
    } else {
      const existing = cart.find(i => i.id === payload.id);
      if (existing) existing.qty = (existing.qty||1) + 1;
      else cart.push({ id: payload.id, name: payload.name || 'Producto', price: payload.price || '0‚Ç¨', priceNum: payload.priceNum || 0, qty:1, image: payload.image || '' });
      saveCart(cart); updateMiniCartUI(); updateCartPanel();
      try { if (announcements) announcements.textContent = `${payload.name} a√±adido al carrito.`; } catch(e){}
    }
    const original = btn.textContent;
    btn.textContent = (translations[currentLang] && translations[currentLang]['btn.added']) || 'A√±adido';
    setTimeout(()=> btn.textContent = original, 900);
  });

  // ---------- CLICK EN TARJETA: navegar a producto (sin borrar handlers) ----------
  document.addEventListener('click', function(e){
    const closestFn = e.target && e.target.closest ? e.target.closest.bind(e.target) : (sel)=> {
      let n = e.target;
      while(n && n.nodeType === 1) {
        if (n.matches && n.matches(sel)) return n;
        n = n.parentElement;
      }
      return null;
    };
    const card = closestFn('.card');
    if (!card) return;
    if (closestFn('button, a')) return;
    const pid = card.dataset && card.dataset.product;
    if (!pid) return;
    window.location.href = 'producto.html?id=' + encodeURIComponent(pid);
  });

  // ---------- CONTACT: EmailJS lazy-load al enviar ----------
  // EmailJS configuration (tus credenciales)
  // USERID: xsKpaFjbRsS95AK3i
  // SERVICE ID: service_tagcpgm
  // TEMPLATE ID: template_l1e0go2

  async function ensureEmailJs(){
    if (window.emailjs && typeof window.emailjs.sendForm === 'function') return;
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js';
      s.crossOrigin = 'anonymous';
      s.onload = res;
      s.onerror = () => rej(new Error('EmailJS load failed'));
      document.head.appendChild(s);
    });
    try { if (window.emailjs && typeof emailjs.init === 'function') emailjs.init('xsKpaFjbRsS95AK3i'); } catch(e){ console.warn('EmailJS init failed', e); }
  }

  (function initContact(){
    const form = document.getElementById('contactForm');
    const sendBtn = document.getElementById('contactSend');
    const successEl = document.getElementById('contactSuccess');
    const ticketHidden = document.getElementById('ticketId');

    if (!form) return;

    // Helper: genera un ticket id legible y √∫nico
    function generateTicketId(){
      const t = 'LIXBY-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
      return t;
    }

    async function sendEmail(e){
      e.preventDefault();
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const message = document.getElementById('contactMessage').value.trim();
      if (!name || !email || !message) { alert('Por favor completa todos los campos.'); return; }

      // asignar ticket id al campo oculto justo antes de enviar
      const ticket = generateTicketId();
      if (ticketHidden) ticketHidden.value = ticket;

      sendBtn.disabled = true;
      const prev = sendBtn.textContent; sendBtn.textContent = 'Enviando...';

      try {
        await ensureEmailJs();
        if (!window.emailjs || typeof window.emailjs.sendForm !== 'function') {
          throw new Error('EmailJS SDK no disponible');
        }
        // Enviamos usando los IDs que nos pasaste
        await emailjs.sendForm('service_tagcpgm', 'template_l1e0go2', '#contactForm');

        // mostrar √©xito visual y limpiar
        successEl.style.display = 'block';
        form.reset();
        // opcional: guardamos una copia local como redundancia (audit trail del cliente)
        try {
          const key = 'lixby_tickets_v1';
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          arr.push({ ticket_id: ticket, name: name, email: email, message: message, created_at: new Date().toISOString(), status: 'sent' });
          localStorage.setItem(key, JSON.stringify(arr));
        } catch (errLocal) { /* no cr√≠tico */ }

        // ocultar mensaje tras unos segundos
        setTimeout(()=> successEl.style.display = 'none', 6000);
      } catch (err) {
        console.error('Error enviando con EmailJS:', err);
        // fallback: guardar ticket localmente para reintento manual
        try {
          const key = 'lixby_tickets_v1';
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          arr.push({ ticket_id: ticket, name: name, email: email, message: message, created_at: new Date().toISOString(), status: 'failed', error: String(err) });
          localStorage.setItem(key, JSON.stringify(arr));
        } catch (errLocal) { console.warn('Fallback save failed', errLocal); }

        alert('No se pudo enviar el mensaje v√≠a EmailJS. Hemos guardado una copia local del ticket y puedes reintentar m√°s tarde.');
      } finally {
        sendBtn.disabled = false; sendBtn.textContent = prev;
      }
    }
    form.addEventListener('submit', sendEmail);
  })();

  // export for other modules if needed
  window.lixby = window.lixby || {};
  window.lixby.cart = { load: loadCart, save: saveCart, getAll: () => cart };

  // ---------------------------
  // FIX: account button behavior
  // ---------------------------
  try {
    const accountBtn = document.getElementById('accountBtn');
    if (accountBtn) {
      accountBtn.addEventListener('click', (e) => {
        e.preventDefault();
        try {
          // If there's a local snapshot of user or Firebase auth shows currentUser, go to account page
          const stored = (function(){ try { return JSON.parse(localStorage.getItem('lixby_user')||'null'); } catch(e){ return null; } })();
          const firebaseUser = (window.appAuth && window.appAuth._rawAuth && window.appAuth._rawAuth.currentUser) ? window.appAuth._rawAuth.currentUser : null;
          if (stored && stored.uid) {
            // quick redirect if we have stored user info
            window.location.href = 'cuenta.html';
            return;
          }
          if (firebaseUser) {
            window.location.href = 'cuenta.html';
            return;
          }
          // If auth modal available, show it (preferred)
          if (window.lixbyAuth && typeof window.lixbyAuth.show === 'function') {
            window.lixbyAuth.show();
            return;
          }
          // Fallback: if auth module exposes overlay element, show it
          const ov = document.getElementById('lixbyAuthOverlay');
          if (ov) { ov.style.display='flex'; ov.setAttribute('aria-hidden','false'); return; }
          // Last resort: go to login page
          window.location.href = 'login.html';
        } catch(err) {
          console.warn('accountBtn handler err', err);
          window.location.href = 'login.html';
        }
      });
    }
  } catch(e){ console.warn('accountBtn attach err', e); }

})();
</script>

<!-- Mejoras: sanitizaci√≥n y accesibilidad del mini-cart (a√±adido, no borra nada) -->
<script>
(function(){
  'use strict';
  const CURRENCY = new Intl.NumberFormat('es-ES',{ style:'currency', currency:'EUR' });

  // 1) Sanitize mini-cart nodes produced by the inline script (prevenir innerHTML XSS)
  const miniCartItems = document.getElementById('miniCartItems');
  if (miniCartItems) {
    const sanitizeNode = (node) => {
      const meta = node.querySelector('.meta');
      if (!meta) return;
      // extraer texto seguro y recomponer elementos
      const nameText = meta.textContent || '';
      const parts = nameText.split('\n').map(s => s.trim()).filter(Boolean);
      const title = document.createElement('div'); title.style.fontWeight = '700'; title.textContent = parts[0] || '';
      const sub = document.createElement('div'); sub.style.color = 'var(--muted)'; sub.textContent = parts.slice(1).join(' ') || '';
      meta.innerHTML = '';
      meta.appendChild(title);
      meta.appendChild(sub);
    };

    const observer = new MutationObserver((muts) => {
      muts.forEach(m => {
        m.addedNodes.forEach(n => {
          if (n.nodeType !== 1) return;
          if (n.classList && n.classList.contains('mini-cart-item')) sanitizeNode(n);
          n.querySelectorAll && n.querySelectorAll('.mini-cart-item').forEach(el => sanitizeNode(el));
        });
      });
    });
    observer.observe(miniCartItems, { childList: true, subtree: true });
  }

  // 2) Mejorar foco y escape (cerrar mini-cart con Esc)
  const cartBtn = document.getElementById('cartBtn');
  const miniCart = document.getElementById('miniCart');
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (miniCart && miniCart.getAttribute('aria-hidden') === 'false') {
        miniCart.setAttribute('aria-hidden','true');
        miniCart.style.display = '';
        cartBtn && cartBtn.setAttribute('aria-expanded','false');
        cartBtn && cartBtn.focus();
      }
    }
  });
  // al abrir, focusar primer control del miniCart (delegado: cuando se haga visible)
  const showObserver = new MutationObserver(() => {
    try {
      if (miniCart && miniCart.getAttribute('aria-hidden') === 'false') {
        const focusable = miniCart.querySelector('button, [tabindex], a, input');
        if (focusable) focusable.focus();
      }
    } catch(e) {}
  });
  if (miniCart) showObserver.observe(miniCart, { attributes: true, attributeFilter: ['aria-hidden'] });

  // 3) Forzar formato monetario en el total del miniCart (si el script original escribe n√∫meros crudos)
  const miniCartTotal = document.getElementById('miniCartTotal');
  if (miniCartTotal) {
    const reformat = () => {
      const raw = miniCartTotal.textContent || '';
      const num = parseFloat(String(raw).replace(/[^\d.-]/g,'')) || 0;
      miniCartTotal.textContent = CURRENCY.format(num);
    };
    // formatear ahora y cada vez que cambie
    reformat();
    const totObs = new MutationObserver(reformat);
    totObs.observe(miniCartTotal, { childList: true, characterData: true, subtree: true });
  }
})();
</script>

<!-- CARGA EL M√ìDULO DE AUTENTICACI√ìN (inicializa Firebase, crea modal y sincroniza header) -->
<script type="module" src="auth-firebase-minimal.js"></script>

<!-- Mejora no destructiva del enlace de accesibilidad: NO fuerza nueva pesta√±a -->
<script>
(function(){
  const a = document.getElementById('accessibilityLink');
  if (!a) return;

  // Asegurar aria-label sin alterar la intenci√≥n de navegaci√≥n
  if (!a.hasAttribute('aria-label')) {
    a.setAttribute('aria-label', 'Ir a la p√°gina de accesibilidad');
  }

  // Aseguramos que se abra en la MISMA pesta√±a: eliminamos target/rel si existieran
  if (a.hasAttribute('target')) a.removeAttribute('target');
  if (a.hasAttribute('rel')) a.removeAttribute('rel');
})();
</script>

</body>
</html>
