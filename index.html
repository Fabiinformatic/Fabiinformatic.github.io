<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIXBY ‚Äî Tecnolog√≠a minimalista</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="/favicon.ico">
  <!-- Overrides locales para header y comportamiento consistente -->
  <style>
    /* Header compacto, l√≠nea recta, minimal */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 120;
      padding: 10px 24px;
      background: rgba(255,255,255,0.02);
      backdrop-filter: blur(8px) saturate(120%);
      -webkit-backdrop-filter: blur(8px) saturate(120%);
      border-bottom: 1px solid rgba(255,255,255,0.03);
      border-radius: 0;
      box-shadow: none;
    }

    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      min-height: 64px;
      padding: 0 6px;
    }

    /* logo a la izquierda */
    .nav-left { display:flex; align-items:center; gap:8px; flex:0 0 auto; }

    /* nav links centrados */
    #navLinks {
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:center;
      flex: 1 1 auto;
      padding: 8px 12px;
      white-space: nowrap;
    }

    /* controles a la derecha en UNA FILA */
    .nav-right {
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex: 0 0 auto;
      flex-direction: row !important; /* evita columnas impuestas por inline */
    }

    /* Mini-cart / lang positioning (no se apilen) */
    .cart-wrapper { position:relative; }
    .mini-cart { right:18px; top:56px; width:320px; box-sizing:border-box; z-index:140; }
    .lang-menu { right:18px; top:56px; box-sizing:border-box; z-index:140; }

    /* asegurar que main empieza debajo del header (fallback si JS no se ejecuta) */
    main { padding-top: calc(64px + 12px); }

    /* Cart panel styles (basics) */
    .cart-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 210; display: none; }
    .cart-backdrop.open { display: block; }
    .cart-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 360px;
      transform: translateX(112%);
      transition: transform .28s ease, box-shadow .28s ease;
      z-index: 220;
      display: flex;
      pointer-events: none;
    }
    .cart-panel.open { transform: translateX(0); pointer-events: auto; box-shadow: -24px 0 48px rgba(2,6,12,0.6); }
    .cart-panel .cart-panel-inner {
      width: 100%;
      display:flex;
      flex-direction:column;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border-left: 1px solid rgba(255,255,255,0.04);
      padding: 0;
      box-sizing: border-box;
      height: 100%;
    }
    .cart-header { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.04); }
    .cart-list { padding:12px; overflow:auto; flex:1; }
    .cart-item { display:flex; gap:12px; margin-bottom:10px; align-items:center; padding-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.02); }
    .cart-item img { width:64px; height:64px; object-fit:cover; border-radius:8px; }
    .cart-footer { padding:12px; border-top:1px solid rgba(255,255,255,0.04); display:flex; flex-direction:column; gap:10px; }
    @media (max-width:720px) { .cart-panel { width: 92%; } }

    /* peque√±o estilo para el bot√≥n a√±adir en las cards */
    .card .actions { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .btn-add { padding:8px 12px; border-radius:8px; border: none; cursor:pointer; background:linear-gradient(180deg,var(--accent), color-mix(in oklab, var(--accent) 60%, #fff 40%)); color:#00121a; font-weight:700; }
    .btn-view { padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--text); cursor:pointer; }

    /* ===== added contact-specific minimal styles inline as fallback ===== */
    .contact-min {
      max-width: 1100px;
      margin: 28px auto;
      padding: 30px;
      display:flex;
      gap:24px;
      align-items:center;
      justify-content:space-between;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(255,255,255,0.03);
      box-sizing:border-box;
    }
    .contact-min .left {flex:1}
    .contact-min h2 { margin:0 0 6px; font-size:1.4rem; }
    .contact-min p.lead { margin:0; color:var(--muted); font-size:1rem }
    .contact-min .form { flex:0 0 360px; display:flex; flex-direction:column; gap:10px }
    .contact-min input, .contact-min textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.015); color:var(--text); font-size:0.95rem; box-sizing:border-box;
    }
    .contact-min .actions { display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:4px }
    .contact-success { display:none; color:var(--accent); font-weight:600; margin-top:8px }
    @media (max-width:900px){ .contact-min { flex-direction:column; } .contact-min .form{ width:100% } }

    /* small auth-modal tweaks (white, minimal) */
    #authOverlay { display:none; }
    #authOverlay[aria-hidden="false"] { display:block; }
    #authModal {
      position:relative;
      max-width:540px;
      margin:6vh auto;
      padding:22px;
      border-radius:12px;
      z-index:9999;
      background: #ffffff;         /* blanco para resaltar */
      color: #07101a;              /* texto oscuro sobre blanco */
      box-shadow: 0 20px 60px rgba(2,6,12,0.45);
      border: 1px solid rgba(7,10,20,0.06);
    }
    #authModal h2 { margin:0 0 8px; color: #07101a; }
    #authModal p { margin:0 0 16px; color: #6b7280; }
    #authModal .btn.ghost { background: transparent; border:1px solid rgba(7,10,20,0.06); color:#07101a; }
    #authModal .btn.primary { background: linear-gradient(180deg,#4aa3ff,#0077ff); color:#fff; }
    #authModal input { width:100%; padding:10px;border-radius:8px;border:1px solid rgba(7,10,20,0.06); }
    #authClose { position:absolute; right:12px; top:12px; background:transparent;border:0;font-size:18px; color:#475569; }
    #authModal .social-btn { display:flex; align-items:center; gap:10px; justify-content:center; padding:10px;border-radius:8px; border:1px solid rgba(7,10,20,0.04); background:transparent; cursor:pointer; width:100%; }
    #authModal .social-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }

    /* small helper text */
    .auth-note { text-align:center; font-size:0.9rem; color:#6b7280; margin-top:8px; }

    /* responsive tweaks */
    @media (max-width:640px){
      #authModal { margin:10vh 16px; padding:18px; }
      #authModal .social-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="nav glass" role="banner">
    <div class="nav-inner">
      <!-- LEFT: logo -->
      <div class="nav-left">
        <div class="brand" role="button" aria-label="Ir al inicio" onclick="location.href='index.html'">LIXBY</div>
      </div>

      <!-- CENTER: nav links -->
      <nav id="navLinks" role="navigation" aria-label="Principal">
        <a href="#inicio" data-i18n="nav.inicio">Inicio</a>
        <a href="#productos" data-i18n="nav.productos">Productos</a>
        <a href="#contacto" data-i18n="nav.contacto">Cont√°ctanos</a>
        <a href="#conocenos" data-i18n="nav.conocenos">Con√≥cenos</a>
      </nav>

      <!-- RIGHT: controles en fila -->
      <div class="nav-right" aria-hidden="false">
        <!-- carrito (mini) -->
        <div class="cart-wrapper" style="position:relative;">
          <button id="cartBtn" class="icon-btn" aria-label="Ver carrito">üõí <span id="cartCount" class="badge">0</span></button>

          <div id="miniCart" class="mini-cart glass" aria-hidden="true">
            <div class="mini-cart-header">
              <strong data-i18n="cart.title">Carrito</strong>
              <button id="clearCart" class="text-btn" data-i18n="cart.clear">Vaciar</button>
            </div>

            <div id="miniCartItems" class="mini-cart-items">
              <!-- items din√°micos -->
            </div>

            <div class="mini-cart-footer" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div><strong data-i18n="cart.total">Total:</strong> <span id="miniCartTotal">0‚Ç¨</span></div>
                <div>
                  <button id="checkoutBtn" class="btn primary" data-i18n="cart.checkout">Pagar</button>
                </div>
              </div>
              <div style="display:flex;gap:8px;">
                <button id="viewCartBtn" class="btn ghost">Ver carrito</button>
              </div>
            </div>
          </div>
        </div>

        <!-- selector idioma -->
        <div class="lang-wrapper">
          <button id="langBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false">
            üá™üá∏ <span id="langLabel">Espa√±ol</span> ‚ñæ
          </button>
          <div id="langMenu" class="lang-menu glass" aria-hidden="true">
            <button class="lang-item" data-lang="es">üá™üá∏ Espa√±ol</button>
            <button class="lang-item" data-lang="en">üá¨üáß English</button>
            <button class="lang-item" data-lang="fr">üá´üá∑ Fran√ßais</button>
          </div>
        </div>

        <!-- Account button (opens modal) -->
        <button id="accountBtn" class="btn ghost" aria-label="Mi cuenta">Cuenta</button>

        <!-- toggle tema -->
        <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema">‚óê</button>
      </div>
    </div>
  </header>

  <!-- AUTH / WELCOME MODAL - NO BORRAR EL RESTO -->
  <div id="authOverlay" aria-hidden="true" style="position:fixed;inset:0;z-index:9998;display:none;">
    <div id="authBackdrop" style="position:absolute;inset:0;background:rgba(2,6,12,0.45);backdrop-filter:blur(4px)"></div>
    <div id="authModal" role="dialog" aria-labelledby="authTitle" aria-modal="true">
      <h2 id="authTitle">Bienvenido a LIXBY</h2>
      <p>Inicia sesi√≥n para acceder a tu cuenta, pedidos y favoritos.</p>

      <div class="social-grid">
        <button id="btnGoogle" class="social-btn" title="Iniciar con Google" aria-label="Iniciar con Google">
          <!-- Google SVG -->
          <svg width="18" height="18" viewBox="0 0 48 48" aria-hidden focusable="false">
            <path fill="#EA4335" d="M24 9.5c3.2 0 6 1.1 8.2 3.1l6.1-6.1C34.9 3 29.8 1.5 24 1.5 14.8 1.5 6.9 6.9 3.1 14.9l7.7 6.0C12.5 17.1 17.7 9.5 24 9.5z"/>
            <path fill="#34A853" d="M46.5 24.5c0-1.6-.1-3.1-.5-4.6H24v9h12.6c-.6 3.6-3.1 6.6-6.6 8.1l6.8 5.3c4.0-3.7 6.7-9.6 6.7-17.8z"/>
            <path fill="#4A90E2" d="M10.8 28.9A14.9 14.9 0 0 1 24 38.5c3.7 0 7.2-1.3 9.9-3.5l-6.8-5.3c-1.9 1.3-4.4 2.1-7.1 2.1-5.3 0-9.9-3.6-11.9-8.5l-7.7 6.0c2.9 5.9 9 10.2 16.6 10.2 0 0 0 0 0 0z"/>
            <path fill="#FBBC05" d="M3.1 14.9L10.8 9a15.2 15.2 0 0 1 13.2-6.5c3.7 0 7.1 1.3 9.9 3.5l-6.1 6.1C30.0 11 27.2 9.5 24 9.5c-6.3 0-11.6 7.6-12.9 12.2z"/>
          </svg>
          <span>Iniciar con Google</span>
        </button>

        <button id="btnGitHub" class="social-btn" title="Iniciar con GitHub" aria-label="Iniciar con GitHub">
          <!-- GitHub SVG -->
          <svg width="18" height="18" viewBox="0 0 16 16" aria-hidden focusable="false">
            <path fill="#111" d="M8 0C3.58 0 0 3.58 0 8a8 8 0 0 0 5.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52 0-.53.63-.01 1.08.58 1.22.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8 8 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
          </svg>
          <span>Iniciar con GitHub</span>
        </button>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin:12px 0;">
        <hr style="flex:1;border:none;height:1px;background:rgba(7,10,20,0.06)"/>
        <span style="font-size:0.9rem;color:#6b7280">o con correo</span>
        <hr style="flex:1;border:none;height:1px;background:rgba(7,10,20,0.06)"/>
      </div>

      <form id="authEmailForm" style="display:flex;flex-direction:column;gap:8px" onsubmit="return false;">
        <input id="authEmail" type="email" placeholder="Correo" required />
        <input id="authPass" type="password" placeholder="Contrase√±a" required />
        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;">
          <button type="button" id="btnEmailSignIn" class="btn primary">Iniciar sesi√≥n</button>
          <button type="button" id="btnEmailSignUp" class="btn ghost">Registrarse</button>
        </div>
      </form>

      <div class="auth-note">
        <button id="btnAnonymous" class="btn ghost" style="margin-top:8px">Continuar como invitado</button>
      </div>

      <div style="display:flex;justify-content:center;margin-top:12px;font-size:0.9rem">
        <a id="authToAccount" href="cuenta.html" style="color:#6b7280">Ya tienes cuenta? Ir a mi cuenta</a>
      </div>

      <button id="authClose" aria-label="Cerrar">‚úï</button>
    </div>
  </div>
  <!-- END AUTH MODAL -->

  <main>
    <!-- HERO -->
    <section id="inicio" class="hero reveal" aria-labelledby="hero-title">
      <div class="hero-content">
        <h1 id="hero-title">La tecnolog√≠a que te entiende</h1>
        <p>Innovaci√≥n minimalista para tu d√≠a a d√≠a</p>
        <a href="#productos" class="btn primary" data-i18n="btn.explorar">Explorar</a>
      </div>
    </section>

    <!-- PRODUCTOS -->
    <section id="productos" class="section reveal" aria-labelledby="prod-title">
      <h2 id="prod-title">Productos</h2>
      <div class="grid">
        <!-- Lixby One Air -->
        <article class="card glass" data-product="lixby-one-air" role="button" tabindex="0" aria-label="Lixby One Air">
          <div class="thumb">
            <img src="https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg" alt="Lixby One Air">
          </div>
          <h3>Lixby One Air</h3>
          <p>Ultraligero y econ√≥mico.</p>
          <span class="price">249‚Ç¨</span>
          <div class="actions">
            <button class="btn-view" onclick="location.href='producto.html?id=lixby-one-air'">Ver</button>
            <button class="btn-add" data-id="lixby-one-air">A√±adir al carrito</button>
          </div>
        </article>

        <!-- Lixby One -->
        <article class="card glass" data-product="lixby-one" role="button" tabindex="0" aria-label="Lixby One">
          <div class="thumb">
            <img src="https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg" alt="Lixby One">
          </div>
          <h3>Lixby One</h3>
          <p>Ultraligero y potente.</p>
          <span class="price">349‚Ç¨</span>
          <div class="actions">
            <button class="btn-view" onclick="location.href='producto.html?id=lixby-one'">Ver</button>
            <button class="btn-add" data-id="lixby-one">A√±adir al carrito</button>
          </div>
        </article>

        <!-- Lixby One Pro -->
        <article class="card glass" data-product="lixby-one-pro" role="button" tabindex="0" aria-label="Lixby One Pro">
          <div class="thumb">
            <img src="https://m.media-amazon.com/images/I/61rriyfRKwL.jpg" alt="Lixby One Pro">
          </div>
          <h3>Lixby One Pro</h3>
          <p>Audio de alta fidelidad.</p>
          <span class="price">899‚Ç¨</span>
          <div class="actions">
            <button class="btn-view" onclick="location.href='producto.html?id=lixby-one-pro'">Ver</button>
            <button class="btn-add" data-id="lixby-one-pro">A√±adir al carrito</button>
          </div>
        </article>
      </div>
    </section>

    <!-- CONTACTO: minimalista y moderno (hecho sin borrar nada fuera de esta secci√≥n) -->
    <section id="contacto" class="section contact-min glass reveal" aria-labelledby="contact-title">
      <div class="left">
        <h2 id="contact-title">Cont√°ctanos</h2>
        <p class="lead">D√©janos una duda o sugerencias y te responderemos lo antes posible.</p>
      </div>

      <!-- IMPORTANT: names adjusted to match typical EmailJS template variables -->
      <form id="contactForm" class="form" aria-label="Formulario de contacto" onsubmit="return false;">
        <!-- use names that match your template: from_name, from_email, message -->
        <input id="contactName" name="from_name" type="text" placeholder="Nombre" required autocomplete="name">
        <input id="contactEmail" name="from_email" type="email" placeholder="Correo" required autocomplete="email">
        <textarea id="contactMessage" name="message" placeholder="Tu mensaje" required></textarea>

        <div class="actions">
          <button type="button" class="btn ghost" onclick="document.getElementById('contactForm').reset();">Borrar</button>
          <button type="submit" id="contactSend" class="btn primary">Enviar</button>
        </div>

        <div id="contactSuccess" class="contact-success" role="status" aria-live="polite">Mensaje enviado. ¬°Gracias! Te contestaremos pronto.</div>
      </form>
    </section>

    <!-- CON√ìCENOS -->
    <section id="conocenos" class="section reveal" aria-labelledby="about-title">
      <h2 id="about-title">Con√≥cenos</h2>
      <p>En LIXBY creemos en el equilibrio perfecto entre dise√±o y funcionalidad. Creamos productos que no solo funcionan, sino que tambi√©n inspiran.</p>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer glass" style="text-align:center;padding:24px;margin-top:40px;">
    <p>¬© <span id="year"></span> LIXBY ‚Äî Todos los derechos reservados</p>
  </footer>

  <!-- Cart panel (est√°tico) + backdrop -->
  <div id="cartBackdrop" class="cart-backdrop" aria-hidden="true"></div>
  <aside id="cartPanel" class="cart-panel" aria-hidden="true">
    <div class="cart-panel-inner glass" role="dialog" aria-label="Carrito">
      <div class="cart-header">
        <strong data-i18n="cart.title">Carrito</strong>
        <button id="cartPanelClose" class="text-btn" aria-label="Cerrar">‚úï</button>
      </div>

      <div id="cartPanelItems" class="cart-list">
        <!-- items din√°micos -->
      </div>

      <div class="cart-footer">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>Total</strong>
          <span id="cartPanelTotal">0‚Ç¨</span>
        </div>
        <div style="display:flex;gap:8px;">
          <button id="cartPanelCheckout" class="btn primary" data-i18n="cart.checkout">Pagar</button>
          <button id="cartPanelClear" class="btn ghost" data-i18n="cart.clear">Vaciar</button>
        </div>
      </div>
    </div>
  </aside>

  <noscript style="display:block;background:#fffb; padding:10px; text-align:center;">
    JavaScript est√° desactivado o ha ocurrido un error. Si la p√°gina no carga correctamente, abre la consola (F12 ‚Üí Console).
  </noscript>

  <!-- small fallback script (mant√©n como estaba) -->
  <script>
    (function(){
      function adjustPadding(){
        try {
          const header = document.querySelector('.nav');
          if(!header) return;
          const pad = Math.round(header.getBoundingClientRect().height + 12);
          document.body.style.paddingTop = pad + 'px';
        } catch(e){}
      }
      adjustPadding();
      window.addEventListener('resize', adjustPadding);

      // Fallback very small panel toggle (no conflict if tienes script.js completo)
      const viewBtn = document.getElementById('viewCartBtn');
      const cartPanel = document.getElementById('cartPanel');
      const cartBackdrop = document.getElementById('cartBackdrop');
      const cartPanelClose = document.getElementById('cartPanelClose');

      function setPanel(open){
        if(!cartPanel || !cartBackdrop) return;
        cartPanel.classList.toggle('open', !!open);
        cartBackdrop.classList.toggle('open', !!open);
        cartPanel.setAttribute('aria-hidden', String(!open));
        cartBackdrop.setAttribute('aria-hidden', String(!open));
      }
      if (viewBtn) viewBtn.addEventListener('click', ()=> setPanel(true));
      if (cartBackdrop) cartBackdrop.addEventListener('click', ()=> setPanel(false));
      if (cartPanelClose) cartPanelClose.addEventListener('click', ()=> setPanel(false));
    })();
  </script>

  <!-- OVERRIDE: fuerza que el bot√≥n del header lleve a carrito.html (usa captura para anular handlers anteriores) -->
  <script>
    (function(){
      // si quieres redirigir a carrito.html en lugar de abrir mini-panel, activa esto
      function goToCart(e){
        e.preventDefault();
        // evita que otros listeners del click se ejecuten
        if (e.stopImmediatePropagation) e.stopImmediatePropagation();
        window.location.href = 'carrito.html';
      }
      const cartBtn = document.getElementById('cartBtn');
      if (cartBtn) cartBtn.addEventListener('click', goToCart, {capture:true});

      // tambi√©n aseguro que el bot√≥n "Ver carrito" (miniCart) vaya a carrito.html
      const viewBtn = document.getElementById('viewCartBtn');
      if (viewBtn) viewBtn.addEventListener('click', function(e){ e.preventDefault(); if (e.stopImmediatePropagation) e.stopImmediatePropagation(); window.location.href='carrito.html'; }, {capture:true});
    })();
  </script>

  <!-- FALLBACK addToCart (solo si script.js no define window.addToCart) -->
  <script>
    (function(){
      const KEY = 'lixby_cart_v1';
      function parsePrice(s){
        if (s === undefined || s === null) return 0;
        return Number(String(s).replace(/[^\d.,-]/g,'').replace(',', '.')) || 0;
      }
      // product data mirror para index r√°pido
      const PRODUCTS_BRIEF = {
        'lixby-one-air': { id:'lixby-one-air', name: 'Lixby One Air', price: '249‚Ç¨', priceNum: 249, image: 'https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg' },
        'lixby-one': { id:'lixby-one', name: 'Lixby One', price: '349‚Ç¨', priceNum: 349, image: 'https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg' },
        'lixby-one-pro': { id:'lixby-one-pro', name: 'Lixby One Pro', price: '899‚Ç¨', priceNum: 899, image: 'https://m.media-amazon.com/images/I/61rriyfRKwL.jpg' }
      };

      function fallbackAdd(product){
        try {
          const raw = localStorage.getItem(KEY);
          const cart = raw ? JSON.parse(raw) : [];
          const existing = cart.find(i => i.id === product.id);
          if (existing) existing.qty = (existing.qty||1) + 1;
          else cart.push({
            id: product.id,
            name: product.name || 'Producto',
            price: product.price || (product.priceNum ? (product.priceNum + '‚Ç¨') : '0‚Ç¨'),
            priceNum: product.priceNum !== undefined ? Number(product.priceNum) : parsePrice(product.price),
            qty: 1,
            image: product.image || ''
          });
          localStorage.setItem(KEY, JSON.stringify(cart));
          // dispatch storage event-style signal
          window.dispatchEvent(new Event('cartUpdated'));
          // visual cue: briefly show miniCart if present
          const mini = document.getElementById('miniCart');
          if (mini) { mini.setAttribute('aria-hidden','false'); setTimeout(()=> mini.setAttribute('aria-hidden','true'), 1800); }
        } catch(e){ console.warn('fallbackAdd error', e); }
      }

      // Attach handlers to btn-add
      document.addEventListener('click', (ev) => {
        const btn = ev.target.closest && ev.target.closest('.btn-add');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const product = PRODUCTS_BRIEF[id];
        const payload = product ? product : { id: id, name: id, price: '0‚Ç¨', priceNum: 0, image: '' };
        if (typeof window.addToCart === 'function' && window.addToCart !== fallbackAdd) {
          // prefer global addToCart if present
          window.addToCart(payload);
        } else {
          fallbackAdd(payload);
        }
        // small feedback
        btn.textContent = 'A√±adido';
        setTimeout(()=> btn.textContent = 'A√±adir al carrito', 900);
      });
    })();
  </script>

  <!-- ============================ FIREBASE AUTH (module) - ADD ============================ -->
  <script type="module">
    // Imports (use the same Firebase version your console suggested)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      GithubAuthProvider,
      signInWithPopup,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signInAnonymously,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Your firebaseConfig (use the one you configured in console)
    const firebaseConfig = {
      apiKey: "AIzaSyDMcDeBKSGqf9ZEexQAIM-9u6GLaQEnLcs",
      authDomain: "lixby-e0344.firebaseapp.com",
      projectId: "lixby-e0344",
      storageBucket: "lixby-e0344.firebasestorage.app",
      messagingSenderId: "671722866179",
      appId: "1:671722866179:web:65868eca5146942b507036",
      measurementId: "G-09SQL30MS8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // providers
    const googleProvider = new GoogleAuthProvider();
    const githubProvider = new GithubAuthProvider();

    // UI
    const overlay = document.getElementById('authOverlay');
    const authClose = document.getElementById('authClose');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnGitHub = document.getElementById('btnGitHub');
    const btnEmailSignIn = document.getElementById('btnEmailSignIn');
    const btnEmailSignUp = document.getElementById('btnEmailSignUp');
    const btnAnonymous = document.getElementById('btnAnonymous');
    const emailInput = document.getElementById('authEmail');
    const passInput = document.getElementById('authPass');
    const accountBtn = document.getElementById('accountBtn');
    const authBackdrop = document.getElementById('authBackdrop');

    function shouldShowWelcome() { try { return !localStorage.getItem('lixby_seen_welcome'); } catch(e){ return true; } }
    function hideWelcomePermanently(){ try { localStorage.setItem('lixby_seen_welcome','1'); } catch(e){} }

    function moveFocusOut() {
      try {
        // blur active element first (avoid aria-hidden on focused element)
        if (document.activeElement && typeof document.activeElement.blur === 'function') document.activeElement.blur();
      } catch(e){}
    }

    function showAuthOverlay(){
      if(!overlay) return;
      overlay.style.display='block';
      overlay.setAttribute('aria-hidden','false');
      // prevent background scroll
      document.documentElement.style.overflow = 'hidden';
      // focus close button for keyboard users
      setTimeout(()=> {
        const close = document.getElementById('authClose');
        if (close && typeof close.focus === 'function') close.focus();
      }, 60);
    }

    function hideAuthOverlay(){
      if(!overlay) return;
      // ensure no focused descendant remains before setting aria-hidden
      moveFocusOut();
      overlay.style.display='none';
      overlay.setAttribute('aria-hidden','true');
      document.documentElement.style.overflow = '';
      // return focus to account button if present
      setTimeout(()=> {
        try { if (accountBtn && typeof accountBtn.focus === 'function') accountBtn.focus(); } catch(e){}
      }, 30);
    }

    if (accountBtn) accountBtn.addEventListener('click', (e)=> {
      e.preventDefault();
      showAuthOverlay();
    });

    if (authClose) authClose.addEventListener('click', ()=> {
      hideAuthOverlay();
      hideWelcomePermanently();
    });

    // close on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && overlay && overlay.getAttribute('aria-hidden') === 'false') {
        hideAuthOverlay();
        e.stopPropagation();
      }
    });

    if (authBackdrop) authBackdrop.addEventListener('click', ()=> {
      hideAuthOverlay();
      hideWelcomePermanently();
    });

    // Sign in handlers with friendly error messages
    async function doSignInWithPopup(provider, providerName) {
      try {
        const res = await signInWithPopup(auth, provider);
        await upsertUserProfile(res.user);
        hideAuthOverlay();
      } catch (err) {
        console.error(providerName + ' sign-in', err);
        // show clearer guidance for domain issues
        if (err && err.code === 'auth/unauthorized-domain') {
          alert('Error: dominio no autorizado para OAuth. A√±ade tu dominio en Firebase Console ‚Üí Authentication ‚Üí Authorized domains (por ejemplo: fabiinformatic.github.io).');
        } else {
          alert(err.message || String(err));
        }
      }
    }

    if (btnGoogle) btnGoogle.addEventListener('click', ()=> doSignInWithPopup(googleProvider,'Google'));
    if (btnGitHub) btnGitHub.addEventListener('click', ()=> doSignInWithPopup(githubProvider,'GitHub'));

    if (btnEmailSignIn) btnEmailSignIn.addEventListener('click', async ()=> {
      const email = (emailInput.value||'').trim();
      const pass = (passInput.value||'').trim();
      if (!email || !pass) return alert('Introduce email y contrase√±a');
      try {
        const res = await signInWithEmailAndPassword(auth, email, pass);
        await upsertUserProfile(res.user);
        hideAuthOverlay();
      } catch(err){
        console.error('email sign-in', err);
        // if user not found, suggest registration
        if (err && err.code === 'auth/user-not-found') {
          if (confirm('Cuenta no encontrada. ¬øQuieres registrarte con este correo?')) {
            try {
              const reg = await createUserWithEmailAndPassword(auth, email, pass);
              await upsertUserProfile(reg.user);
              hideAuthOverlay();
            } catch(e2){
              console.error('Registro fall√≥', e2);
              alert(e2.message || e2);
            }
          }
        } else {
          alert(err.message || String(err));
        }
      }
    });

    if (btnEmailSignUp) btnEmailSignUp.addEventListener('click', async ()=> {
      const email = (emailInput.value||'').trim();
      const pass = (passInput.value||'').trim();
      if (!email || !pass) return alert('Introduce email y contrase√±a');
      try {
        const res = await createUserWithEmailAndPassword(auth, email, pass);
        await upsertUserProfile(res.user);
        hideAuthOverlay();
      } catch(err){
        console.error('email signup', err);
        alert(err.message || String(err));
      }
    });

    if (btnAnonymous) btnAnonymous.addEventListener('click', async ()=> {
      try {
        const res = await signInAnonymously(auth);
        await upsertUserProfile(res.user, { anonymous: true });
        hideAuthOverlay();
      } catch(err){
        console.error('anonymous', err);
        // admin-restricted-operation often means Anonymous is disabled in Firebase
        if (err && err.code === 'auth/admin-restricted-operation') {
          alert('El inicio como invitado no est√° habilitado en el proyecto Firebase. Habil√≠talo en Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Anonymous.');
        } else {
          alert(err.message || String(err));
        }
      }
    });

    // auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log('USER', user.uid, user.email, user.isAnonymous);
        const brand = document.querySelector('.brand');
        if (brand) {
          if (user.email) brand.textContent = (user.email.split('@')[0] || 'Usuario');
          else if (user.displayName) brand.textContent = (user.displayName.split(' ')[0] || 'Usuario');
          else if (user.isAnonymous) brand.textContent = 'Invitado';
        }
      } else {
        console.log('No user');
        if (shouldShowWelcome()) {
          setTimeout(()=> showAuthOverlay(), 300);
        }
      }
    });

    // create/update user doc
    async function upsertUserProfile(user, extra = {}) {
      if (!user || !user.uid) return;
      const ref = doc(db, 'users', user.uid);
      try {
        const snapshot = await getDoc(ref);
        const base = {
          uid: user.uid,
          name: user.displayName || null,
          email: user.email || null,
          photoURL: user.photoURL || null,
          provider: user.providerData && user.providerData[0] && user.providerData[0].providerId,
          createdAt: (snapshot.exists() ? snapshot.data().createdAt : new Date().toISOString())
        };
        await setDoc(ref, {...base, ...extra}, { merge: true });
      } catch(e){ console.warn('upsertUserProfile error', e); }
    }

    // expose helpers
    window.openAuthOverlay = () => { showAuthOverlay(); };
    window.closeAuthOverlay = () => { hideAuthOverlay(); };
    window.lixbySignOut = async function() {
      try { await signOut(auth); localStorage.removeItem('lixby_seen_welcome'); location.href = 'index.html'; } catch(e){ console.warn(e); }
    };

    // initial show
    if (shouldShowWelcome()) { setTimeout(()=> showAuthOverlay(), 300); }
  </script>

  <!-- === EMAILJS SDK (carga segura) & contact handler === -->
  <!-- Load EmailJS SDK from jsdelivr and init on load using your Public Key -->
  <script
    src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"
    crossorigin="anonymous"
    onload="(function(){ try { if (window.emailjs && typeof emailjs.init === 'function') { emailjs.init('xsKpaFjbRsS95AK3i'); console.info('EmailJS inicializado'); } } catch(e){ console.warn('EmailJS onload init error', e); } })()"
  ></script>

  <script>
    (function(){
      // Config provided by you
      const SERVICE_ID = 'service_tagcpgm';
      const TEMPLATE_ID = 'template_l1e0go2';
      const PUBLIC_KEY = 'xsKpaFjbRsS95AK3i'; // already used in onload init

      const form = document.getElementById('contactForm');
      const sendBtn = document.getElementById('contactSend');
      const successEl = document.getElementById('contactSuccess');

      if (!form) { console.warn('No se encontr√≥ #contactForm'); return; }

      async function sendEmail(e){
        e.preventDefault();

        const name = document.getElementById('contactName').value.trim();
        const email = document.getElementById('contactEmail').value.trim();
        const message = document.getElementById('contactMessage').value.trim();

        if (!name || !email || !message) {
          alert('Por favor completa todos los campos.');
          return;
        }

        // UI states
        sendBtn.disabled = true;
        const previousText = sendBtn.textContent;
        sendBtn.textContent = 'Enviando...';

        // Defensive: ensure SDK loaded
        if (!window.emailjs || typeof window.emailjs.sendForm !== 'function') {
          console.error('EmailJS SDK no est√° disponible. Revisa la carga del script o las extensiones que lo bloqueen.');
          alert('Servicio de correo no disponible ahora mismo. Intenta de nuevo m√°s tarde.');
          sendBtn.disabled = false;
          sendBtn.textContent = previousText;
          return;
        }

        try {
          // sendForm maps form field names to template variables
          const response = await emailjs.sendForm(SERVICE_ID, TEMPLATE_ID, '#contactForm');
          console.info('EmailJS sendForm response:', response);
          successEl.style.display = 'block';
          form.reset();
          setTimeout(()=> { successEl.style.display = 'none'; }, 6000);
        } catch (err) {
          console.error('Error enviando con EmailJS:', err);
          // show friendly message to user
          alert('No se pudo enviar el mensaje. Comprueba la consola para m√°s detalles o int√©ntalo m√°s tarde.');
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = previousText;
        }
      }

      form.addEventListener('submit', sendEmail);
    })();
  </script>

  <!-- tu script principal (defer) -->
  <script src="script.js" defer></script>

  <script>
    try { document.getElementById('year').textContent = new Date().getFullYear(); } catch(e){}
  </script>
</body>
</html>
