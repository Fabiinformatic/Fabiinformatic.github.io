<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="meta.title">LIXBY — Tecnología minimalista</title>

  <!-- PERF: preconnect para reducir latencia en recursos externos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://images.weserv.nl" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <link rel="stylesheet" href="style.css" />
  <!-- Pequeños overrides y utilidades inline (NO BORRAR: conservadas y combinadas) -->
  <style>
    /* adjustments: make header/controls a bit more rounded & minimal */
    :root { --radius-md: 12px; --radius-lg: 16px; }
    .nav-inner { min-height: 64px; gap:12px; }
    .btn { border-radius: var(--radius-md); }
    .brand img { border-radius: 10px; }

    /* PRO button style (kept here so HTML is copy/paste-ready) */
    .btn-pro {
      padding:8px 14px;
      font-weight:800;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(90deg, rgba(10,132,255,0.14), rgba(10,132,255,0.28));
      color: #fff;
      box-shadow: 0 6px 18px rgba(10,132,255,0.06);
      position:relative;
      overflow:hidden;
    }
    .btn-pro:before {
      content: "";
      position: absolute;
      inset: -120% -40% -120% -40%;
      background: linear-gradient(90deg, rgba(255,255,255,0.16), rgba(10,132,255,0.28), rgba(255,255,255,0.16));
      transform: rotate(20deg);
      opacity: .6;
      transition: transform .9s ease;
      filter: blur(8px);
    }
    .btn-pro:hover:before { transform: translateX(18%) rotate(20deg); opacity: .95; }
    .btn-pro:focus { box-shadow: 0 8px 28px rgba(10,132,255,0.18); outline: none; }

    /* make mini language & cart menus more rounded */
    .mini-cart, .lang-menu { border-radius: 14px; }

    /* small responsive tweak so PRO button doesn't crowd */
    @media (max-width:720px) { .btn-pro { display:none; } }
  </style>
</head>
<body>
  <!-- skip link para accesibilidad -->
  <a class="skip-link" href="#maincontent">Saltar al contenido</a>

<!-- NAV -->
<header class="nav glass" role="banner">
  <div class="nav-inner">
    <!-- LEFT: logo -->
    <div class="nav-left">
      <div class="brand"
           role="link"
           tabindex="0"
           aria-label="Ir al inicio"
           onclick="location.href='index.html'"
           onkeydown="if(event.key==='Enter' || event.key===' ') { event.preventDefault(); location.href='index.html'; }">
        <img src="https://i.imgur.com/dOCYmkx.jpeg" alt="LIXBY logo" width="44" height="44">
        <div class="title">LIXBY</div>
      </div>
    </div>

    <!-- CENTER: nav links -->
    <nav id="navLinks" role="navigation" aria-label="Principal">
      <a href="#inicio" data-i18n="nav.inicio">Inicio</a>
      <a href="#productos" data-i18n="nav.productos">Productos</a>
      <a href="#contacto" data-i18n="nav.contacto">Contáctanos</a>
      <a href="#conocenos" data-i18n="nav.conocenos">Conócenos</a>
    </nav>

    <!-- RIGHT: controles en fila -->
    <div class="nav-right" aria-hidden="false">
      <div class="cart-wrapper" style="position:relative;">
        <!-- click ahora redirige a carrito.html (tal y como pediste), hover sigue mostrando mini-cart -->
        <button id="cartBtn" class="icon-btn" aria-label="Ver carrito" aria-controls="miniCart" aria-expanded="false" type="button">🛒 <span id="cartCount" class="badge">0</span></button>

        <div id="miniCart" class="mini-cart glass" aria-hidden="true" role="region" aria-label="Mini carrito">
          <div class="mini-cart-header" style="display:flex;justify-content:space-between;align-items:center;">
            <strong data-i18n="cart.title">Carrito</strong>
            <button id="clearCart" class="text-btn" data-i18n="cart.clear" type="button">Vaciar</button>
          </div>
          <div id="miniCartItems" class="mini-cart-items" tabindex="0" aria-live="polite" style="max-height:220px;overflow:auto;">
            <!-- items dinámicos -->
          </div>
          <div class="mini-cart-footer" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong data-i18n="cart.total">Total:</strong> <span id="miniCartTotal">0€</span></div>
              <div><button id="checkoutBtn" class="btn primary" data-i18n="cart.checkout" type="button">Pagar</button></div>
            </div>
            <div style="display:flex;gap:8px;">
              <button id="viewCartBtn" class="btn ghost" type="button" data-i18n="cart.view">Ver carrito</button>
            </div>
          </div>
        </div>
      </div>

      <div class="lang-wrapper">
        <button id="langBtn" class="icon-btn" aria-haspopup="true" aria-expanded="false" type="button"> <span id="langFlag">🇪🇸</span> <span id="langLabel">Español</span> ▾ </button>
        <div id="langMenu" class="lang-menu glass" aria-hidden="true" style="display:none;flex-direction:column;gap:6px;padding:8px;width:200px;">
          <button class="lang-item" data-lang="es" type="button">🇪🇸 Español</button>
          <button class="lang-item" data-lang="en" type="button">🇬🇧 English</button>
          <button class="lang-item" data-lang="fr" type="button">🇫🇷 Français</button>
          <button class="lang-item" data-lang="de" type="button">🇩🇪 Deutsch</button>
          <button class="lang-item" data-lang="it" type="button">🇮🇹 Italiano</button>
        </div>
      </div>

      <div id="accountContainer" style="display:flex;align-items:center;gap:8px;">
        <button id="accountBtn" class="btn ghost" aria-label="Mi cuenta" type="button">Cuenta</button>

        <!-- NUEVO: botón PASATE AL PRO (al lado de la cuenta) -->
        <button id="proBtn" class="btn btn-pro" type="button" aria-label="Pásate al Pro" data-i18n="pro.cta">PÁSATE AL PRO</button>
      </div>

      <button id="themeToggle" class="btn ghost" aria-label="Cambiar tema" type="button">◐</button>
    </div>
  </div>
</header>

<main id="maincontent">
  <!-- HERO -->
  <section id="inicio" class="hero reveal" aria-labelledby="hero-title">
    <div class="hero-content">
      <h1 id="hero-title" data-i18n="hero.title">La tecnología que te entiende</h1>
      <p id="hero-subtitle" data-i18n="hero.subtitle">Innovación minimalista para tu día a día</p>
      <a href="explorar.html" class="btn primary" data-i18n="btn.explorar">Explorar</a>
    </div>
  </section>

  <!-- PRODUCTOS -->
  <section id="productos" class="section reveal" aria-labelledby="prod-title">
    <h2 id="prod-title" data-i18n="section.products">Productos</h2>
    <div class="grid">
      <!-- Lixby One Air -->
      <article class="card glass" data-product="lixby-one-air" role="button" tabindex="0" aria-label="Lixby One Air">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg" alt="Lixby One Air"
               loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3 data-i18n="product.lixby-one-air.title">Lixby One Air</h3>
        <p data-i18n="product.lixby-one-air.desc">Ultraligero y económico.</p>
        <span class="price">249€</span>
        <div class="actions">
          <button class="btn-view" onclick="location.href='producto.html?id=lixby-one-air'" type="button" data-i18n="btn.view">Ver</button>
          <button class="btn-add" data-id="lixby-one-air" type="button" data-i18n="btn.add">Añadir al carrito</button>
        </div>
      </article>

      <!-- Lixby One -->
      <article class="card glass" data-product="lixby-one" role="button" tabindex="0" aria-label="Lixby One">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg" alt="Lixby One"
               loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3 data-i18n="product.lixby-one.title">Lixby One</h3>
        <p data-i18n="product.lixby-one.desc">Ultraligero y potente.</p>
        <span class="price">349€</span>
        <div class="actions">
          <button class="btn-view" onclick="location.href='producto.html?id=lixby-one'" type="button" data-i18n="btn.view">Ver</button>
          <button class="btn-add" data-id="lixby-one" type="button" data-i18n="btn.add">Añadir al carrito</button>
        </div>
      </article>

      <!-- Lixby One Pro -->
      <article class="card glass" data-product="lixby-one-pro" role="button" tabindex="0" aria-label="Lixby One Pro">
        <div class="thumb">
          <img src="https://m.media-amazon.com/images/I/61rriyfRKwL.jpg" alt="Lixby One Pro"
               loading="lazy" decoding="async" width="600" height="600">
        </div>
        <h3 data-i18n="product.lixby-one-pro.title">Lixby One Pro</h3>
        <p data-i18n="product.lixby-one-pro.desc">Audio de alta fidelidad.</p>
        <span class="price">899€</span>
        <div class="actions">
          <button class="btn-view" onclick="location.href='producto.html?id=lixby-one-pro'" type="button" data-i18n="btn.view">Ver</button>
          <button class="btn-add" data-id="lixby-one-pro" type="button" data-i18n="btn.add">Añadir al carrito</button>
        </div>
      </article>
    </div>
  </section>

  <!-- CONTACTO -->
  <section id="contacto" class="section contact-min glass reveal" aria-labelledby="contact-title">
    <div class="left">
      <h2 id="contact-title" data-i18n="contact.title">Contáctanos</h2>
      <p class="lead" data-i18n="contact.lead">Déjanos una duda o sugerencias y te responderemos lo antes posible.</p>
    </div>

    <form id="contactForm" class="form" aria-label="Formulario de contacto" onsubmit="return false;">
      <input id="contactName" name="from_name" type="text" placeholder="Nombre" data-i18n-placeholder="contact.placeholder.name" required autocomplete="name">
      <input id="contactEmail" name="from_email" type="email" placeholder="Correo" data-i18n-placeholder="contact.placeholder.email" required autocomplete="email">
      <textarea id="contactMessage" name="message" placeholder="Tu mensaje" data-i18n-placeholder="contact.placeholder.message" required></textarea>

      <input id="ticketId" type="hidden" name="ticket_id" value="">

      <div class="actions">
        <button type="button" class="btn ghost" onclick="document.getElementById('contactForm').reset();" data-i18n="btn.clear">Borrar</button>
        <button type="submit" id="contactSend" class="btn primary" data-i18n="btn.enviar">Enviar</button>
      </div>
      <div id="contactSuccess" class="contact-success" role="status" aria-live="polite" data-i18n="contact.success">Mensaje enviado. ¡Gracias! Te contestaremos pronto.</div>
    </form>
  </section>

  <!-- CONÓCENOS -->
  <section id="conocenos" class="section reveal" aria-labelledby="about-title">
    <h2 id="about-title" data-i18n="about.title">Conócenos</h2>
    <p data-i18n="about.text">En LIXBY creemos en el equilibrio perfecto entre diseño y funcionalidad. Creamos productos que no solo funcionan, sino que también inspiran.</p>
  </section>
</main>

<!-- debug -->
<div id="debug" style="display:none;max-width:1100px;margin:12px auto;color:var(--muted);white-space:pre-wrap;"></div>

<!-- Footer (con traducciones aplicables) -->
<footer class="footer glass" role="contentinfo" aria-labelledby="footer-heading">
  <div class="footer-grid" id="footerGrid">
    <div class="footer-col">
      <div class="footer-brand">LIXBY</div>
      <p data-i18n="footer.description">Diseño minimalista, tecnología que acompaña tu día a día. Síguenos para novedades y lanzamientos.</p>
      <div class="social-links" aria-label="Redes sociales">
        <!-- icons... preserved -->
        <a href="#" title="Twitter" aria-label="Twitter" rel="noopener">...</a>
        <a href="#" title="Instagram" aria-label="Instagram" rel="noopener">...</a>
        <a href="#" title="YouTube" aria-label="YouTube" rel="noopener">...</a>
      </div>
    </div>

    <div class="footer-col">
      <h4 data-i18n="footer.links">Enlaces</h4>
      <div class="footer-links" role="navigation" aria-label="Enlaces rápidos">
        <a href="explorar.html" data-i18n="footer.explore">Explorar</a>
        <a href="productos.html" data-i18n="footer.catalog">Catálogo</a>
        <a href="carrito.html" data-i18n="footer.cart">Carrito</a>
        <a href="cuenta.html" data-i18n="footer.account">Mi cuenta</a>
      </div>
    </div>

    <div class="footer-col">
      <h4 data-i18n="footer.help">Ayuda</h4>
      <div class="footer-links">
        <a href="contacto.html" data-i18n="footer.contact">Contacto</a>
        <a href="faq.html" id="footerFaqLink" data-i18n="footer.faq">Preguntas frecuentes</a>
        <a href="envios.html" data-i18n="footer.shipping">Envíos y devoluciones</a>
        <a href="soporte.html" data-i18n="footer.support">Soporte técnico</a>
      </div>
    </div>

    <div class="footer-col" aria-label="Newsletter">
      <h4 data-i18n="footer.subscribe">Suscríbete</h4>
      <p data-i18n="footer.subscribe_text">Recibe novedades, ofertas exclusivas y lanzamientos.</p>
      <form id="newsletterForm" class="newsletter-form" onsubmit="return false;" aria-label="Formulario newsletter">
        <input id="newsletterEmail" type="email" placeholder="tu@correo.com" data-i18n-placeholder="newsletter.placeholder" aria-label="Correo electrónico para newsletter" required>
        <button id="newsletterBtn" type="submit" aria-label="Suscribirse" data-i18n="btn.subscribe">Suscribir</button>
      </form>
      <div id="newsletterMsg" role="status" aria-live="polite" style="margin-top:8px;color:var(--muted);font-size:0.95rem"></div>
    </div>
  </div>

  <div class="footer-bottom">
    <div class="legal-left">
      <small>© <span id="year"></span> LIXBY — Todos los derechos reservados</small>
      <div class="legal-links" style="margin-left:12px;">
        <a href="privacidad.html" data-i18n="footer.privacy">Política de privacidad</a>
        <a href="terminos.html" data-i18n="footer.terms">Términos y condiciones</a>
        <a id="accessibilityLink" href="accessibility.html" aria-label="Ir a la página de accesibilidad" data-i18n="footer.accessibility">Accesibilidad</a>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
      <button id="backToTop" class="back-to-top" aria-label="Volver arriba" title="Volver arriba">↑ Volver arriba</button>
      <small style="color:var(--muted)">Versión demo</small>
    </div>
  </div>
</footer>

<!-- Cart panel (estático) + backdrop (se mantiene funcional) -->
<div id="cartBackdrop" class="cart-backdrop" aria-hidden="true"></div>
<aside id="cartPanel" class="cart-panel" aria-hidden="true">
  <div class="cart-panel-inner glass" role="dialog" aria-label="Carrito">
    <div class="cart-header" style="display:flex;justify-content:space-between;align-items:center;">
      <strong data-i18n="cart.title">Carrito</strong>
      <button id="cartPanelClose" class="text-btn" aria-label="Cerrar" type="button">✕</button>
    </div>
    <div id="cartPanelItems" class="cart-list" style="max-height:60vh;overflow:auto;padding:12px"></div>
    <div class="cart-footer" style="padding:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Total</strong>
        <span id="cartPanelTotal">0€</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="cartPanelCheckout" class="btn primary" data-i18n="cart.checkout" type="button">Pagar</button>
        <button id="cartPanelClear" class="btn ghost" data-i18n="cart.clear" type="button">Vaciar</button>
      </div>
    </div>
  </div>
</aside>

<!-- Live region for screen-reader announcements -->
<div id="announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<noscript style="display:block;background:#fffb; padding:10px; text-align:center;">
  JavaScript está desactivado o ha ocurrido un error. Si la página no carga correctamente, abre la consola (F12 → Console).
</noscript>

<!-- ===========================
     SCRIPTS (inline para copiar directo)
     =========================== -->
<script>
(function(){
  // -------------------------
  // Helpers y estado
  // -------------------------
  const KEY = 'lixby_cart_v1';
  const CURRENCY = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });
  function parsePrice(s){ if (s === undefined || s === null) return 0; return Number(String(s).replace(/[^\d.,-]/g,'').replace(',', '.')) || 0; }
  function saveCart(c){ try { localStorage.setItem(KEY, JSON.stringify(c)); } catch(e){} }
  function loadCart(){ try { return JSON.parse(localStorage.getItem(KEY))||[]; } catch(e){ return []; } }
  function formatPriceNum(num){ return CURRENCY.format(Number(num) || 0); }
  function showDebug(msg){ const el=document.getElementById('debug'); if(!el) return; el.style.display='block'; el.textContent += msg + "\n"; console.log('DEBUG',msg); }

  try { document.getElementById('year').textContent = new Date().getFullYear(); } catch(e){}

  // Productos (preservado)
  const PRODUCTS_BRIEF = {
    'lixby-one-air': { id:'lixby-one-air', name: 'Lixby One Air', price: '249€', priceNum: 249, image: 'https://m.media-amazon.com/images/I/61j5RD1d9KL._UF1000,1000_QL80_.jpg' },
    'lixby-one': { id:'lixby-one', name: 'Lixby One', price: '349€', priceNum: 349, image: 'https://m.media-amazon.com/images/I/712Pyq1hPfL._UF1000,1000_QL80_.jpg' },
    'lixby-one-pro': { id:'lixby-one-pro', name: 'Lixby One Pro', price: '899€', priceNum: 899, image: 'https://m.media-amazon.com/images/I/61rriyfRKwL.jpg' }
  };

  // CART state & UI refs
  let cart = loadCart();
  const cartBtn = document.getElementById('cartBtn');
  const miniCart = document.getElementById('miniCart');
  const miniCartItems = document.getElementById('miniCartItems');
  const miniCartTotal = document.getElementById('miniCartTotal');
  const cartCount = document.getElementById('cartCount');
  const clearCartBtn = document.getElementById('clearCart');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const announcements = document.getElementById('announcements');

  const cartPanel = document.getElementById('cartPanel');
  const cartBackdrop = document.getElementById('cartBackdrop');
  const cartPanelClose = document.getElementById('cartPanelClose');
  const cartPanelItems = document.getElementById('cartPanelItems');
  const cartPanelTotal = document.getElementById('cartPanelTotal');
  const cartPanelClear = document.getElementById('cartPanelClear');

  function updateMiniCartUI(){
    if (!cartCount) return;
    const totalQty = cart.reduce((s,i)=>s+(i.qty||0),0);
    cartCount.textContent = totalQty;
    if (!miniCartItems) return;
    miniCartItems.innerHTML = '';
    if (cart.length === 0) {
      miniCartItems.innerHTML = '<div style="padding:8px;color:var(--muted)">'+ (getTranslation('cart.empty') || 'Tu carrito está vacío.') +'</div>';
      if (miniCartTotal) miniCartTotal.textContent = formatPriceNum(0);
      return;
    }
    let total = 0;
    const frag = document.createDocumentFragment();
    cart.forEach((it, idx) => {
      const item = document.createElement('div');
      item.className = 'mini-cart-item';
      item.style.display = 'flex'; item.style.gap='10px'; item.style.alignItems='center'; item.style.padding='8px'; item.style.borderRadius='8px';
      const img = document.createElement('img'); img.src = it.image || 'https://via.placeholder.com/80x80?text=Img'; img.alt = it.name; img.style.width='44px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
      img.loading='lazy'; img.decoding='async';
      const meta = document.createElement('div'); meta.className='meta';
      const title = document.createElement('div'); title.style.fontWeight = '700'; title.textContent = it.name || '';
      const subtitle = document.createElement('div'); subtitle.style.color = 'var(--muted)'; subtitle.textContent = `${formatPriceNum(it.priceNum || parsePrice(it.price))} × ${it.qty||1}`;
      meta.appendChild(title); meta.appendChild(subtitle);
      const remove = document.createElement('button'); remove.className='remove'; remove.textContent='✕'; remove.style.background='transparent'; remove.style.border='none'; remove.style.cursor='pointer';
      remove.setAttribute('type','button');
      remove.addEventListener('click', (e)=>{ e.stopPropagation(); cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
      item.appendChild(img); item.appendChild(meta); item.appendChild(remove);
      frag.appendChild(item);
      total += (it.priceNum || parsePrice(it.price)) * (it.qty||1);
    });
    miniCartItems.appendChild(frag);
    if (miniCartTotal) miniCartTotal.textContent = formatPriceNum(total);
  }

  function updateCartPanel(){
    if (!cartPanelItems) return;
    cartPanelItems.innerHTML = '';
    if (cart.length === 0) {
      cartPanelItems.innerHTML = '<div style="padding:12px;color:var(--muted)">'+ (getTranslation('cart.empty') || 'Tu carrito está vacío.') +'</div>';
      if (cartPanelTotal) cartPanelTotal.textContent = formatPriceNum(0);
      return;
    }
    let total = 0;
    const frag = document.createDocumentFragment();
    cart.forEach((it, idx) => {
      const row = document.createElement('div');
      row.style.display='flex'; row.style.gap='12px'; row.style.alignItems='center'; row.style.padding='10px 0'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
      const img = document.createElement('img'); img.src = it.image || ''; img.alt = it.name; img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover'; img.style.borderRadius='8px';
      const meta = document.createElement('div'); meta.style.flex='1';
      const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = it.name || '';
      const qty = document.createElement('div'); qty.style.color='var(--muted)'; qty.textContent = `× ${it.qty || 1} — ${formatPriceNum(it.priceNum || parsePrice(it.price))}`;
      meta.appendChild(title); meta.appendChild(qty);
      const remove = document.createElement('button'); remove.className='text-btn'; remove.textContent='Eliminar'; remove.setAttribute('type','button');
      remove.addEventListener('click', ()=> { cart.splice(idx,1); saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
      row.appendChild(img); row.appendChild(meta); row.appendChild(remove);
      frag.appendChild(row);
      total += (it.priceNum || parsePrice(it.price)) * (it.qty||1);
    });
    cartPanelItems.appendChild(frag);
    if (cartPanelTotal) cartPanelTotal.textContent = formatPriceNum(total);
  }

  // ensure miniCart style reflects aria-hidden initially
  if (miniCart) {
    if (miniCart.getAttribute('aria-hidden') === 'false') miniCart.style.display = 'flex';
    else miniCart.style.display = '';
  }

  // Hover show mini-cart & click navigates to carrito.html (fixed per request)
  (function wireCartHoverAndClick(){
    const wrapper = document.querySelector('.cart-wrapper');
    let hideTimeout = null;

    function showMini(){
      if (!miniCart) return;
      miniCart.setAttribute('aria-hidden','false');
      miniCart.style.display = 'flex';
      try { cartBtn.setAttribute('aria-expanded','true'); } catch(e){}
    }
    function hideMini(){
      if (!miniCart) return;
      miniCart.setAttribute('aria-hidden','true');
      miniCart.style.display = '';
      try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){}
    }

    if (wrapper) {
      wrapper.addEventListener('mouseenter', (e) => {
        clearTimeout(hideTimeout);
        showMini();
      });
      wrapper.addEventListener('mouseleave', (e) => {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          if (cartPanel && cartPanel.classList.contains('open')) return;
          hideMini();
        }, 220);
      });
    }
    if (miniCart) {
      miniCart.addEventListener('mouseenter', () => { clearTimeout(hideTimeout); showMini(); });
      miniCart.addEventListener('mouseleave', () => {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          if (cartPanel && cartPanel.classList.contains('open')) return;
          hideMini();
        }, 220);
      });
    }

    // CLICK: ahora redirige a carrito.html (según tu petición)
    if (cartBtn) {
      cartBtn.addEventListener('click', (e) => {
        // si quieres mantener comportamiento panel con tecla modificadora, se puede:
        if (e.metaKey || e.ctrlKey) {
          openCartPanel();
          return;
        }
        window.location.href = 'carrito.html';
      });
    }

    // viewCartBtn sigue abriendo el panel (útil)
    const viewBtn = document.getElementById('viewCartBtn');
    if (viewBtn) viewBtn.addEventListener('click', (e) => openCartPanel());
  })();

  // Panel functions
  function openCartPanel(){
    if (!cartPanel || !cartBackdrop) return;
    cartPanel.classList.add('open');
    cartBackdrop.classList.add('open');
    cartPanel.setAttribute('aria-hidden','false');
    cartBackdrop.setAttribute('aria-hidden','false');
    if (miniCart) { miniCart.setAttribute('aria-hidden','true'); miniCart.style.display = ''; try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){} }
    updateCartPanel();
  }
  function closeCartPanel(){
    if (!cartPanel || !cartBackdrop) return;
    cartPanel.classList.remove('open');
    cartBackdrop.classList.remove('open');
    cartPanel.setAttribute('aria-hidden','true');
    cartBackdrop.setAttribute('aria-hidden','true');
  }
  if (cartBackdrop) cartBackdrop.addEventListener('click', closeCartPanel);
  if (cartPanelClose) cartPanelClose.addEventListener('click', closeCartPanel);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (cartPanel && cartPanel.classList.contains('open')) closeCartPanel(); } });

  if (clearCartBtn) clearCartBtn.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); updateCartPanel(); });
  if (cartPanelClear) cartPanelClear.addEventListener('click', () => { cart=[]; saveCart(cart); updateMiniCartUI(); updateCartPanel(); });

  if (checkoutBtn) checkoutBtn.addEventListener('click', () => { if (cart.length===0) return alert(getTranslation('cart.empty') || 'El carrito está vacío'); alert('Simulación de checkout: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });
  if (document.getElementById('cartPanelCheckout')) document.getElementById('cartPanelCheckout').addEventListener('click', () => { if (cart.length===0) return alert(getTranslation('cart.empty') || 'El carrito está vacío'); alert('Simulación de checkout desde panel: ' + cart.reduce((s,i)=>s+(i.qty||0),0) + ' items'); });

  window.addToCart = function(product){
    const existing = cart.find(p => p.id === product.id);
    if (existing) existing.qty = (existing.qty||1) + 1;
    else cart.push({ id: product.id, name: product.name, price: product.price, priceNum: Number(product.priceNum || parsePrice(product.price) || 0), qty:1, image: product.image });
    saveCart(cart);
    updateMiniCartUI();
    updateCartPanel();
    if (miniCart) { miniCart.setAttribute('aria-hidden','false'); miniCart.style.display = 'flex'; try { cartBtn.setAttribute('aria-expanded','true'); } catch(e){} setTimeout(()=>{ if (miniCart) { miniCart.setAttribute('aria-hidden','true'); miniCart.style.display = ''; try { cartBtn.setAttribute('aria-expanded','false'); } catch(e){} } }, 2200); }
    try { if (announcements) announcements.textContent = `${product.name} añadido al carrito.`; } catch(e){}
  };

  updateMiniCartUI();
  updateCartPanel();

  // ---------------------------
  // I18N / translations (mejorado, no petará)
  // ---------------------------
  const langBtn = document.getElementById('langBtn'), langMenu = document.getElementById('langMenu'), langLabel = document.getElementById('langLabel'), langFlag = document.getElementById('langFlag');
  const translations = {
    es: {
      "meta.title":"LIXBY — Tecnología minimalista",
      "nav.inicio":"Inicio","nav.productos":"Productos","nav.contacto":"Contáctanos","nav.conocenos":"Conócenos",
      "hero.title":"La tecnología que te entiende","hero.subtitle":"Innovación minimalista para tu día a día",
      "section.products":"Productos",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultraligero y económico.",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultraligero y potente.",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"Audio de alta fidelidad.",
      "btn.explorar":"Explorar","btn.view":"Ver","btn.add":"Añadir al carrito","btn.added":"Añadido","btn.enviar":"Enviar","btn.clear":"Borrar","btn.subscribe":"Suscribir",
      "contact.title":"Contáctanos","contact.lead":"Déjanos una duda o sugerencias y te responderemos lo antes posible.","contact.placeholder.name":"Nombre","contact.placeholder.email":"Correo","contact.placeholder.message":"Tu mensaje","contact.success":"Mensaje enviado. ¡Gracias! Te contestaremos pronto.",
      "cart.title":"Carrito","cart.clear":"Vaciar","cart.total":"Total:","cart.checkout":"Pagar","cart.empty":"Tu carrito está vacío.","cart.view":"Ver carrito",
      "footer.description":"Diseño minimalista, tecnología que acompaña tu día a día. Síguenos para novedades y lanzamientos.",
      "footer.links":"Enlaces","footer.explore":"Explorar","footer.catalog":"Catálogo","footer.cart":"Carrito","footer.account":"Mi cuenta",
      "footer.help":"Ayuda","footer.contact":"Contacto","footer.faq":"Preguntas frecuentes","footer.shipping":"Envíos y devoluciones","footer.support":"Soporte técnico",
      "footer.subscribe":"Suscríbete","footer.subscribe_text":"Recibe novedades, ofertas exclusivas y lanzamientos.","newsletter.placeholder":"tu@correo.com",
      "footer.privacy":"Política de privacidad","footer.terms":"Términos y condiciones","footer.accessibility":"Accesibilidad",
      "pro.cta":"PÁSATE AL PRO"
    },
    en: {
      "meta.title":"LIXBY — Minimal technology",
      "nav.inicio":"Home","nav.productos":"Products","nav.contacto":"Contact","nav.conocenos":"About",
      "hero.title":"Technology that understands you","hero.subtitle":"Minimal innovations for your day-to-day",
      "section.products":"Products",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultralight and affordable.",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultralight and powerful.",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"High-fidelity audio.",
      "btn.explorar":"Explore","btn.view":"View","btn.add":"Add to cart","btn.added":"Added","btn.enviar":"Send","btn.clear":"Clear","btn.subscribe":"Subscribe",
      "contact.title":"Contact","contact.lead":"Leave us a question or suggestion and we'll reply soon.",
      "contact.placeholder.name":"Name","contact.placeholder.email":"Email","contact.placeholder.message":"Your message","contact.success":"Message sent. Thanks!",
      "cart.title":"Cart","cart.clear":"Clear","cart.total":"Total:","cart.checkout":"Checkout","cart.empty":"Your cart is empty.","cart.view":"View cart",
      "footer.description":"Minimal design, technology that accompanies your everyday life. Follow us for updates and launches.",
      "footer.links":"Links","footer.explore":"Explore","footer.catalog":"Catalog","footer.cart":"Cart","footer.account":"My account",
      "footer.help":"Help","footer.contact":"Contact","footer.faq":"FAQ","footer.shipping":"Shipping & returns","footer.support":"Support",
      "footer.subscribe":"Subscribe","footer.subscribe_text":"Receive news, exclusive offers and launches.","newsletter.placeholder":"you@email.com",
      "footer.privacy":"Privacy policy","footer.terms":"Terms & conditions","footer.accessibility":"Accessibility",
      "pro.cta":"GO PRO"
    },
    fr: {
      "meta.title":"LIXBY — Technologie minimaliste",
      "nav.inicio":"Accueil","nav.productos":"Produits","nav.contacto":"Contact","nav.conocenos":"À propos",
      "hero.title":"La technologie qui vous comprend","hero.subtitle":"Innovation minimaliste pour votre quotidien",
      "section.products":"Produits",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultraléger et abordable.",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultraléger et puissant.",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"Audio haute fidélité.",
      "btn.explorar":"Explorer","btn.view":"Voir","btn.add":"Ajouter au panier","btn.added":"Ajouté","btn.enviar":"Envoyer","btn.clear":"Vider","btn.subscribe":"S'abonner",
      "contact.title":"Contact","contact.lead":"Laissez-nous une question ou suggestion et nous répondrons bientôt.","contact.placeholder.name":"Nom","contact.placeholder.email":"Email","contact.placeholder.message":"Votre message","contact.success":"Message envoyé. Merci!",
      "cart.title":"Panier","cart.clear":"Vider","cart.total":"Total:","cart.checkout":"Payer","cart.empty":"Votre panier est vide.","cart.view":"Voir le panier",
      "footer.description":"Design minimaliste, technologie qui accompagne votre quotidien.","footer.links":"Liens","footer.explore":"Explorer","footer.catalog":"Catalogue","footer.cart":"Panier","footer.account":"Mon compte",
      "footer.help":"Aide","footer.contact":"Contact","footer.faq":"FAQ","footer.shipping":"Livraison & retours","footer.support":"Support",
      "footer.subscribe":"S'abonner","footer.subscribe_text":"Recevez des nouveautés, offres exclusives et lancements.","newsletter.placeholder":"vous@email.com",
      "footer.privacy":"Politique de confidentialité","footer.terms":"Conditions","footer.accessibility":"Accessibilité",
      "pro.cta":"PASSER PRO"
    },
    de: {
      "meta.title":"LIXBY — Minimal Technologie",
      "nav.inicio":"Start","nav.productos":"Produkte","nav.contacto":"Kontakt","nav.conocenos":"Über uns",
      "hero.title":"Technologie, die dich versteht","hero.subtitle":"Minimalistische Innovationen für deinen Alltag",
      "section.products":"Produkte",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultraleicht und preiswert.",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultraleicht und leistungsstark.",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"High-Fidelity Audio.",
      "btn.explorar":"Entdecken","btn.view":"Ansehen","btn.add":"In den Warenkorb","btn.added":"Hinzugefügt","btn.enviar":"Senden","btn.clear":"Löschen","btn.subscribe":"Abonnieren",
      "contact.title":"Kontakt","contact.lead":"Stell uns eine Frage oder Anregung und wir antworten bald.","contact.placeholder.name":"Name","contact.placeholder.email":"E-Mail","contact.placeholder.message":"Deine Nachricht","contact.success":"Nachricht gesendet. Danke!",
      "cart.title":"Warenkorb","cart.clear":"Leeren","cart.total":"Gesamt:","cart.checkout":"Zur Kasse","cart.empty":"Dein Warenkorb ist leer.","cart.view":"Warenkorb ansehen",
      "footer.description":"Minimalistisches Design, Technologie für den Alltag.","pro.cta":"PRO WERDEN"
    },
    it: {
      "meta.title":"LIXBY — Tecnologia minimalista",
      "nav.inicio":"Home","nav.productos":"Prodotti","nav.contacto":"Contatti","nav.conocenos":"Chi siamo",
      "hero.title":"La tecnologia che ti capisce","hero.subtitle":"Innovazione minimalista per la tua quotidianità",
      "section.products":"Prodotti",
      "product.lixby-one-air.title":"Lixby One Air","product.lixby-one-air.desc":"Ultraleggero ed economico.",
      "product.lixby-one.title":"Lixby One","product.lixby-one.desc":"Ultraleggero e potente.",
      "product.lixby-one-pro.title":"Lixby One Pro","product.lixby-one-pro.desc":"Audio ad alta fedeltà.",
      "btn.explorar":"Esplora","btn.view":"Vedi","btn.add":"Aggiungi al carrello","btn.added":"Aggiunto","btn.enviar":"Invia","btn.clear":"Cancella","btn.subscribe":"Iscriviti",
      "contact.title":"Contattaci","contact.lead":"Lascia una domanda o suggerimento e ti risponderemo presto.","contact.placeholder.name":"Nome","contact.placeholder.email":"Email","contact.placeholder.message":"Il tuo messaggio","contact.success":"Messaggio inviato. Grazie!",
      "cart.title":"Carrello","cart.clear":"Svuota","cart.total":"Totale:","cart.checkout":"Paga","cart.empty":"Il tuo carrello è vuoto.","cart.view":"Vedi carrello",
      "footer.description":"Design minimalista, tecnologia che ti accompagna nella vita di tutti i giorni.","pro.cta":"PASSA A PRO"
    }
  };

  // Start language
  let currentLang = localStorage.getItem('lixby_lang') || (navigator.language ? navigator.language.slice(0,2) : 'es');
  if (!translations[currentLang]) currentLang = 'es';

  function getTranslation(key, lang){
    try {
      const map = translations[lang || currentLang] || translations['es'];
      return (map && map[key]) ? map[key] : null;
    } catch(e){ return null; }
  }

  // Apply translations: handles data-i18n (text), data-i18n-placeholder, data-i18n-title, data-i18n-value
  function applyTranslations(lang){
    const map = translations[lang] || translations['es'];
    // set html lang attribute and title
    try { document.documentElement.lang = lang; } catch(e){}
    try { if (map && map['meta.title']) document.title = map['meta.title']; } catch(e){}

    // text nodes / textContent
    document.querySelectorAll('[data-i18n]').forEach(el => {
      try {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        const text = (map && map[key]) ? map[key] : el.textContent;
        el.textContent = text;
      } catch(err) { console.warn('i18n text fail', err); }
    });

    // placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
      try {
        const key = el.getAttribute('data-i18n-placeholder');
        if (!key) return;
        const text = (map && map[key]) ? map[key] : el.getAttribute('placeholder') || '';
        el.setAttribute('placeholder', text);
      } catch(err){ console.warn('i18n placeholder fail', err); }
    });

    // titles/tooltips/values
    document.querySelectorAll('[data-i18n-title]').forEach(el => {
      try {
        const key = el.getAttribute('data-i18n-title');
        if (!key) return;
        const text = (map && map[key]) ? map[key] : el.getAttribute('title') || '';
        el.setAttribute('title', text);
      } catch(err){}
    });

    // small UI label updates
    try {
      const names = { es:'Español', en:'English', fr:'Français', de:'Deutsch', it:'Italiano' };
      if (document.getElementById('langLabel')) document.getElementById('langLabel').textContent = names[lang] || names['es'];
      if (langFlag) {
        const flags = { es:'🇪🇸', en:'🇬🇧', fr:'🇫🇷', de:'🇩🇪', it:'🇮🇹' };
        langFlag.textContent = flags[lang] || '🏳️';
      }
    } catch(e){}

    // update any price/mini-cart messages (robust)
    try { updateMiniCartUI(); updateCartPanel(); } catch(e){}
  }

  function setLang(l){
    if (!translations[l]) l = 'es';
    currentLang = l;
    try { localStorage.setItem('lixby_lang', l); } catch(e){}
    try { applyTranslations(l); } catch(e){ console.warn('applyTranslations failed', e); }
  }

  // wire language menu (safe)
  try {
    setLang(localStorage.getItem('lixby_lang') || currentLang);
    if (langBtn && langMenu){
      langBtn.addEventListener('click', ()=> {
        const isOpen = langMenu.getAttribute('aria-hidden') === 'false';
        langMenu.setAttribute('aria-hidden', String(!isOpen));
        langMenu.style.display = !isOpen ? 'flex' : 'none';
        langBtn.setAttribute('aria-expanded', String(!isOpen));
      });
      Array.from(langMenu.querySelectorAll('.lang-item')).forEach(btn => btn.addEventListener('click', ()=> {
        const lang = btn.getAttribute('data-lang');
        if (!lang) return;
        setLang(lang);
        langMenu.setAttribute('aria-hidden','true');
        langMenu.style.display='none';
        langBtn.setAttribute('aria-expanded','false');
      }));
      document.addEventListener('click', (e)=> {
        if (!langBtn.contains(e.target) && !langMenu.contains(e.target)) {
          langMenu.setAttribute('aria-hidden','true');
          langMenu.style.display='none';
          langBtn.setAttribute('aria-expanded','false');
        }
      });
    }
  } catch(err){ console.warn('lang wiring failed', err); }

  // THEME
  const THEME_KEY = 'lixby_theme';
  const themeToggle = document.getElementById('themeToggle');
  if (localStorage.getItem(THEME_KEY) === 'light') document.documentElement.classList.add('light');
  if (themeToggle) themeToggle.addEventListener('click', ()=>{ const isLight = document.documentElement.classList.toggle('light'); try{ localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark'); }catch(e){} });

  // CONTACT: EmailJS lazy-load (preservado; no modificado)
  async function ensureEmailJs(){
    if (window.emailjs && typeof window.emailjs.sendForm === 'function') return;
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js';
      s.crossOrigin = 'anonymous';
      s.onload = res;
      s.onerror = () => rej(new Error('EmailJS load failed'));
      document.head.appendChild(s);
    });
    try { if (window.emailjs && typeof emailjs.init === 'function') emailjs.init('xsKpaFjbRsS95AK3i'); } catch(e){ console.warn('EmailJS init failed', e); }
  }

  (function initContact(){
    const form = document.getElementById('contactForm');
    const sendBtn = document.getElementById('contactSend');
    const successEl = document.getElementById('contactSuccess');
    const ticketHidden = document.getElementById('ticketId');
    if (!form) return;

    function generateTicketId(){
      const t = 'LIXBY-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
      return t;
    }

    async function sendEmail(e){
      e.preventDefault();
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const message = document.getElementById('contactMessage').value.trim();
      if (!name || !email || !message) { alert(getTranslation('contact.fill') || 'Por favor completa todos los campos.'); return; }
      const ticket = generateTicketId();
      if (ticketHidden) ticketHidden.value = ticket;
      sendBtn.disabled = true;
      const prev = sendBtn.textContent; sendBtn.textContent = getTranslation('contact.sending') || 'Enviando...';
      try {
        await ensureEmailJs();
        if (!window.emailjs || typeof window.emailjs.sendForm !== 'function') {
          throw new Error('EmailJS SDK no disponible');
        }
        await emailjs.sendForm('service_tagcpgm', 'template_l1e0go2', '#contactForm');
        successEl.style.display = 'block';
        form.reset();
        try {
          const key = 'lixby_tickets_v1';
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          arr.push({ ticket_id: ticket, name: name, email: email, message: message, created_at: new Date().toISOString(), status: 'sent' });
          localStorage.setItem(key, JSON.stringify(arr));
        } catch (errLocal) { /* no crítico */ }
        setTimeout(()=> successEl.style.display = 'none', 6000);
      } catch (err) {
        console.error('Error enviando con EmailJS:', err);
        try {
          const key = 'lixby_tickets_v1';
          const arr = JSON.parse(localStorage.getItem(key) || '[]');
          arr.push({ ticket_id: ticket, name: name, email: email, message: message, created_at: new Date().toISOString(), status: 'failed', error: String(err) });
          localStorage.setItem(key, JSON.stringify(arr));
        } catch (errLocal) { console.warn('Fallback save failed', errLocal); }
        alert(getTranslation('contact.error') || 'No se pudo enviar el mensaje vía EmailJS.');
      } finally {
        sendBtn.disabled = false; sendBtn.textContent = prev;
      }
    }
    form.addEventListener('submit', sendEmail);
  })();

  // Account button: keep as before but safe
  try {
    const accountBtn = document.getElementById('accountBtn');
    if (accountBtn) {
      accountBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const stored = (function(){ try { return JSON.parse(localStorage.getItem('lixby_user')||'null'); } catch(e){ return null; } })();
        if (stored && stored.uid) {
          window.location.href = 'cuenta.html';
          return;
        }
        // fallback: go to login/account page
        window.location.href = 'cuenta.html';
      });
    }
  } catch(e){}

  // PRO button behaviour (simple demo: lleva a /pro o abre modal)
  const proBtn = document.getElementById('proBtn');
  if (proBtn) {
    proBtn.addEventListener('click', ()=> {
      // redirigir a página PRO (crear pro.html si quieres)
      window.location.href = 'pro.html';
    });
  }

  // expose for debugging
  window.lixby = window.lixby || {};
  window.lixby.cart = { load: loadCart, save: saveCart, getAll: () => cart };
  window.lixby.setLang = setLang;
})();
</script>
</body>
</html>
