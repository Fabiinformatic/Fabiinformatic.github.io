<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mi cuenta ‚Äî LIXBY</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root { color-scheme: dark; }
    body { background: transparent; color: var(--text); font-family: 'Inter', system-ui, sans-serif; margin:0; }

    /* HEADER FIJO */
    header {
      position: sticky; top: 0; z-index: 1000;
      padding:12px 24px; display:flex; justify-content:space-between; align-items:center;
      background: rgba(15,20,27,0.85); border-bottom:1px solid #1b2230; backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .brand { font-weight:800; cursor:pointer; user-select:none; letter-spacing:0.04em; font-size:1.15rem; transition: color .18s var(--ease-bouncy);}
    .brand:focus-visible { outline: none; color: var(--accent); box-shadow: 0 0 0 4px var(--accent-soft);}
    .btn.ghost { background:transparent; border:1px solid var(--stroke); color:var(--text); }
    main {
      max-width:1100px; margin:50px auto 60px; padding:0 20px;
      display: grid; gap: 28px;
      animation: minimal-fade-in 0.88s var(--ease-bouncy) 0.07s 1 both;
    }
    @media (max-width:700px){ main { margin:24px auto 50px; padding:0 6px; } }
    .account-layout {
      display: grid; grid-template-columns: 340px 1fr; gap: 28px; align-items: flex-start;
    }
    @media (max-width:900px) {
      .account-layout { grid-template-columns:1fr; gap:18px; }
    }
    .glass-card {
      background: var(--bg-elev);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      padding: 32px 26px;
      position: relative;
      overflow: hidden;
      transition: box-shadow .45s var(--ease-bouncy), border-color .23s var(--ease-bouncy), background .23s var(--ease-bouncy);
      animation: minimal-fade-in 0.9s var(--ease-bouncy);
      opacity: 1;
    }
    .glass-card.section { margin-top:0; }
    h2 { margin-top:0; font-size:1.18rem; letter-spacing:0.01em; }
    .profile-avatar {
      width:100px; height:100px; border-radius:18px;
      background: linear-gradient(135deg, rgba(10,132,255,0.10), rgba(255,255,255,0.06));
      display:block; margin-bottom:14px; object-fit:cover;
      border: 2px solid var(--accent-soft);
      box-shadow: 0 4px 18px rgba(10,132,255,0.09);
      transition: box-shadow .26s var(--ease-bouncy), border-color .18s var(--ease-bouncy);
    }
    .profile-avatar:hover { box-shadow: 0 8px 32px rgba(10,132,255,0.15); border-color: var(--accent); }
    .profile-info { text-align:center; margin-bottom: 18px;}
    .profile-info h2 { margin-bottom:6px; }
    .muted { color:var(--muted); font-size:0.96em; }
    .profile-status {
      display:inline-block; margin-top:6px; padding:2px 10px;
      border-radius: 8px; background: var(--glass-strong); color:var(--accent); font-weight:600; font-size:0.9em;
    }
    .profile-actions { display:flex; gap:10px; justify-content:center; margin:18px 0 0; }
    .btn { padding:9px 16px; border-radius:var(--radius-md); font-weight:700; font-size:1em; }
    .btn[disabled] { opacity:.5; pointer-events:none; }
    .account-form label { display:block; margin-top:18px; font-weight:600; color:var(--muted);}
    .account-form input, .account-form textarea, .account-form select {
      width:100%; padding:10px; border-radius:9px; border:1px solid var(--stroke);
      background: rgba(255,255,255,0.03); color:var(--text); font-size:1em; margin-top:4px;
      transition: border-color .18s var(--ease-bouncy), box-shadow .18s var(--ease-bouncy);
    }
    .account-form input:focus, .account-form textarea:focus, .account-form select:focus {
      border-color: var(--accent); outline: none; box-shadow: var(--focus-ring);
    }
    .account-form select {
      cursor: pointer;
    }
    .account-form input[readonly] {
      background: rgba(255,255,255,0.02); color: var(--muted);
      cursor: not-allowed;
    }
    .form-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .form-section:last-of-type {
      border-bottom: none;
      margin-bottom: 0;
    }
    .form-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .save-actions { margin-top:22px; display:flex; gap:10px; }
    /* Secciones personales */
    .sections-list { display:grid; gap:22px; }
    .section-title {
      display:flex; align-items:center; gap:8px;
      font-size:1.06rem; font-weight:700; margin-bottom:10px;
    }
    .section-badge {
      background: var(--accent-soft); color: var(--accent);
      border-radius: 12px; padding:2px 10px; font-size:0.85em; font-weight:500;
    }
    .favorites-list, .orders-list, .purchased-list {
      display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      margin-top: 8px;
    }
    .favorite-card, .purchase-card, .order-card {
      background: var(--glass);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 14px;
      font-size:0.98em;
      min-height:40px;
      transition: box-shadow .28s var(--ease-bouncy), border-color .22s var(--ease-bouncy);
      display:flex; flex-direction:column; gap:7px;
      cursor:pointer;
      animation: minimal-fade-in 0.6s var(--ease-bouncy);
    }
    .favorite-card:hover, .purchase-card:hover, .order-card:hover {
      border-color: var(--accent-soft);
      box-shadow: 0 4px 18px rgba(10,132,255,0.08);
      background: var(--glass-strong);
    }
    .empty-state {
      color:var(--muted); font-size:0.97em; text-align:center; padding:18px 0; opacity:.8;
      animation: minimal-fade-in 1.1s var(--ease-bouncy);
    }
    /* Animaci√≥n sutil de carga */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(10,132,255,0.10) 50%, rgba(255,255,255,0.04) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.4s infinite linear;
      border-radius: 8px; min-height: 32px;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand" id="brand" role="link" tabindex="0" aria-label="Ir al inicio">LIXBY</div>
    <a href="index.html" class="btn ghost">Volver</a>
  </header>

  <main>
    <div class="account-layout">
      <!-- Columna perfil -->
      <div class="glass-card" style="padding-bottom:20px;">
        <div class="profile-info">
          <img id="profileAvatar" class="profile-avatar" src="" alt="Avatar">
          <h2 id="profileName">Invitado</h2>
          <div id="profileEmail" class="muted" style="margin-bottom:4px;"></div>
          <div id="profileStatus" class="profile-status">No autenticado</div>
        </div>
        <div class="profile-actions">
          <button id="loginNowBtn" class="btn primary">Iniciar sesi√≥n</button>
          <button id="signOutBtn" class="btn ghost" style="display:none">Cerrar sesi√≥n</button>
        </div>
      </div>

      <!-- Columna informaci√≥n de la cuenta -->
      <form class="glass-card account-form" autocomplete="off" onsubmit="return false;">
        <h2>Informaci√≥n de la cuenta</h2>
        
        <!-- ü™™ Identidad b√°sica -->
        <div class="form-section">
          <h3 class="form-section-title">ü™™ Identidad b√°sica</h3>
          <label for="firstNameInput">Nombre</label>
          <input id="firstNameInput" type="text" placeholder="Tu nombre" autocomplete="given-name">
          <label for="lastNameInput">Apellidos</label>
          <input id="lastNameInput" type="text" placeholder="Tus apellidos" autocomplete="family-name">
          <label for="genderInput">G√©nero</label>
          <select id="genderInput">
            <option value="">Seleccionar g√©nero</option>
            <option value="masculino">Masculino</option>
            <option value="femenino">Femenino</option>
            <option value="otro">Otro</option>
            <option value="prefiero-no-decir">Prefiero no decir</option>
          </select>
        </div>

        <!-- üéÇ Datos de nacimiento -->
        <div class="form-section">
          <h3 class="form-section-title">üéÇ Datos de nacimiento</h3>
          <label for="birthDateInput">Fecha de nacimiento</label>
          <input id="birthDateInput" type="date" autocomplete="bday">
          <label for="ageInput">Edad</label>
          <input id="ageInput" type="number" placeholder="Se calcula autom√°ticamente" readonly>
        </div>

        <!-- üåç Ubicaci√≥n -->
        <div class="form-section">
          <h3 class="form-section-title">üåç Ubicaci√≥n</h3>
          <label for="countryInput">Pa√≠s o regi√≥n</label>
          <select id="countryInput">
            <option value="es">Espa√±a</option>
            <option value="mx">M√©xico</option>
            <option value="ar">Argentina</option>
            <option value="co">Colombia</option>
            <option value="pe">Per√∫</option>
            <option value="cl">Chile</option>
            <option value="ve">Venezuela</option>
            <option value="us">Estados Unidos</option>
            <option value="fr">Francia</option>
            <option value="de">Alemania</option>
            <option value="it">Italia</option>
            <option value="pt">Portugal</option>
            <option value="gb">Reino Unido</option>
            <option value="other">Otro</option>
          </select>
          <label for="cityInput">Ciudad o provincia</label>
          <input id="cityInput" type="text" placeholder="Tu ciudad" autocomplete="address-level2">
          <label for="postalCodeInput">C√≥digo postal</label>
          <input id="postalCodeInput" type="text" placeholder="28001" autocomplete="postal-code">
        </div>

        <!-- üí¨ Preferencias ling√º√≠sticas -->
        <div class="form-section">
          <h3 class="form-section-title">üí¨ Preferencias ling√º√≠sticas</h3>
          <label for="primaryLanguageInput">Idioma preferido</label>
          <select id="primaryLanguageInput">
            <option value="es">Espa√±ol</option>
            <option value="en">Ingl√©s</option>
            <option value="fr">Franc√©s</option>
            <option value="de">Alem√°n</option>
            <option value="it">Italiano</option>
            <option value="pt">Portugu√©s</option>
            <option value="ca">Catal√°n</option>
            <option value="eu">Euskera</option>
            <option value="gl">Gallego</option>
          </select>
          <label for="secondaryLanguageInput">Segundo idioma (opcional)</label>
          <select id="secondaryLanguageInput">
            <option value="">Ninguno</option>
            <option value="es">Espa√±ol</option>
            <option value="en">Ingl√©s</option>
            <option value="fr">Franc√©s</option>
            <option value="de">Alem√°n</option>
            <option value="it">Italiano</option>
            <option value="pt">Portugu√©s</option>
            <option value="ca">Catal√°n</option>
            <option value="eu">Euskera</option>
            <option value="gl">Gallego</option>
          </select>
          <label for="dateFormatInput">Formato de fecha/hora</label>
          <select id="dateFormatInput">
            <option value="DD/MM/YYYY">DD/MM/AAAA</option>
            <option value="MM/DD/YYYY">MM/DD/AAAA</option>
            <option value="YYYY-MM-DD">AAAA-MM-DD</option>
          </select>
          <label for="currencyInput">Moneda preferida</label>
          <select id="currencyInput">
            <option value="EUR">‚Ç¨ Euro</option>
            <option value="USD">$ D√≥lar estadounidense</option>
            <option value="GBP">¬£ Libra esterlina</option>
            <option value="MXN">$ Peso mexicano</option>
            <option value="ARS">$ Peso argentino</option>
            <option value="COP">$ Peso colombiano</option>
            <option value="PEN">S/ Sol peruano</option>
            <option value="CLP">$ Peso chileno</option>
          </select>
        </div>

        <!-- üìû Contacto -->
        <div class="form-section">
          <h3 class="form-section-title">üìû Contacto</h3>
          <label for="emailPrimaryInput">Correo electr√≥nico principal</label>
          <input id="emailPrimaryInput" type="email" placeholder="tu@email.com" autocomplete="email">
          <label for="emailSecondaryInput">Correo alternativo de recuperaci√≥n</label>
          <input id="emailSecondaryInput" type="email" placeholder="recuperacion@email.com" autocomplete="email">
          <label for="phonePrimaryInput">N√∫mero de tel√©fono</label>
          <input id="phonePrimaryInput" type="tel" placeholder="+34 600 000 000" autocomplete="tel">
          <label for="phoneSecondaryInput">Tel√©fono de respaldo (opcional)</label>
          <input id="phoneSecondaryInput" type="tel" placeholder="+34 600 000 001" autocomplete="tel">
        </div>

        <!-- Direcci√≥n de env√≠o (original) -->
        <div class="form-section">
          <h3 class="form-section-title">üìç Direcci√≥n de env√≠o</h3>
          <label for="addressInput">Direcci√≥n completa</label>
          <textarea id="addressInput" rows="3" placeholder="Calle, n√∫mero, piso, puerta..." autocomplete="street-address"></textarea>
        </div>

        <div class="save-actions">
          <button id="saveProfileBtn" class="btn primary">Guardar cambios</button>
        </div>
      </form>
    </div>

    <div class="sections-list">
      <!-- Secci√≥n informaci√≥n personal -->
      <div class="glass-card section">
        <div class="section-title">
          <span>Informaci√≥n personal</span>
          <span class="section-badge" id="personalBadge" style="display:none;">Privado</span>
        </div>
        <div id="personalInfo" class="muted">Inicia sesi√≥n para ver y editar tu informaci√≥n personal.</div>
      </div>

      <!-- Secci√≥n productos favoritos -->
      <div class="glass-card section">
        <div class="section-title">
          <span>Favoritos</span>
          <span class="section-badge" id="favBadge" style="display:none;">Solo t√∫</span>
        </div>
        <div id="favoritesList" class="favorites-list">
          <div class="empty-state">Inicia sesi√≥n para ver tus productos favoritos.</div>
        </div>
      </div>

      <!-- Secci√≥n productos comprados -->
      <div class="glass-card section">
        <div class="section-title">
          <span>Productos comprados</span>
          <span class="section-badge" id="purchasedBadge" style="display:none;">Historial</span>
        </div>
        <div id="purchasedList" class="purchased-list">
          <div class="empty-state">Inicia sesi√≥n para ver tus productos comprados.</div>
        </div>
      </div>

      <!-- Secci√≥n pedidos y env√≠os -->
      <div class="glass-card section">
        <div class="section-title">
          <span>Pedidos y env√≠os</span>
          <span class="section-badge" id="ordersBadge" style="display:none;">Seguimiento</span>
        </div>
        <div id="ordersList" class="orders-list">
          <div class="empty-state">Inicia sesi√≥n para ver tus pedidos y env√≠os.</div>
        </div>
      </div>
    </div>
  </main>

  <script type="module" src="auth-firebase-minimal.js"></script>
  <script>
  (function(){
    // --- Navegaci√≥n y accesibilidad ---
    const brandEl = document.getElementById('brand');
    brandEl.addEventListener('click', ()=> location.href='index.html');
    brandEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); brandEl.click(); } });

    // --- UI refs ---
    const profileNameEl = document.getElementById('profileName');
    const profileEmailEl = document.getElementById('profileEmail');
    const profileStatusEl = document.getElementById('profileStatus');
    const avatarImgEl = document.getElementById('profileAvatar');
    const loginBtn = document.getElementById('loginNowBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const saveBtn = document.getElementById('saveProfileBtn');
    
    // Form inputs - original
    const addressInput = document.getElementById('addressInput');
    
    // New form inputs
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const genderInput = document.getElementById('genderInput');
    const birthDateInput = document.getElementById('birthDateInput');
    const ageInput = document.getElementById('ageInput');
    const countryInput = document.getElementById('countryInput');
    const cityInput = document.getElementById('cityInput');
    const postalCodeInput = document.getElementById('postalCodeInput');
    const primaryLanguageInput = document.getElementById('primaryLanguageInput');
    const secondaryLanguageInput = document.getElementById('secondaryLanguageInput');
    const dateFormatInput = document.getElementById('dateFormatInput');
    const currencyInput = document.getElementById('currencyInput');
    const emailPrimaryInput = document.getElementById('emailPrimaryInput');
    const emailSecondaryInput = document.getElementById('emailSecondaryInput');
    const phonePrimaryInput = document.getElementById('phonePrimaryInput');
    const phoneSecondaryInput = document.getElementById('phoneSecondaryInput');
    
    const personalInfo = document.getElementById('personalInfo');
    const favoritesList = document.getElementById('favoritesList');
    const purchasedList = document.getElementById('purchasedList');
    const ordersList = document.getElementById('ordersList');

    // Badges
    const personalBadge = document.getElementById('personalBadge');
    const favBadge = document.getElementById('favBadge');
    const purchasedBadge = document.getElementById('purchasedBadge');
    const ordersBadge = document.getElementById('ordersBadge');

    const LS_USER = 'lixby_user';

    // --- Helpers ---
    function readLocalSnapshot(){
      try { return JSON.parse(localStorage.getItem(LS_USER)||'null'); } catch(e){ return null; }
    }
    function currentFirebaseUser(){
      try {
        const auth = window.appAuth && window.appAuth._rawAuth;
        const u = auth && auth.currentUser;
        if (!u) return null;
        return {
          uid: u.uid,
          displayName: u.displayName || (u.email ? u.email.split('@')[0] : 'Usuario'),
          email: u.email || '',
          photoURL: u.photoURL || '',
          isAnonymous: !!u.isAnonymous
        };
      } catch(e){ return null; }
    }
    function placeholderAvatarForName(name, size=100){
      const initials = (String(name||'Lixby').trim().split(/\s+/).slice(0,2).map(s=>s[0]||'').join('').toUpperCase() || 'LX');
      return `https://via.placeholder.com/${size}?text=${encodeURIComponent(initials)}`;
    }

    function showSkeleton(listEl, count=3){
      listEl.innerHTML = '';
      for(let i=0;i<count;i++){
        const div = document.createElement('div');
        div.className = 'skeleton';
        listEl.appendChild(div);
      }
    }

    // Helper function to calculate age
    function calculateAge(birthDate) {
      if (!birthDate) return '';
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age;
    }

    // Helper function to load user data into form
    function loadUserDataToForm(userData) {
      if (!userData) return;
      
      // Basic info
      firstNameInput.value = userData.firstName || '';
      lastNameInput.value = userData.lastName || '';
      genderInput.value = userData.gender || '';
      
      // Birth date and age
      birthDateInput.value = userData.birthDate || '';
      if (userData.birthDate) {
        ageInput.value = calculateAge(userData.birthDate);
      }
      
      // Location
      countryInput.value = userData.country || 'es';
      cityInput.value = userData.city || '';
      postalCodeInput.value = userData.postalCode || '';
      
      // Language preferences
      primaryLanguageInput.value = userData.primaryLanguage || 'es';
      secondaryLanguageInput.value = userData.secondaryLanguage || '';
      dateFormatInput.value = userData.dateFormat || 'DD/MM/YYYY';
      currencyInput.value = userData.currency || 'EUR';
      
      // Contact
      emailPrimaryInput.value = userData.emailPrimary || userData.email || '';
      emailSecondaryInput.value = userData.emailSecondary || '';
      phonePrimaryInput.value = userData.phonePrimary || userData.phone || '';
      phoneSecondaryInput.value = userData.phoneSecondary || '';
      addressInput.value = userData.address || userData.shippingAddress || '';
    }

    // Helper function to clear form
    function clearForm() {
      const inputs = [
        firstNameInput, lastNameInput, genderInput, birthDateInput, ageInput,
        countryInput, cityInput, postalCodeInput, primaryLanguageInput, secondaryLanguageInput,
        dateFormatInput, currencyInput, emailPrimaryInput, emailSecondaryInput,
        phonePrimaryInput, phoneSecondaryInput, addressInput
      ];
      inputs.forEach(input => {
        if (input) input.value = '';
      });
    }

    function renderAccountUI(u){
      const isUser = !!u && !!u.uid;
      const displayName = (u && (u.name || u.displayName)) || 'Invitado';
      const email = (u && u.email) || '';
      const isAnon = !!(u && u.isAnonymous);

      profileNameEl.textContent = displayName;
      profileEmailEl.textContent = email || (isAnon ? 'Invitado' : '');
      profileStatusEl.textContent = isUser ? (isAnon ? 'Invitado (autenticado)' : 'Autenticado') : 'No autenticado';

      const photo = (u && u.photoURL) || placeholderAvatarForName(displayName, 100);
      avatarImgEl.src = photo; avatarImgEl.alt = displayName + ' avatar';

      loginBtn.style.display = isUser ? 'none' : '';
      signOutBtn.style.display = isUser ? '' : 'none';
      saveBtn.disabled = !isUser;

      // Mostrar badges solo si autenticado
      [personalBadge, favBadge, purchasedBadge, ordersBadge].forEach(b=>b && (b.style.display = isUser ? '' : 'none'));

      // Rellenar inputs si hay datos cacheados
      if (isUser) {
        const snap = readLocalSnapshot();
        loadUserDataToForm(snap);
        personalInfo.textContent = 'Puedes editar tu informaci√≥n personal desde aqu√≠.';
        // Cargar favoritos/compras/pedidos
        showSkeleton(favoritesList, 2); setTimeout(()=>favoritesList.innerHTML='<div class="empty-state">No hay favoritos a√∫n.</div>',700);
        showSkeleton(purchasedList, 2); setTimeout(()=>purchasedList.innerHTML='<div class="empty-state">No hay compras recientes.</div>',800);
        showSkeleton(ordersList, 2); setTimeout(()=>ordersList.innerHTML='<div class="empty-state">No hay pedidos en curso.</div>',900);
      } else {
        clearForm();
        personalInfo.textContent = 'Inicia sesi√≥n para ver y editar tu informaci√≥n personal.';
        favoritesList.innerHTML = '<div class="empty-state">Inicia sesi√≥n para ver tus productos favoritos.</div>';
        purchasedList.innerHTML = '<div class="empty-state">Inicia sesi√≥n para ver tus productos comprados.</div>';
        ordersList.innerHTML = '<div class="empty-state">Inicia sesi√≥n para ver tus pedidos y env√≠os.</div>';
      }
    }

    // Primer pintado: usa snapshot si existe
    renderAccountUI(readLocalSnapshot());

    // Rehidrataci√≥n robusta: detecta sesi√≥n real aunque el m√≥dulo no exponga onAuthState
    let lastUid = null, tries = 0;
    async function tickAuth(){
      const fb = currentFirebaseUser();
      const ls = readLocalSnapshot();
      const candidate = fb || ls || null;
      const nowUid = candidate && candidate.uid || null;
      if (nowUid !== lastUid) {
        renderAccountUI(candidate);
        lastUid = nowUid;
      }
      // reintenta unas cuantas veces al cargar por si Firebase tarda
      if (!fb && tries < 40) { tries++; setTimeout(tickAuth, 500); }
    }
    tickAuth();

    // Event listeners for new functionality
    birthDateInput.addEventListener('change', function() {
      if (this.value) {
        ageInput.value = calculateAge(this.value);
      }
    });

    // Acciones
    loginBtn.addEventListener('click', ()=>{
      const overlay = document.getElementById('lixbyAuthOverlay') || document.getElementById('authOverlay');
      if (overlay) { overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); }
      else location.href='login.html';
    });

    signOutBtn.addEventListener('click', async ()=>{
      try {
        if (window.appAuth && typeof window.appAuth.signOut === 'function') {
          await window.appAuth.signOut();
        }
      } catch(e){ console.warn(e); }
      localStorage.removeItem(LS_USER);
      renderAccountUI(null);
    });

    saveBtn.addEventListener('click', async ()=>{
      const payload = {
        // New fields
        firstName: firstNameInput.value.trim(),
        lastName: lastNameInput.value.trim(),
        gender: genderInput.value,
        birthDate: birthDateInput.value,
        age: ageInput.value,
        country: countryInput.value,
        city: cityInput.value.trim(),
        postalCode: postalCodeInput.value.trim(),
        primaryLanguage: primaryLanguageInput.value,
        secondaryLanguage: secondaryLanguageInput.value,
        dateFormat: dateFormatInput.value,
        currency: currencyInput.value,
        emailPrimary: emailPrimaryInput.value.trim(),
        emailSecondary: emailSecondaryInput.value.trim(),
        phonePrimary: phonePrimaryInput.value.trim(),
        phoneSecondary: phoneSecondaryInput.value.trim(),
        address: addressInput.value.trim()
      };
      
      try {
        if (!window.appAuth || typeof window.appAuth.updateProfileExtra !== 'function') {
          alert('Funci√≥n no disponible ahora mismo'); return;
        }
        await window.appAuth.updateProfileExtra(payload);
        alert('Perfil actualizado');
      } catch(e){
        console.error(e); alert('No se pudo guardar el perfil');
      }
    });
  })();
  </script>
</body>
</html>
