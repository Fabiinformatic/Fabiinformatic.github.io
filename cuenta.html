<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi cuenta — LIXBY</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .wrap { max-width:1100px; margin:36px auto; padding:20px; }
    .account-grid { display:grid; grid-template-columns: 360px 1fr; gap:18px; align-items:start; }
    @media(max-width:980px){ .account-grid { grid-template-columns: 1fr; } }
    .panel { padding:18px; border-radius:12px; background:var(--bg-elev); border:1px solid var(--stroke); }
    .avatar-large { width:120px; height:120px; border-radius:12px; background:rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:28px; color:var(--muted); }
    .field { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    .input-wide { padding:10px 12px; border-radius:8px; border:1px solid var(--stroke); background:transparent; color:var(--text); }
    .section-title { font-weight:700; margin-bottom:8px; }
    .small-muted { color:var(--muted); font-size:0.95rem; }
    .btn-row { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .list-item { padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); margin-bottom:8px; background:transparent; }
  </style>
</head>
<body>
  <header class="nav"><div class="nav-inner"><div class="brand" id="brand">LIXBY</div><div class="nav-right"><a class="btn ghost" href="index.html">Volver</a></div></div></header>

  <main class="wrap" id="accountMain" role="main" aria-labelledby="accountHeading">
    <h1 id="accountHeading" class="sr-only">Mi cuenta</h1>

    <div class="account-grid">
      <aside class="panel" id="leftPanel" aria-labelledby="leftTitle">
        <h2 id="leftTitle" class="section-title">Tu perfil</h2>
        <div style="display:flex;gap:12px;align-items:center">
          <div id="avatarBox" class="avatar-large">LX</div>
          <div style="flex:1">
            <div id="displayName" style="font-weight:700">Invitado</div>
            <div id="displayEmail" class="small-muted">No autenticado</div>
            <div style="margin-top:8px" id="loginButtons"><button id="btnOpenAuth" class="btn primary">Iniciar sesión</button></div>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid var(--stroke)">

        <h3 class="section-title">Información personal</h3>
        <div id="personalBlock" class="small-muted">Inicia sesión para ver y editar tu información.</div>
      </aside>

      <section class="panel" id="mainPanel" aria-labelledby="mainTitle">
        <h2 id="mainTitle" class="section-title">Información de la cuenta</h2>

        <div id="accountContent">
          <div id="profileSection">
            <div class="field">
              <label for="nameInput">Nombre visible</label>
              <input id="nameInput" class="input-wide" />
            </div>
            <div class="field">
              <label for="phoneInput">Teléfono</label>
              <input id="phoneInput" class="input-wide" />
            </div>
            <div class="field">
              <label for="shippingInput">Dirección de envío</label>
              <textarea id="shippingInput" rows="3" class="input-wide"></textarea>
            </div>
            <div class="btn-row">
              <button id="saveProfile" class="btn primary">Guardar cambios</button>
              <button id="signOutBtn" class="btn ghost">Cerrar sesión</button>
            </div>
            <div id="profileMsg" class="small-muted" style="margin-top:10px"></div>
          </div>

          <hr style="margin:18px 0;border:none;border-top:1px solid var(--stroke)">

          <h3 class="section-title">Pedidos recientes</h3>
          <div id="ordersList" class="small-muted">Inicia sesión para ver tus pedidos.</div>

          <h3 class="section-title" style="margin-top:18px">Favoritos</h3>
          <div id="favsList" class="small-muted">Inicia sesión para ver tus favoritos.</div>
        </div>
      </section>
    </div>

  </main>

  <script type="module" src="auth-firebase-minimal.js"></script>
  <script>
    // comportamiento de la página de cuenta — sincroniza con appAuth
    const brand = document.getElementById('brand');
    brand.addEventListener('click', ()=> location.href='index.html');

    document.getElementById('btnOpenAuth').addEventListener('click', ()=> {
      // muestra overlay si existe
      const o = document.getElementById('lixbyAuthOverlay');
      if (o) { o.style.display='flex'; o.setAttribute('aria-hidden','false'); }
      else location.href = 'login.html';
    });

    // elementos
    const avatarBox = document.getElementById('avatarBox');
    const displayNameEl = document.getElementById('displayName');
    const displayEmailEl = document.getElementById('displayEmail');
    const nameInput = document.getElementById('nameInput');
    const phoneInput = document.getElementById('phoneInput');
    const shippingInput = document.getElementById('shippingInput');
    const saveProfile = document.getElementById('saveProfile');
    const signOutBtn = document.getElementById('signOutBtn');
    const profileMsg = document.getElementById('profileMsg');
    const ordersList = document.getElementById('ordersList');
    const favsList = document.getElementById('favsList');

    function showSignedOut() {
      displayNameEl.textContent = 'Invitado';
      displayEmailEl.textContent = 'No autenticado';
      avatarBox.textContent = 'LX';
      nameInput.value=''; phoneInput.value=''; shippingInput.value='';
      profileMsg.textContent = '';
      ordersList.innerHTML = 'Inicia sesión para ver tus pedidos.';
      favsList.innerHTML = 'Inicia sesión para ver tus favoritos.';
    }

    // subscribe auth state
    if (window.appAuth && typeof window.appAuth.onAuthState === 'function') {
      window.appAuth.onAuthState(async (u) => {
        if (!u) { showSignedOut(); return; }
        // render basic header info
        const display = u.name || u.email || 'Usuario';
        displayNameEl.textContent = display;
        displayEmailEl.textContent = u.email || (u.isAnonymous ? 'Invitado' : '');
        avatarBox.textContent = (display && display[0]) ? display[0].toUpperCase() : 'U';

        // fetch profile via fetch from local storage snapshot if present, otherwise rely on renderAccountPageIfNeeded implemented in auth module
        const localRaw = localStorage.getItem('lixby_user');
        let local = null;
        try { local = localRaw ? JSON.parse(localRaw) : null; } catch(e){ local=null; }
        nameInput.value = (local && (local.firstName || local.name)) || '';
        phoneInput.value = (local && local.phone) || '';
        shippingInput.value = (local && local.shipping && (local.shipping.address || '')) || '';

        // try to let auth module render account panel with more data (it already does) — but also try to load orders/favs gracefully
        try {
          // small delay to let auth module fetch
          setTimeout(()=> {
            // If auth module created #accountPanel it will have already filled content; otherwise, fetch minimal via Firestore (not here)
          }, 200);
        } catch(e) { console.warn(e); }

        // try to populate orders/favs from local cache (fallback)
        ordersList.innerHTML = '<div class="small-muted">Cargando pedidos…</div>';
        favsList.innerHTML = '<div class="small-muted">Cargando favoritos…</div>';
      });
    } else {
      showSignedOut();
    }

    saveProfile.addEventListener('click', async ()=>{
      const user = (window.appAuth && window.appAuth._rawAuth && window.appAuth._rawAuth.currentUser) || null;
      if (!user) { alert('Autentícate primero'); return; }
      profileMsg.textContent = 'Guardando…';
      saveProfile.disabled = true;
      try {
        if (!window.appAuth || typeof window.appAuth.updateProfileExtra !== 'function') throw new Error('No disponible');
        const extra = { firstName: nameInput.value.trim(), lastName: '', dob: null, phone: phoneInput.value.trim(), shipping: { address: shippingInput.value.trim() } };
        await window.appAuth.updateProfileExtra(extra);
        profileMsg.textContent = 'Perfil actualizado ✔';
        setTimeout(()=> profileMsg.textContent = '', 2800);
      } catch (e) {
        console.error(e);
        profileMsg.textContent = 'Error al guardar';
      } finally { saveProfile.disabled = false; }
    });

    signOutBtn.addEventListener('click', async ()=>{
      if (!confirm('¿Cerrar sesión?')) return;
      try { if (window.appAuth && typeof window.appAuth.signOut === 'function') await window.appAuth.signOut(); else location.href='index.html'; } catch(e){ console.warn(e); alert('Error cerrando sesión'); }
    });
  </script>
</body>
</html>
