<!-- (presupongo que tu HTML de cuenta está intacto y solo reemplazamos/añadimos el script que gestiona la UI de cuenta) -->

<script>
(function(){
  // IDs de elementos en tu cuenta.html (ajusta si tus ids son distintos)
  const profileNameEl = document.getElementById('profileName'); // muestra nombre visible
  const profileEmailEl = document.getElementById('profileEmail');
  const profileStatusEl = document.getElementById('profileStatus');
  const avatarImgEl = document.getElementById('profileAvatar'); // img element to render avatar
  const loginBtn = document.getElementById('loginNowBtn'); // botón "Iniciar sesión" en la página
  const signOutBtn = document.getElementById('signOutBtn'); // botón "Cerrar sesión"
  const saveBtn = document.getElementById('saveProfileBtn');

  // Util: leer snapshot local (usado por el auth module)
  function readLocalSnapshot(){
    try {
      const raw = localStorage.getItem('lixby_user');
      if (!raw) return null;
      return JSON.parse(raw);
    } catch(e){ return null; }
  }

  // Genera URL de placeholder con iniciales (misma estrategia que el módulo de auth)
  function placeholderAvatarForName(name, size=96){
    const initials = (String(name||'Lixby').trim().split(/\s+/).slice(0,2).map(s=>s[0]||'').join('').toUpperCase() || 'LX');
    return `https://via.placeholder.com/${size}?text=${encodeURIComponent(initials)}`;
  }

  // Render UI de la cuenta según objeto `u` (puede ser null)
  function renderAccountUI(u){
    // safe defaults
    const isUser = !!u && !!u.uid;
    const displayName = (u && (u.name || u.displayName)) || 'Invitado';
    const email = (u && u.email) || '';
    const isAnon = !!(u && u.isAnonymous);

    if (profileNameEl) profileNameEl.textContent = displayName;
    if (profileEmailEl) profileEmailEl.textContent = email;
    if (profileStatusEl) profileStatusEl.textContent = isUser ? (isAnon ? 'Invitado (autenticado como anónimo)' : 'Autenticado') : 'No autenticado';

    // Avatar: si hay photoURL, úsala; si no, placeholder con iniciales (misma apariencia que header)
    const photo = (u && u.photoURL) || placeholderAvatarForName(displayName, 120);
    if (avatarImgEl) {
      avatarImgEl.src = photo;
      avatarImgEl.alt = (displayName ? (displayName + ' avatar') : 'Avatar invitado');
    }

    // Mostrar/ocultar botones
    if (loginBtn) loginBtn.style.display = isUser ? 'none' : '';
    if (signOutBtn) signOutBtn.style.display = isUser ? '' : 'none';

    // Si estás mostrando campos editables, habilítalos solo si autenticado (o según tu lógica)
    if (saveBtn) saveBtn.disabled = !isUser;
  }

  // Fallback inicial: intenta usar localStorage snapshot
  try {
    const snap = readLocalSnapshot();
    if (snap) renderAccountUI(snap);
    else renderAccountUI(null);
  } catch(e){
    renderAccountUI(null);
  }

  // 1) Si el módulo de auth está cargado y provee onAuthState, suscríbete (recomendado)
  if (window.appAuth && typeof window.appAuth.onAuthState === 'function') {
    try {
      window.appAuth.onAuthState(function(u){
        // u puede ser objeto minimal (uid,name,email,photoURL,isAnonymous) o null
        renderAccountUI(u || null);
      });
    } catch(e){
      console.warn('onAuthState subscription failed', e);
    }
  } else if (window.lixbyAuth && typeof window.lixbyAuth._rawAuth !== 'undefined') {
    // si no hay onAuthState pero hay rawAuth, intenta utilizar auth observer (opcional)
    try {
      const raw = window.lixbyAuth._rawAuth;
      if (raw && typeof raw.onAuthStateChanged === 'function') {
        raw.onAuthStateChanged(function(user){
          if (user) {
            // create minimal representation
            const u = { uid: user.uid, name: user.displayName || (user.email? user.email.split('@')[0] : 'Usuario'), email: user.email, photoURL: user.photoURL, isAnonymous: !!user.isAnonymous };
            renderAccountUI(u);
            try { localStorage.setItem('lixby_user', JSON.stringify(u)); } catch(e){}
          } else {
            renderAccountUI(null);
            try { localStorage.removeItem('lixby_user'); } catch(e){}
          }
        });
      }
    } catch(e){ /* ignore */ }
  } else {
    // última defensa: escucha cambios de localStorage desde otras pestañas
    window.addEventListener('storage', function(ev){
      if (ev.key === 'lixby_user') {
        try {
          const val = ev.newValue ? JSON.parse(ev.newValue) : null;
          renderAccountUI(val);
        } catch(e){ renderAccountUI(null); }
      }
    });
  }

  // Abre modal de auth (usa API expuesta por auth module si existe)
  function openAuthModal(){
    if (window.lixbyAuth && typeof window.lixbyAuth.show === 'function') { return window.lixbyAuth.show(); }
    if (window.appAuth && typeof window.appAuth.show === 'function') { return window.appAuth.show(); }
    // fallback: navegar a login.html
    location.href = 'login.html';
  }

  if (loginBtn) loginBtn.addEventListener('click', function(){ openAuthModal(); });
  if (avatarImgEl) avatarImgEl.addEventListener('click', function(){ openAuthModal(); });

  // Cerrar sesión: preferir la API expuesta
  if (signOutBtn) signOutBtn.addEventListener('click', async function(){
    try {
      if (window.appAuth && typeof window.appAuth.signOut === 'function') {
        await window.appAuth.signOut();
      } else if (window.lixbyAuth && typeof window.lixbyAuth.signOut === 'function') {
        await window.lixbyAuth.signOut();
      } else {
        // fallback: limpiar snapshot local
        localStorage.removeItem('lixby_user');
      }
      // actualizar UI
      renderAccountUI(null);
    } catch(err) {
      console.error('Sign out failed', err);
      alert('No se pudo cerrar sesión. Revisa la consola.');
    }
  });

  // Si tienes un botón "guardar perfil", puedes guardar cambios vía appAuth.updateProfileExtra
  if (saveBtn) {
    saveBtn.addEventListener('click', async function(){
      if (!window.appAuth || typeof window.appAuth.updateProfileExtra !== 'function') {
        alert('Función de actualización de perfil no disponible.');
        return;
      }
      // Ejemplo simple: tomar campos por id y enviar
      const nameField = document.getElementById('displayNameInput');
      const telField = document.getElementById('phoneInput');
      const addrField = document.getElementById('addressInput');
      const payload = {};
      if (nameField) payload.displayName = nameField.value.trim();
      if (telField) payload.phone = telField.value.trim();
      if (addrField) payload.address = addrField.value.trim();
      try {
        await window.appAuth.updateProfileExtra(payload);
        alert('Perfil actualizado');
      } catch(e){ console.error(e); alert('Error actualizando perfil'); }
    });
  }

})();
</script>
