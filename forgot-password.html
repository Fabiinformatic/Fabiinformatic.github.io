<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recuperar contraseña — LIXBY</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .form-card { max-width:520px; margin:60px auto; }
    .input-wide { width:100%; box-sizing:border-box; padding:10px; border-radius:8px; border:1px solid var(--stroke); }
    .muted { color:var(--muted); font-size:0.95rem; }
    .error { color:#dc2626; margin-top:6px; font-size:0.95rem; }
    .hint { font-size:0.9rem; color:var(--muted); margin-top:8px; }
    .actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .hidden { display:none; }
    /* Small visual cue for dev hint */
    .dev-hint { margin-top:8px; font-size:0.9rem; color:#7c7c7c; background:rgba(0,0,0,0.03); padding:8px; border-radius:6px; }
  </style>
</head>
<body>
  <header class="nav"><div class="nav-inner"><div class="brand" id="brand" role="link" tabindex="0">LIXBY</div></div></header>

  <main>
    <div class="form-card glass" role="main" aria-labelledby="title">
      <h1 id="title" style="text-align:center">Restablecer contraseña</h1>
      <p class="muted" style="text-align:center">Introduce tu correo; te enviaremos un enlace. Si no llega, puedes usar el código de prueba (desarrollo).</p>

      <form id="fpForm" novalidate>
        <!-- STEP 1: email -->
        <div id="stepEmail">
          <label for="fpEmail"><strong>Correo electrónico</strong></label>
          <input id="fpEmail" type="email" class="input-wide" placeholder="nombre@ejemplo.com" autocomplete="email" />
          <div id="err-fpEmail" class="error" aria-live="polite"></div>

          <div class="actions">
            <a href="login.html" class="btn ghost">Volver</a>
            <button id="fpBtn" class="btn primary" type="submit">Enviar enlace</button>
          </div>

          <div id="fpMsg" class="muted" role="status" aria-live="polite" style="margin-top:12px"></div>
        </div>

        <!-- STEP 2: enter code -->
        <div id="stepCode" class="hidden" style="margin-top:18px;">
          <label for="fpCode"><strong>Código de recuperación</strong></label>
          <input id="fpCode" class="input-wide" placeholder="123456" inputmode="numeric" />
          <div id="err-fpCode" class="error" aria-live="polite"></div>
          <div class="actions">
            <button id="verifyCodeBtn" class="btn primary" type="button">Verificar código</button>
          </div>
          <div class="hint" style="margin-top:8px">Si no recibes el enlace por correo, usa el código de prueba generado (solo para desarrollo).</div>
        </div>

        <!-- STEP 3: new password -->
        <div id="stepNewPass" class="hidden" style="margin-top:18px;">
          <label for="fpNewPass"><strong>Nueva contraseña</strong></label>
          <input id="fpNewPass" type="password" class="input-wide" placeholder="Mínimo 6 caracteres" autocomplete="new-password" />
          <div id="err-fpNewPass" class="error" aria-live="polite"></div>
          <div class="actions">
            <a href="login.html" class="btn ghost">Cancelar</a>
            <button id="confirmNewPassBtn" class="btn primary" type="button">Cambiar contraseña</button>
          </div>
        </div>

      </form>
    </div>
  </main>

  <!-- auth module must expose resetPassword, verifyResetCodeLocal, confirmPasswordResetLocal, confirmPasswordResetFirebase -->
  <script type="module" src="auth-firebase-minimal.js"></script>
  <script>
    // UX wiring
    document.getElementById('brand').addEventListener('click', ()=> location.href='index.html');
    document.getElementById('brand').addEventListener('keypress', (e)=> { if (e.key === 'Enter') location.href='index.html'; });

    const fpForm = document.getElementById('fpForm');
    const fpEmail = document.getElementById('fpEmail');
    const errEmail = document.getElementById('err-fpEmail');
    const fpMsg = document.getElementById('fpMsg');
    const fpBtn = document.getElementById('fpBtn');

    const stepCode = document.getElementById('stepCode');
    const fpCode = document.getElementById('fpCode');
    const errCode = document.getElementById('err-fpCode');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');

    const stepNewPass = document.getElementById('stepNewPass');
    const fpNewPass = document.getElementById('fpNewPass');
    const errNewPass = document.getElementById('err-fpNewPass');
    const confirmNewPassBtn = document.getElementById('confirmNewPassBtn');

    let currentEmail = '';
    // detect if URL contains oobCode (Firebase link flow)
    const urlParams = new URLSearchParams(location.search);
    const oobCode = urlParams.get('oobCode');

    // helper: show new-password step (used for both flows)
    function showNewPassStep() {
      stepCode.classList.add('hidden');
      stepNewPass.classList.remove('hidden');
      // hide email step too (we don't need it at this point)
      document.getElementById('stepEmail').classList.add('hidden');
      setTimeout(()=> fpNewPass.focus(), 120);
    }

    // If there's an oobCode in URL, go directly to change-password UI using confirmPasswordResetFirebase
    if (oobCode) {
      // show new pass UI immediately
      showNewPassStep();
      fpMsg.textContent = 'Se ha detectado un enlace para restablecer la contraseña. Introduce tu nueva contraseña.';
    }

    fpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      // reset errors / messages
      errEmail.textContent = '';
      fpMsg.textContent = '';
      errCode.textContent = '';
      errNewPass.textContent = '';
      stepCode.classList.add('hidden');
      stepNewPass.classList.add('hidden');

      // If oobCode present, we shouldn't send email — user arrived by link
      if (oobCode) {
        // show password step
        showNewPassStep();
        return;
      }

      const email = (fpEmail.value || '').trim().toLowerCase();
      if (!email) { errEmail.textContent = 'Introduce tu correo.'; fpEmail.focus(); return; }
      currentEmail = email;

      fpBtn.disabled = true;
      fpMsg.textContent = 'Procesando...';

      try {
        if (!window.appAuth || typeof window.appAuth.resetPassword !== 'function') throw new Error('Función de restablecer no disponible.');
        // call resetPassword; returns { sentEmail, code } per our auth module
        const res = await window.appAuth.resetPassword(email, { method: 'link_and_code' });
        if (res.sentEmail) {
          fpMsg.textContent = 'Hemos enviado un correo con instrucciones. ';
        } else {
          fpMsg.textContent = 'No se pudo enviar el correo. ';
        }
        // Always show code step for demo/testing (module returns res.code)
        stepCode.classList.remove('hidden');
        fpMsg.textContent += 'Introduce el código que hayas recibido (o usa el código de prueba).';

        if (res.code) {
          // show code in console (do NOT show in production). Show dev hint only in dev env.
          console.info('LIXBY código de recuperación (prueba):', res.code);
          const isDev = location.hostname === 'localhost' || location.protocol === 'file:' || localStorage.getItem('lixby_dev') === '1';
          if (isDev) {
            const devHint = document.createElement('div');
            devHint.className = 'dev-hint';
            devHint.textContent = `Código de prueba (solo desarrollo): ${res.code}`;
            fpMsg.appendChild(document.createElement('br'));
            fpMsg.appendChild(devHint);
          }
        }
        // focus code input for convenience
        setTimeout(()=> { fpCode.focus(); }, 200);
      } catch (err) {
        console.error(err);
        fpMsg.textContent = err && err.message ? err.message : 'Error enviando instrucciones.';
      } finally {
        fpBtn.disabled = false;
      }
    });

    verifyCodeBtn.addEventListener('click', async () => {
      errCode.textContent = '';
      errNewPass.textContent = '';
      fpMsg.textContent = '';
      const code = (fpCode.value || '').trim();
      if (!currentEmail) { errCode.textContent = 'Primero introduce tu correo y solicita un código.'; return; }
      if (!code) { errCode.textContent = 'Introduce el código.'; fpCode.focus(); return; }

      verifyCodeBtn.disabled = true;
      fpMsg.textContent = 'Verificando...';
      try {
        if (!window.appAuth || typeof window.appAuth.verifyResetCodeLocal !== 'function') throw new Error('Función de verificación no disponible.');
        const ok = await window.appAuth.verifyResetCodeLocal(currentEmail, code);
        if (!ok) {
          errCode.textContent = 'Código incorrecto o caducado.';
          fpMsg.textContent = '';
          return;
        }
        fpMsg.textContent = 'Código verificado. Ahora introduce tu nueva contraseña.';
        showNewPassStep();
      } catch (err) {
        console.error(err);
        errCode.textContent = err && err.message ? err.message : 'Error verificando código.';
      } finally {
        verifyCodeBtn.disabled = false;
      }
    });

    confirmNewPassBtn.addEventListener('click', async () => {
      errNewPass.textContent = ''; fpMsg.textContent = '';
      const newPass = (fpNewPass.value || '').trim();
      const code = (fpCode.value || '').trim();
      if (!newPass || newPass.length < 6) { errNewPass.textContent = 'Contraseña mínima 6 caracteres.'; fpNewPass.focus(); return; }

      confirmNewPassBtn.disabled = true;
      fpMsg.textContent = 'Cambiando contraseña...';

      try {
        // If oobCode present -> use Firebase confirm flow
        if (oobCode) {
          if (!window.appAuth || typeof window.appAuth.confirmPasswordResetFirebase !== 'function') throw new Error('Función de confirmación Firebase no disponible.');
          await window.appAuth.confirmPasswordResetFirebase(oobCode, newPass);
          fpMsg.textContent = 'Contraseña cambiada correctamente. Redirigiendo a iniciar sesión...';
          setTimeout(()=> location.href = 'login.html', 1200);
          return;
        }

        // Otherwise use local demo confirm (requires email + code)
        if (!currentEmail) { fpMsg.textContent = 'Falta email.'; return; }
        if (!code) { errNewPass.textContent = 'Falta código de verificación.'; return; }
        if (!window.appAuth || typeof window.appAuth.confirmPasswordResetLocal !== 'function') throw new Error('Función de confirmación local no disponible.');
        await window.appAuth.confirmPasswordResetLocal(currentEmail, code, newPass);
        fpMsg.textContent = 'Contraseña cambiada correctamente. Redirigiendo a iniciar sesión...';
        setTimeout(()=> location.href = 'login.html', 1200);
      } catch (err) {
        console.error(err);
        errNewPass.textContent = err && err.message ? err.message : 'Error cambiando contraseña.';
      } finally {
        confirmNewPassBtn.disabled = false;
      }
    });

    // accessibility: allow Enter to submit code & new password when focused
    fpCode.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { e.preventDefault(); verifyCodeBtn.click(); } });
    fpNewPass.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { e.preventDefault(); confirmNewPassBtn.click(); } });

    // Small UX: if page has oobCode, optionally show a hint with masked oob presence
    if (oobCode) {
      // keep email input visible if you want user to confirm email — here we hide it above
      // but for transparency we add a small status message
      fpMsg.setAttribute('aria-live','polite');
    }
  </script>
</body>
</html>
